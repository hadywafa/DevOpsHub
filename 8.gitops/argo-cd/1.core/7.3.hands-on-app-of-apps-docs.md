# ğŸ’¿ **Argo CD Bootstrapping**

## ğŸ·ï¸ **Information**

1. Repository: <https://argoproj.github.io/argo-helm>
2. Chart: `argo-cd`
3. version: `8.1.1`
4. Namespace: `argo-cd`

## ğŸ—ï¸ **Bootstrap Flow**

1. Provision new cluster
2. Install Argo CD via Helm
3. Apply `bootstrap.yaml`
4. Argo CD syncs all Applications from Git
5. Cluster is fully bootstrapped

---

## ğŸ§‘ğŸ»â€ğŸ’» **How to Bootstrap to new k8s cluster**

### ğŸ› ï¸ **Prerequisites**

- A new Kubernetes cluster (EKS, AKS, GKE, Minikube, etc.)
- `kubectl` configured to access the cluster
- `helm` installed locally
- Access to your Git repository:  
  `https://github.com/OrchidaTax/helm-deployments.git`
- The bootstrap manifest (`bootstrap.yaml`) stored locally

---

### ğŸ”¹ Step 1: Install Argo CD

Install Argo CD into the new cluster using Helm:

```bash
helm repo add argo https://argoproj.github.io/argo-helm
helm repo update

helm install argo-cd argo/argo-cd \
  --namespace argo-cd \
  --create-namespace \
  --version 8.1.1 \
  --values values.yaml
```

ğŸ‘‰ Adjust the chart version to match the one used in your current cluster.

---

### ğŸ”¹ Step 2: Apply the Bootstrap Application

**`argocd-bootstrap-app.yaml`:**

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: bootstrap
  namespace: argo-cd
  annotations:
    argocd.argoproj.io/sync-options: Prune=true,CreateNamespace=true
spec:
  project: default
  source:
    repoURL: https://github.com/OrchidaTax/helm-deployments.git
    path: argocd/apps
    targetRevision: main
    directory:
      recurse: true
  destination:
    server: https://kubernetes.default.svc
    namespace: argo-cd
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - ServerSideApply=true
```

Apply your bootstrap manifest:

```bash
kubectl apply -f bootstrap.yaml -n argo-cd
```

This creates an Argo CD Application named `bootstrap` that points to your Git repo (`helm-deployments.git`) and syncs all Applications under `argocd/apps`.

---

### ğŸ”¹ Step 3: Verify Bootstrap Sync

Check that the bootstrap Application is created and syncing:

```bash
kubectl get applications -n argo-cd
```

Or view in the Argo CD UI:

```bash
kubectl port-forward svc/argo-cd-argocd-server -n argo-cd 8080:443
```

Then open:  
`https://localhost:8080`

Login with:

```bash
kubectl -n argo-cd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
```

---

### ğŸ”¹ Step 4: Validate Applications

Once bootstrap syncs:

- All Applications defined in `argocd/apps` will be created automatically.
- Verify:

  ```bash
  kubectl get applications -n argo-cd
  ```

- Each Application should show `Synced` and `Healthy`.

---

## â€¼ï¸ **Argo CD as an Application**

Managing **Argo CD itself as an Argo CD Application** is a powerful but optional pattern. It allows Argo CD to reconcile its own installation from Git, ensuring that every cluster is bootstrapped in a fully reproducible, GitOpsâ€‘native way. However, this approach comes with tradeâ€‘offs that teams must understand.

### âœ… Benefits

- **GitOps reproducibility**: Argo CDâ€™s installation, configuration, and upgrades are all tracked in Git.
- **Selfâ€‘healing**: Drift in Argo CDâ€™s own resources (Deployments, RBAC, Ingress) is automatically corrected.
- **Single source of truth**: One repository defines both infrastructure and workloads, simplifying audits and compliance.

### âš ï¸ Risks

- **Chickenâ€‘andâ€‘egg problem**: Argo CD must be installed minimally (via Helm or manifests) before it can reconcile itself.
- **Lockâ€‘out risk**: Misconfigured values (e.g., disabling the API server or ingress) can break Argo CD and block access.
- **Double ownership**: Helm and Argo CD may both â€œownâ€ the release unless you clearly hand off control to Argo CD.

### ğŸ§  Best Practice Flow

1. **Install Argo CD minimally with Helm** (just enough to run).
2. **Include an `argo-cd` Application** in your Git repo (`argocd/apps`) pointing to the Helm chart and values.
3. **Apply `bootstrap.yaml`** â†’ Argo CD reconciles itself and all other Applications.
4. **Document recovery steps** (e.g., `helm upgrade argo-cd ...`) so operators can restore Argo CD if selfâ€‘management fails.

### ğŸš¦ Recommendation

- **Do not include Argo CD as an Application** in `argocd/apps`.
- Manage Argo CD itself with Helm upgrades, and let Argo CD manage everything else.
- Later, if you want full GitOps reproducibility, you can add Argo CD as an Application â€” but only after youâ€™ve built recovery scripts and tested failure scenarios.

---

ğŸ‘‰ So: **for risky workloads, keep Argo CD out of the apps folder**. Helm manages Argo CD, Argo CD manages your workloads. That separation reduces the chance of lockouts.

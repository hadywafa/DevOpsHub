# â˜¸ï¸ **Amazon EKS Authentication & Authorization**

**(User vs Role in `~/.kube/config`, Internals, Console/CLI/Terraform Implementation)**

---

## â‰ï¸ **What Happens When You Run `kubectl`**

Before you even choose between **User** or **Role**, you need to understand the full chain of authentication & authorization inside an EKS cluster.

Letâ€™s visualize it ğŸ‘‡

<div align="center" style="background-color: #2b3436ff; border-radius: 10px; border: 2px solid">

```mermaid
sequenceDiagram
    participant K8sUser as ğŸ‘¤ kubectl (You)
    participant IAM as ğŸ” AWS IAM (User/Role)
    participant STS as ğŸªª AWS STS (Token)
    participant EKS as â˜¸ï¸ EKS API Server
    participant RBAC as ğŸ”’ Kubernetes RBAC

    K8sUser->>IAM: Uses credentials/profile (User or Assumed Role)
    IAM->>STS: Requests token via `aws eks get-token`
    STS->>EKS: Sends signed JWT (OIDC-based)
    EKS->>EKS: Matches token â†’ Access Entry (Principal ARN)
    EKS->>RBAC: Checks Access Policy or `kubernetes_groups`
    RBAC->>K8sUser: âœ… or âŒ depending on authorization
```

</div>

> ğŸ’¬ So every time you type `kubectl get pods`, EKS runs a full IAM â†’ STS â†’ EKS â†’ RBAC chain.

---

## âš™ï¸ **How `~/.kube/config` Works in EKS**

When you run:

```bash
aws eks update-kubeconfig --name my-cluster --region eu-west-1 [--role-arn <role>]
```

AWS CLI writes your kubeconfig with three key parts:

```yaml
apiVersion: v1
clusters:
  - cluster:
      server: https://ABCD.gr7.eu-west-1.eks.amazonaws.com
      certificate-authority-data: LS0tLS1...
    name: arn:aws:eks:eu-west-1:123456789012:cluster/my-cluster
users:
  - name: arn:aws:iam::123456789012:role/eks-admin
    user:
      exec:
        apiVersion: client.authentication.k8s.io/v1beta1
        command: aws
        args:
          - eks
          - get-token
          - --cluster-name
          - my-cluster
          - --role-arn
          - arn:aws:iam::123456789012:role/eks-admin
contexts:
  - name: my-cluster@eks-admin
    context:
      cluster: arn:aws:eks:eu-west-1:123456789012:cluster/my-cluster
      user: arn:aws:iam::123456789012:role/eks-admin
current-context: my-cluster@eks-admin
```

ğŸ¯ So kubeconfig doesnâ€™t hold static credentials â€” it **calls `aws eks get-token`** every time you run `kubectl`.

Thatâ€™s why youâ€™ll see â€œ`the server has asked for the client to provide credentials`â€ if STS canâ€™t mint a token.

---

## ğŸ§© **Authentication Choices**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Category                 | **IAM User**              | **IAM Role (Recommended)**                 |
| ------------------------ | ------------------------- | ------------------------------------------ |
| ğŸ• Credential lifetime   | Long-lived access keys    | Short-lived STS session tokens             |
| ğŸ‘¥ Multiple users        | One Access Entry per user | One Role shared among users via AssumeRole |
| ğŸ”’ Security              | Static keys, risky        | Rotating tokens, MFA, least privilege      |
| ğŸ§‘â€ğŸ¤â€ğŸ§‘ Offboarding           | Delete user               | Remove user from IAM group or SSO          |
| ğŸ—ï¸ Scale across accounts | Hard                      | Designed for cross-account                 |
| ğŸ§¾ Audit trail           | Limited                   | Full AssumeRole events in CloudTrail       |
| âœ… Best use case         | Labs, single-user test    | Production, SSO, teams, automation         |

</div>

> ğŸŸ¢ Always prefer **Roles** â€” scalable, secure, and compatible with SSO or CI/CD.

---

## ğŸ­ **Two Layers of Authorization in EKS**

After authentication, EKS decides **what you can do** using one of two models:

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Model                         | Where Defined  | Use Case                                             |
| ----------------------------- | -------------- | ---------------------------------------------------- |
| ğŸ§© **EKS Access Policies**    | AWS-level      | Simple, AWS-managed access control (Admin/Edit/View) |
| ğŸ”— **Custom Kubernetes RBAC** | Inside cluster | Fine-grained control for custom verbs or CRDs        |

</div>

### 1. **Access Policy (AWS-managed)**

Example policies:

- `AmazonEKSViewPolicy` â†’ read-only
- `AmazonEKSEditPolicy` â†’ CRUD in namespace
- `AmazonEKSAdminPolicy` â†’ cluster resource admin
- `AmazonEKSClusterAdminPolicy` â†’ full cluster control

Example AWS CLI:

```bash
aws eks associate-access-policy \
  --cluster-name my-eks \
  --principal-arn arn:aws:iam::123:role/eks-admin \
  --policy-arn arn:aws:eks::aws:cluster-access-policy/AmazonEKSClusterAdminPolicy \
  --access-scope type=cluster
```

### 2. **Custom RBAC via `kubernetes_groups`**

```hcl
resource "aws_eks_access_entry" "dev_team" {
  cluster_name      = aws_eks_cluster.eks.name
  principal_arn     = aws_iam_role.dev.arn
  kubernetes_groups = ["dev-team"]
}
```

Then in Kubernetes:

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: dev-team-edit
  namespace: dev
subjects:
  - kind: Group
    name: dev-team
roleRef:
  kind: Role
  name: edit
  apiGroup: rbac.authorization.k8s.io
```

---

## ğŸ…°ï¸ **Option A** â€” Authenticate with **IAM Role** (Best Practice)

### ğŸ’¡ When to use

âœ… For humans via SSO  
âœ… For CI/CD (Jenkins, GitHub Actions)  
âœ… For cross-account access

### ğŸ§± Architecture

<div align="center" style="background-color: #2b3436ff; border-radius: 10px; border: 2px solid">

```mermaid
graph TD
A[User via AWS SSO] --> B[Assume Role eks-admin]
B --> C[STS Token]
C --> D[EKS Access Entry (eks-admin)]
D --> E[Access Policy / Kubernetes Groups]
E --> F[Kubernetes RBAC]
```

</div>

### ğŸ’» CLI Example

```bash
aws eks create-access-entry \
  --cluster-name my-eks \
  --principal-arn arn:aws:iam::123456789012:role/eks-admin

aws eks associate-access-policy \
  --cluster-name my-eks \
  --principal-arn arn:aws:iam::123456789012:role/eks-admin \
  --policy-arn arn:aws:eks::aws:cluster-access-policy/AmazonEKSClusterAdminPolicy \
  --access-scope type=cluster

aws eks update-kubeconfig \
  --name my-eks --region eu-west-1 \
  --role-arn arn:aws:iam::123456789012:role/eks-admin \
  --alias my-eks-admin
```

### ğŸ§© Terraform Example

```hcl
resource "aws_iam_role" "eks_admin" {
  name = "eks-admin"
  assume_role_policy = data.aws_iam_policy_document.trust.json
}

resource "aws_eks_access_entry" "eks_admin" {
  cluster_name  = aws_eks_cluster.main.name
  principal_arn = aws_iam_role.eks_admin.arn
}

resource "aws_eks_access_policy_association" "eks_admin_policy" {
  cluster_name  = aws_eks_cluster.main.name
  principal_arn = aws_iam_role.eks_admin.arn
  policy_arn    = "arn:aws:eks::aws:cluster-access-policy/AmazonEKSClusterAdminPolicy"
  access_scope  = jsonencode({ type = "cluster" })
}
```

---

## ğŸ…±ï¸ **Option B** â€” Authenticate with **IAM User**

### ğŸ’¡ When to use

- Only for **sandbox or single-user clusters**
- **Not** suitable for shared or production clusters

### ğŸ’» CLI Example

```bash
aws eks create-access-entry \
  --cluster-name my-eks \
  --principal-arn arn:aws:iam::123:user/alice

aws eks associate-access-policy \
  --cluster-name my-eks \
  --principal-arn arn:aws:iam::123:user/alice \
  --policy-arn arn:aws:eks::aws:cluster-access-policy/AmazonEKSEditPolicy \
  --access-scope type=namespace,namespaces=dev

aws eks update-kubeconfig --name my-eks --region eu-west-1 --alias alice-context
```

### âš ï¸ Why not recommended

- Static credentials stored in profiles
- No rotation or MFA by default
- Harder to offboard

---

## ğŸ§° **Inside the kubeconfig (STS Token Flow)**

When `kubectl` runs:

1. AWS CLI plugin calls `aws eks get-token`
2. Token is a **signed OIDC JWT** with:

   - Cluster ARN
   - IAM principal ARN
   - Expiry (~15 min)

3. EKS API server verifies signature
4. Maps the ARN â†’ Access Entry
5. Access Policy or Group decides final permissions

So, **`aws eks get-token` = short-lived identity proof** ğŸªª

---

## ğŸ” **Troubleshooting Access Issues**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Error                                                | Meaning                      | Fix                                        |
| ---------------------------------------------------- | ---------------------------- | ------------------------------------------ |
| `the server has asked for credentials`               | No valid token in kubeconfig | Use `--role-arn` or login via SSO          |
| `forbidden: nodes`                                   | You donâ€™t have cluster-admin | Attach `AmazonEKSClusterAdminPolicy`       |
| `kubectl get nodes` works but not `kubectl get pods` | Namespace mismatch           | Scope policy correctly or add RBAC binding |
| `aws eks describe-access-entry` shows none           | You didnâ€™t create one        | Add access entry for your role/user        |

</div>

---

## ğŸ§­ **Recommended Authentication Strategy** (Production)

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Persona            | How to Authenticate         | How to Authorize                         | Example Policy        |
| ------------------ | --------------------------- | ---------------------------------------- | --------------------- |
| ğŸ‘¨â€ğŸ’» Platform Admins | Assume IAM Role `eks-admin` | `AmazonEKSClusterAdminPolicy`            | Cluster-scoped        |
| ğŸ‘©â€ğŸ’» Developers      | Assume IAM Role `eks-dev`   | `AmazonEKSEditPolicy` (namespace-scoped) | Dev namespace         |
| ğŸ¤– CI/CD Pipelines | IAM Role `eks-deployer`     | `AmazonEKSEditPolicy`                    | Deployment namespaces |

</div>

---

## ğŸ‰ **Bonus â€” Multi-context Kubeconfig**

You can have multiple access levels in one file:

```bash
aws eks update-kubeconfig --name my-eks --role-arn arn:aws:iam::123:role/eks-admin --alias admin
aws eks update-kubeconfig --name my-eks --role-arn arn:aws:iam::123:role/eks-dev --alias dev
kubectl config use-context dev
```

---

## âœ… **Best Practices**

- ğŸ”’ Always use **IAM Roles**, not Users
- ğŸ• Prefer **STS short-lived sessions** via `aws eks get-token`
- ğŸ§¾ Use **AWS SSO (IAM Identity Center)** for human access
- ğŸ§© Use **Access Policies** for 90% of use cases
- âš™ï¸ Use **Custom RBAC** only when you need very fine-grained control
- ğŸ§± For in-cluster AWS API access â†’ use **IRSA**, not the same IAM Role as your admin
- ğŸ§¹ Keep kubeconfig minimal â€” remove unused contexts

---

## ğŸ§¾ **Summary Table**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Layer                   | AWS Component       | Kubernetes Component | Description                              |
| ----------------------- | ------------------- | -------------------- | ---------------------------------------- |
| **Authentication**      | IAM User / IAM Role | `aws eks get-token`  | Verifies who you are                     |
| **Authorization (AWS)** | EKS Access Policy   | â€”                    | Grants managed access via policy         |
| **Authorization (K8s)** | â€”                   | RBAC (`RoleBinding`) | Grants granular resource permissions     |
| **Connection**          | EKS Endpoint        | `~/.kube/config`     | Holds cluster API endpoint & exec plugin |
| **Execution**           | AWS CLI (STS token) | EKS API Server       | Executes requests securely               |

</div>

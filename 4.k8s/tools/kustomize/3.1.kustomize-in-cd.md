# ğŸš€ **Integrating Kustomize in CI/CD â€” Push-based vs Pull-based (GitOps)**

## ğŸ§© **Whatâ€™s the goal?**

When you use **Kustomize** in CI/CD, your main goal is to **inject the right image tag** (like a commit SHA) into the overlay and deploy to the correct environment â€” _without duplicating YAMLs_.

There are two major integration styles ğŸ‘‡

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Type                    | Description                                                                                | Example tools                |
| ----------------------- | ------------------------------------------------------------------------------------------ | ---------------------------- |
| **Push-based**          | CI/CD pipeline builds, edits Kustomize overlay, and _pushes directly_ to the cluster       | GitHub Actions, Azure DevOps |
| **Pull-based (GitOps)** | CI/CD pipeline commits overlay changes to Git; the _cluster pulls & applies_ automatically | Argo CD, Flux CD             |

</div>

---

## **1ï¸âƒ£ Push-based CI/CD â€” Pipeline pushes to cluster**

### ğŸ”´ **The Problem**

Youâ€™ve already built your Docker image and pushed it to the registry.
Now you want to deploy it â€” but your `deployment.yaml` still points to `image: myapi:latest`.

Thatâ€™s bad ğŸ˜¬ â€” `latest` breaks traceability and rollbacks.

---

### âœ… **The Solution** â€” Push-based Kustomize Deployment

Your CI/CD pipeline will:

1. Build the image and tag it (e.g., `:sha256` or commit SHA).
2. Update the overlay using `kustomize edit set image`.
3. Apply it with `kubectl apply -k overlays/<env>`.

---

### ğŸ“‚ **Folder Structure**

```ini
k8s/
â”œâ”€â”€ base/
â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â””â”€â”€ kustomization.yaml
â””â”€â”€ overlays/
    â”œâ”€â”€ dev/kustomization.yaml
    â””â”€â”€ prod/kustomization.yaml
```

---

### ğŸ“ Base example â€” `base/deployment.yaml`

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapi
spec:
  replicas: 2
  template:
    spec:
      containers:
        - name: myapi
          image: myacr.azurecr.io/myapi # no tag here!
```

---

### ğŸ“ Dev overlay â€” `overlays/dev/kustomization.yaml`

```yaml
resources:
  - ../../base
images:
  - name: myacr.azurecr.io/myapi
    newTag: PLACEHOLDER
namespace: dev
```

---

### ğŸ“ CI/CD pipeline example (GitHub Actions or Azure DevOps)

```bash
# already logged into Kubernetes & registry
cd k8s/overlays/dev
kustomize edit set image myacr.azurecr.io/myapi=myacr.azurecr.io/myapi:${GITHUB_SHA}
kubectl apply -k .
```

âœ… Result:

- Overlay gets the SHA tag
- Kustomize rebuilds final manifest
- Cluster gets the exact version you built

---

### ğŸ’¬ Best Practices for Push-based Pipelines

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Practice                       | Why                                                   |
| ------------------------------ | ----------------------------------------------------- |
| Use **SHA tags**, not `latest` | ensures traceability & rollback                       |
| Use `kustomize edit set image` | avoids YAML parsing errors                            |
| Keep overlays small            | only env differences (namespace, replicas, image tag) |
| Add approvals for prod         | via GitHub/Azure Environments                         |
| Use digest for production      | for true immutability                                 |

</div>

---

### ğŸ§  Typical Flow

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

```mermaid
flowchart LR
A[Build image â†’ tag with SHA] --> B[Push to registry]
B --> C[Update overlay with new tag]
C --> D[kubectl apply -k overlays/dev]
D --> E[K8s cluster updated]
```

</div>

---

## **2ï¸âƒ£ Pull-based (GitOps) â€” Cluster pulls from Git**

---

### ğŸ”´ **The Problem**

You have multiple clusters or teams, and you want:

- Automated drift correction ğŸ§²
- Clear audit trail ğŸ§¾
- No pipelines touching your cluster directly

---

### âœ… **The Solution** â€” GitOps with Kustomize

Your pipeline:

1. Builds & pushes image.
2. Updates the overlay (e.g., sets image tag).
3. Commits and pushes the change to Git.

A GitOps operator like **Argo CD** or **Flux**:

- Watches the repo.
- Detects the change.
- Applies it automatically.

---

### ğŸ“ Example: Argo CD

#### `Application.yaml`

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: myapi-dev
spec:
  project: default
  source:
    repoURL: https://github.com/org/repo
    targetRevision: main
    path: k8s/overlays/dev
  destination:
    server: https://kubernetes.default.svc
    namespace: dev
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
```

#### CI step (after pushing image)

```bash
cd k8s/overlays/dev
kustomize edit set image myacr.azurecr.io/myapi=myacr.azurecr.io/myapi:${GITHUB_SHA}
git commit -am "Promote dev to ${GITHUB_SHA}"
git push
```

âœ… Argo CD detects the commit â†’ syncs cluster â†’ done!

---

### ğŸ“ Example: Flux CD

```yaml
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: myapi-dev
  namespace: flux-system
spec:
  interval: 1m
  path: ./k8s/overlays/dev
  prune: true
  sourceRef:
    kind: GitRepository
    name: platform-config
```

Same CI step as above â†’ Flux sees new commit â†’ reconciles.

---

### ğŸ’¬ Best Practices for GitOps + Kustomize

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Practice                       | Why                              |
| ------------------------------ | -------------------------------- |
| Commit image SHA to overlay    | makes Git the source of truth    |
| Never let CI apply to cluster  | keeps reconciliation safe        |
| Use Argo CD or Flux automation | ensures self-healing deployments |
| Store only declarative YAML    | no scripts, no imperatives       |
| Use PR reviews for promotion   | built-in approval gates          |

</div>

---

### ğŸ§  Typical Flow

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

```mermaid
flowchart LR
A[Build image â†’ tag with SHA] --> B[Push to registry]
B --> C[Commit new tag to overlay in Git]
C --> D["GitOps tool (Argo/Flux) detects change"]
D --> E[Cluster reconciles automatically]
```

</div>

---

## âš–ï¸ **Push-based vs Pull-based Comparison**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Feature               | Push-based CI/CD           | Pull-based GitOps                |
| --------------------- | -------------------------- | -------------------------------- |
| Who applies manifests | CI/CD pipeline             | GitOps controller (Argo/Flux)    |
| Deployment trigger    | Code push / pipeline run   | Git commit                       |
| Drift correction      | Manual                     | Automatic (self-heal)            |
| Audit trail           | Pipeline logs              | Git history                      |
| Multi-cluster support | Harder                     | Easy (per cluster Kustomization) |
| Setup complexity      | Low                        | Medium (needs controller)        |
| Security              | Pipeline needs kube access | Cluster-only (safer)             |

</div>

---

## âœ… **Summary**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Concept                 | Description                                                            |
| ----------------------- | ---------------------------------------------------------------------- |
| **Push-based**          | Pipeline edits Kustomize overlay & applies directly                    |
| **Pull-based (GitOps)** | Pipeline commits overlay update â†’ Argo/Flux syncs                      |
| **Both use**            | `kustomize edit set image` to inject new image tag                     |
| **Best for**            | Push â†’ small teams / few clusters </br> Pull â†’ large or regulated orgs |
| **Shared rule**         | Base YAML = static, Overlays = environment logic                       |

</div>

---

âœ¨ **In short:**

> **Push-based** = â€œCI/CD drives deployment.â€  
> **Pull-based** = â€œCluster self-heals from Git.â€

# ðŸ§  **Helm Chart Testing & Linting**

_â€œBecause broken YAMLs donâ€™t belong in productionâ€._

---

## ðŸ“– **Why Testing Helm Charts Matters**

Helm charts are code â€” and like all code, they can break ðŸ˜…

Testing ensures that:

- Your templates render correctly ðŸ§©
- Values merge as expected âš–ï¸
- Hooks and manifests are valid before touching Kubernetes ðŸ’¥
- CI/CD pipelines catch errors before cluster deployment ðŸš¦

Helm provides **three testing layers**:

1. **Linting** (static validation)
2. **Template rendering** (syntax + value merge)
3. **Runtime testing** (functional verification on cluster)

---

## ðŸ§° **`helm lint` â€” Static Chart Validation**

> **Purpose:** Catch mistakes before rendering or deploying.

Run it at the root of your chart:

```bash
helm lint ./mywebapp
```

ðŸ§¾ Example output:

```ini
==> Linting ./mywebapp
[INFO] Chart.yaml: icon is recommended
[ERROR] values.yaml: missing required field "image.repository"
Error: 1 chart(s) linted, 1 chart(s) failed
```

âœ… **What It Checks:**

- YAML syntax correctness
- Required files (`Chart.yaml`, `values.yaml`, `templates/`)
- Invalid indentation
- Deprecated API versions
- Missing dependencies in `Chart.yaml`

---

### ðŸ’¡ Pro Tip:

Use in CI/CD:

```bash
helm lint ./charts/* --strict
```

`--strict` makes warnings fail your pipeline (like `eslint --max-warnings=0`).

---

## ðŸ§© **`helm template` â€” Dry Rendering Validation**

> **Purpose:** Render your chart locally into Kubernetes YAML **without applying it**.

Think of it as:
ðŸ’¬ _â€œShow me what Helm will actually send to Kubernetes.â€_

---

### ðŸ”§ Command

```bash
helm template mywebapp ./mywebapp -f values-prod.yaml
```

ðŸ§¾ Output (truncated):

```yaml
# Source: mywebapp/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mywebapp
spec:
  replicas: 3
  template:
    spec:
      containers:
        - name: nginx
          image: nginx:1.25
```

---

### ðŸ’¡ Use Cases:

- âœ… Preview final YAML before real deployment
- âœ… Validate variable merging
- âœ… Debug templating logic (`.Values`, `.Chart`, `.Release`)
- âœ… Integrate into CI/CD validation stages

---

## ðŸ§ª `helm install --dry-run --debug` â€” Full Simulation

> Simulates the **entire install** process, including hooks and manifests, but **does not touch the cluster**.

---

### ðŸ”§ Command

```bash
helm install mywebapp ./mywebapp --dry-run --debug
```

ðŸ§¾ Example Output:

```ini
install.go:187: [debug] Created tunnel using local port: '53743'
Release "mywebapp" does not exist. Installing it now.
MANIFEST:
---
# Source: mywebapp/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: mywebapp
...
```

âœ… Youâ€™ll see:

- All rendered YAMLs
- Values merged from `values.yaml`, `-f`, and `--set`
- Hook manifests if defined

ðŸ’¡ Great for verifying large CI/CD release steps (especially before prod deployment).

---

## ðŸ“„ **`helm get manifest` â€” Post-Install Validation**

> Fetches **the actual deployed manifests** for an existing release.

```bash
helm get manifest mywebapp
```

âœ… Use this to compare rendered YAML vs deployed YAML.

---

## ðŸ§ª **`helm test` â€” Runtime Functional Tests**

> Runs **real tests** in the cluster _after installation_ â€” defined using `helm.sh/hook: test`.

---

### ðŸ“„ Example: `templates/test-connection.yaml`

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: "{{ .Release.Name }}-test"
  annotations:
    "helm.sh/hook": test
spec:
  containers:
    - name: curl
      image: busybox
      command: ["sh", "-c", "curl -f http://mywebapp:80"]
  restartPolicy: Never
```

---

### ðŸ”§ Command

```bash
helm test mywebapp --logs
```

ðŸ§¾ Output:

```ini
RUNNING: mywebapp-test
PASSED: connection successful!
SUCCESS: 1 passed, 0 failed
```

âœ… **Use Cases:**

- Validate app endpoint availability
- Check DB connectivity
- Smoke test post-deployment

ðŸ’¡ Combine this with `helm upgrade --install --wait` in pipelines for a full deploy-test flow.

---

## ðŸ§ª **Advanced Testing â€” `helm-unittest` Plugin**

> Helmâ€™s **lint** and **template** check structure,
> but `helm-unittest` allows **unit tests for templates** like real code ðŸ§ 

---

### ðŸ§© Install Plugin

```bash
helm plugin install https://github.com/quintush/helm-unittest
```

---

### ðŸ“„ Example Test File

`tests/deployment_test.yaml`

```yaml
suite: Test deployment template
templates:
  - deployment.yaml
tests:
  - it: should set the correct image
    values:
      image:
        repository: nginx
        tag: 1.25
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: nginx:1.25

  - it: should default replicas to 1
    asserts:
      - equal:
          path: spec.replicas
          value: 1
```

---

### ðŸ”§ Run Tests

```bash
helm unittest ./mywebapp
```

ðŸ§¾ Output:

```ini
### Chart [./mywebapp] ###
 PASS  Test deployment template
 - should set the correct image âœ”
 - should default replicas to 1 âœ”
Executed 2 tests in 0.012 seconds
```

âœ… **Benefits:**

- Catch templating bugs before deployment
- Test behavior under different `.Values` inputs
- Integrate into CI pipelines

---

## ðŸ§© **Visual â€” Helm Testing Pyramid**

<div align="center" style="background-color: #2b3436ff; border-radius: 10px; border: 2px solid">

```mermaid
---
config:
  theme: dark
  look: handDrawn
title: "Helm Chart Validation Layers"
---

flowchart TD
    A["ðŸ”¬ Static (Structure)<br>helm lint<br>helm unittest"]
    B["ðŸ§ª Render (Dry-run)<br>helm template<br>helm install --dry-run"]
    C["ðŸš€ Functional (Cluster)<br>helm test"]

    A --> B --> C
```

</div>

> ðŸ§  The higher you go, the more realistic â€” but also the more resource-consuming.

---

## ðŸ“‘ **Common Testing Patterns**

| Goal                    | Command                  | Description                   |
| ----------------------- | ------------------------ | ----------------------------- |
| Validate YAML structure | `helm lint`              | Detects syntax errors         |
| Verify templates render | `helm template`          | Expands all manifests locally |
| Simulate install        | `helm install --dry-run` | Emulates full release         |
| Check final manifests   | `helm get manifest`      | View deployed YAML            |
| Run cluster tests       | `helm test`              | Run `helm.sh/hook: test` pods |
| Unit test logic         | `helm unittest`          | Template-level tests          |

---

## ðŸ§ª **Debugging Tips**

ðŸ§© Print full `.Values` inside a template:

```yaml
{ { - printf "%+v" .Values | nindent 0 } }
```

ðŸ§  Useful for verifying merged values during dry-runs.

---

ðŸ§© Show all rendered manifests for debugging:

```bash
helm template ./mywebapp --debug
```

ðŸ§© Show history and revisions:

```bash
helm history mywebapp
```

---

## ðŸ§° **Real CI/CD Integration Example**

### ðŸ”§ Azure DevOps / GitHub Actions Step:

```yaml
- name: Lint Helm chart
  run: helm lint ./charts/mywebapp --strict

- name: Render Helm template (validation)
  run: helm template mywebapp ./charts/mywebapp -f values-prod.yaml

- name: Dry-run install (simulation)
  run: helm install mywebapp ./charts/mywebapp --dry-run --debug

- name: Deploy
  run: helm upgrade --install mywebapp ./charts/mywebapp --wait

- name: Run Helm tests
  run: helm test mywebapp --logs
```

âœ… Ensures your Helm chart is fully validated before and after deployment.

---

## ðŸ’¡ **Best Practices**

- âœ… Always run `helm lint` in CI before merging any PR.
- âœ… Use `helm template` or `--dry-run` in staging to preview manifests.
- âœ… Keep Helm tests (`helm.sh/hook: test`) lightweight and deterministic.
- âœ… Clean up test pods with `helm.sh/hook-delete-policy: hook-succeeded`.
- âœ… Add unit tests with `helm-unittest` for complex charts.
- âœ… Combine with `kubeval` or `kubeconform` to validate rendered manifests against Kubernetes schemas.

---

## ðŸ§¾ **Quick Summary Table**

| Command                  | Purpose                 | Use Case           |
| ------------------------ | ----------------------- | ------------------ |
| `helm lint`              | Validate structure      | Pre-commit checks  |
| `helm template`          | Render YAML locally     | Visual preview     |
| `helm install --dry-run` | Full install simulation | Safe test runs     |
| `helm test`              | Run runtime hooks       | Post-deploy tests  |
| `helm get manifest`      | Inspect live manifests  | Debug after deploy |
| `helm unittest`          | Unit test templates     | CI/CD automation   |

---

## ðŸ§­ **Diagram â€” Helm Validation Flow**

<div align="center" style="background-color: #2b3436ff; border-radius: 10px; border: 2px solid">

```mermaid
flowchart TD
  A[helm lint] --> B[helm template]
  B --> C[helm install --dry-run]
  C --> D[helm upgrade --install]
  D --> E[helm test]
  E --> F["helm unittest (optional local tests)"]
```

</div>

# 🧭 **Helmfile — The “Helm for Your Helm”**

> 💡 _Think of Helmfile as a **supercharged orchestrator** for Helm charts — it manages multiple Helm releases, environments, and dependencies from one YAML file._

---

## 🎯 **Why Helmfile Exists**

Helm is great for **one release at a time**, but when you have:

- Many charts (e.g., API, frontend, Redis, RabbitMQ)
- Multiple environments (dev/staging/prod)
- Shared values and dependencies

😬 …things get messy.

> 👉 **Helmfile** fixes that by letting you **declare all Helm releases in one place** and manage them **declaratively**, like Terraform for Helm.

---

## 💭 **Basic Concept**

Helmfile defines your **Helm releases**, **repositories**, and **environments** inside a single YAML file (`helmfile.yaml`).
Then, Helmfile runs commands like:

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Command            | Meaning                                           |
| ------------------ | ------------------------------------------------- |
| `helmfile sync`    | Installs/updates releases to match your file      |
| `helmfile apply`   | Like sync, but asks for confirmation (diff first) |
| `helmfile diff`    | Shows changes without applying                    |
| `helmfile destroy` | Uninstalls all defined releases                   |

</div>

---

## 🗂️ **Project Structure Example**

```ini
helmfile-demo/
├── helmfile.yaml
├── environments/
│   ├── values-dev.yaml
│   ├── values-staging.yaml
│   └── values-prod.yaml
└── charts/
    ├── myapi/
    ├── redis/
    └── ingress-nginx/
```

---

## 🧾 **Helmfile YAML Syntax Overview**

```yaml
# helmfile.yaml
repositories:
  - name: bitnami
    url: https://charts.bitnami.com/bitnami
  - name: ingress-nginx
    url: https://kubernetes.github.io/ingress-nginx

environments:
  dev:
    values:
      - environments/values-dev.yaml
  staging:
    values:
      - environments/values-staging.yaml
  prod:
    values:
      - environments/values-prod.yaml

releases:
  - name: myapi
    namespace: myapi-dev
    chart: ./charts/myapi
    values:
      - image:
          repository: myacr.azurecr.io/myapi
          tag: "{{ .Environment.Values.imageTag }}"
    installed: true

  - name: redis
    namespace: myapi-dev
    chart: bitnami/redis
    values:
      - persistence:
          enabled: false
        architecture: standalone

  - name: ingress
    namespace: ingress
    chart: ingress-nginx/ingress-nginx
    version: 4.10.0
    installed: true
```

---

## 🌍 **Environments Explained**

Each environment can override shared values.

**Example:**

```yaml
# environments/values-dev.yaml
imageTag: dev-{{ .Environment.Name }}
replicaCount: 1
```

```yaml
# environments/values-prod.yaml
imageTag: stable
replicaCount: 3
```

📦 Use in commands:

```bash
helmfile -e dev apply
helmfile -e prod diff
```

---

## 🧩 **Helmfile Variable Substitution**

Inside your Helmfile, you can reference:

- `{{ .Environment.Name }}` → the active environment name
- `{{ .Release.Name }}` → current release
- `{{ .Values.someKey }}` → values from your environment files
- `{{ required "msg" .Values.key }}` → enforce required values

---

## ⚙️ **Common Commands**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Command             | Description                       |
| ------------------- | --------------------------------- |
| `helmfile init`     | Initialize structure              |
| `helmfile deps`     | Download dependent charts         |
| `helmfile template` | Render all templates              |
| `helmfile lint`     | Validate charts before deployment |
| `helmfile apply`    | Apply with confirmation           |
| `helmfile sync`     | Apply directly                    |
| `helmfile diff`     | Show differences before upgrade   |
| `helmfile destroy`  | Uninstall all releases            |
| `helmfile status`   | Show release statuses             |

</div>

---

## 🧪 **Real Example: Multi-Chart Deployment**

```bash
helmfile apply
```

### Output:

```ini
Upgrading release=myapi, chart=./charts/myapi
Upgrading release=redis, chart=bitnami/redis
Upgrading release=ingress, chart=ingress-nginx/ingress-nginx
```

Helmfile will:

1. Fetch repos (bitnami, ingress-nginx)
2. Diff each release with current state
3. Apply changes in parallel

---

## 🧰 **Helmfile in CI/CD**

Example GitHub Actions job:

```yaml
- name: Deploy via Helmfile
  uses: azure/setup-helm@v4
  with:
    version: v3.15.0
- run: |
    curl -L https://github.com/helmfile/helmfile/releases/download/v1.1.0/helmfile_1.1.0_linux_amd64.tar.gz | tar xz
    sudo mv helmfile /usr/local/bin/
    helmfile -e staging apply
```

> ✅ Use `helmfile diff` before `helmfile apply` in production CI for safe promotion.

---

## 🧠 **Advanced Features**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Feature              | Description                                                    |
| -------------------- | -------------------------------------------------------------- |
| **Selectors**        | Run Helmfile on specific releases (`--selector name=myapi`)    |
| **Hooks**            | Run scripts before/after deployments                           |
| **Dependencies**     | Define release dependencies via `needs:`                       |
| **State Locking**    | Use Helmfile statefiles like Terraform (avoid race conditions) |
| **Nested helmfiles** | Use `helmfiles:` field to include other Helmfiles              |

</div>

---

## 🧩 **Example: Dependencies and Hooks**

```yaml
releases:
  - name: redis
    chart: bitnami/redis
    installed: true

  - name: myapi
    chart: ./charts/myapi
    needs: ["redis"]
    hooks:
      - events: ["presync"]
        command: "echo"
        args: ["Backing up database before deploy"]
```

---

## 🧱 **Folder-Based Multi-Env Structure (Best Practice)**

```ini
helmfile.yaml              # main entry
helmfiles/
  dev.yaml
  staging.yaml
  prod.yaml
environments/
  dev/values.yaml
  prod/values.yaml
charts/
  myapi/
  redis/
```

You can include them:

```yaml
# helmfile.yaml
helmfiles:
  - path: helmfiles/dev.yaml
  - path: helmfiles/prod.yaml
```

Then run:

```bash
helmfile -e dev apply
```

---

## 🔐 **Integrating with ACR or GHCR**

You can inject registry credentials into environment values:

```yaml
environments:
  prod:
    values:
      - registry:
          server: myacr.azurecr.io
          username: "{{ requiredEnv "ACR_USER" }}"
          password: "{{ requiredEnv "ACR_PASS" }}"
```

And reference them inside Helm chart values:

```yaml
image:
  repository: {{ .Environment.Values.registry.server }}/myapi
```

---

## 🧩 **Helmfile vs Helm Comparison**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Feature                     | Helm      | Helmfile    |
| --------------------------- | --------- | ----------- |
| Deploy one chart            | ✅        | ✅          |
| Manage multiple charts      | ⚠️ manual | ✅ easy     |
| Multi-environment values    | manual    | ✅ built-in |
| Apply all with diff         | ❌        | ✅          |
| Dependencies between charts | ❌        | ✅          |
| GitOps-friendly YAML config | ❌        | ✅          |
| Ideal for CI/CD stacks      | partial   | ✅ perfect  |

</div>

---

## 🚀 **Example: Complete Monolithic Helmfile**

```yaml
repositories:
  - name: bitnami
    url: https://charts.bitnami.com/bitnami
  - name: ingress-nginx
    url: https://kubernetes.github.io/ingress-nginx

environments:
  dev:
    values: [environments/values-dev.yaml]
  staging:
    values: [environments/values-staging.yaml]
  prod:
    values: [environments/values-prod.yaml]

releases:
  - name: redis
    chart: bitnami/redis
    namespace: redis
    installed: true

  - name: myapi
    chart: ./charts/myapi
    namespace: myapi
    needs: ["redis"]
    values:
      - image:
          repository: myacr.azurecr.io/myapi
          tag: "{{ .Environment.Values.imageTag }}"
      - replicaCount: "{{ .Environment.Values.replicaCount }}"
    hooks:
      - events: ["presync"]
        command: "echo"
        args: ["Backing up Redis before deploy"]

  - name: ingress
    chart: ingress-nginx/ingress-nginx
    namespace: ingress
    version: 4.10.0
```

---

## 🧩 **Key Best Practices**

- ✅ Use `helmfile diff` before apply in CI/CD
- ✅ Separate environment value files
- ✅ Use digests for production images
- ✅ Keep Helmfile and charts version-controlled
- ✅ Run with `--wait --atomic` for safe upgrades
- ✅ Use `needs:` to order releases

---

## 🔚 **Summary**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| You want to...                 | You use...                               |
| ------------------------------ | ---------------------------------------- |
| Deploy multiple charts at once | `helmfile apply`                         |
| Preview changes                | `helmfile diff`                          |
| Manage environments            | `environments:`                          |
| Link dependent charts          | `needs:`                                 |
| Integrate in CI/CD             | Use Helmfile CLI                         |
| Reuse values                   | Centralize them in `environments/*.yaml` |

</div>

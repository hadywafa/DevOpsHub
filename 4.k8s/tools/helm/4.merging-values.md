# ğŸ§  **Helm Value Merging & Scoping Explained**

_â€œWho wins when everyone has a value?â€._

---

## ğŸ–¼ï¸ **The Big Picture**

Helm supports multiple ways to provide values to a chart:

- **`values.yaml`** â€” default chart values
- **Custom values file (`-f`)** â€” environment-specific overrides
- **Inline overrides (`--set`)** â€” quick CLI overrides
- **Global values (`.Values.global`)** â€” shared across subcharts
- **Subchart `values.yaml`** â€” each dependencyâ€™s local values

When you run:

```bash
helm install mywebapp ./mywebapp \
  -f prod-values.yaml \
  --set replicaCount=10
```

Helm merges all these layers **in order of precedence** ğŸ§©

---

## âš–ï¸ **The Helm Value Precedence Order**

> ğŸ§® Highest priority wins.

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Priority | Source                           | Example                     |
| -------- | -------------------------------- | --------------------------- |
| ğŸ¥‡ 1     | `--set` CLI flag                 | `--set image.tag=v3`        |
| ğŸ¥ˆ 2     | Extra values file(s) `-f`        | `-f prod-values.yaml`       |
| ğŸ¥‰ 3     | Chartâ€™s `values.yaml`            | default values in the chart |
| ğŸ§© 4     | Subchart `values.yaml`           | only for dependencies       |
| ğŸª£ 5      | Global values (`.Values.global`) | accessible by all charts    |

</div>

> So Helm merges in this order:  
> **Chart default â†’ extra files â†’ CLI `--set` â†’ global values apply everywhere**

---

## âš™ï¸ **Visual Diagram â€” How Values Merge**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

```mermaid
flowchart TD
  A[values.yaml] --> B(Merged Values)
  B1[-f prod-values.yaml] --> B
  B2[--set overrides] --> B
  C[.Values.global.*] --> D[Parent + Subcharts]
  B --> E[Render Templates]
```

</div>

---

## ğŸ§© **Merging Behavior Example**

Letâ€™s say you have:

### ğŸ“„ `values.yaml`

```yaml
replicaCount: 2
image:
  repository: nginx
  tag: latest
```

### ğŸ“„ `prod-values.yaml`

```yaml
replicaCount: 5
image:
  tag: stable
```

### ğŸ§  CLI

```bash
--set image.tag=v2
```

ğŸ”® **Final merged values:**

```yaml
replicaCount: 5
image:
  repository: nginx
  tag: v2
```

âœ… `--set` wins
âœ… File overrides default
âœ… Unchanged fields are inherited

---

## ğŸ§© **Merging with Nested Maps**

Helm performs a **deep merge**, not a shallow one â€” meaning nested keys are merged recursively.

**Example:**

`values.yaml`

```yaml
env:
  DB_HOST: localhost
  DB_USER: admin
```

`-f prod-values.yaml`

```yaml
env:
  DB_USER: produser
```

âœ… **Result:**

```yaml
env:
  DB_HOST: localhost
  DB_USER: produser
```

ğŸ§  It didnâ€™t delete `DB_HOST`, only replaced the overridden field.

---

## ğŸŒ **Global Values â€” `.Values.global`**

Global values are special shared keys that propagate across **parent and subcharts**.

### Example Structure:

**Parent Chart (`myapp`)**

```ini
myapp/
â”œâ”€â”€ values.yaml
â”œâ”€â”€ charts/
â”‚   â””â”€â”€ redis/
â”‚       â””â”€â”€ values.yaml
```

### Parent `values.yaml`

```yaml
global:
  appEnv: production
redis:
  image:
    tag: latest
```

### Subchart `templates/config.yaml`

```yaml
env: { { .Values.global.appEnv } }
```

ğŸ’¡ Even though `appEnv` is defined in the **parent**, the **subchart** can still access it:

```yaml
env: production
```

âœ… **Global values automatically merge into subchartsâ€™ `.Values.global` scope.**

---

## ğŸ§© **Subchart Values and Overrides**

Each subchart (dependency) has its own `values.yaml`, but the parent can override it.

Example:

### ğŸ“Œ Parent Chart

```yaml
dependencies:
  - name: redis
    repository: https://charts.bitnami.com/bitnami
    version: 18.4.0
```

### ğŸ“Œ Parent `values.yaml`

```yaml
redis:
  architecture: replication
  replica:
    replicaCount: 3
```

â¡ï¸ Helm merges this under the subchartâ€™s `.Values`, so inside the Redis subchart:

```yaml
{{ .Values.architecture }}        # replication
{{ .Values.replica.replicaCount }} # 3
```

ğŸ§  **Parent overrides subchart defaults automatically.**

---

## ğŸ§  **Accessing Parent vs Subchart Values**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Context                   | Access Scope           | Example                                 |
| ------------------------- | ---------------------- | --------------------------------------- |
| Parent chart template     | `.Values`              | `.Values.image.repository`              |
| Subchart template         | `.Values`              | `.Values.replicaCount` (subchartâ€™s own) |
| Subchart accessing global | `.Values.global.*`     | `.Values.global.appEnv`                 |
| Parent accessing subchart | `.Values.<subchart>.*` | `.Values.redis.replica.replicaCount`    |

</div>

---

## ğŸ§© **Combining Global + Local Overrides**

**values.yaml:**

```yaml
global:
  region: eu-west-1
app:
  region: us-east-1
```

**template:**

```yaml
region: { { .Values.app.region | default .Values.global.region } }
```

âœ… **If app-specific region exists â†’ use it.**
âœ… **Else â†’ fallback to global region.**

ğŸ§¾ Result:

```ini
region: us-east-1
```

---

## âš™ï¸ **Using Multiple Values Files**

You can provide **multiple `-f` flags** â€” they are merged in order (later overrides earlier).

Example:

```bash
helm install mywebapp ./mywebapp \
  -f values.yaml \
  -f staging.yaml \
  -f secret-overrides.yaml
```

Helm merges:

```ini
values.yaml â†’ staging.yaml â†’ secret-overrides.yaml
```

Later files win ğŸ¯

---

## ğŸ§© Using `--set-file` and `--set-string`

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Flag           | Description                          | Example                        |
| -------------- | ------------------------------------ | ------------------------------ |
| `--set`        | Inline key-value (auto type-detects) | `--set replicaCount=3`         |
| `--set-string` | Forces string type                   | `--set-string password=0123`   |
| `--set-file`   | Reads value from file                | `--set-file config=./app.conf` |

</div>

> ğŸ’¡ Use `--set-string` when numeric strings like `001` are required (Helm otherwise converts to int).

---

## ğŸ§ª **Debugging Value Merges**

### ğŸ§° Show merged values for a release

```bash
helm get values <release> --all
```

### ğŸ§ª Render without applying

```bash
helm template ./mychart -f prod-values.yaml --set image.tag=v2
```

### ğŸ§  Show what final `.Values` looks like

Add this debug snippet:

```yaml
{ { - printf "%+v" .Values | nindent 0 } }
```

---

## ğŸ’¡ **Real Example: Full Merge**

**Default `values.yaml`**

```yaml
replicaCount: 2
image:
  repository: nginx
  tag: latest
```

**File: `qa-values.yaml`**

```yaml
replicaCount: 3
```

**CLI:**

```bash
--set image.tag=stable
```

âœ… Final `.Values` during render:

```yaml
replicaCount: 3
image:
  repository: nginx
  tag: stable
```

---

## ğŸ–¼ï¸ **Parent/Subchart Value Flow**

<div align="center" style="background-color: #2b3436ff; border-radius: 10px; border: 2px solid">

```mermaid
flowchart LR
  A["Parent values.yaml"] --> B[".Values"]
  A --> C[".Values.global.*"]
  B --> D[Parent Templates]
  A --> E["Subchart Overrides (.Values.<subchart>)"]
  E --> F[Subchart Templates]
  C --> F
```

</div>

---

## ğŸ’¡ **Best Practices**

- âœ… Use `global` for shared settings like environment, imagePullSecrets, or domain.
- âœ… Use per-env override files (e.g., `values-dev.yaml`, `values-prod.yaml`).
- âœ… Avoid overusing `--set`; prefer `-f` for maintainability.
- âœ… Keep parent/subchart variable names consistent.
- âœ… Use `default` or `required` in templates to handle missing keys.
- âœ… Always run `helm template` before `install` to preview merged results.

---

## ğŸ§¾ **Quick Summary Table**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Concept                      | Description                    | Example                     |
| ---------------------------- | ------------------------------ | --------------------------- |
| **`values.yaml`**            | Default chart config           | base settings               |
| **`-f file.yaml`**           | File override                  | `helm install -f prod.yaml` |
| **`--set`**                  | Inline override                | `--set image.tag=v2`        |
| **Global values**            | Shared between charts          | `.Values.global.*`          |
| **Deep merge**               | Nested maps merge recursively  | Keeps unchanged keys        |
| **Order**                    | `values.yaml` < `-f` < `--set` | Highest wins                |
| **Parent override subchart** | `.Values.redis.*`              | parent > subchart           |
| **Multiple -f files**        | Later wins                     | `-f base -f prod`           |

</div>

---

## ğŸ§© **Example Directory**

```ini
myapp/
â”œâ”€â”€ values.yaml
â”œâ”€â”€ values-prod.yaml
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â”œâ”€â”€ service.yaml
â”‚   â””â”€â”€ _helpers.tpl
â””â”€â”€ charts/
    â””â”€â”€ redis/
        â”œâ”€â”€ values.yaml
        â””â”€â”€ templates/
```

# üß® Malicious Code Execution in Kubernetes: How Attackers Run Unauthorized Commands

This guide explains how attackers exploit vulnerabilities in your Kubernetes setup to **run unauthorized code**, escalate privileges, and compromise your cluster. You‚Äôll learn how these attacks work and how to defend against them.

---

## üß† What Is Malicious Code Execution?

Malicious code execution happens when an attacker:

- Exploits a vulnerability in your app or cluster
- Runs unauthorized commands or binaries inside a container or on the host
- Gains control over workloads, secrets, or infrastructure

This can lead to:

- **Privilege escalation** (e.g., root access)
- **Data exfiltration** (e.g., stealing secrets)
- **Cluster-wide compromise** (e.g., spawning backdoored pods)

---

## üîç Common Attack Vectors

Attackers use several methods to execute code inside your cluster:

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Attack Vector                | Description                                                            | Impact                               |
| ---------------------------- | ---------------------------------------------------------------------- | ------------------------------------ |
| Import Tools or Scripts      | Use `curl`, `wget`, or package managers to download and run payloads   | Arbitrary code execution             |
| Modify Host Files            | Tamper with mounted host files (e.g., `/etc/rc.local`, cron jobs)      | Persistence and stealthy backdoors   |
| Host-Level Process Injection | Abuse host PID namespace or `SYS_PTRACE` to inject into host processes | Host compromise and lateral movement |

</div>

> ‚ö†Ô∏è _Warning_: Granting `SYS_PTRACE` or enabling host PID namespaces is **highly risky**. Always review Pod Security Standards before allowing privileged capabilities.

---

## üß™ Post-Compromise Behavior

Once inside a container, attackers often **call the Kubernetes API** to:

- Spawn new pods with malicious images
- Trigger DoS attacks by scaling deployments
- Harvest service account tokens and secrets

> _Visual_: Diagram showing compromised pods interacting with the API server and spawning new workloads.

---

## üß¨ Poisoning the Image Repository

If attackers steal an **image pull secret**, they can:

- Push backdoored images to your registry
- Trick future deployments into running malicious containers

```bash
kubectl create secret docker-registry my-image-pull-secret \
  --docker-username=<username> \
  --docker-password=<password> \
  --docker-server=<registry-url> \
  --namespace=default
```

> _Visual_: Flowchart showing poisoned images pulled from Docker Hub into NGINX, Node.js, and MySQL pods.

---

## üõ°Ô∏è Mitigation Strategies

### 1Ô∏è‚É£ Scan and Patch Vulnerabilities

- Use tools like **Trivy** to scan container images and host OS
- Integrate scanning into CI/CD
- Block deployments if high-severity CVEs are found

> _Tip_: Automate scanning on every build to catch issues early.

---

### 2Ô∏è‚É£ Restrict API Server Access

- Enforce **strong authentication**
- Use **granular RBAC** to limit who can call sensitive API endpoints
- Avoid giving `cluster-admin` to service accounts

> _Visual_: User blocked from accessing API due to RBAC restrictions

---

### 3Ô∏è‚É£ Secure Image Repositories and Pull Secrets

- Store secrets in encrypted vaults (e.g., HashiCorp Vault)
- Limit which service accounts can use image pull secrets
- Enforce **image signing** to verify integrity

```yaml
imagePullSecrets:
  - name: my-image-pull-secret
```

> _Visual_: Pod spec showing secure image pull configuration

---

### 4Ô∏è‚É£ Monitor and Alert

Use **Prometheus + Alertmanager** to detect suspicious activity:

```yaml
- alert: SecretChangeDetected
  expr: kube_secret_info
  for: 1m
  labels:
    severity: critical
  annotations:
    summary: "Secret Change Detected"
    description: "A change was detected in a Kubernetes Secret."

- alert: CommandExecutionInContainer
  expr: increase(kube_audit_event_total{verb="exec"}[5m]) > 0
  for: 1m
  labels:
    severity: warning
  annotations:
    summary: "Exec API call detected"
    description: "An exec call was detected in container {{ $labels.container }}."
```

> _Tip_: Alert on `exec` calls, secret changes, and API abuse.

---

### 5Ô∏è‚É£ Audit and Review

- Periodically review:
  - RBAC roles
  - Service account permissions
  - Image registry access policies
- Conduct **penetration tests** to validate your defenses

> _Visual_: Slide showing audit icons and checklist for service accounts, image security, and API access

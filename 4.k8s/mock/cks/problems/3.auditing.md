# ðŸ“ƒ Auditing in Kubernetes

## âœ… **Step 1 â€” Enable Auditing Using `/etc/kubernetes/cluster-policy.yaml`**

Make sure the kube-apiserver is launched with audit flags:

Edit its systemd manifest:

```bash
sudo nano /etc/kubernetes/manifests/kube-apiserver.yaml
```

Add or modify these flags:

```yaml
- --audit-log-path=/var/log/cluster-audit.log
- --audit-policy-file=/etc/kubernetes/cluster-policy.yaml
- --audit-log-maxage=10
- --audit-log-maxsize=10
- --audit-log-maxbackup=3
```

Meaning:

| Requirement                                | Setting                   |
| ------------------------------------------ | ------------------------- |
| Store logs at `/var/log/cluster-audit.log` | `--audit-log-path`        |
| Retain logs for **10 days**                | `--audit-log-maxage=10`   |
| Each log max size **10MB**                 | `--audit-log-maxsize=10`  |
| Keep max **3 files**                       | `--audit-log-maxbackup=3` |

Restart is automatic because this is a static pod.

---

## âœ… **Step 2 â€” Update the Audit Policy File (`cluster-policy.yaml`)**

Now edit:

```bash
sudo nano /etc/kubernetes/cluster-policy.yaml
```

Use the following **correct audit policy** that meets all rules:

```yaml
apiVersion: audit.k8s.io/v1
kind: Policy
rules:
  # 1ï¸âƒ£ Track delete activity on secrets in kube-system at Metadata level
  - level: Metadata
    resources:
      - group: ""
        resources: ["secrets"]
    namespaces: ["kube-system"]
    verbs: ["delete"]

  # 2ï¸âƒ£ Track changes to deployments in default namespace at Request level
  - level: Request
    resources:
      - group: "apps"
        resources: ["deployments"]
    namespaces: ["default"]

  # 3ï¸âƒ£ Track all other requests at Metadata level (catch-all)
  - level: Metadata
    resources:
      - group: ""
        resources: ["*"]
      - group: "apps"
        resources: ["*"]
```

This satisfies:

âœ” Delete secrets in `kube-system` â†’ Metadata
âœ” Deployment changes in `default` â†’ Request
âœ” "All other requests" â†’ Metadata

---

## âœ… **Step 3 â€” Ensure Policy Takes Effect**

After modifying any file under `/etc/kubernetes/manifests/`, kubelet automatically restarts the kube-apiserver.

Verify:

```bash
kubectl get pods -n kube-system | grep kube-apiserver
```

Check audit log is created:

```bash
sudo tail -f /var/log/cluster-audit.log
```

You should see JSON events coming in.

---

## âœ… **Step 4 â€” Validate All Requirements Are Met**

### âœ” Logs go to `/var/log/cluster-audit.log`

### âœ” Retain logs for **10 days**

### âœ” Max single file size = **10MB**

### âœ” Max **3 rotated files**

### âœ” Delete events on `secrets` in `kube-system` logged at **Metadata level**

### âœ” Deployment changes in `default` logged at **Request level**

### âœ” All other requests logged at **Metadata level**

### âœ” Configuration persists across restarts

---

## â­ **Final Exam-Ready Response**

> **Auditing is enabled using `/etc/kubernetes/cluster-policy.yaml`, logs are stored at `/var/log/cluster-audit.log` with 10-day retention, 10MB max size, and 3-file rotation. The audit policy has been updated to record delete actions on `secrets` in `kube-system` (Metadata level), record deployment changes in `default` (Request level), and log all other requests at Metadata level. The policy is applied and active.**

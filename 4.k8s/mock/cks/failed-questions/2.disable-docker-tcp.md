# üß© **THE EXACT CKS-STYLE QUESTION (2025 format)**

## **Question**

You are asked to secure a Kubernetes node running Docker as its container runtime.

1. **Disable Docker Engine TCP socket access** (Docker is currently listening on port `2375` which is insecure and unauthenticated).
2. **Remove the ‚Äúdocker‚Äù group** from developers who should not have privileged container access.
3. **Ensure Kubernetes continues to work normally** after the hardening changes.
4. **Restart Docker** and verify that kubelet can still pull images and run pods.

Perform these tasks on node:
`node01`

---

## üß† **WHAT THE QUESTION IS REALLY TESTING**

‚úî Hardening Docker daemon
‚úî Disabling insecure access (TCP 2375)
‚úî Understanding systemd config for Docker
‚úî Removing user from privileged group
‚úî Ensuring kubelet uses the UNIX socket (`/var/run/docker.sock`), not TCP
‚úî Testing Kubernetes functionality

This is a classic CKS scenario because TCP 2375 = **No TLS, remote root access**.

---

## ü•á **THE CORRECT ANSWER (Step by Step)**

---

### **1Ô∏è‚É£ Check if Docker is listening on TCP (2375)**

```bash
sudo ss -lntp | grep dockerd
```

If you see:

```ini
LISTEN 0 128 0.0.0.0:2375 ...
```

‚Üí It is insecure.

---

### **2Ô∏è‚É£ Locate the systemd unit override for Docker**

In most CKS exam environments:

```bash
ls /etc/systemd/system/docker.service.d/
```

You will see something like:

- `override.conf`
- `docker-tcp.conf`

Open it:

```bash
sudo vi /etc/systemd/system/docker.service.d/docker-tcp.conf
```

Content may look like:

```ini
[Service]
ExecStart=
ExecStart=/usr/bin/dockerd -H fd:// -H tcp://0.0.0.0:2375
```

This enables **insecure remote root access**.

---

### **3Ô∏è‚É£ Disable Docker TCP Socket Access (Correct Fix)**

Edit the file OR create a new override:

```bash
sudo mkdir -p /etc/systemd/system/docker.service.d
sudo vi /etc/systemd/system/docker.service.d/override.conf
```

Write this:

```ini
[Service]
ExecStart=
ExecStart=/usr/bin/dockerd -H fd://
```

‚ùó **Important**:
The empty `ExecStart=` line resets previous values ‚Äî CKS exam expects this.

---

### **4Ô∏è‚É£ Reload systemd and restart Docker**

```bash
sudo systemctl daemon-reload
sudo systemctl restart docker
```

Verify:

```bash
sudo ss -lntp | grep dockerd
```

‚úî Expected result: Only UNIX socket  
‚ùå No TCP 2375

---

### üßπ **Remove users from the dangerous "docker" group**

List users in group:

```bash
getent group docker
```

Example output:

```ini
docker:x:999:developer1,developer2
```

Remove each user:

```bash
sudo gpasswd -d developer1 docker
sudo gpasswd -d developer2 docker
```

OR delete group entirely (safer):

```bash
sudo groupdel docker
```

Remember:
**Anyone in docker group has root access ‚Üí insecure.**

---

### üß™ **Verify Kubernetes still works (critical for full marks)**

#### Test kubelet pulling images:

```bash
sudo crictl ps
sudo crictl images
```

If crictl is not configured automatically, exam provides:

```bash
sudo crictl --runtime-endpoint unix:///var/run/dockershim.sock ps
```

#### Test creating a new pod:

```bash
kubectl run test --image=nginx --restart=Never
kubectl get pods
```

If pod runs ‚Üí Docker hardening is valid & kubelet still works.

---

## üõë **Common CKS Traps You Must Avoid**

| Mistake                                                          | Result                 |
| ---------------------------------------------------------------- | ---------------------- |
| Removing Docker daemon socket `-H fd://`                         | Kubernetes breaks      |
| Disabling Docker service accidentally                            | kubelet crashes        |
| Forgetting `ExecStart=` reset line                               | TCP stays enabled      |
| Removing docker group while systemd overrides still reference it | Dockerd fails to start |
| Not restarting Docker after editing                              | No effect              |

---

## üéØ **The EXACT Exam-Perfect Final Answer Summary**

```bash
# 1. Remove insecure TCP 2375 access
sudo vi /etc/systemd/system/docker.service.d/override.conf

# Add:
[Service]
ExecStart=
ExecStart=/usr/bin/dockerd -H fd://

# 2. Reload and restart
sudo systemctl daemon-reload
sudo systemctl restart docker

# 3. Remove docker group access
getent group docker
sudo gpasswd -d developer1 docker
sudo gpasswd -d developer2 docker
usermod -s /bin/nologin hady
# or
sudo groupdel docker

# 4. Confirm docker no longer listens on 2375
sudo ss -lntp | grep dockerd

# 5. Verify Kubernetes works
crictl ps
kubectl run test --image=nginx --restart=Never
kubectl get pods
```

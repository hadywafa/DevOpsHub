# â˜¸ï¸ **kube-bench**

## ğŸ“– **Understanding How kube-bench Works**

`kube-bench` performs **CIS Benchmark tests** defined in YAML files under its `cfg/` directory.
Each test:

- checks for a specific Kubernetes configuration (like a flag, permission, or file mode);
- reports a result: âœ… PASS, âš ï¸ WARN, or âŒ FAIL;
- gives **â€œRemediationâ€** text explaining what to fix.

```bash
sudo kube-bench run --benchmark cis-1.24
```

That command triggers:

1. Auto-detection of node role (master/control-plane or worker).
2. Execution of relevant tests.
3. Report printed to terminal or exported in JSON.

---

## âš™ï¸ **Running kube-bench (Full & Partial Scans)**

### ğŸ§ª Full Scan

Run all CIS checks (control plane + node):

```bash
sudo kube-bench run
```

- Detects node type automatically.
- Takes 1â€“2 minutes.
- Outputs summarized results.

---

### ğŸ¯ Run a Specific Section Only

You can focus on one benchmark section instead of everything.
For example:

- `1` â†’ Control Plane Components
- `4` â†’ Worker Node Configuration

Run only section 1:

```bash
sudo kube-bench run --section 1
```

Or section 4 (nodes):

```bash
sudo kube-bench run --section 4
```

This is great when youâ€™ve just fixed something in that area (e.g., kubelet config).

---

### ğŸ§© Run a Specific Test ID

Each CIS rule has an ID like `1.2.7`.
You can target it directly:

```bash
sudo kube-bench run --check 1.2.7
```

This runs **only** the single rule â€” perfect for verifying fixes quickly.

---

## ğŸ§¾ **Viewing and Saving Reports**

### ğŸ–¥ï¸ Default (Console Output)

When you run `kube-bench`, results print in color-coded text:

```ini
== Summary ==
14 checks PASS
3 checks FAIL
2 checks WARN
```

### ğŸ§© Export as JSON

For programmatic analysis or saving logs:

```bash
sudo kube-bench run --json > /var/log/kube-bench-report.json
```

View with `jq`:

```bash
cat /var/log/kube-bench-report.json | jq .
```

Example:

```json
{
  "section": "1.2 API Server",
  "test_number": "1.2.7",
  "desc": "Ensure --authorization-mode is not set to AlwaysAllow",
  "state": "FAIL",
  "remediation": "Edit /etc/kubernetes/manifests/kube-apiserver.yaml"
}
```

---

## ğŸ¤¹ğŸ» **Understanding Result Types**

<div align="center" style="background:#343739ff; border-radius:20px">

| Result      | Meaning                                | Example                            |
| ----------- | -------------------------------------- | ---------------------------------- |
| âœ… **PASS** | The node complies with the control     | `--anonymous-auth=false`           |
| âŒ **FAIL** | Misconfiguration detected              | `--authorization-mode=AlwaysAllow` |
| âš ï¸ **WARN** | Cannot determine (manual check needed) | Check audit log policy manually    |
| â“ **INFO** | Informational or skipped test          | Optional for environment           |

</div>

---

## ğŸ“ƒ **Reading the Report (CLI Output Example)**

```ini
[INFO] 1 Control Plane Configuration
[PASS] 1.1.1 Ensure API server pod spec file permissions are set to 644 or more restrictive
[FAIL] 1.2.7 Ensure that the --authorization-mode argument is not set to AlwaysAllow
    Remediation: Edit /etc/kubernetes/manifests/kube-apiserver.yaml
    Reason: Found '--authorization-mode=AlwaysAllow'
[WARN] 1.3.2 Ensure controller-manager certs are owned by root
```

Each FAIL includes:

- The **control ID** (`1.2.7`)
- **Current finding** (reason)
- **Remediation instruction**

---

## ğŸ”§ **How to Remediate Failures**

Letâ€™s fix the most common ones youâ€™ll see ğŸ‘‡

### ğŸ©¹ Example 1: Disable AlwaysAllow Authorization (1.2.7)

**File:** `/etc/kubernetes/manifests/kube-apiserver.yaml`

```yaml
- --authorization-mode=Node,RBAC
```

Remove or replace `AlwaysAllow`.

Then reload:

```bash
sudo systemctl restart kubelet
```

Check fix:

```bash
sudo kube-bench run --check 1.2.7
```

âœ… Should now PASS.

---

### ğŸ©¹ Example 2: Disable Anonymous Auth for Kubelet (4.2.6)

**File:** `/var/lib/kubelet/config.yaml`

```yaml
authentication:
  anonymous:
    enabled: false
```

Apply:

```bash
sudo systemctl restart kubelet
```

Recheck:

```bash
sudo kube-bench run --check 4.2.6
```

---

### ğŸ©¹ Example 3: Secure etcd Data Permissions (2.2.1)

**File:** `/etc/kubernetes/pki/etcd/server.key`

```bash
sudo chmod 600 /etc/kubernetes/pki/etcd/server.key
sudo chown etcd:etcd /etc/kubernetes/pki/etcd/server.key
```

Verify:

```bash
sudo kube-bench run --check 2.2.1
```

---

## ğŸ¯ **Checking Only Fixed Controls**

Once youâ€™ve remediated a few items, you donâ€™t need to rerun all 200+ checks.

### âœ… Run a Single Control

```bash
sudo kube-bench run --check 4.2.6
```

### âœ… Run a Section (e.g. Kubelet)

```bash
sudo kube-bench run --section 4
```

### âœ… Run Multiple Controls

```bash
sudo kube-bench run --check 1.2.7,4.2.6
```

Perfect for quick re-validation.

---

## ğŸ§¾ **Advanced Report Options**

<div align="center" style="background:#343739ff; border-radius:20px">

| Option                             | Description                    |
| ---------------------------------- | ------------------------------ |
| `--json`                           | Machine-readable report        |
| `--benchmark cis-1.24`             | Use specific CIS version       |
| `--targets=master,node`            | Manually specify role          |
| `--config-dir=/etc/kube-bench/cfg` | Use custom config folder       |
| `--check <id>`                     | Run single test                |
| `--section <num>`                  | Run only one benchmark section |

</div>

---

## âœğŸ» **Example Workflow (Fix â†’ Verify)**

<div align="center" style="background:#343739ff; border-radius:20px">

| Step | Action                     | Command                                   |
| ---- | -------------------------- | ----------------------------------------- |
| 1ï¸âƒ£   | Run full scan              | `sudo kube-bench run`                     |
| 2ï¸âƒ£   | Note failures              | Identify control IDs (e.g., 1.2.7, 4.2.6) |
| 3ï¸âƒ£   | Apply fix                  | Edit manifest/config                      |
| 4ï¸âƒ£   | Restart service            | `sudo systemctl restart kubelet`          |
| 5ï¸âƒ£   | Re-test only fixed control | `sudo kube-bench run --check 4.2.6`       |
| 6ï¸âƒ£   | Confirm PASS               | âœ… PASS output                            |
| 7ï¸âƒ£   | Document changes           | Save report or audit log                  |

</div>

---

## âœğŸ» **Realistic Example**

### Run:

```bash
sudo kube-bench run --section 1
```

### Output:

```ini
[FAIL] 1.2.7 Ensure that --authorization-mode is not set to AlwaysAllow
Remediation: Edit /etc/kubernetes/manifests/kube-apiserver.yaml
Reason: Found 'AlwaysAllow'
```

### Fix:

```bash
sudo sed -i 's/AlwaysAllow/Node,RBAC/' /etc/kubernetes/manifests/kube-apiserver.yaml
sudo systemctl restart kubelet
```

### Verify Fix:

```bash
sudo kube-bench run --check 1.2.7
```

âœ… Output:

```ini
[PASS] 1.2.7 Ensure that the --authorization-mode argument is not set to AlwaysAllow
```

---

## ğŸ–¼ï¸ **Visual Flow of the Workflow**

<div align="center" style="background:#343739ff; border-radius:20px">

```mermaid
flowchart TD
    A[Run kube-bench] --> B[Identify FAIL checks]
    B --> C[Read remediation instructions]
    C --> D[Edit config files / manifests]
    D --> E[Restart affected components]
    E --> F[Re-run kube-bench --check <id>]
    F --> G[PASS âœ… â†’ Document compliance]
```

</div>

---

## âœ… **Best Practices (CKS & Real World)**

- âœ… Always run as `sudo` (it needs system access).
- âœ… Donâ€™t edit kubelet or API server flags directly â€” use manifests or config files.
- âœ… Document every fix in your GitOps or change management system.
- âœ… Automate regular CIS scans via cron or CI/CD pipeline.
- âœ… For managed clusters (EKS/GKE/AKS), use:

```bash
kubectl run kube-bench --rm -it --image=aquasec/kube-bench:latest --restart=Never
```

---

## ğŸ“š **Quick Command Reference**

<div align="center" style="background:#343739ff; border-radius:20px">

| Task                 | Command                                    |
| -------------------- | ------------------------------------------ |
| Run full scan        | `sudo kube-bench run`                      |
| Run specific section | `sudo kube-bench run --section 1`          |
| Run specific control | `sudo kube-bench run --check 1.2.7`        |
| Run multiple checks  | `sudo kube-bench run --check 1.2.7,4.2.6`  |
| Save as JSON         | `sudo kube-bench run --json > report.json` |
| Re-run after fix     | `sudo kube-bench run --check <id>`         |
| View last 10 fails   | `sudo kube-bench run \| grep FAIL`         |

</div>

---

## ğŸ’ **Summary Table**

<div align="center" style="background:#343739ff; border-radius:20px">

| Phase     | Command Example                            | Output      | Purpose                |
| --------- | ------------------------------------------ | ----------- | ---------------------- |
| ğŸ§ª Scan   | `sudo kube-bench run`                      | Full report | Initial audit          |
| ğŸ“Š Filter | `sudo kube-bench run --check 4.2.6`        | PASS/FAIL   | Targeted recheck       |
| ğŸ”§ Fix    | Edit kubelet config                        | â€”           | Apply remediation      |
| âœ… Verify | `sudo kube-bench run --check 4.2.6`        | PASS        | Confirm compliance     |
| ğŸ“„ Export | `sudo kube-bench run --json > report.json` | JSON        | Reporting & automation |

</div>

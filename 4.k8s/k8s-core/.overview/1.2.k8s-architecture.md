# â˜¸ï¸ **Kubernetes Cluster Architecture**

Kubernetes is built like a **well-organized company**:

1. The **Control Plane** is the _management team_ â€” it makes all decisions, plans schedules, and monitors performance.
2. The **Worker Nodes** are the _employees_ â€” they actually do the work, running your applications inside containers.

Together, they form the **Kubernetes Cluster** â€” a self-healing, distributed system that ensures your apps are _always up and running._

---

## ğŸ¨ **Cluster Overview**

<div align="center" style="background-color:#F5F5F5; border-radius: 10px; border: 2px solid">
  <img src="images/k8s-architecture.drawio-1.png" alt="Kubernetes Cluster Architecture" style="width: 80%; border-radius: 10px" />
  <!-- <img src="images/pods-relations.png" alt="Pods Relations" style="width: 60%; border-radius: 10px" /> -->
</div>

---

## ğŸ§  **Control Plane Components** (The Brains)

These are the **commanders** of Kubernetes â€” they control, coordinate, and maintain the clusterâ€™s desired state.

### ğŸŒ a. **API Server** (`kube-apiserver`)

- Acts as the **front door** to the Kubernetes cluster.
- Every interaction (via `kubectl`, SDK, or UI) goes through the API server.
- It validates requests and updates the cluster state in `etcd`.
- Itâ€™s the **communication hub** for all control plane components.

> ğŸ“ Example:  
> When you run `kubectl apply -f deployment.yaml`, it talks to the **API Server**, which then updates the **etcd** store and instructs other components (like the Scheduler) to act.

---

### ğŸ—„ï¸ b. **etcd**

- A **distributed key-value store** that acts as Kubernetesâ€™ **source of truth**.
- Stores cluster configuration, node states, secrets, and workload definitions.
- If `etcd` is lost, your cluster **forgets everything** â€” so backup is crucial!

> ğŸ“ Example:
>
> ```yaml
> /api/v1/namespaces/default/pods/my-app-pod
> ```
>
> This data â€” including spec, labels, and current status â€” is persisted in `etcd`.

---

### ğŸ§® c. **Scheduler** (`kube-scheduler`)

- Decides **which node** should run each Pod.
- Evaluates resource availability (CPU, memory), taints/tolerations, affinity, and policies.
- Think of it as the **HR manager** assigning tasks to employees.

> ğŸ“ Example:  
> Pod A requests 1 CPU and 2 GB RAM â†’ Scheduler checks available nodes â†’ assigns Pod A to Node 2.

---

### ğŸ§‘â€ğŸ’¼ d. **Controller Manager** (`kube-controller-manager`)

- Runs **controller loops** that continuously ensure the cluster matches the _desired state_.
- Controllers include:

  - **Node Controller:** Detects and replaces failed nodes.
  - **Service Controller:** Creates and maintains services.
  - **StatefulSet Controller:** Ensures desired replicas of stateful sets exist.
  - **Job Controller:** Cleans up pods belonging to completed jobs.
  - **DaemonSet Controller:** Ensures desired replicas of daemon sets exist.
  - **ReplicaSet Controller:** Ensures desired replicas of replica sets exist.
  - **Deployment Controller:** Ensures desired replicas of deployments exist.
  - **Endpoint Controller:** Updates service endpoints when pods change.

> ğŸ“’ Notes:
>
> - They use the **Watch API** to establish long-lived connections with the API server, allowing them to receive real-time updates about changes to resources.
> - Think of controllers as **autopilots** â€” they continuously fix things that drift out of sync.

---

### â˜ï¸ e. **Cloud Controller Manager**

- Integrates Kubernetes with **cloud provider APIs** (AWS, Azure, GCP).
- Manages resources like:

  - Load balancers
  - Persistent volumes
  - Network routes

> ğŸ§  Example: When you define a Service of type `LoadBalancer`, the **Cloud Controller** creates a cloud-native load balancer automatically.

---

## âš™ï¸ **Worker Node Components** (The Muscle)

These are the **machines (VMs or physical servers)** that actually run your application containers.

---

### ğŸ‘· a. **Kubelet**

- The **node agent** â€” it ensures pods assigned to this node are running correctly.
- Talks to the API Server, pulls container images, and reports health.
- Restarts containers if they crash.

> ğŸ’¬ â€œBoss (API Server) told me to run this Pod â€” Iâ€™ll make sure it stays alive.â€

---

### ğŸŒ b. **Kube-proxy**

- Handles **network traffic routing** `to` and `from` pods.
- Implements **Service abstraction** â€” ensuring traffic can reach pods `even if their IPs change`.
- Works at the **network layer (iptables / IPVS)** to balance traffic.

> ğŸ’¡ Example: When you hit a Service endpoint, `kube-proxy` redirects your request to one of the healthy pods.

---

### ğŸ§© c. **Container Runtime**

- Responsible for **running containers** inside pods.
- Supports multiple runtimes:

  - `containerd` (default)
  - `CRI-O`
  - `Docker` (deprecated for direct use)

> ğŸ“¦ It downloads images, creates containers, and manages their lifecycle.

---

### ğŸ§± d. **Pod**

- The **smallest deployable unit** in Kubernetes.
- Wraps one or more containers that share:

  - The same **network namespace**
  - The same **storage volumes**
  - The same **lifecycle**

> ğŸ§© Example:
> A pod running a web app and a sidecar container for logging.
>
> ```yaml
> apiVersion: v1
> kind: Pod
> metadata:
>   name: web-app
> spec:
>   containers:
>     - name: app
>       image: nginx
>     - name: log-agent
>       image: fluentd
> ```
>
> ---

---

## âš’ï¸ **Workload Resources** â€” How You Define Applications

| Resource          | Purpose                                                          |
| ----------------- | ---------------------------------------------------------------- |
| **Deployment**    | Manages ReplicaSets and provides declarative updates to apps.    |
| **ReplicaSet**    | Ensures the correct number of pod replicas.                      |
| **StatefulSet**   | Manages pods that need stable network IDs or persistent storage. |
| **DaemonSet**     | Ensures one pod per node (for logging or monitoring agents).     |
| **Job / CronJob** | Runs batch or scheduled workloads.                               |

> ğŸ“˜ **Example:**
> A Deployment defines _how many replicas_ of your app should exist â€” the Controller ensures thatâ€™s always true.

---

## ğŸŒ **Services & Networking**

| Component            | Function                                               |
| -------------------- | ------------------------------------------------------ |
| **Service**          | Provides stable IP and DNS for accessing pods.         |
| **Ingress**          | Routes external HTTP(S) traffic to internal services.  |
| **Network Policies** | Control which pods can talk to which pods.             |
| **CoreDNS**          | Built-in DNS for service discovery inside the cluster. |

> ğŸ’¡ Think of Services as **phone directories** â€” pods come and go, but the Service name stays the same.

---

## ğŸ«™ **Storage**

| Component                       | Description                                                    |
| ------------------------------- | -------------------------------------------------------------- |
| **PersistentVolume (PV)**       | Physical storage resource in the cluster.                      |
| **PersistentVolumeClaim (PVC)** | Podâ€™s request for storage â€” like an order form for disk space. |

---

## ğŸ” **Configuration**

| Component     | Description                                                       |
| ------------- | ----------------------------------------------------------------- |
| **ConfigMap** | Stores non-sensitive configuration (e.g., environment variables). |
| **Secret**    | Stores sensitive info (passwords, tokens).                        |

---

## ğŸ›¡ï¸ **Security and RBAC**

| Component          | Role                                                           |
| ------------------ | -------------------------------------------------------------- |
| **RBAC**           | Grants fine-grained permissions to users and service accounts. |
| **ServiceAccount** | Provides an identity for pods to interact with the API.        |

> ğŸ§  Example: A Pod can authenticate with the API using its ServiceAccount token â€” no hardcoded passwords needed.

---

## ğŸ“Š **Monitoring & Logging**

- **Metrics Server:** Collects cluster-wide CPU and memory usage for autoscaling.
- **Logging Stack (e.g., EFK/ELK):** Centralized logs from all pods and nodes.

> ğŸ“ˆ Example: Horizontal Pod Autoscaler (HPA) uses data from Metrics Server to add pods automatically when CPU > 80%.

---

## ğŸ§­ **Namespaces**

- Provide **logical isolation** within a single cluster.
- Ideal for separating environments (e.g., `dev`, `staging`, `prod`) or teams.

> ğŸ’¡ Think of Namespaces as **folders** inside your cluster.

---

## ğŸ§° **Helm** â€” The Kubernetes Package Manager

- Simplifies app deployment using **Helm Charts**.
- A single chart can define:

  - Deployment
  - Service
  - ConfigMaps
  - Secrets

- Works like **â€œaptâ€ or â€œyumâ€** but for Kubernetes apps.

> ğŸ§© Example:
> `helm install prometheus prometheus-community/kube-prometheus-stack`

---

## ğŸ§¯ **Cluster Maintenance** & **Troubleshooting**

| Tool               | Purpose                                               |
| ------------------ | ----------------------------------------------------- |
| **kubectl**        | CLI for interacting with the API Server.              |
| **kubeadm**        | Bootstraps a new cluster easily.                      |
| **Logs & Metrics** | Identify failed pods, nodes, or resource bottlenecks. |

> ğŸ’¬ Example:
>
> ```bash
> kubectl get pods -A
> kubectl describe pod myapp
> kubectl logs myapp-1234
> ```

---

## ğŸ–¼ï¸ **Visual Summary**

<div align="center" style="background-color:#fff; border-radius: 10px; border: 2px solid">
  <img src="images/k8s-arch.png" alt="Kubernetes Cluster Architecture" style="width: 80%; border-radius: 10px" />
</div>

---

## ğŸ **In Short**

| Layer             | Function                                |
| ----------------- | --------------------------------------- |
| **Control Plane** | Think â†’ Decides cluster state.          |
| **Worker Nodes**  | Act â†’ Run containers (pods).            |
| **etcd**          | Remember â†’ Stores state permanently.    |
| **Scheduler**     | Assigns â†’ Decides where pods go.        |
| **Controllers**   | Enforce â†’ Keep desired state.           |
| **Kubelet**       | Execute â†’ Runs and monitors containers. |
| **Services**      | Connect â†’ Enable stable networking.     |

---

## ğŸ“š **References**

<https://devopscube.com/kubernetes-architecture-explained/>  
<https://cyclops-ui.com/blog/2023/12/18/k8s-cluster-components/>

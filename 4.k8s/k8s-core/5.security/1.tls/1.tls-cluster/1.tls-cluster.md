 Excellent â€” this is where most CKS candidates start connecting **TLS theory** to **real cluster internals** ğŸ”

Letâ€™s unpack **Type 1: `tls-cluster` (Control Plane TLS)** in full detail â€” including the architecture, certificate files, rotation behavior, verification commands, and best practices for the CKS exam.

---

# ğŸ§© TLS-Cluster (Control Plane TLS) â€” Deep Dive

> **Definition:**
> `tls-cluster` secures **Kubernetes internal component communication** (API Server â†” Controller â†” Scheduler â†” Kubelet â†” etcd).
> It enforces **mutual TLS (mTLS)** to authenticate and encrypt all control-plane traffic.

---

## âš™ï¸ 1. Why Control Plane TLS Exists

Without TLS, the following high-privilege communications would be unprotected:

* Kubelet talking to API server to register nodes
* API server reading/writing etcd secrets
* Controller Manager connecting to API server
* Scheduler binding Pods through the API

TLS ensures:

* **Confidentiality:** traffic between components is encrypted
* **Integrity:** packets canâ€™t be modified in transit
* **Authentication:** only valid components with signed certs can talk to each other

---

## ğŸ—ï¸ 2. TLS Architecture Overview

```mermaid
flowchart TD
    subgraph Control Plane
        A[Kube-API Server] <--mTLS--> B[Controller Manager]
        A <--mTLS--> C[Scheduler]
        A <--mTLS--> D[Kubelet (Control Plane Node)]
        A <--mTLS--> E[etcd]
    end
```

Every arrow here represents a **mutual TLS channel** â€” both sides verify certificates signed by a **shared Cluster CA**.

---

## ğŸ“‚ 3. Certificate Locations (`/etc/kubernetes/pki`)

When the cluster is created using `kubeadm`, these certificates are stored under `/etc/kubernetes/pki/`.

| File                                                | Purpose                                       | Used By                    |
| --------------------------------------------------- | --------------------------------------------- | -------------------------- |
| `ca.crt`, `ca.key`                                  | Cluster CA                                    | Signs all other certs      |
| `apiserver.crt`, `apiserver.key`                    | Secures API server endpoint                   | kube-apiserver             |
| `apiserver-kubelet-client.crt`, `.key`              | Client cert for API server to talk to kubelet | kube-apiserver             |
| `etcd/ca.crt`, `etcd/server.crt`, `etcd/server.key` | etcd server TLS                               | etcd                       |
| `front-proxy-ca.crt`, `front-proxy-client.crt`      | Front-proxy (aggregated APIs)                 | aggregator, metrics server |
| `sa.key`, `sa.pub`                                  | Sign service account tokens                   | controller-manager         |

> ğŸ§  Note: `sa.key` and `sa.pub` are not for TLS encryption but for JWT signing.

---

## ğŸ§° 4. Certificate Creation (kubeadm)

During cluster creation:

```bash
sudo kubeadm init
```

`kubeadm`:

1. Creates a local **Certificate Authority (CA)**
2. Uses that CA to generate:

   * server certificates (for API, etcd)
   * client certificates (for controllers, scheduler, etc.)
3. Stores them in `/etc/kubernetes/pki/`
4. Embeds them into static pod manifests under `/etc/kubernetes/manifests/`

Example manifest snippet:

```yaml
- command:
  - kube-apiserver
  - --tls-cert-file=/etc/kubernetes/pki/apiserver.crt
  - --tls-private-key-file=/etc/kubernetes/pki/apiserver.key
  - --client-ca-file=/etc/kubernetes/pki/ca.crt
```

---

## ğŸ§© 5. Certificate Flow (Mutual TLS Handshake)

1ï¸âƒ£ API Server presents `apiserver.crt`
2ï¸âƒ£ Kubelet verifies it using `ca.crt`
3ï¸âƒ£ Kubelet presents its client certificate (`kubelet-client-current.pem`)
4ï¸âƒ£ API Server verifies it against same CA
â†’ Only if both sides are valid, connection proceeds.

---

## ğŸ” 6. Inspecting Certificates

To verify details:

```bash
sudo openssl x509 -in /etc/kubernetes/pki/apiserver.crt -text -noout
```

Look for:

* `Subject:` CN (component identity)
* `Issuer:` (should match Cluster CA)
* `Not After:` (expiry date)

To verify match:

```bash
openssl verify -CAfile /etc/kubernetes/pki/ca.crt /etc/kubernetes/pki/apiserver.crt
```

---

## ğŸ” 7. Certificate Rotation

Since Kubernetes v1.19+, `kubelet` and `controller-manager` can auto-renew their certificates.

* **Enabled by default:**
  `rotateCertificates: true` in `/var/lib/kubelet/config.yaml`
* **Renew API certificates:**

  ```bash
  sudo kubeadm cert renew all
  ```
* **Check expiration:**

  ```bash
  kubeadm cert check-expiration
  ```

  Example output:

  ```
  CERTIFICATE                EXPIRES                  RESIDUAL TIME
  apiserver.crt              Aug 21, 2025 11:30 UTC   362d
  front-proxy-client.crt     Aug 21, 2025 11:30 UTC   362d
  etcd/server.crt            Aug 21, 2025 11:30 UTC   362d
  ```

---

## ğŸ§ª 8. Testing TLS Connectivity

### Test API server port

```bash
openssl s_client -connect 127.0.0.1:6443 -CAfile /etc/kubernetes/pki/ca.crt
```

Expected:

```
Verify return code: 0 (ok)
```

### Test etcd TLS

```bash
ETCDCTL_API=3 etcdctl --cacert=/etc/kubernetes/pki/etcd/ca.crt \
  --cert=/etc/kubernetes/pki/etcd/server.crt \
  --key=/etc/kubernetes/pki/etcd/server.key \
  endpoint health
```

Output:

```
127.0.0.1:2379 is healthy: successfully committed proposal
```

---

## ğŸ› ï¸ 9. Regenerating or Replacing Certificates

If you lose or corrupt certs:

```bash
sudo kubeadm init phase certs all --cert-dir /etc/kubernetes/pki
```

To renew specific one:

```bash
sudo kubeadm cert renew apiserver
```

Restart affected pods:

```bash
sudo systemctl restart kubelet
```

---

## ğŸ§± 10. Common Exam-Level Issues (CKS)

| Problem                  | Cause                                   | Fix                                                        |
| ------------------------ | --------------------------------------- | ---------------------------------------------------------- |
| âŒ API server wonâ€™t start | Wrong cert path or invalid key          | Check `/etc/kubernetes/manifests/kube-apiserver.yaml`      |
| âš ï¸ Expired certs         | Certificates older than 1 year          | `kubeadm cert renew all`                                   |
| âŒ Node not joining       | Kubelet cert expired or mismatched      | `systemctl restart kubelet` + check `/var/lib/kubelet/pki` |
| âš ï¸ etcd unhealthy        | Missing etcd CA or mismatched peer cert | Verify `etcd/` certificates and owner: `etcd:etcd`         |

---

## ğŸ§  11. Important Files Summary

| Component  | Cert                                              | Key                                          | CA File                           | Notes           |
| ---------- | ------------------------------------------------- | -------------------------------------------- | --------------------------------- | --------------- |
| API Server | `/etc/kubernetes/pki/apiserver.crt`               | `/etc/kubernetes/pki/apiserver.key`          | `/etc/kubernetes/pki/ca.crt`      | For port 6443   |
| Controller | `/etc/kubernetes/pki/controller-manager.crt`      | `/etc/kubernetes/pki/controller-manager.key` | same                              | Client to API   |
| Scheduler  | `/etc/kubernetes/pki/scheduler.crt`               | `/etc/kubernetes/pki/scheduler.key`          | same                              | Client to API   |
| etcd       | `/etc/kubernetes/pki/etcd/server.crt`             | `/etc/kubernetes/pki/etcd/server.key`        | `/etc/kubernetes/pki/etcd/ca.crt` | Internal DB TLS |
| Kubelet    | `/var/lib/kubelet/pki/kubelet-client-current.pem` | same dir                                     | same                              | Auto-rotated    |

---

## ğŸ§© 12. Example Real TLS Chain

```
ca.crt (Cluster CA)
 â”œâ”€â”€ apiserver.crt (Server)
 â”‚   â””â”€â”€ Signed by ca.crt
 â”œâ”€â”€ apiserver-kubelet-client.crt
 â”‚   â””â”€â”€ Signed by ca.crt
 â”œâ”€â”€ etcd/server.crt
 â”‚   â””â”€â”€ Signed by etcd/ca.crt
 â””â”€â”€ front-proxy-client.crt
     â””â”€â”€ Signed by front-proxy-ca.crt
```

---

## âœ… 13. Security Best Practices

âœ” Rotate certificates yearly (or via automation)
âœ” Store `/etc/kubernetes/pki` in restricted permissions (`600`)
âœ” Never share `ca.key` outside control-plane node
âœ” Verify that all API components use `--client-ca-file` flag
âœ” Use `system:node:<nodename>` identity for kubelet authentication
âœ” Use `--anonymous-auth=false` in API server to avoid bypassing mTLS

---

## ğŸ“˜ 14. Quick Verification Checklist

| Check              | Command                                       | Expected                  |
| ------------------ | --------------------------------------------- | ------------------------- |
| List certs         | `ls /etc/kubernetes/pki`                      | CA, API, etcd certs exist |
| Check expiry       | `kubeadm cert check-expiration`               | > 30 days left            |
| Validate cert      | `openssl verify -CAfile ca.crt apiserver.crt` | OK                        |
| Verify API health  | `kubectl get componentstatuses`               | All Healthy               |
| Verify etcd health | `etcdctl endpoint health`                     | Healthy                   |

---

Would you like me to follow up with a **â€œPractical TLS Hardening for Control Plane (CKS Lab)â€** section â€” where we actually edit API server flags (like disabling anonymous-auth, enabling client-ca, enforcing mTLS, etc.) and verify them with `curl --cert` and `openssl`? Thatâ€™s the next step for CKS hands-on readiness.

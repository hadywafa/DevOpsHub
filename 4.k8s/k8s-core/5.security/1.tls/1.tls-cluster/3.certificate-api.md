# üîê **Kubernetes Certificate API**

## üìñ **What Is the Certificate API?**

The **Kubernetes Certificate API** enables secure, automated issuance of **X.509 certificates** using native Kubernetes resources.  
It revolves around the `CertificateSigningRequest` (CSR) object, which allows users, nodes, or workloads to request certificates from the cluster‚Äôs certificate authority (CA).

---

## ‚ÅâÔ∏è **Why Was It Created?**

Before the Certificate API, cert issuance was manual:

- Generate key and CSR
- Send to external CA
- Manually approve and distribute certs

This was error-prone and hard to automate.

The Certificate API solves this by:

- Enabling **declarative cert requests**
- Integrating with **RBAC and approval workflows**
- Supporting **automated rotation** (e.g., kubelet bootstrap)
- Allowing **custom signers** (e.g., cert-manager)

---

## ‚úÖ **Benefits**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Benefit                      | Description                                                         |
| ---------------------------- | ------------------------------------------------------------------- |
| **Native Kubernetes object** | CSR is a first-class resource (`certificates.k8s.io/v1`)            |
| **RBAC-aware**               | CSR creation and approval can be scoped via RBAC                    |
| **Automated workflows**      | Used by kubelet for TLS bootstrap and rotation                      |
| **Customizable**             | Supports multiple signers and usages (`client auth`, `server auth`) |
| **Auditable**                | CSR lifecycle is logged and inspectable                             |

</div>

---

## üß≠ **CSR Approval & Signing**

In Kubernetes, the **`kube-controller-manager`** is responsible for handling **CertificateSigningRequest (CSR)** objects. It includes two built-in controllers:

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Controller      | Role                        | Description                                            |
| --------------- | --------------------------- | ------------------------------------------------------ |
| `CSR-Approving` | Approves CSRs automatically | Based on predefined policies (e.g., kubelet bootstrap) |
| `CSR-Signing`   | Signs approved CSRs         | Uses the cluster‚Äôs CA to issue X.509 certificates      |

</div>

---

> üîÅ These controllers work together: one **approves**, the other **signs** ‚Äî as shown in your diagram.

---

### ‚öôÔ∏è Configuration in `kube-controller-manager`

These controllers are **enabled by default**, but their behavior depends on the flags and CA files passed to the controller manager.

#### ‚úÖ Key Flags in `kube-controller-manager.yaml`

```yaml
--cluster-signing-cert-file=/etc/kubernetes/pki/ca.crt
--cluster-signing-key-file=/etc/kubernetes/pki/ca.key
```

These flags tell the controller manager:

- Where to find the **CA cert and key**
- Which signer to use for issuing certificates

> Without these flags, the `CSR-Signing` controller **cannot function** ‚Äî CSRs will remain in `Approved` state but never get signed.

---

## üß™ Full Example: Create an Admin User via Certificate API

Let‚Äôs create a new user `hady-admin` with full cluster access using a signed certificate.

---

### üîß Step 1: Generate Private Key and CSR

```bash
openssl genrsa -out hady-admin.key 2048

openssl req -new -key hady-admin.key -out hady-admin.csr \
-subj "/CN=hady-admin/O=system:masters"
```

> üîê `CN=hady-admin` is the username  
> üîê `O=system:masters` gives full admin privileges (via RBAC)

---

### üîß Step 2: Base64 Encode the CSR

```bash
cat hady-admin.csr | base64 | tr -d '\n' > hady-admin.csr.base64
```

---

### üîß Step 3: Create CSR Resource

```yaml
# hady-admin-csr.yaml
apiVersion: certificates.k8s.io/v1
kind: CertificateSigningRequest
metadata:
  name: hady-admin-csr
spec:
  groups:
    - system:authenticated
  request: <paste base64 CSR here>
  signerName: kubernetes.io/kube-apiserver-client
  usages:
    - client auth
```

Apply it:

```bash
kubectl apply -f hady-admin-csr.yaml
```

---

### üîß Step 4: Approve the CSR

```bash
kubectl certificate approve hady-admin-csr
```

Check status:

```bash
kubectl get csr hady-admin-csr
```

---

### üîß Step 5: Extract Signed Certificate

```bash
kubectl get csr hady-admin-csr -o jsonpath='{.status.certificate}' | base64 -d > hady-admin.crt
```

Now you have:

- `hady-admin.key` (private key)
- `hady-admin.crt` (signed cert)

---

### üîß Step 6: Create kubeconfig for `hady-admin`

```bash
kubectl config set-credentials hady-admin \
  --client-certificate=hady-admin.crt \
  --client-key=hady-admin.key

kubectl config set-context hady-admin-context \
  --cluster=<your-cluster-name> \
  --user=hady-admin

kubectl config use-context hady-admin-context
```

Test access:

```bash
kubectl get pods --all-namespaces
```

---

## üîê **Security Notes**

- Only users in `system:masters` can bypass RBAC ‚Äî use with caution
- You can restrict cert usage via `usages` field (`client auth`, `server auth`)
- CSR approval can be automated via controllers or manual via `kubectl`

---

## üß† **Summary**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Step | Action               | Tool Used             |
| ---- | -------------------- | --------------------- |
| 1    | Generate key and CSR | `openssl`             |
| 2    | Encode CSR           | `base64`              |
| 3    | Create CSR resource  | `kubectl apply`       |
| 4    | Approve CSR          | `kubectl certificate` |
| 5    | Extract signed cert  | `kubectl get csr`     |
| 6    | Create kubeconfig    | `kubectl config`      |

</div>

---

## üß† TL;DR

- The **Controller Manager** handles CSR **approval and signing**
- It must be configured with the **cluster CA cert and key**
- It runs two controllers: `CSR-Approving` and `CSR-Signing`
- You can inspect and customize its behavior via the static Pod manifest:

  ```bash
  cat /etc/kubernetes/manifests/kube-controller-manager.yaml
  ```

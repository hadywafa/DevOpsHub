# ğŸ¤– **Service Accounts in Kubernetes (Deep Dive for Admins)**

> _â€œHow Pods, Jobs, and external CI/CD tools actually authenticate to the Kubernetes API â€” and how Kubernetes automates that behind the scenes.â€_

---

## ğŸ“– **What Is a Service Account?**

A **ServiceAccount (SA)** is a **non-human identity** used by:

- Pods and controllers **inside the cluster**, and
- external automation tools **outside the cluster** (like Jenkins, GitHub Actions, or ArgoCD)

Itâ€™s how â€œmachinesâ€ (not people) prove who they are to the Kubernetes API.

Each SA provides:

- A **name** (identity)
- An automatically managed **JWT token**
- An associated **CA certificate**
- (Optionally) **RBAC permissions**

---

## ğŸ­ **Two Main Use Cases of ServiceAccounts**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Usage Type                     | Description                                                                       | Typical Identity                                          | Token Handling                                                               | Example Use Case                                                                  |
| ------------------------------ | --------------------------------------------------------------------------------- | --------------------------------------------------------- | ---------------------------------------------------------------------------- | --------------------------------------------------------------------------------- |
| ğŸ§© **Internal ServiceAccount** | Used **inside the cluster** â€” assigned to Pods, Deployments, Jobs, or DaemonSets. | `system:serviceaccount:<namespace>:<serviceaccount-name>` | Token auto-mounted at `/var/run/secrets/kubernetes.io/serviceaccount/token`  | A backend Pod calling the Kubernetes API to read ConfigMaps or scale Deployments. |
| ğŸŒ **External ServiceAccount** | Used **outside the cluster** â€” for CI/CD tools or scripts needing API access.     | `system:serviceaccount:<namespace>:<serviceaccount-name>` | Token manually created via `kubectl create token` and embedded in kubeconfig | GitHub Actions or Terraform deploying manifests to the cluster.                   |

</div>

---

### âš™ï¸ **1. Internal Flow (In-Cluster Pods)**

#### ğŸ”§ How It Works

- Pod is assigned a ServiceAccount (default or custom)
- Kubernetes auto-mounts a short-lived token and CA cert
- inside your pod SDKs like `client-go` use the token to authenticate to the API
- RBAC rules tied to the SA control access

#### ğŸ“¦ Example

```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: config-reader
  namespace: dev
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: configmap-reader
  namespace: dev
rules:
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: bind-config-reader
  namespace: dev
subjects:
  - kind: ServiceAccount
    name: config-reader
    namespace: dev
roleRef:
  kind: Role
  name: configmap-reader
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: v1
kind: Pod
metadata:
  name: configmap-client
  namespace: dev
spec:
  serviceAccountName: config-reader
  containers:
    - name: busybox
      image: busybox
      command: ["sh", "-c", "sleep 3600"]
```

> âœ… No need to manually create a token â€” Kubernetes handles it.

---

### ğŸŒ **2. External Flow (Outside-Cluster Tools)**

#### ğŸ”§ How It Works

- Create a ServiceAccount and bind it to a Role or ClusterRole
- Manually generate a token using `kubectl create token`
- Embed the token in a kubeconfig
- Use it in CI/CD pipelines or scripts

#### ğŸ¤– Example

```bash
# Create the ServiceAccount
kubectl create serviceaccount deployer --namespace dev

# Bind it to cluster-admin (or scoped Role)
kubectl create clusterrolebinding deployer-admin \
  --clusterrole=cluster-admin \
  --serviceaccount=dev:deployer

# Generate a token (valid for 24h)
kubectl create token deployer --namespace dev --duration=24h
```

#### ğŸ§¾ Kubeconfig Template

```yaml
apiVersion: v1
kind: Config
clusters:
  - name: my-cluster
    cluster:
      server: https://<api-server>
      certificate-authority-data: <base64-ca.crt>
users:
  - name: deployer
    user:
      token: <paste-token-here>
contexts:
  - name: deployer-context
    context:
      cluster: my-cluster
      user: deployer
      namespace: dev
current-context: deployer-context
```

> âœ… This kubeconfig can be used by GitHub Actions, Jenkins, Terraform, or CLI scripts.

---

## ğŸ›¡ï¸ **ServiceAccount Permissions (RBAC Connection)**

A ServiceAccount alone has **no permissions** by default.  
You must bind it to a **Role** or **ClusterRole** using **RoleBinding**.

### Example: Allow this SA to list Pods

```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: reader
  namespace: dev
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: pod-reader
  namespace: dev
rules:
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: read-pods
  namespace: dev
subjects:
  - kind: ServiceAccount
    name: reader
    namespace: dev
roleRef:
  kind: Role
  name: pod-reader
  apiGroup: rbac.authorization.k8s.io
```

âœ… The `reader` SA can now `get` and `list` Pods in namespace `dev`.

---

## â‰ï¸ **How Kubernetes Validates the Token Internally**

1. Client (Pod or CI/CD) sends HTTPS request with:

   ```ini
   Authorization: Bearer eyJhbGciOi...
   ```

2. API server verifies:

   - Token signature matches clusterâ€™s ServiceAccount signing key.
   - Token audience matches.
   - Token hasnâ€™t expired.

3. Identity extracted:

   ```ini
   system:serviceaccount:<namespace>:<serviceaccount-name>
   ```

4. RBAC rules applied â†’ allow or deny.

---

## ğŸ§° **Commands You Should Know**

| Command                                                               | Description                       |
| --------------------------------------------------------------------- | --------------------------------- |
| `kubectl get sa -A`                                                   | List all ServiceAccounts          |
| `kubectl describe sa <name>`                                          | Show token Secret and annotations |
| `kubectl create serviceaccount <name>`                                | Create new SA                     |
| `kubectl delete sa <name>`                                            | Delete                            |
| `kubectl create token <name>`                                         | Generate JWT for external usage   |
| `kubectl auth can-i --as system:serviceaccount:<ns>:<name> list pods` | Simulate access                   |

---

## âœ… **Best Practices for Admins**

- âœ… Create **dedicated SAs** per app â€” never reuse â€œdefaultâ€
- âœ… Use **namespaces** to scope access
- âœ… Rotate external tokens regularly
- âœ… Prefer **short-lived bound tokens** over static ones
- âœ… Never store tokens in code or git
- âœ… Combine with **RBAC** for least privilege
- âœ… Disable automatic mounting for Pods that donâ€™t need it:

```yaml
automountServiceAccountToken: false
```

---

## ğŸ **Summary**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Concept              | Description                                           |
| -------------------- | ----------------------------------------------------- |
| **Internal SAs**     | Used automatically by Pods                            |
| **External SAs**     | Used by CI/CD and automation                          |
| **Token Mount Path** | `/var/run/secrets/kubernetes.io/serviceaccount/token` |
| **Modern Tokens**    | Bound, short-lived, auto-rotated                      |
| **RBAC Integration** | Defines what SAs can do                               |
| **External Access**  | Use `kubectl create token` + kubeconfig               |
| **Security Tip**     | Disable `automountServiceAccountToken` if not needed  |

</div>

---

<div align="center" style="background-color:#121F2E; border-radius: 10px; border: 2px solid">
  <img src="image/1761670148862.png" alt="Ingress and Egress Traffic" style="width: 60%">
</div>

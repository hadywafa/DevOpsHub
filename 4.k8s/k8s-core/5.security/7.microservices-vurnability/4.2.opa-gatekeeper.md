# ğŸ‘®ğŸ» OPA Gatekeeper: The Complete, Hands-On Guide

_The Kubernetes-native way to enforce OPA policies using CRDs._

---

## ğŸ“– **What is OPA Gatekeeper?**

**Gatekeeper** is a Kubernetes-native admission controller based on **OPA + Rego**, designed specifically for Kubernetes policy enforcement.

OPA alone = a generic policy engine
Gatekeeper = **OPA + Kubernetes glue**, making policy-as-code truly Kubernetes-native.

Gatekeeper adds:

- Custom Resource Definitions (CRDs)
- Kubernetes-style configuration (YAML-first)
- Audit functionality
- Mutation support
- Enforcement modes
- Better observability
- Constraint libraries
- The ability to scope and reuse policies

Think of Gatekeeper as:

ğŸ‘‰ _â€œOPA, but built FOR Kubernetes.â€_

---

<div align="center" style="background-color:#F1F1F1; border-radius: 10px; border: 2px solid">
  <img src="image/1763401397088.png" alt="OpenSSL" style="width: 80%">
</div>

## â“ **Why Gatekeeper Instead of Plain OPA?**

### ğŸ”¥ OPA alone as an admission webhook is powerfulâ€¦ but painful:

- âŒ You must write your own webhook server
- âŒ You must manage certificates
- âŒ You must handle admission reviews manually
- âŒ You must bundle policies as ConfigMaps
- âŒ Hard to test
- âŒ Hard to manage at scale

Gatekeeper solves all this.

---

## ğŸŒŸ What Gatekeeper Provides (Beyond OPA)

| Feature                      | OPA         | Gatekeeper     |
| ---------------------------- | ----------- | -------------- |
| Rego policy language         | âœ”ï¸          | âœ”ï¸             |
| Admission control            | âœ”ï¸ (manual) | âœ”ï¸ (automatic) |
| Kubernetes CRDs for policies | âŒ          | âœ”ï¸             |
| ConstraintTemplates          | âŒ          | âœ”ï¸             |
| Constraints                  | âŒ          | âœ”ï¸             |
| Audit capability             | âŒ          | âœ”ï¸             |
| Mutation                     | âŒ          | âœ”ï¸             |
| Kubernetes-native mgmt       | âŒ          | âœ”ï¸             |
| Community policy library     | âŒ          | âœ”ï¸ Tons        |

Gatekeeper turns policy management into **declarative Kubernetes objects**.

---

## ğŸ”¬ **Gatekeeper Core Concepts** (The Heart of It)

Gatekeeper uses two CRDs:

---

### 1. ğŸ”§ **ConstraintTemplate**

Defines:

- A reusable **Rego policy**
- Input schema
- Parameters the user can configure

It is like a **class**.

---

### 2. ğŸ”’ **Constraint**

Defines:

- The actual instance of the policy
- Which resources it applies to
- Parameter values

It is like an **object of the class**.

---

## ğŸ—ï¸ **Architecture of Gatekeeper** (Visual)

<div align="center" style="background-color:#F1F1F1; border-radius: 10px; border: 2px solid">
  <img src="image/1763401734911.png" alt="OpenSSL" style="width: 80%">
</div>

---

<div align="center" style="background-color:#F1F1F1; border-radius: 10px; border: 2px solid">
  <img src="image/1763401771152.png" alt="OpenSSL" style="width: 80%">
</div>

---

<div align="center" style="background-color:#F1F1F1; border-radius: 10px; border: 2px solid">
  <img src="image/1763401796083.png" alt="OpenSSL" style="width: 80%">
</div>

---

<div align="center" style="background-color:#F1F1F1; border-radius: 10px; border: 2px solid">
  <img src="image/1763401988107.png" alt="OpenSSL" style="width: 80%">
</div>

---

## ğŸ“¦ **Install with kubectl**

```bash
kubectl apply -f https://raw.githubusercontent.com/open-policy-agent/gatekeeper/master/deploy/gatekeeper.yaml
```

Verify installation:

```bash
kubectl get pods -n gatekeeper-system
```

Expected:

- gatekeeper-controller-manager
- gatekeeper-audit
- gatekeeper-webhook

---

## ğŸ“ **Example 1 - â€œDeny Pods Using hostPathâ€**

Let's create:

1. **ConstraintTemplate** â†’ defines the Rego policy
2. **Constraint** â†’ applies the rule to Pods

---

### ğŸ”¹ 1. ConstraintTemplate: `k8sdenyhostpath.yaml`

```yaml
apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: k8sdenyhostpath # ğŸ‘ˆ Your custom name
spec:
  crd:
    spec:
      names:
        kind: K8sDenyHostPath # ğŸ‘ˆ Your custom kind (used in Constraint)
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8sdenyhostpath   # ğŸ‘ˆ Your custom Rego package name

        violation[{"msg": msg}] {
          input.review.kind.kind == "Pod"
          container := input.review.object.spec.containers[_]
          volume := input.review.object.spec.volumes[_]
          volume.hostPath
          msg := sprintf("hostPath volumes are forbidden: %v", [volume.hostPath.path])
        }
```

Apply:

```bash
kubectl apply -f k8sdenyhostpath.yaml
```

---

### ğŸ”¹ 2. Constraint: `deny-hostpath.yaml`

```yaml
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sDenyHostPath # ğŸ‘ˆ Must match the kind from the Template
metadata:
  name: deny-host-path
spec:
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]
```

Apply:

```bash
kubectl apply -f deny-hostpath.yaml
```

---

### ğŸ”¹ 3. Try to Create a Pod With hostPath

#### bad-pod.yaml

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: bad-pod
spec:
  containers:
    - name: busybox
      image: busybox
      command: ["sleep", "3600"]
  volumes:
    - name: host-data
      hostPath:
        path: /etc
```

Apply:

```bash
kubectl apply -f bad-pod.yaml
```

Output:

```ini
Error: admission webhook "validation.gatekeeper.sh" denied the request:

hostPath volumes are forbidden: /etc
```

ğŸ”¥ **Gatekeeper blocked it!**

---

## ğŸ“ **Example 2 â€” Do Not Allow `:latest` Tag Images**

This is one of the most common compliance rules.

---

### ğŸ”¹ 1. ConstraintTemplate

```yaml
apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: k8sdenylatesttag # ğŸ‘ˆ Your custom name
spec:
  crd:
    spec:
      names:
        kind: K8sDenyLatestTag # ğŸ‘ˆ Your custom kind (used in Constraint)
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8sdenylatesttag    # ğŸ‘ˆ Your custom Rego package name

        violation[{"msg": msg}] {
          container := input.review.object.spec.containers[_]
          endswith(container.image, ":latest")
          msg := sprintf("Image %v uses 'latest' tag, which is not allowed.", [container.image])
        }
```

---

### ğŸ”¹ 2. Constraint

```yaml
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sDenyLatestTag # ğŸ‘ˆ Must match the kind from the Template
metadata:
  name: no-latest-tag
spec:
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]
```

---

### ğŸ”¹ 3. Try Deploying a Pod With `:latest`

```bash
kubectl apply -f - <<EOF
apiVersion: v1
kind: Pod
metadata:
  name: latest-pod
spec:
  containers:
  - name: nginx
    image: nginx:latest
EOF
```

Result:

```ini
Error: Image nginx:latest uses 'latest' tag, which is not allowed.
```

---

## ğŸ“ƒ **Gatekeeper Audit Mode**

Audit runs periodically and checks **existing** resources, not just new ones.

View audit violations:

```bash
kubectl get k8sdenyhostpath.constraints.gatekeeper.sh deny-host-path -o yaml
```

You will see a list under:

```yaml
status:
  violations:
```

This helps enforce policies retroactively.

---

## ğŸ“ **Gatekeeper Mutation** (Optional Feature)

Gatekeeper can **modify resources** before they are accepted.

Example uses:

- Add labels
- Add seccompProfile
- Force `runAsNonRoot=true`
- Insert default annotations

Mutation is done using:

- `Assign` (basic mutation)
- `AssignMetadata`

Example: Force all namespaces to have a label:

```yaml
apiVersion: mutations.gatekeeper.sh/v1beta1
kind: AssignMetadata
metadata:
  name: add-team-label
spec:
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Namespace"]
  location: "metadata.labels.team"
  value: "devops"
```

---

## ğŸ”© `Gatekeeper` vs `PSA` vs `Kyverno`

| Feature           | Gatekeeper                 | PSA                   | Kyverno               |
| ----------------- | -------------------------- | --------------------- | --------------------- |
| Built-in?         | No                         | Yes                   | No                    |
| Language          | Rego                       | No language           | YAML-based            |
| Mutation          | âœ”ï¸                         | âŒ                    | âœ”ï¸ Strong             |
| Audit             | âœ”ï¸                         | âœ”ï¸                    | âœ”ï¸                    |
| CRDs for policies | âœ”ï¸                         | âŒ                    | âœ”ï¸                    |
| Best for          | Large orgs, Rego expertise | Baseline pod security | Simpler YAML policies |

---

## ğŸ“¦ **Directory Structure for Gatekeeper Policies**

A clean layout:

```ini
gatekeeper/
  templates/
    k8sdenylatesttag.yaml
    k8sdenyhostpath.yaml
  constraints/
    no-latest-tag.yaml
    deny-host-path.yaml
  samples/
    bad-pod.yaml
```

---

## ğŸ **Final Summary**

- **Gatekeeper = OPA + Kubernetes CRDs**
- Policies written as **ConstraintTemplates**
- Rules applied via **Constraints**
- Gatekeeper acts as **validating webhook**
- Audit tracks existing violations
- Mutation modifies resources before saving
- Ideal for **enterprise Kubernetes governance**

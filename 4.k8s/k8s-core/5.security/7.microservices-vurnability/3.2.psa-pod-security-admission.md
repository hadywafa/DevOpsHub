# ğŸ” **Pod Security Admission (PSA)**

_The modern, built-in way to enforce pod security in Kubernetes._

---

## ğŸŒŸ **What is Pod Security Admission (PSA)?**

PSA is a **built-in Kubernetes Admission Controller** that evaluates every Pod creation/update request and checks whether it meets the **Pod Security Standards (PSS)**:

- ğŸ”¥ **Privileged** (least secure)
- âš–ï¸ **Baseline** (default)
- ğŸ”’ **Restricted** (most secure)

ğŸ’¡ PSA **does not require any external tools or webhooks**.
It works **entirely through namespace labels**.

Think of PSA as a **bouncer at a club**:

<div align="center" style="background-color: #1a2325ff; border-radius: 10px; border: 2px solid">

| Mode        | Behavior                          | Analogy                                            |
| ----------- | --------------------------------- | -------------------------------------------------- |
| **Enforce** | Blocks Pods that violate PSS      | â€œYouâ€™re not allowed in.â€ ğŸš«                        |
| **Warn**    | Lets Pod run but prints a warning | â€œIâ€™ll allow it, but donâ€™t do that again.â€ âš ï¸       |
| **Audit**   | Logs violation in audit logs      | â€œI wonâ€™t tell you, but Iâ€™ll tell your manager.â€ ğŸ“ |

</div>

---

<div align="center" style="background-color:#F1F1F1; border-radius: 10px; border: 2px solid">
  <img src="image/1763375379359.png" alt="OpenSSL" style="width: 60%">
</div>

---

<div align="center" style="background-color:#F1F1F1; border-radius: 10px; border: 2px solid">
  <img src="image/1763375293256.png" alt="OpenSSL" style="width: 60%">
</div>

---

## âš™ï¸ 2. How PSA Works Internally

Hereâ€™s how Kubernetes decides whether to accept your Pod:

<div align="center" style="background-color: #1a2325ff; border-radius: 10px; border: 2px solid">

```mermaid
sequenceDiagram
    participant User
    participant APIServer
    participant PSA
    participant etcd

    User->>APIServer: kubectl apply -f pod.yaml
    APIServer->>PSA: Validate pod spec
    PSA->>PSA: Compare namespace labels + PSS rules
    PSA-->>APIServer: Allow/Reject + Warnings
    APIServer->>etcd: Save object (if allowed)
    APIServer-->>User: "Applied" or "Rejected"
```

</div>

---

## âœğŸ» **Hands-on: Real Practical Examples**

Below is a **step-by-step guide you can try on any real cluster** (Minikube, Kind, AKS, EKS, GKE).

---

## ğŸ”¹ Step 1 â€” Create a New Namespace

```bash
kubectl create namespace demo-psa
```

Check:

```bash
kubectl get ns demo-psa --show-labels
```

You will see no PSA labels yet.

---

## ğŸ”¹ Step 2 â€” Apply Restricted Policy (Enforce Mode)

```bash
kubectl label namespace demo-psa \
  pod-security.kubernetes.io/enforce=restricted
```

Verify:

```bash
kubectl get ns demo-psa --show-labels
```

Output should include:

```ini
pod-security.kubernetes.io/enforce=restricted
```

---

## ğŸ”¹ Step 3 â€” Try to Create an Insecure Pod (It Will Fail!)

> âŒ This Pod violates Restricted PSS because it runs as root.

### insecure-pod.yaml

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: insecure
  namespace: demo-psa
spec:
  containers:
    - name: app
      image: nginx
      securityContext:
        runAsUser: 0
```

Apply:

```bash
kubectl apply -f insecure-pod.yaml
```

ğŸ”¥ **PSA will reject it**:

```ini
Error: pods "insecure" is forbidden:
violates PodSecurity "restricted": runAsUser=0 (must be non-root)
```

> ğŸ§  PSA just saved you.

---

## ğŸ”¹ Step 4 â€” Create a Pod That Complies With Restricted PSS

### secure-pod.yaml

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: secure
  namespace: demo-psa
spec:
  securityContext:
    seccompProfile:
      type: RuntimeDefault
  containers:
    - name: app
      image: nginx
      securityContext:
        runAsNonRoot: true
        allowPrivilegeEscalation: false
        readOnlyRootFilesystem: true
```

Apply:

```bash
kubectl apply -f secure-pod.yaml
```

Success! ğŸ‰

```bash
kubectl get pods -n demo-psa
```

---

## ğŸ”¹ Step 5 â€” Adding Warn Mode

Letâ€™s now add warnings instead of strict rejection.

```bash
kubectl label namespace demo-psa \
  pod-security.kubernetes.io/warn=baseline --overwrite
```

Now try the insecure Pod again:

```bash
kubectl apply -f insecure-pod.yaml
```

You will see:

```ini
Warning: violates PodSecurity "baseline": host namespaces are not allowed
```

But the Pod will **still run** âœ”ï¸

---

## ğŸ”¹ Step 6 â€” Adding Audit Mode

Audit mode writes logs in the audit system of your cluster.

```bash
kubectl label namespace demo-psa \
  pod-security.kubernetes.io/audit=privileged --overwrite
```

Try again:

```bash
kubectl apply -f insecure-pod.yaml
```

The Pod runs, but audit logs will contain entries like:

```ini
audit.k8s.io: violation: privileged rule violated by Pod insecure
```

---

## ğŸ”¹ Step 7 â€” Exemptions

You can bypass PSA for:

- Users
- Namespaces
- Runtime classes

Example: Exempt `system:serviceaccount:my-team:ci-bot`

### kube-apiserver flags:

```ini
--admission-control-config-file=/etc/kubernetes/psa-config.yaml
```

### psa-config.yaml

```yaml
apiVersion: apiserver.config.k8s.io/v1
kind: AdmissionConfiguration
plugins:
  - name: PodSecurity
    configuration:
      apiVersion: pod-security.admission.config.k8s.io/v1
      exemptions:
        usernames:
          - system:serviceaccount:my-team:ci-bot
        namespaces:
          - kube-system
        runtimeClassNames:
          - my-custom-runtime
```

This bot/user/runtime can bypass PSA checks.

---

## ğŸ”¹ Step 8 â€” PSA in Real Projects

Below are **real-world practical examples**.

---

### ğŸ“ Example 1 â€” Lock Down Production Namespace

```bash
kubectl label ns prod \
  pod-security.kubernetes.io/enforce=restricted \
  pod-security.kubernetes.io/warn=baseline \
  pod-security.kubernetes.io/audit=privileged
```

Meaning:

| Mode    | Policy     | Effect                      |
| ------- | ---------- | --------------------------- |
| Enforce | restricted | Block insecure Pods         |
| Warn    | baseline   | Warn developers             |
| Audit   | privileged | Track deeply insecure specs |

---

### ğŸ“ Example 2 â€” Open Namespace for Dev

```bash
kubectl label ns dev \
  pod-security.kubernetes.io/enforce=baseline
```

Developers can deploy almost anything except privileged containers.

---

### ğŸ“ Example 3 â€” System Namespace

```bash
kubectl label ns kube-system \
  pod-security.kubernetes.io/enforce=privileged
```

Allows CNIs, CSIs, kube-proxies.

---

## ğŸ‘¨â€ğŸ’» **PSA Debugging Tips**

### ğŸ” **See PSA Evaluation Results**

```bash
kubectl apply -f pod.yaml --dry-run=server
```

This will display warnings but not create the Pod.

---

### ğŸ” **Check PSA Labels on Namespace**

```bash
kubectl get ns <name> --show-labels
```

---

### ğŸ” **Show Why a Pod Was Rejected**

`kubectl describe pod <name>`

Youâ€™ll find:

```ini
Error from admission controller 'PodSecurity': ...
```

---

### ğŸ” **Check Audit Logs (EKS/GKE/AKS)**

Look in:

```ini
/var/log/kubernetes/audit.log
```

Or cloud provider Logs Explorer.

---

## ğŸ‰ **Final PSA Cheat Sheet**

<div align="center" style="background-color: #1a2325ff; border-radius: 10px; border: 2px solid">

| ITEM       | DEFINITION                                     |
| ---------- | ---------------------------------------------- |
| PSA        | Built-in admission controller for pod security |
| PSS        | Standards (Privileged, Baseline, Restricted)   |
| Labels     | How you configure PSA                          |
| Modes      | Enforce, Warn, Audit                           |
| Exemptions | Allow bypassing PSA                            |

</div>

---

## ğŸ Want More Hands-On?

I can also generate:

- âœ… A **full PSA lab** using Kind
- âœ… A **PSA migration plan** (PSP â†’ PSA)
- âœ… A **GitHub-ready PSA demo folder**
- âœ… PSA + Kyverno hybrid architecture

Just tell me what you'd like next!

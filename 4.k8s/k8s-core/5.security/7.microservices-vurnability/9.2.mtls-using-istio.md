# ‚õµ **Istio**

## üìñ What Is Istio? (Beginner-Friendly Overview)

Istio is a **service mesh**‚Äîa networking layer you add to your Kubernetes cluster to provide:

- ‚úî **Zero-trust security** ‚Üí mTLS (Pod-to-Pod encryption)
- ‚úî **Traffic management** ‚Üí routing, canaries, A/B tests
- ‚úî **Observability** ‚Üí metrics, logs, traces
- ‚úî **Policy enforcement** ‚Üí rate limits, quotas, access policies

Think of it as:

> **‚ÄúSidecar proxies injected next to every pod, controlling and securing all communication automatically.‚Äù**

## üß© Istio Components (Simple)

| Component                        | What it does                                                               |
| -------------------------------- | -------------------------------------------------------------------------- |
| **Envoy sidecar**                | Proxy inside every pod; handles traffic, encryption, policies              |
| **Istiod (control plane)**       | Sends configuration to all Envoy sidecars (policies, certificates, routes) |
| **Citadel (now part of istiod)** | Issues certificates to pods for mTLS                                       |
| **Data Plane**                   | All Envoy proxies in pods                                                  |
| **Control Plane**                | Istiod, config, policy, certificate management                             |

## ‚≠ê Why Istio Is Needed?

Without a service mesh:

- Pod A ‚Üí Pod B traffic is **plain text**
- No authentication between pods
- No encryption, no authorization
- Hard to see traffic flow
- Hard to implement canary deployments

With Istio:

- Pods authenticate using **certificates**
- All traffic is encrypted **by default** (mTLS)
- You get metrics for free (Prometheus, Grafana)
- You can route traffic based on rules (versions, headers)
- Security policies are uniform across the cluster

---

## üîê **Pod-to-Pod Encryption in Istio (mTLS)**

Istio implements **P2P encryption using mTLS (mutual TLS)**.

This means:

- ‚úî Pod A has a certificate
- ‚úî Pod B has a certificate
- ‚úî They verify each other
- ‚úî They encrypt all traffic using TLS

You don't modify application code.
Envoy proxies do everything automatically.

---

## üî¨ How mTLS Works in Istio (Detailed but Simple)

### Step 1 ‚Äî Sidecar Injection

Istio injects an **Envoy sidecar** into each pod:

```ini
[App Container] + [Envoy Sidecar]
```

All communication passes through Envoy.

Use automatic injection:

```bash
kubectl label namespace default istio-injection=enabled
```

---

### Step 2 ‚Äî Istiod issues certificates (SPIFFE IDs)

Each pod gets:

- A private key
- A certificate
- A SPIFFE identity: `spiffe://cluster.local/ns/default/sa/default`

Certificates are rotated automatically every 24 hours.

---

### Step 3 ‚Äî Sidecars negotiate mTLS

When Pod A connects to Pod B:

```ini
App A ‚Üí Envoy A ‚Üí mTLS ‚Üí Envoy B ‚Üí App B
```

1. **Envoy A** starts TLS handshake
2. **Envoy B** responds
3. They authenticate each other using certificates
4. A secure channel is created
5. Data flows encrypted

Your app does nothing‚ÄîEnvoy handles all encryption.

---

## üõ°Ô∏è Enabling mTLS in Istio (Full Implementation)

Istio can run in three modes:

| Mode           | Meaning                      |
| -------------- | ---------------------------- |
| **DISABLE**    | No TLS                       |
| **PERMISSIVE** | Accept both plaintext & mTLS |
| **STRICT**     | mTLS only (recommended)      |

### Step 1 ‚Äî Ensure by default namespace is using Istio

```bash
kubectl label namespace default istio-injection=enabled
```

---

### Step 2 ‚Äî Apply PeerAuthentication for STRICT mode

```yaml
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: default
spec:
  mtls:
    mode: STRICT
```

This forces mTLS for all pods in the namespace.

---

### Step 3 ‚Äî Apply DestinationRule (optional but recommended)

```yaml
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: default
  namespace: default
spec:
  host: "*.default.svc.cluster.local"
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
```

This ensures Envoy config is aligned with mTLS mode.

---

## üìä Verifying mTLS

Check if mTLS is enabled:

```bash
istioctl authn tls-check <source-pod> <destination-service>
```

Example:

```bash
istioctl authn tls-check ratings-v1 ratings.default.svc.cluster.local
```

Expected:

```ini
MODE: mTLS (STRICT)
```

Or check SNI traffic inside Envoy:

```bash
istioctl proxy-config clusters <pod-name>
```

You should see:

```ini
tls_context:
  common_tls_context:
```

This means mTLS is working.

---

## üîç Visual Diagram: Istio mTLS

```ini
+----------------------+          +----------------------+
|        Pod A         |          |        Pod B         |
|   [App A] [Envoy A]  | mTLS --> |   [App B] [Envoy B]  |
+----------------------+          +----------------------+
              ^                             ^
              |                             |
            Cert A                        Cert B
     (spiffe://cluster.local)      (spiffe://cluster.local)

Traffic is encrypted IN TRANSIT.
```

---

## üß™ Quick Hands-On Example (Works on Minikube or Kind)

### Deploy sample app

```bash
kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml
```

### Inject sidecars manually

```bash
kubectl get deploy -o yaml | istioctl kube-inject -f - | kubectl apply -f -
```

### Enable mTLS

```bash
kubectl apply -f samples/bookinfo/networking/destination-rule-all-mtls.yaml
```

### Test traffic

```bash
kubectl exec -it <pod> -c istio-proxy -- curl http://<service>
```

Traffic is encrypted automatically.

---

## üèÅ Summary (Super Simple)

| Topic                             | Explanation                                                    |
| --------------------------------- | -------------------------------------------------------------- |
| **What is Istio?**                | A service mesh that secures, manages, and observes pod traffic |
| **How does P2P encryption work?** | Envoy sidecars create mTLS tunnels between pods                |
| **Does app code change?**         | No‚Äîeverything is transparent                                   |
| **Who gives certificates?**       | Istiod (formerly Citadel)                                      |
| **How to enable mTLS?**           | Use PeerAuthentication + DestinationRule                       |
| **Where does encryption happen?** | Between Envoy proxies, not inside app containers               |

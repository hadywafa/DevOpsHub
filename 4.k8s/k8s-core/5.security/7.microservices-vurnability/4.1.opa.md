# ğŸ‚ **OPA (Open Policy Agent)**

## ğŸ“– **What is OPA?**

**Open Policy Agent (OPA)** is a **general-purpose policy engine**.
You give it:

- **Data** (input/context)
- **Policies** (written in a language called **Rego**)

â€¦and it returns **decisions** like:

- `allow = true/false`
- `allowed_roles = ["admin", "auditor"]`
- `patch = { ... }` (for mutations)

OPA doesnâ€™t enforce anything by itself. It just **answers questions** like:

> â€œGiven this request and these rules, should this be allowed?â€

It can be embedded in:

- Microservices
- CLIs
- API gateways
- Kubernetes (via Gatekeeper / admission webhooks)
- CI/CD pipelines
- Any system that needs policy decisions.

---

## â“ **Why OPA? (Why not just `if` statements?)**

You _could_ hardcode logic like:

```go
if user.Role == "admin" && resource.Owner == user.ID {
    // allow
}
```

But this becomes a nightmare when:

- Policies change frequently
- Security/compliance want to manage rules
- You have many microservices/languages

OPA solves this by:

- Separating **policy** from **application code**
- Centralizing or standardizing policies
- Letting you test policies like code (unit tests)
- Using a **declarative language (Rego)**

Think of OPA as **â€œRBAC, ABAC, and all your security/business rules as codeâ€**.

Typical use cases:

- API authorization
- Kubernetes pod admission security
- Terraform plan validation
- CI/CD checks (e.g., â€œno image from `:latest` tagâ€)
- Data filtering (who can see what rows/fields)

---

### Without OPA

<div align="center" style="background-color:#F1F1F1; border-radius: 10px; border: 2px solid">
  <img src="image/1763381843232.png" alt="OpenSSL" style="width: 80%">
</div>

---

<div align="center" style="background-color:#F1F1F1; border-radius: 10px; border: 2px solid">
  <img src="image/1763381873167.png" alt="OpenSSL" style="width: 80%">
</div>

---

### With OPA

<div align="center" style="background-color:#F1F1F1; border-radius: 10px; border: 2px solid">
  <img src="image/1763381801198.png" alt="OpenSSL" style="width: 80%">
</div>

---

<div align="center" style="background-color:#F1F1F1; border-radius: 10px; border: 2px solid">
  <img src="image/1763381892395.png" alt="OpenSSL" style="width: 80%">
</div>

---

## ğŸ§¬ **OPA Architecture & Components**

OPA has a few core concepts:

1. **Policy** â€“ written in **Rego**
2. **Data** â€“ JSON documents (e.g., user roles, resource metadata)
3. **Input** â€“ JSON representing the **current request** being evaluated
4. **Decision** â€“ JSON result computed by the policy

You typically run OPA:

- As a **sidecar** (next to your app)
- As a **daemon** (local)
- As a **central service** (via HTTP)
- As an **admission webhook** (for Kubernetes)

---

## ğŸ§ª **Rego Basics (The Policy Language)**

A minimal Rego policy file `example.rego`:

```rego
package authz

default allow = false

allow if {
  input.user.role == "admin"
}

allow if {
  input.user.id == input.resource.owner
}
```

- `package authz` â€“ namespace
- `default allow = false` â€“ deny by default
- `allow` rules â€“ return `true` if any rule body succeeds

If `allow` is `true`, your app can allow the action.

---

## ğŸ’» **OPA (Local / Microservice Setup)**

Letâ€™s do a **local hands-on** using the OPA binary + HTTP API.

### ğŸ“Œ **1. Run OPA Server Locally**

Download OPA (binary) and run:

```bash
wget https://openpolicyagent.org/download/opa_linux_amd64 -O opa
chmod +x opa
```

```bash
opa run --server
```

OPA will listen on `localhost:8181` by default.

```json
{
  "level": "warning",
  "msg": "OPA running with uid or gid 0. Running OPA with root privileges is not recommended.",
  "time": "2025-11-17T12:44:03Z"
}
```

---

### ğŸ“Œ **2. Create a Policy: `authz.rego`**

```rego
package authz

default allow = false

# Admins can do anything
allow if {
  input.user.role == "admin"
}

# Resource owners can read their own resource
allow if {
  input.action == "read"
  input.user.id == input.resource.owner
}

# Only managers can delete resources
allow if {
  input.action == "delete"
  input.user.role == "manager"
}
```

---

### ğŸ“Œ **3. Load Policy into OPA (`/v1/policies/`<policy_name>)**

Run:

```bash
curl -X PUT \
  --data-binary @<policy_file>.rego \
  <host>:8181/v1/policies/<policy_name>
```

```bash
curl -X PUT \
  --data-binary @authz.rego \
  localhost:8181/v1/policies/authz
```

OPA now knows this policy.

---

### ğŸ“Œ **4. Query the Policy via OPA API (`/v1/data/authz/allow`)**

#### ğŸ“ Example Input (user is owner, reading)

```json
{
  "input": {
    "user": { "id": "u1", "role": "user" },
    "resource": { "id": "r1", "owner": "u1" },
    "action": "read"
  }
}
```

Query:

```bash
curl -X POST localhost:8181/v1/data/authz/allow \
  -H "Content-Type: application/json" \
  -d '{
    "input": {
      "user": { "id": "u1", "role": "user" },
      "resource": { "id": "r1", "owner": "u1" },
      "action": "read"
    }
  }'
```

Result:

```json
{ "result": true }
```

---

#### ğŸ“ Example Input (user NOT allowed to delete)

```bash
curl -X POST localhost:8181/v1/data/authz/allow \
  -H "Content-Type: application/json" \
  -d '{
    "input": {
      "user": { "id": "u1", "role": "user" },
      "resource": { "id": "r1", "owner": "u2" },
      "action": "delete"
    }
  }'
```

Result:

```json
{ "result": false }
```

---

### ğŸ“Œ **5. Integrating OPA in Your Service (Pseudo-Code)**

#### ğŸ“ Example in pseudocode (e.g., Go/C#/Node conceptually):

```pseudo
function authorize(request):
    input = {
        "user": {
            "id": request.userId,
            "role": request.userRole
        },
        "resource": {
            "id": request.resourceId,
            "owner": request.resourceOwnerId
        },
        "action": request.action
    }

    opaResponse = http.post("http://opa:8181/v1/data/authz/allow", { "input": input })

    if opaResponse.result == true:
        return ALLOW
    else:
        return DENY
```

The **app remains dumb about rules**.
Rules live entirely in OPA/Rego.

---

## ğŸ§ª **Using Data Documents in OPA (RBAC Example)**

Letâ€™s say you have a `data.json`:

```json
{
  "roles": {
    "alice": "admin",
    "bob": "user"
  },
  "permissions": {
    "admin": ["create", "read", "update", "delete"],
    "user": ["read"]
  }
}
```

Load into OPA:

```bash
curl -X PUT \
  --data-binary @data.json \
  localhost:8181/v1/data
```

Policy `rbac.rego`:

```rego
package rbac

default allow = false

allow {
  some permission
  user_role := data.roles[input.user]
  allowed := data.permissions[user_role]
  input.action == allowed[_]  # user action is in allowed list
}
```

Query:

```bash
curl -X POST localhost:8181/v1/data/rbac/allow \
  -H "Content-Type: application/json" \
  -d '{
    "input": {
      "user": "bob",
      "action": "delete"
    }
  }'
```

Result:

```json
{ "result": false }
```

OPA uses **data + policy + input** to compute decisions.

---

## ğŸ“š **References**

### ğŸ”— <https://openpolicyagent.org/docs/>

<div align="center" style="background-color:#F1F1F1; border-radius: 10px; border: 2px solid">
<img src="image/1763382324664.png" alt="OpenSSL" style="width: 80%">
</div>

### ğŸ”— <https://openpolicyagent.org/docs/policy-testing/>

<div align="center" style="background-color:#F1F1F1; border-radius: 10px; border: 2px solid">
<img src="image/1763382566683.png" alt="OpenSSL" style="width: 80%">
</div>

### ğŸ”— <https://play.openpolicyagent.org/>

<div align="center" style="background-color:#F1F1F1; border-radius: 10px; border: 2px solid">
<img src="image/1763382531134.png" alt="OpenSSL" style="width: 80%">
</div>

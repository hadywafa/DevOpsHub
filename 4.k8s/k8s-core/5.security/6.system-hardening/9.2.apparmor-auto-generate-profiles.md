# ğŸ›¡ï¸ AppArmor â€” Auto-Generate & Edit Profiles (The Clean Explanation)

When learning AppArmor, the part that feels magical (and confusing) is:

> â€œHow does AppArmor _automatically_ create and adjust profiles for my application?â€

This works using **learning modes** + **audit logs**.

Letâ€™s break it down visually and with an example.

---

## ğŸ§  How AppArmor Normally Works (Quick Reminder)

A profile can run in:

| Mode         | Meaning                                  |
| ------------ | ---------------------------------------- |
| **enforce**  | Block & log violations                   |
| **complain** | Allow but log violations (learning mode) |
| **disable**  | Not used at all                          |

To _generate or fix_ a profile, we use **complain mode**.

---

## ğŸ¯ Goal of Auto-Generation

AppArmor does NOT expect you to write long profiles manually.

Instead you:

1. Put an app in **complain mode**
2. Use the application â†’ AppArmor learns what it needs
3. Use `aa-logprof` to convert logs â†’ generate a clean profile
4. Switch the profile to **enforce**

Basically:

```ini
Complaining â†’ Learning â†’ Suggest Rules â†’ Build Profile â†’ Enforce
```

---

## ğŸ§© Where the Magic Happens: `aa-logprof`

`aa-logprof` reads AppArmor audit logs and asks:

> â€œThe app tried to access this file. Should we allow it?â€

You answer:
`A` = allow
`D` = deny
`I` = ignore

---

## ğŸ› ï¸ Step-by-Step: Automatic Profile Creation (Very Clear)

Letâ€™s take an example:
We want to restrict a program `/usr/bin/myapp`.

---

### **Step 1 â€” Create a basic empty profile**

```bash
sudo aa-genprof /usr/bin/myapp
```

This tool does:

- âœ” Creates a profile skeleton
- âœ” Puts the app in **complain mode**
- âœ” It tells you:
  - â€œRun your application now so I can learn what it does.â€

---

### **Step 2 â€” Run the application normally**

Use it like your user would:

```bash
/usr/bin/myapp
```

AppArmor will log _everything it tries to access._

---

### **Step 3 â€” Finish learning**

Go back to the terminal where `aa-genprof` is running.

It will start asking you:

```ini
Profile: /usr/bin/myapp
Path: /etc/myapp/config.yml
Severity: 3
Allow reading this file? (A)llow / (D)eny / (I)gnore
```

You answer:

- `A` â†’ AppArmor writes a rule into the profile
- `D` â†’ Deny rule is added
- `I` â†’ Ignore (no rule)

After you finish all suggestions, it generates a **complete profile** like:

```ini
/usr/bin/myapp {
  /etc/myapp/** r,
  /var/log/myapp/** rw,
  network inet stream,
  capability net_bind_service,
}
```

---

### **Step 4 â€” Switch to enforce mode**

```bash
sudo aa-enforce /usr/bin/myapp
```

Now AppArmor blocks anything not in the profile.

---

## ğŸ§ª Example: Editing an Existing Profile Automatically

Letâ€™s say your app gets blocked:

```ini
AppArmor denied access to /tmp/foo.txt
```

You can update the profile using:

```bash
sudo aa-logprof
```

It will ask:

```ini
[DENIED] myapp â†’ /tmp/foo.txt
Add rule?
(A)llow  (D)eny  (I)gnore
```

Choose:

- `A` â†’ AppArmor adds `/tmp/foo.txt r,`
- `D` â†’ AppArmor keeps blocking it

---

## ğŸ§  Why Is This Useful?

Because **you donâ€™t write profiles by hand**.

You let AppArmor:

- watch the app
- gather logs
- show you what rules it needs
- and YOU confirm each rule

Perfect for CKS exam â€” fast & accurate.

---

## ğŸ”¥ FULL CLEAN HANDS-ON Example (Docker)

Letâ€™s say we run:

```bash
docker run --rm -it --name innocent ubuntu bash
```

Inside the container:

```bash
apt update
cat /etc/passwd
```

### Step 1 â€” Find the Docker profile

```bash
sudo aa-status
```

Youâ€™ll likely see:

```ini
docker-default (enforce)
```

### Step 2 â€” Put it in complain mode

```bash
sudo aa-complain /etc/apparmor.d/docker
```

### Step 3 â€” Trigger violations

Inside the container, do weird things:

```bash
touch /secret
apt install curl
```

AppArmor logs everything.

### Step 4 â€” Learn & update

```bash
sudo aa-logprof
```

Youâ€™ll see:

```ini
Program docker-default tried to write /secret
(A)llow (D)eny (I)gnore?
```

Answer â†’ profile gets updated.

### Step 5 â€” Enforce again

```bash
sudo aa-enforce /etc/apparmor.d/docker
```

Now violatons will be blocked.

---

## ğŸ¬ Summary (Crystal Clear)

- âœ” **aa-genprof** â†’ create a new profile automatically
- âœ” **aa-logprof** â†’ update an existing profile automatically
- âœ” **complain mode** â†’ learning mode
- âœ” **enforce mode** â†’ real blocking
- âœ” Profiles are built from real application behavior
- âœ” YOU confirm rules one by one
- âœ” Perfect for CKS exam

# âœ… Kubernetes AppArmor

As of Kubernetes **1.30+**, **AppArmor no longer requires annotations**.
You can now use:

```yaml
securityContext:
  appArmorProfile:
    type: Localhost
    localhostProfile: my-profile
```

This is the _new recommended and official_ method.
Annotations still work but are **deprecated**.

---

## ğŸ§© **THE SIMPLE LIFECYCLE OF APPARMOR IN KUBERNETES**

Letâ€™s make it **super simple** so you never get confused.

---

### ğŸ”„ **AppArmor Lifecycle in Kubernetes (Simple Version)**

Think of the lifecycle as **5 steps**:

```ini
+-------------------+
|   1. Kernel LSM   |
| AppArmor enabled? |
+-------------------+
           |
           v
+----------------------------+
| 2. Node has profile file   |
| /etc/apparmor.d/<profile> |
+----------------------------+
           |
           v
+----------------------------+
| 3. kubelet loads profile   |
|   (via apparmor_parser)   |
+----------------------------+
           |
           v
+---------------------------+
| 4. Pod requests profile   |
|   (securityContext)       |
+---------------------------+
           |
           v
+---------------------------+
| 5. Container runs with    |
|     profile enforced      |
+---------------------------+
```

> âœ”ï¸ If ANY step is missing â†’ apparmor fails â†’ pod goes into **AppArmorProfileNotFound**.

---

## âš™ï¸ **WHAT happens internally? (Still simple)**

### ğŸ”¹ 1. **Node Boot**

AppArmor kernel module loads â†’ provides security hooks.

### ğŸ”¹ 2. **Profile Exists on Node**

Kubernetes does NOT distribute profiles.
Each node must have:

```ini
/etc/apparmor.d/<my-profile>
```

### ğŸ”¹ 3. **kubelet loads + attaches profile**

When a pod requests:

```yaml
appArmorProfile:
  type: Localhost
  localhostProfile: my-profile
```

The kubelet checks:

1. profile exists
2. profile is loaded (`aa-status`)
3. profile is compatible with container runtime

Then kubelet tells container runtime:

> â€œRun this container under AppArmor profile X.â€

### ğŸ”¹ 4. **Runtime enforces it**

If using containerd:

```ini
runc --apparmor-profile my-profile
```

### ğŸ”¹ 5. **Violations logged in kernel**

You see DENIED logs in:

```ini
dmesg
journalctl -k
```

---

## âœğŸ» **HANDS-ON LAB**

This is **fully updated** using the NEW `appArmorProfile` API.

Works on:

- âœ” containerd
- âœ” kubeadm cluster
- âœ” minikube
- âœ” kind

---

### ğŸ§ª **STEP 1 â€” Create an AppArmor profile ON THE NODE**

SSH into the node:

```bash
sudo nano /etc/apparmor.d/deny-write
```

Add:

```ini
#include <tunables/global>

profile deny-write flags=(attach_disconnected) {
  file,
  deny /** w,
}
```

Load it:

```bash
sudo apparmor_parser -r /etc/apparmor.d/deny-write
```

Verify:

```bash
sudo aa-status | grep deny-write
```

---

### ğŸ§ª **STEP 2 â€” Deploy a Pod using the new AppArmor securityContext**

Create:

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: apparmor-test
spec:
  containers:
    - name: main
      image: busybox
      command: ["sh", "-c", "sleep 3600"]
      securityContext:
        appArmorProfile:
          type: Localhost
          localhostProfile: deny-write
```

Apply:

```bash
kubectl apply -f apparmor-test.yaml
```

---

### ğŸ§ª **STEP 3 â€” Verify the pod is using AppArmor**

```bash
kubectl get pod apparmor-test -o jsonpath='{.status.containerStatuses[0].appArmorProfile}'
```

Expected:

```ini
localhost/deny-write
```

---

### ğŸ§ª **STEP 4 â€” Test the restriction**

```bash
kubectl exec -it apparmor-test -- sh
```

Try writing:

```sh
echo hi > /tmp/x
```

Result:

```ini
Permission denied
```

Check logs:

```bash
sudo dmesg | grep DENIED | tail
```

You'll see:

```ini
DENIED write access for profile deny-write
```

ğŸ”¥ You have **confirmed AppArmor works!**

---

## ğŸš¨ If Pod Fails With Error

If you see:

```ini
AppArmorProfileNotFound
```

It means:

- profile file missing on node
- profile not loaded via apparmor_parser
- typo in profile name
- using Localhost but profile isnâ€™t in `/etc/apparmor.d/`

---

## ğŸ§© HOW KUBERNETES SELECTS THE PROFILE

1. If using `RuntimeDefault` (seccomp), AppArmor does nothing
2. If using `Unconfined`, AppArmor is disabled
3. If using `Localhost`, kubelet loads named profile
4. If annotation + securityContext â†’ **securityContext wins**

---

## ğŸ¯ SUPER CLEAN SUMMARY

| Step | What You Must Do                             |
| ---- | -------------------------------------------- |
| 1    | Ensure AppArmor kernel enabled (`aa-status`) |
| 2    | Create profile file under `/etc/apparmor.d/` |
| 3    | Load it using `apparmor_parser`              |
| 4    | Reference it using **securityContext**       |
| 5    | Test write/exec and check logs (`dmesg`)     |

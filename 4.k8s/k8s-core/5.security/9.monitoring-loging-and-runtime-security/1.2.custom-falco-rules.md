# ğŸ”§ **Configuring Custom Falco Rules**

Falco allows you to load **custom security rules** that extend the default detection engine.
How you add these rules depends on **how Falco is installed**.

We cover **all 2 common deployment modes**:

---

## ğŸŸ§ **Scenario 1 â€” Falco Installed as a System Service (Host / Bare Metal / VM)**

ğŸ’¡ _Falco installed via apt/yum, acting as a kernel-level agent outside Kubernetes._

When installed as a Linux service, Falco loads rules from:

```bash
# main config
/etc/falco/falco.yaml
# custom rules location
/etc/falco/rules.d/*.yaml
```

---

### âœ… **Add Custom Rules to System Installation**

1. Create a new rules file:

   ```bash
   sudo nano /etc/falco/rules.d/custom-rules.yaml
   ```

   Example:

   ```yaml
   - rule: Detect bash execution
   desc: Alert when bash is executed on the node
   condition: evt.type=execve and proc.name=bash
   output: Bash executed on host by user=%user.name cmd=%proc.cmdline
   priority: INFO
   tags: [host, shell]
   ```

2. Validate syntax:

   ```bash
   sudo falco -r /etc/falco/rules.d/custom-rules.yaml --validate
   ```

3. Restart Falco service:

   ```bash
   sudo systemctl restart falco
   sudo systemctl status falco
   ```

### âœ” Result:

Falco running as a systemd service will automatically include your custom YAMLS.

### ğŸ“ Note

> - The default location for custom rules is `/etc/falco/rules.d/*.yaml`.
> - `rules_file` section inside `/etc/falco/falco.yaml` file defines the order in which rules are loaded.
> - last rule has the highest priority.
> - If you want to add custom rules to the end of the list, you can use the `rules_file` setting in `/etc/falco/falco.yaml`\

---

## ğŸŸ¦ **Scenario 2 â€” Falco Installed via Helm (Kubernetes DaemonSet)**

ğŸ’¡ _Most common production installation_

Falco loads rule files from:

```ini
/etc/falco/rules.d/
```

Helm automatically mounts this directory from ConfigMaps.

---

### âœ… **Option A â€” Add Custom Rules Using Helm values.yaml (Recommended)**

1. Create a file in your repo:

   ```ini
   custom-rules.yaml
   ```

2. Add the file content under `falco.extraRules` in **values.yaml**:

   ```yaml
   falco:
   extraRules:
       custom-rules.yaml: |-
       - list: shell_binaries
           items: [bash, sh, zsh, ash]

       - rule: Terminal shell in container
           desc: Detect a shell spawned inside containers
           condition: >
           container and evt.type=execve and proc.name in (shell_binaries)
           output: >
           Shell spawned! user=%user.name container=%container.name
           priority: WARNING
           tags: [shell, container]
   ```

3. Deploy Falco:

   ```bash
   helm upgrade --install falco falcosecurity/falco \
   --namespace falco -f values.yaml
   ```

#### âœ” What Helm does for you:

- Creates a **ConfigMap** that holds `custom-rules.yaml`
- Mounts it to `/etc/falco/rules.d/custom-rules.yaml`
- Falco automatically loads every file under `rules.d/*.yaml`

---

### âœ… **Option B â€” Manually Create a ConfigMap and Patch DaemonSet**

If you donâ€™t want to modify Helm values:

1. Create the ConfigMap

   ```bash
   kubectl create configmap falco-custom-rules \
   -n falco \
   --from-file=custom-rules.yaml
   ```

2. Patch Falco DaemonSet

   - Add this to the container spec:

     ```yaml
     volumeMounts:
     - name: custom-rules
         mountPath: /etc/falco/rules.d/custom-rules.yaml
         subPath: custom-rules.yaml
     ```

   - Add this to DaemonSet volumes:

     ```yaml
     volumes:
     - name: custom-rules
         configMap:
         name: falco-custom-rules
     ```

#### âœ” Result:

Rules become available at:

```ini
/etc/falco/rules.d/custom-rules.yaml
```

> ğŸ” To apply new rules â†’ restart Falco pods.

---

## âš™ï¸ **How Falco Rules Work**

Falco rules live in YAML files (usually ending with `*.rules` or `*.yaml`).

There are **3 building blocks**:

### 1. **Lists** â€“ reusable sets of values

```yaml
- list: trusted_containers
  items:
    - kube-apiserver
    - coredns
```

### 2. **Macros** â€“ reusable conditions

```yaml
- macro: container
  condition: container.id != host
```

### 3. **Rules** â€“ actual alerts you care about

```yaml
- rule: Terminal shell in container
  desc: Detect shell spawned in a container
  condition: >
    container
    and proc.name in (bash, sh, zsh)
  output: >
    Shell spawned in container: user=%user.name
    container=%container.name proc=%proc.name
  priority: WARNING
  tags: [container, shell, mitre_execution]
```

Falco evaluates:
**event â†’ check condition â†’ if true â†’ emit output at priority level.**

---

## ğŸ”– **Common Fields & Conditions Youâ€™ll Use**

Some **super common fields** in rules:

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Field                 | Meaning                                                |
| --------------------- | ------------------------------------------------------ |
| `proc.name`           | Process name (e.g. `bash`, `curl`, `nc`)               |
| `proc.args`           | Command-line arguments                                 |
| `user.name`           | Linux user name                                        |
| `user.uid`            | User ID (0 = root)                                     |
| `container.id`        | Container vs host (`host` value)                       |
| `container.name`      | Name of container                                      |
| `fd.name`             | File path (e.g. `/etc/shadow`)                         |
| `evt.type`            | Syscall type (`execve`, `open`, `write`, `connect`, â€¦) |
| `evt.dir`             | Direction: `>` = enter, `<` = exit                     |
| `fd.sip` / `fd.sport` | Source IP / port for network events                    |

</div>

---

**Basic pattern** in `condition`:

```yaml
condition: <filter on event & fields using AND / OR / IN / NOT>
```

Examples:

```yaml
container and proc.name = bash
evt.type=execve and user.uid=0
fd.name startswith /etc/
proc.name in (bash, sh, zsh)
```

---

## ğŸ“ **Real Examples** - Writing Custom Falco Rules â€“

Weâ€™ll do four rules:

1. **Block interactive shells in containers**
2. **Detect usage of `curl` or `wget` in containers**
3. **Detect writes to `/etc/shadow` or `/etc/passwd`**
4. **Detect `kubectl exec` into pods** (good for audit)

Youâ€™d usually put these into a file like `custom-rules.yaml`.

---

### ğŸ§¨ Rule 1 â€“ Shell spawned in container

```yaml
- macro: container
  condition: container.id != host

- list: shell_binaries
  items: [bash, sh, zsh, ash]

- rule: Terminal shell in container
  desc: Detect an interactive shell spawned inside any container
  condition: >
    container
    and evt.type=execve
    and proc.name in (shell_binaries)
  output: >
    Falco Alert: Shell spawned in container (user=%user.name
    container=%container.name image=%container.image.repository
    command=%proc.cmdline)
  priority: WARNING
  tags: [container, shell, execution]
```

**What this does:**

- Only in **containers** (not the host)
- When a process is executed (`execve`)
- If the process is a shell (bash, sh, zsh, ash)
- Emit a warning

---

### ğŸŒ Rule 2 â€“ Detect curl/wget in containers (data exfiltration)

```yaml
- list: network_tools
  items: [curl, wget]

- rule: Suspicious network tool in container
  desc: Detect usage of curl/wget inside containers (could be data exfil or C2)
  condition: >
    container
    and evt.type=execve
    and proc.name in (network_tools)
  output: >
    Falco Alert: Network tool %proc.name executed in container=%container.name
    image=%container.image.repository user=%user.name cmd=%proc.cmdline
  priority: NOTICE
  tags: [container, network, exfiltration]
```

You can later refine it with `and not container.image.repository in (trusted_images)` if you like.

---

### ğŸ§¾ Rule 3 â€“ Write to `/etc/passwd` or `/etc/shadow`

```yaml
- list: sensitive_files
  items:
    - /etc/passwd
    - /etc/shadow

- rule: Write to sensitive system files
  desc: Detect any writes to passwd/shadow (host or container)
  condition: >
    evt.type in (open, openat, creat, truncate)
    and evt.dir = ">"
    and fd.name in (sensitive_files)
  output: >
    Falco Alert: Process %proc.name (user=%user.name) wrote to %fd.name
    command=%proc.cmdline container=%container.name
  priority: CRITICAL
  tags: [filesystem, privilege_escalation, integrity]
```

**Why this is important:**
Any modification to these files is almost always malicious unless youâ€™re in a very specific maintenance flow.

---

### â˜¸ï¸ Rule 4 â€“ Detect `kubectl exec` into pods

Falco can also watch Kubernetes metadata (through the audit logs or via kubelet/syscalls depending on deployment) â€“ but a simple approach is to detect `kubectl` running with `exec`.

```yaml
- rule: Kubectl exec usage
  desc: Detect when kubectl exec is used (audit/change-control)
  condition: >
    evt.type=execve
    and proc.name = kubectl
    and proc.args contains "exec"
  output: >
    Falco Alert: kubectl exec was used by user=%user.name
    cmd=%proc.cmdline
  priority: NOTICE
  tags: [kubernetes, audit, exec]
```

You donâ€™t necessarily block it, but you **log every occurrence**.

---

## ğŸ§ª **Test & Debug Your Rules**

### 1. Check Falco logs

```bash
kubectl logs -n falco daemonset/falco
```

Look for:

- Rule load errors
- YAML syntax errors
- Unknown fields

Falco will log something like:

> Error loading rules: invalid list name, unknown macro, etc.

---

### 2. Use `falco --list` inside the pod

Exec into a Falco pod:

```bash
kubectl exec -it -n falco <falco-pod-name> -- sh
falco --list
falco --list-rules | grep "Terminal shell in container"
```

### 3. Trigger the rule manually

For the shell rule:

```bash
kubectl run test-shell --image=alpine -it -- sh
```

If rule is correct, youâ€™ll see alerts in:

- Falco logs
- Sidekick target (Slack/Webhook/etc.) if configured

---

## ğŸ”š **Summary**

**Falco Rule = IF (condition on syscalls + metadata) THEN (emit alert with template).**

- **Lists** â†’ reusable sets of values
- **Macros** â†’ reusable snippets of conditions (â€œin containerâ€, â€œwriting fileâ€)
- **Rules** â†’ actual security logic + output

And in Kubernetes:

- Use **ConfigMap or Helm `extraRules`** to load custom rules.
- Mount into `/etc/falco/rules.d/`.
- Restart Falco pods when adding/changing rules (unless hot reload is set).

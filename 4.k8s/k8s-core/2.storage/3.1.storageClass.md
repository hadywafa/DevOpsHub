# üè≠ **StorageClass ‚Äî Dynamic Provisioning and Automation of PersistentVolumes**

> üéØ **Goal:** Learn how to configure, customize, and troubleshoot StorageClasses ‚Äî the component that automates storage provisioning for PVCs in Kubernetes.

---

## üìñ **What is a StorageClass?**

A **StorageClass** defines **how** storage should be provisioned dynamically in your cluster.

When a user creates a **PVC** and references a **StorageClass**, Kubernetes automatically:

1. Contacts the **provisioner** (e.g., AWS EBS, Azure Disk, NFS CSI, Ceph, etc.)
2. Creates the **underlying disk/volume**
3. Generates a **PV** and binds it to the PVC

> üí° Think of StorageClass as a _template_ for dynamic PV creation.

---

## üß© **Key Components of a StorageClass**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Field                  | Description                                                      |
| ---------------------- | ---------------------------------------------------------------- |
| `provisioner`          | CSI driver or legacy plugin (e.g., `ebs.csi.aws.com`)            |
| `parameters`           | Provider-specific storage settings                               |
| `reclaimPolicy`        | What happens to volume after PVC deletion                        |
| `allowVolumeExpansion` | Whether PVC can be resized                                       |
| `volumeBindingMode`    | When the volume is bound (`Immediate` or `WaitForFirstConsumer`) |
| `mountOptions`         | Filesystem options (e.g., `nfsvers=4.1`)                         |

</div>

---

## ‚úçüèª **Example: AWS EBS StorageClass**

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: gp3
provisioner: ebs.csi.aws.com
parameters:
  type: gp3
  fsType: ext4
  iops: "3000"
  throughput: "125"
reclaimPolicy: Delete
allowVolumeExpansion: true
volumeBindingMode: WaitForFirstConsumer
```

Explanation:

- **`provisioner`** ‚Üí uses AWS EBS CSI driver
- **`parameters`** ‚Üí EBS type, fsType, and performance tuning
- **`reclaimPolicy`** ‚Üí deletes volume when PVC removed
- **`allowVolumeExpansion`** ‚Üí lets PVC grow later
- **`volumeBindingMode`** ‚Üí delays binding until Pod scheduled (zone-aware)

---

## üü¶ **Azure Disk Example**

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: azure-managed
provisioner: disk.csi.azure.com
parameters:
  skuName: Premium_LRS
  kind: Managed
reclaimPolicy: Delete
allowVolumeExpansion: true
volumeBindingMode: WaitForFirstConsumer
```

---

## üü® **GCP Persistent Disk Example**

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: standard
provisioner: pd.csi.storage.gke.io
parameters:
  type: pd-balanced
  fstype: ext4
reclaimPolicy: Delete
allowVolumeExpansion: true
```

---

## üß± **Static vs Dynamic Provisioning Recap**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Mode        | Description                      | Managed By                    | Typical Use      |
| ----------- | -------------------------------- | ----------------------------- | ---------------- |
| **Static**  | Admin manually defines PVs       | Cluster Admin                 | NFS, legacy      |
| **Dynamic** | PV auto-created when PVC appears | Kubernetes (via StorageClass) | Cloud disks, CSI |

</div>

---

## üîÑ **Default StorageClass**

The **default StorageClass** is used when a PVC doesn‚Äôt specify one.

View current default:

```bash
kubectl get sc
```

Output:

```ini
NAME               PROVISIONER          AGE   DEFAULT
gp3 (default)      ebs.csi.aws.com      50d   true
```

Set or change default:

```bash
kubectl patch storageclass gp3 -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'
```

Remove default:

```bash
kubectl patch storageclass gp3 -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"false"}}}'
```

---

## üß© **Volume Binding Modes**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Mode                   | Description                              | Use Case                        |
| ---------------------- | ---------------------------------------- | ------------------------------- |
| `Immediate`            | Volume created as soon as PVC is created | Non-zonal storage (e.g., NFS)   |
| `WaitForFirstConsumer` | PV created only when Pod scheduled       | Zonal storage (EBS, Azure Disk) |

</div>

---

> üí° `WaitForFirstConsumer` prevents provisioning in the wrong zone before the Pod is scheduled.

---

## üîí **Reclaim Policy**

Defines what happens when PVC is deleted.

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Policy    | Behavior                                        |
| --------- | ----------------------------------------------- |
| `Delete`  | Removes underlying volume (default for dynamic) |
| `Retain`  | Keeps data for manual reuse or backup           |
| `Recycle` | Clears data (deprecated)                        |

</div>

---

Change:

```bash
kubectl patch sc gp3 -p '{"reclaimPolicy":"Retain"}'
```

---

## üß† **Allowing Volume Expansion**

To let users grow their disks dynamically:

```yaml
allowVolumeExpansion: true
```

Then they can run:

```bash
kubectl patch pvc data-claim -p '{"spec":{"resources":{"requests":{"storage":"20Gi"}}}}'
```

> ‚ö†Ô∏è The underlying CSI driver must support resizing.

---

## üß∞ **Mount Options**

Useful for tuning NFS or block storage mounts:

```yaml
mountOptions:
  - nfsvers=4.1
  - noatime
```

You can verify mount options inside the Pod:

```bash
mount | grep <mountPath>
```

---

## üìù **StorageClass in Action**

1Ô∏è‚É£ Create StorageClass ‚Üí  
2Ô∏è‚É£ Create PVC referencing it ‚Üí  
3Ô∏è‚É£ Pod uses PVC ‚Üí  
4Ô∏è‚É£ Kubernetes provisions PV dynamically ‚Üí  
5Ô∏è‚É£ Volume auto-deleted (if `Delete` policy)

Example PVC:

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: db-data
spec:
  accessModes: [ReadWriteOnce]
  resources:
    requests:
      storage: 10Gi
  storageClassName: gp3
```

Verification:

```bash
kubectl get pv,pvc
```

---

## üß© **Common Parameters by Cloud**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Provider          | Parameter        | Example                       |
| ----------------- | ---------------- | ----------------------------- |
| **AWS**           | `type`           | gp3 / io2                     |
|                   | `fsType`         | ext4 / xfs                    |
|                   | `iops`           | "3000"                        |
| **Azure**         | `skuName`        | StandardSSD_LRS / Premium_LRS |
|                   | `kind`           | Managed                       |
| **GCP**           | `type`           | pd-standard / pd-balanced     |
|                   | `fsType`         | ext4                          |
| **OpenEBS / NFS** | `server`, `path` | For shared volumes            |

</div>

---

## üîß **Troubleshooting StorageClass & Dynamic Provisioning**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Problem                       | Symptom                           | Fix                                               |
| ----------------------------- | --------------------------------- | ------------------------------------------------- |
| PVC stuck in `Pending`        | `no persistent volumes available` | Check provisioner logs, match `storageClassName`  |
| Pod pending with volume error | ‚Äúcouldn‚Äôt attach disk‚Äù            | Zone mismatch ‚Äî use `WaitForFirstConsumer`        |
| Volume not deleted            | ReclaimPolicy = `Retain`          | Manually delete or patch                          |
| Resize failed                 | ‚Äúexpansion not supported‚Äù         | Enable `allowVolumeExpansion`, verify CSI support |
| Wrong fsType                  | Mount errors                      | Match filesystem type to driver                   |

</div>

---

### üîç Diagnostic Commands

```bash
kubectl get sc
kubectl describe sc <name>
kubectl get pvc,pv
kubectl describe pvc <name>
kubectl get events --sort-by=.metadata.creationTimestamp
```

Check CSI logs:

```bash
kubectl logs -n kube-system -l app=csi-provisioner
```

---

## üß† **CSI (Container Storage Interface) Overview**

Most modern StorageClasses rely on a **CSI driver**, which provides:

- **Provisioning** (create/delete volumes)
- **Attachment** (mount/unmount)
- **Snapshots / Clones / Resize**

You can list installed CSI drivers:

```bash
kubectl get csidrivers
```

---

## ‚úÖ **Best Practices for Admins**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Area              | Recommendation                                    |
| ----------------- | ------------------------------------------------- |
| **Default class** | Have one clear default StorageClass               |
| **Zones**         | Always use `WaitForFirstConsumer` for zonal disks |
| **Security**      | Limit who can create StorageClasses               |
| **Expansion**     | Enable volume resizing                            |
| **Performance**   | Tune parameters like IOPS / throughput            |
| **Auditing**      | Regularly `kubectl get sc,pv,pvc -A`              |
| **Monitoring**    | Integrate CSI metrics into Prometheus/Grafana     |
| **Backup**        | Enable snapshots or replication via CSI           |

</div>

---

## üèÅ **Summary**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Concept                  | Description                               |
| ------------------------ | ----------------------------------------- |
| **StorageClass**         | Template for provisioning PVs dynamically |
| **Provisioner**          | CSI driver or legacy plugin               |
| **Parameters**           | Control disk type, fsType, performance    |
| **ReclaimPolicy**        | Defines cleanup behavior                  |
| **VolumeBindingMode**    | Immediate or WaitForFirstConsumer         |
| **allowVolumeExpansion** | Enables PVC resizing                      |
| **mountOptions**         | Fine-tunes volume mounts                  |

</div>

---

## üß≠ Next Step in Storage Series

Now that we‚Äôve covered:

- **PVs (PersistentVolumes)**
- **PVCs (PersistentVolumeClaims)**
- **StorageClasses (Dynamic Provisioning)**

The next logical step is üí° **Data Operations and Storage Troubleshooting** ‚Äî covering:

- Backup, restore, and snapshot management
- Cloning, retention, and data migration
- CSI snapshot controllers
- Common real-world issues and admin recovery workflows

Would you like me to start **Data Operations & Troubleshooting Storage** next?

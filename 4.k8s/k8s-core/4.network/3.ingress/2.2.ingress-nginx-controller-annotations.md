# ⚙️ **NGINX Ingress Controller — Most Common and Important Annotations**

> _Annotations are small YAML “tuning knobs” that modify NGINX behavior for each Ingress individually._

They **override global defaults** set in the controller’s ConfigMap and give **fine-grained control per app**.

---

## 🧩 **URL Rewriting & Redirects**

### 🧠 Purpose

Used when you want to **change the incoming request path** before it reaches your backend service.

---

### 📌 1. `nginx.ingress.kubernetes.io/rewrite-target`

Rewrites the matched path into a new one.

```yaml
metadata:
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
```

**Example:**

Ingress rule:

```yaml
path: /api
rewrite-target: /
```

- Client requests → `example.com/api`
- Backend receives → `/`

So `/api` is **stripped off** before hitting the service.

**🔁 With Capture Groups:**

You can also keep part of the path using regex:

```yaml
path: /shop/(.*)
rewrite-target: /$1
```

`example.com/shop/items` → backend sees `/items`

⚠️ Requires `pathType: ImplementationSpecific`.

---

### 📌 2. `nginx.ingress.kubernetes.io/force-ssl-redirect`

Forces all HTTP → HTTPS redirects.

```yaml
nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
```

✅ Great for production, especially when using TLS secrets.

---

### 📌 3. `nginx.ingress.kubernetes.io/permanent-redirect`

Sends an **HTTP 301 redirect** to another URL.

```yaml
nginx.ingress.kubernetes.io/permanent-redirect: https://new.example.com
```

Useful for version migrations or decommissioned services.

---

## 🔐 **Security & Authentication**

### 📌 1. `nginx.ingress.kubernetes.io/whitelist-source-range`

Restricts access to specific client IP ranges.

```yaml
nginx.ingress.kubernetes.io/whitelist-source-range: "192.168.1.0/24,203.0.113.45/32"
```

Blocks all other clients with `403 Forbidden`.

---

### 📌 2. `nginx.ingress.kubernetes.io/auth-type`, `auth-secret`, `auth-realm`

Enables **Basic Authentication**.

```yaml
nginx.ingress.kubernetes.io/auth-type: basic
nginx.ingress.kubernetes.io/auth-secret: basic-auth
nginx.ingress.kubernetes.io/auth-realm: "Authentication Required"
```

Create the secret:

```bash
htpasswd -c auth myuser
kubectl create secret generic basic-auth --from-file=auth
```

---

### 📌 3. `nginx.ingress.kubernetes.io/enable-access-log`

Disables access logs for specific Ingress if set to `"false"`.

```yaml
nginx.ingress.kubernetes.io/enable-access-log: "false"
```

Good for high-volume internal apps.

---

### 📌 4. `nginx.ingress.kubernetes.io/secure-backends`

Forces HTTPS between the controller and backend pods (if your app supports it).

```yaml
nginx.ingress.kubernetes.io/secure-backends: "true"
```

---

## ⚙️ **Proxy & Timeout Controls**

Used to control connection behavior between NGINX and backend Pods.

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Annotation                                          | Description                            | Example |
| --------------------------------------------------- | -------------------------------------- | ------- |
| `nginx.ingress.kubernetes.io/proxy-connect-timeout` | Time to wait for connection to backend | `"10"`  |
| `nginx.ingress.kubernetes.io/proxy-read-timeout`    | Time to wait for backend response      | `"30"`  |
| `nginx.ingress.kubernetes.io/proxy-send-timeout`    | Time to send request body to backend   | `"30"`  |
| `nginx.ingress.kubernetes.io/proxy-body-size`       | Max allowed upload size                | `"50m"` |

</div>

---

Example:

```yaml
metadata:
  annotations:
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-body-size: "20m"
```

---

## ⚡ **Rate Limiting (Protect from Overload or Abuse)**

### 📌 1. `nginx.ingress.kubernetes.io/limit-rps`

Limits requests per second per client IP.

```yaml
nginx.ingress.kubernetes.io/limit-rps: "5"
```

If a client sends >5 requests/sec → `503 Service Temporarily Unavailable`.

---

### 📌 2. `nginx.ingress.kubernetes.io/limit-rpm`

Same but per minute instead of per second.

```yaml
nginx.ingress.kubernetes.io/limit-rpm: "100"
```

---

### 📌 3. `nginx.ingress.kubernetes.io/limit-connections`

Limits concurrent connections per IP.

```yaml
nginx.ingress.kubernetes.io/limit-connections: "10"
```

---

### 🧠 Combine Them

You can combine all three to create robust throttling per client.

---

## 🧰 **Load Balancing Controls**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Annotation                                        | Function                                                         | Example              |
| ------------------------------------------------- | ---------------------------------------------------------------- | -------------------- |
| `nginx.ingress.kubernetes.io/load-balance`        | Choose balancing method (`round_robin`, `least_conn`, `ip_hash`) | `"ip_hash"`          |
| `nginx.ingress.kubernetes.io/upstream-hash-by`    | Hash by header/cookie to keep session stickiness                 | `"cookie:SESSIONID"` |
| `nginx.ingress.kubernetes.io/session-cookie-name` | Sticky session cookie name                                       | `"app_session"`      |

</div>

---

Example:

```yaml
metadata:
  annotations:
    nginx.ingress.kubernetes.io/load-balance: "least_conn"
    nginx.ingress.kubernetes.io/upstream-hash-by: "cookie:SESSIONID"
```

---

## 🧱 **Headers and CORS Control**

### 📌 1. `nginx.ingress.kubernetes.io/enable-cors`

Enables Cross-Origin Resource Sharing.

```yaml
nginx.ingress.kubernetes.io/enable-cors: "true"
nginx.ingress.kubernetes.io/cors-allow-origin: "https://frontend.example.com"
nginx.ingress.kubernetes.io/cors-allow-methods: "GET, PUT, POST, OPTIONS"
nginx.ingress.kubernetes.io/cors-allow-headers: "DNT,X-CustomHeader,Keep-Alive,User-Agent"
```

---

### 📌 2. `nginx.ingress.kubernetes.io/add-headers`

Adds custom headers from a ConfigMap.

```yaml
nginx.ingress.kubernetes.io/add-headers: my-headers
```

Example ConfigMap:

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: my-headers
data:
  X-Frame-Options: "DENY"
  X-Content-Type-Options: "nosniff"
```

---

## 📦 **Custom Error Pages**

Use `custom-http-errors` to intercept and handle backend errors gracefully.

```yaml
nginx.ingress.kubernetes.io/custom-http-errors: "404,500,502,503"
```

You can then define a separate service to render friendly error pages.

---

## 🧩 **Canary Deployments (A/B Testing)**

Used for safe rollouts and weighted traffic splits.

```yaml
metadata:
  annotations:
    nginx.ingress.kubernetes.io/canary: "true"
    nginx.ingress.kubernetes.io/canary-weight: "20"
```

### Other Canary Variants

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Annotation                                           | Description                           |
| ---------------------------------------------------- | ------------------------------------- |
| `nginx.ingress.kubernetes.io/canary-by-header`       | Route requests with a specific header |
| `nginx.ingress.kubernetes.io/canary-by-header-value` | Match specific header value           |
| `nginx.ingress.kubernetes.io/canary-weight`          | Weight-based traffic split (e.g. 10%) |

</div>

---

Example:

```yaml
metadata:
  annotations:
    nginx.ingress.kubernetes.io/canary-by-header: "X-Canary"
    nginx.ingress.kubernetes.io/canary-by-header-value: "true"
```

✅ Only requests with header `X-Canary: true` go to the new version.

---

## 📊 **Metrics and Logging**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Annotation                                       | Description                | Example            |
| ------------------------------------------------ | -------------------------- | ------------------ |
| `nginx.ingress.kubernetes.io/enable-access-log`  | Enable/disable access logs | `"true"`           |
| `nginx.ingress.kubernetes.io/enable-rewrite-log` | Show rewrite debug logs    | `"true"`           |
| `nginx.ingress.kubernetes.io/limit-whitelist`    | Log only certain IPs       | `"192.168.1.0/24"` |

</div>

---

> Useful for debugging complex routing.

---

## 🧱 **Miscellaneous Useful Annotations**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Annotation                                              | Purpose                                          |
| ------------------------------------------------------- | ------------------------------------------------ |
| `nginx.ingress.kubernetes.io/use-regex: "true"`         | Enable regex in path matching                    |
| `nginx.ingress.kubernetes.io/proxy-buffer-size: "8k"`   | Tune buffer for large headers                    |
| `nginx.ingress.kubernetes.io/proxy-buffering: "on/off"` | Enable or disable proxy buffering                |
| `nginx.ingress.kubernetes.io/server-snippet`            | Inject custom NGINX config into the server block |
| `nginx.ingress.kubernetes.io/configuration-snippet`     | Inject custom config into the location block     |

</div>

---

Example custom snippet:

```yaml
metadata:
  annotations:
    nginx.ingress.kubernetes.io/configuration-snippet: |
      add_header X-Powered-By "Kubernetes Ingress";
```

---

## 🧭 **Quick Reference Summary**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Category            | Key Annotations                                                 |
| ------------------- | --------------------------------------------------------------- |
| **Routing**         | `rewrite-target`, `use-regex`, `permanent-redirect`             |
| **Security**        | `whitelist-source-range`, `auth-type`, `secure-backends`        |
| **Timeouts**        | `proxy-read-timeout`, `proxy-send-timeout`, `proxy-body-size`   |
| **Rate Limiting**   | `limit-rps`, `limit-rpm`, `limit-connections`                   |
| **Load Balancing**  | `load-balance`, `upstream-hash-by`, `session-cookie-name`       |
| **CORS/Headers**    | `enable-cors`, `add-headers`                                    |
| **Canary**          | `canary`, `canary-weight`, `canary-by-header`                   |
| **Custom Behavior** | `server-snippet`, `configuration-snippet`, `custom-http-errors` |

</div>

---

## 💡 **Pro Tips for Production**

- ✅ Always quote numeric annotations as strings (`"10"` not `10`).
- ✅ Use regex paths only when needed; they slow down matching.
- ✅ Limit per-Ingress overrides — prefer global ConfigMap tuning.
- ✅ Document every annotation in the YAML (why it exists).
- ✅ Test rewrites and rate limits in staging first — easy to misconfigure.

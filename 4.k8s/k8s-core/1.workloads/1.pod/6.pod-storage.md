# üíæ **Pod Storage** (**at Pod Level**)

> üéØ **Goal:** Understand how storage works inside them, and how to manage both as an administrator ‚Äî with real commands, troubleshooting flows, and admin tips.

## üìñ **Pod Storage Basics**

Pods are ephemeral ‚Äî when a Pod dies, data inside is lost unless stored in **Volumes**.

> üíæ Volumes provide **persistent or shared storage** that survives container restarts.

---

## üé≠ **Volume Types** (Admin View)

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Type                            | Description                                                                      | Scope         |
| ------------------------------- | -------------------------------------------------------------------------------- | ------------- |
| **emptyDir**                    | Temporary storage shared by containers in Pod                                    | Pod lifecycle |
| **hostPath**                    | Mount host node directory                                                        | Tied to node  |
| **persistentVolumeClaim (PVC)** | - Connects to cluster-wide storage (EBS, AzureDisk, etc.) </br> - PVC ‚Üí PV ‚Üí Pod | Persistent    |
| **CSI volumes**                 | - Provided by external storage drivers </br> - StorageClass ‚Üí PVC ‚Üí PV ‚Üí Pod     | Persistent    |
| **configMap**                   | Mounts configuration data (stored in ETCD as Plain Text)                         | Read-only     |
| **configMap / secret**          | Mounts configuration data (Stored in ETCD as base64-encoded value)               | Read-only     |

</div>

---

## ‚úçüèª **Example: emptyDir (Shared Storage)**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: shared-pod
spec:
  containers:
    - name: app1
      image: busybox
      command: ["sh", "-c", "echo Hello > /data/msg; sleep 3600"]
      volumeMounts:
        - name: shared-storage
          mountPath: /data
    - name: app2
      image: busybox
      command: ["sh", "-c", "cat /data/msg; sleep 3600"]
      volumeMounts:
        - name: shared-storage
          mountPath: /data
  volumes:
    - name: shared-storage
      emptyDir: {}
```

> ‚ÅâÔ∏è How it Works:
>
> - Kubernetes creates a directory on the node.
> - It mounts that directory into `/data` folder inside the container.
> - The container can read/write files there
> - When the pod is deleted, the directory is wiped.

---

## ‚úçüèª **Example: hostPath**

```yaml
volumes:
  - name: host-storage
    hostPath:
      path: /var/log/app
      type: Directory
```

> ‚ö†Ô∏è **Tied to specific node.**
>
> - If Pod moves, data doesn‚Äôt follow.

---

## ‚úçüèª **Example: Persistent Storage with PVC**

### üîπ Step 1: Define PersistentVolume (PV)

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-demo
spec:
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteOnce
  hostPath:
    path: "/mnt/data"
```

---

### üîπ Step 2: Define PersistentVolumeClaim (PVC)

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-demo
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 500Mi
```

---

### üîπ Step 3: Use PVC in Pod

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: pv-pod
spec:
  containers:
    - name: app
      image: nginx
      volumeMounts:
        - name: app-storage
          mountPath: /usr/share/nginx/html
  volumes:
    - name: app-storage
      persistentVolumeClaim:
        claimName: pvc-demo
```

‚úÖ Pod mounts `/mnt/data` ‚Üí data persists if Pod is deleted.

---

### üß© Verify Storage Binding

```bash
kubectl get pv,pvc
```

Expected output:

```ini
NAME           CAPACITY  ACCESS MODES  STATUS    CLAIM
pv/pv-demo     1Gi       RWO           Bound     default/pvc-demo
```

---

## üß∞ **Common Troubleshooting Commands**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Task                     | Command                                          |
| ------------------------ | ------------------------------------------------ |
| Show volumes used by Pod | `kubectl describe pod <pod> \| grep -A3 Volumes` |
| List PV and PVC          | `kubectl get pv,pvc`                             |
| Check storageclass       | `kubectl get sc`                                 |
| Inspect binding          | `kubectl describe pvc <name>`                    |
| Remove stale PV          | `kubectl delete pv <name>`                       |

</div>

---

## üî¥ **Common Storage Issues**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Problem                       | Cause                        | Fix                               |
| ----------------------------- | ---------------------------- | --------------------------------- |
| PVC stuck in Pending          | No matching PV               | Create PV or correct StorageClass |
| PV Released but not Reclaimed | ReclaimPolicy set to Retain  | Manually delete PV                |
| Pod won‚Äôt start               | PVC not bound                | Check `kubectl describe pvc`      |
| Data lost after restart       | Used emptyDir instead of PVC | Use persistent volume             |

</div>

---

## üß© **StorageClass**

Defines **provisioning backend** for dynamic PV creation.

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: fast
provisioner: kubernetes.io/aws-ebs
parameters:
  type: gp3
reclaimPolicy: Delete
```

Then your PVC just references `storageClassName: fast`.
Kubernetes automatically provisions a PV.

---

## üìÉ **Clean-Up Commands**

```bash
kubectl delete pod shared-pod
kubectl delete pvc pvc-demo
kubectl delete pv pv-demo
kubectl delete sc fast
```

# ü©∫ Kubernetes Pods 102 ‚Äî **Probes, Health Checks & Graceful Shutdown**

## üéØ Goal

Learn how to keep pods healthy and avoid downtime by mastering:

- **Liveness**, **Readiness**, and **Startup** probes
- **Graceful shutdowns** and **preStop hooks**
- Real troubleshooting techniques

---

## üìñ **Why Health Checks Matter**

Kubernetes automatically **restarts or stops containers** based on their health.
Without probes, Kubernetes **can‚Äôt distinguish** between:

- A pod that‚Äôs slow,
- A pod that‚Äôs dead, or
- A pod that‚Äôs just starting up.

‚úÖ **Probes = Reliability + Self-Healing**

---

## üëØ‚Äç‚ôÇÔ∏è **Types of Probes**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Probe               | Purpose                                      | Default Behavior                                     |
| ------------------- | -------------------------------------------- | ---------------------------------------------------- |
| **Liveness Probe**  | Detects if a container is still alive.       | If it fails ‚Üí Kubelet restarts the container.        |
| **Readiness Probe** | Checks if the app is ready to serve traffic. | If it fails ‚Üí Pod is removed from Service endpoints. |
| **Startup Probe**   | Used for slow-starting apps.                 | If defined ‚Üí disables liveness until success.        |

</div>

---

## üß™ **Probe Methods**

Kubernetes supports 3 probe types:

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Method                 | Description                                                 |
| ---------------------- | ----------------------------------------------------------- |
| üåê **HTTP GET**        | Calls a specific endpoint (`/healthz`) and expects 2xx/3xx. |
| üì® **TCP Socket**      | Opens a TCP connection on a given port.                     |
| üßëüèª‚Äçüíª **Exec Command** | Runs a command inside the container; success = 0 exit code. |

</div>

---

## ‚úçüèª Example: HTTP GET Probes

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: probe-http
spec:
  containers:
    - name: nginx
      image: nginx
      ports:
        - containerPort: 80
      livenessProbe:
        httpGet:
          path: /
          port: 80
        initialDelaySeconds: 5
        periodSeconds: 10
      readinessProbe:
        httpGet:
          path: /
          port: 80
        initialDelaySeconds: 2
        periodSeconds: 5
```

üß† **Explanation:**

- Wait 5s after start, then check every 10s for liveness.
- Wait 2s for readiness before accepting traffic.

---

## ‚úçüèª Example: Exec Probes

```yaml
livenessProbe:
  exec:
    command:
      - cat
      - /tmp/healthy
  initialDelaySeconds: 3
  periodSeconds: 5
```

üí° Used for scripts or file-based health indicators.

---

## ‚úçüèª Example: TCP Socket Probes

```yaml
readinessProbe:
  tcpSocket:
    port: 3306
  initialDelaySeconds: 10
  periodSeconds: 5
```

‚úÖ Perfect for databases or custom ports.

---

## üïú **Probe Timing Parameters**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Field                 | Meaning                        | Default |
| --------------------- | ------------------------------ | ------- |
| `initialDelaySeconds` | Wait before first probe        | 0       |
| `periodSeconds`       | Time between probes            | 10      |
| `timeoutSeconds`      | Probe timeout                  | 1       |
| `successThreshold`    | # of successes to mark healthy | 1       |
| `failureThreshold`    | # of failures before action    | 3       |

</div>

---

üß† **Mnemonic:** _Delay ‚Üí Period ‚Üí Timeout ‚Üí Success ‚Üí Failure_

---

## ü©π **Startup Probe Example** (for slow apps)

```yaml
startupProbe:
  httpGet:
    path: /healthz
    port: 8080
  periodSeconds: 10
  failureThreshold: 30
```

This allows up to **5 minutes (30√ó10s)** for startup before marking as failed.
During that time, liveness and readiness are **ignored**.

---

## üî¥ **Common Probe Failures & Fixes**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Problem                         | Cause                                 | Fix                                             |
| ------------------------------- | ------------------------------------- | ----------------------------------------------- |
| **CrashLoopBackOff**            | Liveness probe restarts app too early | Increase `initialDelaySeconds`                  |
| **Pod never ready**             | Readiness probe path invalid          | Verify endpoint/port                            |
| **Service not sending traffic** | Readiness always failing              | Test endpoint manually                          |
| **Flapping probes**             | Timeout too short                     | Increase `timeoutSeconds` or `failureThreshold` |
| **Long startup apps**           | StartupProbe missing                  | Add a `startupProbe` before liveness            |

</div>

---

Test probe manually:

```bash
kubectl exec -it <pod> -- curl localhost:8080/healthz
```

---

## üß© **Lifecycle Hooks** (preStop / postStart)

You can hook into container lifecycle events:

```yaml
lifecycle:
  postStart:
    exec:
      command: ["sh", "-c", "echo Started > /tmp/start.log"]
  preStop:
    exec:
      command: ["sh", "-c", "echo Stopping... && sleep 5"]
```

‚ö†Ô∏è Note: `postStart` doesn‚Äôt delay readiness. Use readiness probe for that.

---

## ‚öôÔ∏è **Graceful Shutdown** (Proper Exit Handling)

When you delete a pod or scale down a Deployment:

1Ô∏è‚É£ Kubelet sends **SIGTERM** to containers.  
2Ô∏è‚É£ It waits for `terminationGracePeriodSeconds` (default **30s**).  
3Ô∏è‚É£ If the container doesn‚Äôt exit ‚Üí sends **SIGKILL** (force kill).  
4Ô∏è‚É£ Service removes pod from endpoints (if readiness fails).

---

### Example: Graceful Shutdown

```yaml
spec:
  containers:
    - name: nginx
      image: nginx
      lifecycle:
        preStop:
          exec:
            command: ["/bin/sh", "-c", "sleep 10"]
  terminationGracePeriodSeconds: 20
```

üß† Here:

- When pod is terminated ‚Üí preStop hook sleeps 10s.
- Pod has up to 20s total before being force killed.

‚úÖ Ensures connections close properly (good for web apps & DBs).

---

## üß† **Admin Troubleshooting Workflow**

1Ô∏è‚É£ **Check Events**

```bash
kubectl describe pod myapp | grep -A5 Events
```

2Ô∏è‚É£ **Check Probe Details**

```bash
kubectl get pod myapp -o jsonpath='{.spec.containers[*].livenessProbe}'
```

3Ô∏è‚É£ **Force a Restart**

```bash
kubectl delete pod myapp
```

4Ô∏è‚É£ **Inspect Graceful Shutdown Timing**

```bash
kubectl get pod myapp -o jsonpath='{.spec.terminationGracePeriodSeconds}'
```

---

## üß∞ **Quick Command Cheat Sheet**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Task              | Command                                                 |
| ----------------- | ------------------------------------------------------- |
| Show events       | `kubectl describe pod <name>`                           |
| Get probe config  | `kubectl get pod <name> -o yaml`                        |
| Simulate shutdown | `kubectl delete pod <name>`                             |
| Edit probe live   | `kubectl edit pod <name>`                               |
| Test endpoint     | `kubectl exec -it <pod> -- curl localhost:8080/healthz` |

</div>

---

## ‚úçüèª **Real Example** ‚Äî Full Pod with Probes & Hooks

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: webapp
  labels:
    app: webapp
spec:
  containers:
    - name: webapp
      image: mycompany/webapp:v1
      ports:
        - containerPort: 8080
      readinessProbe:
        httpGet:
          path: /ready
          port: 8080
        initialDelaySeconds: 5
        periodSeconds: 3
      livenessProbe:
        httpGet:
          path: /healthz
          port: 8080
        initialDelaySeconds: 10
        periodSeconds: 5
      lifecycle:
        preStop:
          exec:
            command: ["sh", "-c", "echo Shutting down... && sleep 5"]
  terminationGracePeriodSeconds: 15
```

‚úÖ This pod:

- Waits 5s before marking ready.
- Restarts if health endpoint fails.
- Gracefully exits in 5s on shutdown.

---

## ‚úÖ **Best Practices**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Category          | Recommendation                                         |
| ----------------- | ------------------------------------------------------ |
| **Startup**       | Use `startupProbe` for slow apps (JVM, DBs).           |
| **Liveness**      | Only for detecting deadlocks/crashes, not readiness.   |
| **Readiness**     | Control traffic flow into pod during startup/updates.  |
| **Timing**        | Always tune delay/period for your app startup profile. |
| **Graceful Exit** | Always use `preStop` hook with realistic grace period. |
| **Testing**       | Manually curl endpoints before finalizing probes.      |

</div>

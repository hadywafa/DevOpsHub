# 🧰 **Kubernetes StatefulSets 102** — Troubleshooting StatefulSets

> 🎯 **Goal:** Learn how to diagnose common StatefulSet problems involving **persistent volumes**, **networking**, **ordering**, and **rollouts** — and how to fix them like a Kubernetes veteran.

---

## 🧩 1. **Pods Stuck in “Pending” State**

### 🔍 Symptom

```bash
kubectl get pods
```

Output:

```ini
mysql-0   Pending
mysql-1   Pending
```

### 📋 Root Causes

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Cause                             | Description                                                |
| --------------------------------- | ---------------------------------------------------------- |
| ❌ No available PersistentVolumes | PVCs can’t bind to any PV                                  |
| 🔴 Wrong StorageClass             | Class doesn’t match PV or dynamic provisioning disabled    |
| 🧱 Node constraints               | No node satisfies Pod affinity or storage                  |
| 🚫 Scheduler limits               | Pod can’t be scheduled due to taints or resource shortages |

</div>

---

### 🧠 Diagnosis Steps

```bash
kubectl describe pod mysql-0
```

Look for:

```ini
Warning  FailedScheduling  PersistentVolumeClaim is not bound
```

Then check PVC:

```bash
kubectl get pvc
kubectl describe pvc data-mysql-0
```

If `Pending`:

- Check if StorageClass exists:

  ```bash
  kubectl get storageclass
  ```

- Ensure PVs are available or dynamic provisioning is working.

---

### 🩹 Fix

1. If dynamic provisioning is off, manually create a PV:

   ```yaml
   apiVersion: v1
   kind: PersistentVolume
   metadata:
     name: pv-mysql-0
   spec:
     capacity:
       storage: 10Gi
     accessModes: ["ReadWriteOnce"]
     hostPath:
       path: /data/mysql0
   ```

2. Ensure it matches the PVC’s requirements (`storage`, `accessModes`, `storageClassName`).

3. Wait for PVC to bind → Pod will auto-start.

---

## ⚙️ 2. **StatefulSet Doesn’t Scale or Update Properly**

### 🔍 Symptom

```bash
kubectl rollout status statefulset mysql
```

Output:

```ini
Waiting for statefulset rollout to finish: 1 old replicas are pending termination
```

### 📋 Root Causes

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Cause                     | Description                                  |
| ------------------------- | -------------------------------------------- |
| Readiness probe failing   | Next Pod won’t start until previous is Ready |
| PVC reuse conflicts       | Volume still attached to terminated Pod      |
| Node pressure             | Evicted Pods not rescheduled                 |
| PodDisruptionBudget (PDB) | Blocks simultaneous updates                  |

</div>

---

### 🧠 Diagnosis

Check pod status:

```bash
kubectl describe pod mysql-1
```

Look for:

```ini
Readiness probe failed
MountVolume.SetUp failed
```

Also:

```bash
kubectl get events --sort-by=.metadata.creationTimestamp
```

---

### 🩹 Fix

- If **readiness probe** failing → validate `/health` endpoint.
- If **volume in use**:

  ```bash
  kubectl get pv | grep Bound
  kubectl describe pv <pv-name>
  ```

  Detach or delete stuck PV if safe.

- If **node pressure**:

  ```bash
  kubectl describe node <node>
  ```

  Look for:

  ```ini
  MemoryPressure=True
  DiskPressure=True
  ```

  Migrate or scale nodes.

---

## 🧱 3. **Lost or Corrupted Data Volume**

### 🔍 Symptom

Pod restarts, logs show DB corruption:

```ini
InnoDB: Unable to open the tablespace
```

### 📋 Root Causes

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Cause                 | Description                                  |
| --------------------- | -------------------------------------------- |
| Disk failure          | Underlying storage corrupted                 |
| Manual PV deletion    | PVC still references missing PV              |
| Filesystem corruption | Container runtime crash or abrupt power loss |

</div>

---

### 🧠 Diagnosis

```bash
kubectl describe pvc data-mysql-0
```

Check:

- Bound PV still exists?
- Storage backend (EBS, Ceph, hostPath) healthy?

Inspect logs:

```bash
kubectl logs mysql-0
```

---

### 🩹 Fix

1. **If volume missing:**

   - Restore from backup or snapshot.

2. **If corrupted:**

   - Stop StatefulSet rollout:

     ```bash
     kubectl rollout pause statefulset mysql
     ```

   - Recover DB manually or mount new PVC.

3. **Rebind new volume (careful):**

   ```bash
   kubectl delete pod mysql-0
   kubectl delete pvc data-mysql-0
   kubectl apply -f new-pv.yaml
   ```

   Then restart StatefulSet.

---

## ⚙️ 4. **PVCs Not Deleted After StatefulSet Removal**

### 🔍 Symptom

```bash
kubectl delete statefulset mysql
kubectl get pvc
```

Output:

```ini
data-mysql-0   Bound
data-mysql-1   Bound
```

### 🧠 Explanation

PVCs persist **by design** — to protect your data.

---

### 🩹 Fix (if you really want to remove them)

```bash
kubectl delete pvc -l app=mysql
```

Or manually:

```bash
kubectl delete pvc data-mysql-0 data-mysql-1
```

⚠️ Only do this after verifying backups!

---

## 🧩 5. **DNS or Headless Service Issues**

### 🔍 Symptom

Pods cannot resolve each other:

```ini
ping mysql-0.mysql-headless
unknown host
```

### 📋 Root Causes

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Cause                    | Description              |
| ------------------------ | ------------------------ |
| Missing headless service | StatefulSet requires one |
| Wrong service selector   | Doesn’t match Pod labels |
| CoreDNS misconfiguration | DNS caching or crash     |

</div>

---

### 🧠 Diagnosis

Check service:

```bash
kubectl get svc mysql-headless -o yaml
```

Ensure:

- `clusterIP: None`
- `selector.app: mysql`

Validate DNS:

```bash
kubectl exec -it mysql-0 -- nslookup mysql-1.mysql-headless
```

---

### 🩹 Fix

If service missing:

```bash
kubectl apply -f headless-service.yaml
```

If DNS broken:

```bash
kubectl get pods -n kube-system | grep coredns
kubectl logs -n kube-system <coredns-pod>
```

Restart CoreDNS if needed.

---

## ⚙️ 6. **Rollback Failing or Partial Update**

### 🔍 Symptom

Some Pods updated, others not:

```ini
mysql-0   image: mysql:8.0.40
mysql-1   image: mysql:8.0.38
```

### 📋 Root Causes

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Cause                             | Description                                |
| --------------------------------- | ------------------------------------------ |
| Manual Pod edits                  | StatefulSet doesn’t reconcile manual edits |
| Partitioned rollout               | Update strategy partition limits           |
| Controller bug or stuck condition | Older replicaset metadata                  |

</div>

---

### 🧠 Diagnosis

```bash
kubectl rollout history statefulset mysql
kubectl get statefulset mysql -o yaml | grep partition
```

---

### 🩹 Fix

- Resume rollout:

  ```bash
  kubectl rollout resume statefulset mysql
  ```

- If partitioned rollout:

  ```bash
  kubectl patch statefulset mysql -p '{"spec":{"updateStrategy":{"rollingUpdate":{"partition":0}}}}'
  ```

- To rollback to previous version:

  ```bash
  kubectl rollout undo statefulset mysql
  ```

---

## 🧭 7. **StatefulSet Pod Not Re-Creating After Crash**

### 🔍 Symptom

Pod deleted, not auto-recreated:

```ini
kubectl delete pod mysql-0
kubectl get pods  # no new one
```

### 📋 Root Causes

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Cause                                             | Description                   |
| ------------------------------------------------- | ----------------------------- |
| PodManagementPolicy set to “Parallel” incorrectly | Confuses controller           |
| Controller crash                                  | kube-controller-manager issue |
| API sync lag                                      | Slow reconciliation loop      |

</div>

---

### 🧠 Fix

```bash
kubectl get statefulset mysql -o yaml | grep podManagementPolicy
```

If you see:

```yaml
podManagementPolicy: Parallel
```

Try reverting:

```bash
kubectl patch statefulset mysql -p '{"spec":{"podManagementPolicy":"OrderedReady"}}'
```

Then restart controller or force reconcile:

```bash
kubectl rollout restart statefulset mysql
```

---

## 🧱 8. **`PodDisruptionBudget` Blocking Rollouts**

### 🔍 Symptom

```ini
kubectl rollout status statefulset kafka
Waiting because of PodDisruptionBudget...
```

### 🧠 Fix

Check PDB:

```bash
kubectl get pdb
```

If too restrictive:

```bash
kubectl edit pdb kafka-pdb
```

Adjust:

```yaml
minAvailable: 1  → 0
```

---

## 🔪 **Tools for StatefulSet Diagnosis**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Tool             | Command                                                    | Use                        |
| ---------------- | ---------------------------------------------------------- | -------------------------- |
| Describe Pod     | `kubectl describe pod <name>`                              | Lifecycle, volumes, events |
| PVC info         | `kubectl describe pvc <name>`                              | Storage binding            |
| Events           | `kubectl get events --sort-by=.metadata.creationTimestamp` | Cluster timeline           |
| Logs             | `kubectl logs <pod>`                                       | App-level errors           |
| StatefulSet YAML | `kubectl get statefulset <name> -o yaml`                   | Strategy & volume mapping  |

</div>

---

## ✅ **Summary**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Problem        | Cause                     | Fix                        |
| -------------- | ------------------------- | -------------------------- |
| Pod Pending    | PVC not bound             | Check PV/StorageClass      |
| Rollout stuck  | Readiness or volume issue | Fix probe or detach PV     |
| Data loss      | Volume deleted/corrupt    | Restore/replace PV         |
| PVC remains    | Default behavior          | Delete manually if safe    |
| DNS fails      | Headless service missing  | Recreate `clusterIP: None` |
| Rollback hangs | Partition/Manual edits    | Undo or resume rollout     |

</div>

---

## 🚀 **Pro Tip**

When debugging any StatefulSet:

```bash
kubectl describe statefulset <name>
kubectl get pods -l app=<label> -o wide
kubectl get pvc,pv
kubectl get events --sort-by=.metadata.creationTimestamp
```

That combo gives a **full 360° picture**.

# üßÆ **Jobs & CronJobs 101 ‚Äî Batch and Scheduled Workloads**

> üéØ **Goal:** Understand how to create, manage, and troubleshoot **Jobs** and **CronJobs** ‚Äî the go-to Kubernetes resources for **one-time** or **recurring** tasks.

---

## üìñ **What Are Jobs in Kubernetes?**

A **Job** ensures that a **specific number of Pods successfully complete**.
Unlike Deployments or DaemonSets, Jobs are **not long-running** ‚Äî they **run to completion**.

### üß© Behavior Overview

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Action                      | What Happens                       |
| --------------------------- | ---------------------------------- |
| You create a Job            | Controller starts one or more Pods |
| A Pod finishes successfully | Count of completed Pods increases  |
| Desired completions reached | Job is marked **Completed**        |
| Pods fail repeatedly        | Job retries them (based on policy) |

</div>

---

### üß± Example: A Simple Job

```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: hello-job
spec:
  template:
    spec:
      containers:
        - name: hello
          image: busybox
          command: ["echo", "Hello from Kubernetes Job!"]
      restartPolicy: Never
```

Deploy:

```bash
kubectl apply -f hello-job.yaml
```

Check status:

```bash
kubectl get jobs
kubectl get pods
```

Logs:

```bash
kubectl logs job/hello-job
```

---

## ‚öôÔ∏è **Job Lifecycle and States**

A Job transitions through these states:

```mermaid
flowchart LR
A[Pending] --> B[Running]
B -->|Success| C[Completed ‚úÖ]
B -->|Failure| D[Backoff/Retry ‚ôªÔ∏è]
D -->|Exhausted retries| E[Failed ‚ùå]
```

Each retry spawns **a new Pod** until it reaches the `backoffLimit`.

---

## üß© **Controlling Job Behavior**

### üí• `restartPolicy`

- Must be `Never` or `OnFailure`.
- Job controller manages retries ‚Äî not kubelet.

### üîÅ `backoffLimit`

Number of retries before Job fails:

```yaml
spec:
  backoffLimit: 3
```

### üßÆ `completions` and `parallelism`

- **`completions`** = how many successful Pods are required.
- **`parallelism`** = how many Pods can run at once.

Example ‚Äî run 5 Pods, 2 at a time:

```yaml
spec:
  completions: 5
  parallelism: 2
```

---

## ‚úçüèª **Real Example ‚Äî Batch File Processor**

```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: file-processor
spec:
  completions: 5
  parallelism: 2
  template:
    spec:
      containers:
        - name: processor
          image: alpine
          command: ["sh", "-c", "echo Processing file $(hostname); sleep 5"]
      restartPolicy: Never
```

View progress:

```bash
kubectl get jobs
```

```ini
NAME              COMPLETIONS   DURATION   AGE
file-processor    5/5           35s        1m
```

---

## üßëüèª‚Äçüíª **Job Management Commands**

| Action   | Command                                                  |
| -------- | -------------------------------------------------------- |
| Create   | `kubectl apply -f job.yaml`                              |
| View     | `kubectl get jobs -A`                                    |
| Describe | `kubectl describe job <name>`                            |
| Logs     | `kubectl logs job/<name>`                                |
| Delete   | `kubectl delete job <name>`                              |
| Rerun    | `kubectl delete job <name> && kubectl apply -f job.yaml` |

---

## üßπ **Cleaning Up Old Jobs**

By default, Jobs and Pods stay after completion.
To **auto-cleanup**, use TTL (Time-To-Live):

```yaml
spec:
  ttlSecondsAfterFinished: 60
```

‚úÖ Job and Pods deleted automatically 60 seconds after finishing.

---

## üßÆ **CronJobs ‚Äî Scheduled Jobs**

A **CronJob** runs Jobs **on a time-based schedule**, like a Linux cron.

Example schedule:
`"0 */6 * * *"` ‚Üí every 6 hours.

### üß± Example: CronJob YAML

```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: cleanup-temp
spec:
  schedule: "0 */6 * * *"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: cleanup
              image: alpine
              command: ["sh", "-c", "echo Cleaning temp files at $(date)"]
          restartPolicy: OnFailure
```

Deploy:

```bash
kubectl apply -f cleanup-temp.yaml
```

---

### üß© Cron Syntax Reference

| Field        | Meaning | Example               |
| ------------ | ------- | --------------------- |
| Minute       | `0-59`  | `*/5` every 5 minutes |
| Hour         | `0-23`  | `3` ‚Üí 3 AM            |
| Day of month | `1-31`  | `1` ‚Üí first day       |
| Month        | `1-12`  | `*/2` every 2 months  |
| Day of week  | `0-6`   | `1` ‚Üí Monday          |

üí° Use [crontab.guru](https://crontab.guru) to generate schedules.

---

## ‚öôÔ∏è **CronJob Execution Flow**

```mermaid
flowchart LR
A[CronJob Schedule] --> B[Job Created]
B --> C["Pod(s) Launched"]
C --> D[Job Completes]
D --> E[New Job created next run]
```

- The **CronJob controller** creates a new Job object each time the schedule triggers.
- Each Job runs its Pod(s) independently.

---

## üß† **Key CronJob Parameters**

| Field                        | Description                       |
| ---------------------------- | --------------------------------- |
| `schedule`                   | Cron expression                   |
| `successfulJobsHistoryLimit` | Number of successful Jobs to keep |
| `failedJobsHistoryLimit`     | Number of failed Jobs to keep     |
| `concurrencyPolicy`          | Controls overlapping executions   |
| `startingDeadlineSeconds`    | Grace period for missed schedules |

### Example:

```yaml
spec:
  concurrencyPolicy: Forbid
  failedJobsHistoryLimit: 3
  successfulJobsHistoryLimit: 2
```

---

### üß© `concurrencyPolicy` Options

| Policy    | Behavior                               |
| --------- | -------------------------------------- |
| `Allow`   | Default; multiple runs may overlap     |
| `Forbid`  | Skip new run if previous still running |
| `Replace` | Cancel running job and start a new one |

---

## üß∞ **Managing CronJobs**

| Action            | Command                                       |
| ----------------- | --------------------------------------------- |
| List all          | `kubectl get cronjobs`                        |
| Describe          | `kubectl describe cronjob <name>`             |
| View Jobs created | `kubectl get jobs --selector=job-name=<name>` |
| Logs              | `kubectl logs job/<job-name>`                 |
| Delete            | `kubectl delete cronjob <name>`               |

---

## ‚öôÔ∏è **Troubleshooting Jobs & CronJobs**

| Problem                    | Symptom                      | Fix                                |
| -------------------------- | ---------------------------- | ---------------------------------- |
| Job stuck in Pending       | Node affinity or quota issue | Check events and resources         |
| Pods restarting repeatedly | restartPolicy wrong          | Use `Never` or `OnFailure`         |
| CronJob missed run         | Controller downtime          | Check `startingDeadlineSeconds`    |
| Overlapping Jobs           | Tasks run simultaneously     | Use `concurrencyPolicy: Forbid`    |
| CronJob never triggers     | Wrong cron syntax            | Verify schedule via `crontab.guru` |

### Diagnostic commands:

```bash
kubectl describe job <name>
kubectl describe cronjob <name>
kubectl get events --sort-by=.metadata.creationTimestamp
```

---

## üß± **Real Example ‚Äî Nightly Database Backup**

```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: db-backup
spec:
  schedule: "0 2 * * *" # every day at 2 AM
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: backup
              image: alpine
              command: ["sh", "-c", "pg_dump -h db -U admin > /backup/db.sql"]
              env:
                - name: PGPASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: db-secret
                      key: password
          restartPolicy: OnFailure
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
```

‚úÖ Automatically triggers backup every night at 2 AM.

---

## üß≠ **Best Practices**

| Area                    | Best Practice                                 |
| ----------------------- | --------------------------------------------- |
| **TTL Cleanup**         | Use `ttlSecondsAfterFinished` for old Jobs.   |
| **Logs**                | Stream logs using `kubectl logs job/<name>`.  |
| **Concurrency Control** | Prevent overlaps with `Forbid`.               |
| **Resource Requests**   | Always set limits for batch jobs.             |
| **Monitoring**          | Track Job completions via Prometheus metrics. |
| **Security**            | Run CronJobs with dedicated service accounts. |

---

## ‚úÖ **Summary**

| Concept         | Job                  | CronJob                           |
| --------------- | -------------------- | --------------------------------- |
| **Purpose**     | Run to completion    | Run on a schedule                 |
| **Controller**  | Job Controller       | CronJob Controller (creates Jobs) |
| **Retries**     | Yes (`backoffLimit`) | Yes (per run)                     |
| **Cleanup**     | TTL or manual        | History limits                    |
| **Concurrency** | Parallel Pods        | Parallel scheduled runs           |

---

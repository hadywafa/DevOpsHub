# âš™ï¸ Terraform Meta-Arguments

## ğŸ§  What Are Meta-Arguments?

Terraform meta-arguments are **special configuration keywords** that change how a resource or module behaves. The most important ones include:

- `count` â€“ Create multiple copies based on an integer
- `for_each` â€“ Create multiple instances based on a set/map
- `depends_on`, `lifecycle`, `provider` â€“ Others not covered here

Today, we focus on the most common meta-arguments for looping: **`count`** and **`for_each`**.

---

## 1ï¸âƒ£ `count` â€“ Repeating a Resource with Indexing

### ğŸ” Concept

The `count` meta-argument allows you to create **multiple instances of the same resource** by specifying an integer value.

---

### âœ… Example 1: Basic Count

```ini
variable "filename" {
  default = "/root/pets.txt",
}

resource "local_file" "pet" {
  count    = 3
  filename = var.filename
  content  = "I love cats"
}
```

- This creates 3 files: `pet[0]`, `pet[1]`, `pet[2]`
- But they all share the **same filename** (`/root/pets.txt`) â†’ ğŸ’¥ causes overwrite

---

### âœ… Example 2: Using `count.index` with a list

```ini
variable "filename" {
  default = [
    "/root/pets.txt",
    "/root/dogs.txt",
    "/root/cats.txt"
  ]
}

resource "local_file" "pet" {
  count    = 3
  filename = var.filename[count.index]
  content  = "My pet file"
}
```

Terraform creates:

- `pet[0]` â†’ pets.txt
- `pet[1]` â†’ dogs.txt
- `pet[2]` â†’ cats.txt

---

### âŒ Problem with `count`: Index-Based Instability

If you **remove an item** from the list (say remove `"pets.txt"`), Terraform:

- Shifts remaining elements
- Replaces `pet[0]` and `pet[1]`
- Destroys `pet[2]`

Youâ€™ll see:

```txt
pet[0] must be replaced
pet[1] must be replaced
pet[2] will be destroyed
```

ğŸ’£ This happens because Terraform tracks resources **by index**, not value.

---

## 2ï¸âƒ£ `for_each` â€“ Map- or Set-Based Iteration (Stable!)

### ğŸ” Concept

The `for_each` meta-argument allows you to **create resources per element of a set or map**, and tracks them **by value** â€” not by index.

This avoids unnecessary replacement when order changes.

---

### âœ… Example 1: `for_each` with a `set(string)`

```ini
variable "filename" {
  type = set(string)
  default = [
    "/root/pets.txt",
    "/root/dogs.txt",
    "/root/cats.txt"
  ]
}

resource "local_file" "pet" {
  for_each = var.filename
  filename = each.value
  content  = "Pet File"
}
```

Terraform creates:

```txt
local_file.pet["/root/pets.txt"]
local_file.pet["/root/dogs.txt"]
local_file.pet["/root/cats.txt"]
```

ğŸ§  Resources are tracked by **value**, not position â†’ no surprises when order changes!

---

### âœ… Example 2: Convert a list to set using `toset()`

```ini
for_each = toset(var.filename)
```

âœ… Useful when your variable is a list, but you want stable value-based tracking.

---

## ğŸ§ª When to Use `count` vs `for_each`

| Feature                  | `count`       | `for_each`               |
| ------------------------ | ------------- | ------------------------ |
| Data type                | Integer       | Set or Map               |
| Access method            | `count.index` | `each.key`, `each.value` |
| Tracked by               | Index         | Value                    |
| Stable with reordering   | âŒ No         | âœ… Yes                   |
| Good for simple copies   | âœ… Yes        | âœ… Yes                   |
| Good for key/value pairs | âŒ No         | âœ… Yes (use map)         |

---

## ğŸ’¥ Problem Recap: `count` Destroys Unnecessarily

When using:

```ini
count = length(var.filename)
filename = var.filename[count.index]
```

Then reduce the list from 5 â†’ 2 items, Terraform:

- Replaces or destroys files based on **shifted index**
- Even if the filename value hasnâ€™t changed
- This is **not ideal** in production

---

## âœ… Solution: Use `for_each` with sets/maps

```ini
for_each = toset(var.filename)
filename = each.value
```

Now files are:

- Created
- Updated
- Or deleted â€” only when the filename **value** changes, not index

---

## ğŸ§  Summary

| Meta-Arg   | Best Use Case                                 |
| ---------- | --------------------------------------------- |
| `count`    | Simple repetition, based on fixed-length list |
| `for_each` | Value-based iteration with stable identity    |

ğŸ“Œ **Use `count`** when:

- You only need numeric copies
- You donâ€™t care about ordering

ğŸ“Œ **Use `for_each`** when:

- You care about **identity** and **stability**
- Youâ€™re using **sets or maps**

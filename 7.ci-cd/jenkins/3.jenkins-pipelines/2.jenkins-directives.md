# üß© Jenkins Pipeline Directives

Each Jenkinsfile is built from **directives** ‚Äî the structured components that describe HOW the pipeline behaves.

We cover:

1. `agent`
2. `environment`
3. `post`
4. `notifications`
5. `script` block
6. `when`
7. `input`
8. `parameters`
9. `credentials`
10. `stash` / `unstash`
11. `parallel`

Let‚Äôs go **one by one**, in your preferred enhanced style.

---

## üìÉ Declarative Pipeline ‚Äì Correct Order (Outer ‚Üí Inner)

> Think: **Import ‚Üí Pipeline ‚Üí Global config ‚Üí Flow ‚Üí Execution ‚Üí Control**

---

### 1Ô∏è‚É£ File / Import Level (Before `pipeline {}`)

| Item                       | Type      | Purpose                                       |
| -------------------------- | --------- | --------------------------------------------- |
| `@Library('shared-lib') _` | Import    | Load shared libraries                         |
| `libraries {}`             | Directive | Declare shared libraries (alternative syntax) |

üìå **Rule**: Must be **outside** `pipeline {}`

---

### 2Ô∏è‚É£ Root Container

| Item       | Type          | Purpose                      | Level |
| ---------- | ------------- | ---------------------------- | ----- |
| `pipeline` | **Directive** | Root of declarative pipeline | Root  |

---

### 3Ô∏è‚É£ Root-Level Configuration (Global Behavior)

> These affect **the whole pipeline**

| Order | Item          | Type      | Purpose                                |
| ----- | ------------- | --------- | -------------------------------------- |
| 1     | `agent`       | Directive | Default executor for all stages        |
| 2     | `options`     | Directive | timeouts, retries, concurrency         |
| 3     | `triggers`    | Directive | cron, pollSCM                          |
| 4     | `parameters`  | Directive | build inputs                           |
| 5     | `environment` | Directive | global env vars                        |
| 6     | `tools`       | Directive | JDK, Maven, Node                       |
| 7     | `post`        | Directive | pipeline-level cleanup & notifications |

üìå **Important**
Order inside `pipeline {}` does **not change execution**, but this is the **recommended canonical layout**.

---

### 4Ô∏è‚É£ Flow Definition

| Item     | Type      | Purpose          | Level     |
| -------- | --------- | ---------------- | --------- |
| `stages` | Directive | Holds all stages | Root only |

---

### 5Ô∏è‚É£ Stage Level (Execution Units)

| Order | Item          | Type      | Purpose                | Level           |
| ----- | ------------- | --------- | ---------------------- | --------------- |
| 1     | `stage('X')`  | Directive | Logical step           | Inside `stages` |
| 2     | `agent`       | Directive | Override executor      | Stage           |
| 3     | `when`        | Directive | Conditional execution  | Stage           |
| 4     | `options`     | Directive | Stage-specific control | Stage           |
| 5     | `environment` | Directive | Stage env vars         | Stage           |
| 6     | `tools`       | Directive | Stage tool override    | Stage           |
| 7     | `input`       | Directive | Manual approval        | Stage           |
| 8     | `post`        | Directive | Stage result handling  | Stage           |

---

### 6Ô∏è‚É£ Stage Execution Logic

#### A. Normal Stage

| Item    | Type      | Level      |
| ------- | --------- | ---------- |
| `steps` | Directive | Stage only |

---

#### B. Parallel Stage

| Item       | Type      | Level            |
| ---------- | --------- | ---------------- |
| `parallel` | Directive | Inside a `stage` |

---

#### C. Matrix Stage

| Item     | Type      | Level            |
| -------- | --------- | ---------------- |
| `matrix` | Directive | Inside a `stage` |
| `axes`   | Directive | Inside matrix    |
| `stages` | Directive | Inside matrix    |

---

### 7Ô∏è‚É£ Step-Level (Actual Commands)

> These live **inside `steps {}`**

| Item                        | Type | Purpose          |
| --------------------------- | ---- | ---------------- |
| `sh / bat`                  | Step | Execute commands |
| `script`                    | Step | Full Groovy      |
| `withCredentials`           | Step | Secure secrets   |
| `stash / unstash`           | Step | Move artifacts   |
| `checkout`                  | Step | SCM checkout     |
| `junit`, `archiveArtifacts` | Step | Reports          |

---

### 8Ô∏è‚É£ Custom / Shared Library Layer

| Item               | Type            | Where used        |
| ------------------ | --------------- | ----------------- |
| `notifications {}` | Custom wrapper  | `post` or `steps` |
| `deployApp()`      | Shared lib step | `steps`           |
| `slackNotify()`    | Shared lib step | `post`            |

---

## üéûÔ∏è Visual Hierarchy (Memorize This)

```groovy
@Library()

pipeline {
  agent
  options
  triggers
  parameters
  environment
  tools
  post

  stages {
    stage {
      agent
      when
      options
      environment
      tools
      input
      steps {
        script
        sh
        stash
      }
      post
    }

    stage {
      parallel { ... }
    }

    stage {
      matrix { ... }
    }
  }
}
```

---

## üìå 1. `agent` Directive ‚Äî Where the Stage or Pipeline Runs

> `agent` tells Jenkins **which machine**, **container**, or **pod** to use for execution.

---

### üü¶ Pipeline-Level Agent

```groovy
pipeline {
    agent any
}
```

Runs on **any available agent**.

---

**Use a Specific Agent Label:**

```groovy
agent { label 'linux' }
```

Jenkins will select agents tagged with `'linux'`.

---

### üéØ Stage-Specific Agent

You can override the pipeline agent per stage:

```groovy
stage('Build Java') {
    agent { docker { image 'maven:3.9' } }
    steps { sh 'mvn package' }
}
```

Different stages ‚Üí Different environments ‚Üí Super powerful.

---

### **üê≥ Run Pipeline Inside a Docker Container:**

<div align="center" style="background-color:#fff; border-radius: 10px; border: 2px solid">
   <img src="image/1_XdrN753FgzRuMI4YDOVu2w.png" alt="GitHub Actions Matrix Build" style="width: 80%">
</div>

---

```groovy
agent {
    docker {
        image 'node:18'
        args '-u root'
    }
}
```

Now every stage runs inside a Node.js 18 container.

### **‚òÅÔ∏è Kubernetes Ephemeral Agent (Most Modern):**

<div align="center" style="background-color:#EDEFF0; border-radius: 10px; border: 2px solid">
   <img src="image/jenkins-agent-1.gif" alt="GitHub Actions Matrix Build" style="width: 60%">
</div>

---

```groovy
agent {
    kubernetes {
        yamlFile 'k8s/jenkins-pod.yaml'
    }
}
```

Creates a **pod per build** ‚Äî scalable and cloud-native.

---

## üìå 2. `environment` Directive ‚Äî Define Environment Variables

> Used to define:
>
> - ‚úî global environment variables
> - ‚úî stage-specific variables
> - ‚úî credential bindings
> - ‚úî computed variables

---

### üåç Global Variables

```groovy
environment {
    APP_ENV = 'dev'
    REGION = 'us-east-1'
}
```

---

### üßÆ Dynamic Variables

```groovy
environment {
    VERSION = "${env.BUILD_NUMBER}"
}
```

---

### üîê Inject Credentials

```groovy
environment {
    API_KEY = credentials('my-api-key')
}
```

Now `API_KEY` appears as environment variable in steps.

---

### üéØ Stage-Level Environment Variables

```groovy
stage('Deploy') {
    environment {
        ENV = 'production'
    }
    steps {
        sh 'echo Deploying to $ENV'
    }
}
```

---

## üìå 3. `post` Directive ‚Äî Runs After the Pipeline or Stage

> `post` defines **actions** after a stage or whole pipeline finishes.

---

### ‚≠ê Pipeline-Level Post Actions

```groovy
post {
    success {
        echo "Build succeeded!"
    }
    failure {
        echo "Build failed!"
    }
    always {
        cleanWs()
    }
}
```

---

### üß™ Publish Reports on Build Completion

```groovy
post {
    always {
        junit '**/target/surefire-reports/*.xml'
    }
}
```

---

### üîî Notify on Failure (Email/Slack)

```groovy
post {
    failure {
        slackSend message: "Build FAILED"
    }
}
```

---

## üìå 4. `notifications` (Custom Pattern)

> This is often implemented using shared libraries.

---

### üåü Real Example (Using Shared Library)

`vars/notifySlack.groovy`

```groovy
def call(String msg) {
    slackSend(message: msg, color: '#FF0000')
}
```

Usage:

```groovy
notifications {
    notifySlack("Build completed for ${env.JOB_NAME}")
}
```

This is NOT a Jenkins core directive but is widely used in enterprise pipelines.

---

## üìå 5. `script` Block ‚Äî Run Groovy Code Inside Declarative Pipeline

> Used when you need **full Groovy power** inside a Declarative pipeline.

---

### ‚≠ê Example 1: Loop Through Microservices

```groovy
stage('Build Services') {
    steps {
        script {
            def services = ['auth', 'billing', 'orders']
            services.each { svc ->
                sh "docker build -t myapp/${svc}:latest ${svc}/"
            }
        }
    }
}
```

---

### ‚≠ê Example 2: Conditional Logic

```groovy
script {
    if (env.BRANCH_NAME == 'main') {
        deployToProd()
    } else {
        echo "Skipping production deployment"
    }
}
```

---

### ‚≠ê Example 3: Return Values

```groovy
script {
    def version = sh(script: "cat version.txt", returnStdout: true).trim()
    echo "Version is $version"
}
```

---

## üìå 6. `when` Directive ‚Äî Conditional Stage Execution

> Determines **WHEN** a stage should run.

---

### ‚≠ê Example 1: Run Only on Main Branch

```groovy
stage('Deploy to Prod') {
    when { branch 'main' }
    steps { sh './deploy-prod.sh' }
}
```

---

### ‚≠ê Example 2: Run When File Changes

```groovy
when { changeset "**/*.java" }
```

---

### ‚≠ê Example 3: Run Only When Manual Trigger

```groovy
when { buildingTag() }
```

---

### ‚≠ê Example 4: Multiple Conditions

```groovy
when {
    allOf {
        branch 'main'
        environment name: 'READY', value: 'true'
    }
}
```

---

## üìå 7. `input` Directive ‚Äî Human Approval / Manual Gates

> Used for:
>
> - ‚úî deployment approvals
> - ‚úî manual QA verification
> - ‚úî promotion workflows

---

### ‚≠ê Example 1: Basic Approval

```groovy
stage('Approval') {
    steps {
        input "Deploy to Production?"
    }
}
```

---

### ‚≠ê Example 2: Approve with Parameters

```groovy
input message: "Approve deploy?", parameters: [
    string(name: "TAG", defaultValue: "latest")
]
```

---

### ‚≠ê Example 3: Approvers Only

```groovy
input message: "Continue?", submitter: 'team-lead'
```

---

## üìå 8. `parameters` Directive ‚Äî Pass Values to the Pipeline

> Used to customize pipeline behavior.

---

### ‚≠ê String Parameter

```groovy
parameters {
    string(name: 'ENV', defaultValue: 'dev')
}
```

---

### ‚≠ê Choice Parameter

```groovy
parameters {
    choice(name: 'ACTION', choices: ['build', 'deploy'])
}
```

---

### ‚≠ê Boolean Parameter

```groovy
parameters {
    booleanParam(name: 'RUN_TESTS', defaultValue: true)
}
```

---

### ‚≠ê Full Example

```groovy
stage("Deploy") {
    when { expression { params.ENV == 'prod' } }
    steps {
        sh "./deploy.sh ${params.ENV}"
    }
}
```

---

## üìå 9. `credentials` Directive ‚Äî Secure Access in Pipelines

> Credentials must NEVER be hard-coded.

---

### ‚≠ê Example 1: Username/Password

```groovy
steps {
    withCredentials([usernamePassword(
        credentialsId: 'docker-creds',
        usernameVariable: 'USER',
        passwordVariable: 'PASS'
    )]) {
        sh "docker login -u $USER -p $PASS"
    }
}
```

---

### ‚≠ê Example 2: Secret Text

```groovy
withCredentials([string(credentialsId: 'api-secret', variable: 'TOKEN')]) {
    sh "curl -H 'Authorization: Bearer $TOKEN' https://api.com/data"
}
```

---

### ‚≠ê Example 3: SSH Key

```groovy
sshagent(['github-key']) {
    sh "git pull"
}
```

---

## üìå 10. `stash` & `unstash` ‚Äî Sharing Files Between Stages/Agents

> Use them when:
>
> - ‚úî build and test stages run on **different agents**
> - ‚úî you need to pass artifacts between stages

---

### ‚≠ê Example: Build on Linux ‚Üí Test on Windows

```groovy
stage('Build') {
    agent { label 'linux' }
    steps {
        sh 'mvn package'
        stash includes: 'target/*.jar', name: 'app'
    }
}

stage('Test') {
    agent { label 'windows' }
    steps {
        unstash 'app'
        bat 'java -jar target/app.jar'
    }
}
```

---

### üëç Best Practice

Name your stashes clearly ‚Üí reduces debugging pain.

---

## üìå 11. `parallel` Directive ‚Äî Run Stages at the Same Time

> Use when:
>
> - ‚úî running multiple test suites
> - ‚úî building microservices
> - ‚úî speeding up CI by 50‚Äì80%

---

<div align="center" style="background-color:#fff; border-radius: 10px; border: 2px solid">
   <img src="image/1765392111920.png" alt="GitHub Actions Matrix Build" style="width: 80%">
</div>

<div align="center" style="background-color:#fff; border-radius: 10px; border: 2px solid">
   <img src="image/1765392122236.png" alt="GitHub Actions Matrix Build" style="width: 80%">
</div>

---

### ‚≠ê Example 1: Parallel Tests

```groovy
stage('Tests') {
    parallel {
        Unit: { sh 'npm run test:unit' }
        Integration: { sh 'npm run test:integration' }
        UI: { sh 'npm run test:ui' }
    }
}
```

---

### ‚≠ê Example 2: Build 3 Microservices in Parallel

```groovy
stage('Build Services') {
    parallel {
        ServiceA: { sh 'docker build -t a . ' }
        ServiceB: { sh 'docker build -t b . ' }
        ServiceC: { sh 'docker build -t c . ' }
    }
}
```

---

### ‚≠ê Example 3: Parallel with Fail-Fast

```groovy
parallel failFast: true, branches: [
    Unit: { sh 'npm test' },
    Lint: { sh 'npm run lint' }
]
```

---

## üéØ Final Summary Table

<div align="center" style="background-color: #192730ff; border-radius: 5px; border: 2px solid">

| Directive       | Purpose                           | Real Use Cases                         |
| --------------- | --------------------------------- | -------------------------------------- |
| `agent`         | Where pipeline/stage runs         | Docker, Kubernetes, node labels        |
| `environment`   | Define environment variables      | Versions, credentials, flags           |
| `post`          | Actions after success/failure     | Cleanup, Slack alerts, test reports    |
| `notifications` | Custom wrappers for notifications | Slack, email from shared libs          |
| `script`        | Full Groovy logic                 | Loops, conditions, dynamic commands    |
| `when`          | Conditional execution             | Run only on main branch, tags, changes |
| `input`         | Manual approval                   | Deployments, QA validation             |
| `parameters`    | User inputs before build          | ENV selection, actions                 |
| `credentials`   | Secure secrets                    | API keys, Docker login, SSH keys       |
| `stash/unstash` | Move files across agents          | Build in Linux ‚Üí Test in Windows       |
| `parallel`      | Execute tasks concurrently        | Parallel tests, microservices builds   |

---

</div>

# ğŸ§© Jenkins Pipeline Directives

Each Jenkinsfile is built from **directives** â€” the structured components that describe HOW the pipeline behaves.

We cover:

1. `agent`
2. `environment`
3. `post`
4. `notifications`
5. `script` block
6. `when`
7. `input`
8. `parameters`
9. `credentials`
10. `stash` / `unstash`
11. `parallel`

Letâ€™s go **one by one**, in your preferred enhanced style.

---

## ğŸ“Œ 1. `agent` Directive â€” Where the Stage or Pipeline Runs

> `agent` tells Jenkins **which machine**, **container**, or **pod** to use for execution.

---

### ğŸŸ¦ Pipeline-Level Agent

```groovy
pipeline {
    agent any
}
```

Runs on **any available agent**.

---

**Use a Specific Agent Label:**

```groovy
agent { label 'linux' }
```

Jenkins will select agents tagged with `'linux'`.

---

### ğŸ¯ Stage-Specific Agent

You can override the pipeline agent per stage:

```groovy
stage('Build Java') {
    agent { docker { image 'maven:3.9' } }
    steps { sh 'mvn package' }
}
```

Different stages â†’ Different environments â†’ Super powerful.

---

### **ğŸ³ Run Pipeline Inside a Docker Container:**

<div align="center" style="background-color:#fff; border-radius: 10px; border: 2px solid">
   <img src="image/1_XdrN753FgzRuMI4YDOVu2w.png" alt="GitHub Actions Matrix Build" style="width: 80%">
</div>

---

```groovy
agent {
    docker {
        image 'node:18'
        args '-u root'
    }
}
```

Now every stage runs inside a Node.js 18 container.

### **â˜ï¸ Kubernetes Ephemeral Agent (Most Modern):**

<div align="center" style="background-color:#EDEFF0; border-radius: 10px; border: 2px solid">
   <img src="image/jenkins-agent-1.gif" alt="GitHub Actions Matrix Build" style="width: 60%">
</div>

---

```groovy
agent {
    kubernetes {
        yamlFile 'k8s/jenkins-pod.yaml'
    }
}
```

Creates a **pod per build** â€” scalable and cloud-native.

---

## ğŸ“Œ 2. `environment` Directive â€” Define Environment Variables

> Used to define:
>
> - âœ” global environment variables
> - âœ” stage-specific variables
> - âœ” credential bindings
> - âœ” computed variables

---

### ğŸŒ Global Variables

```groovy
environment {
    APP_ENV = 'dev'
    REGION = 'us-east-1'
}
```

---

### ğŸ§® Dynamic Variables

```groovy
environment {
    VERSION = "${env.BUILD_NUMBER}"
}
```

---

### ğŸ” Inject Credentials

```groovy
environment {
    API_KEY = credentials('my-api-key')
}
```

Now `API_KEY` appears as environment variable in steps.

---

### ğŸ¯ Stage-Level Environment Variables

```groovy
stage('Deploy') {
    environment {
        ENV = 'production'
    }
    steps {
        sh 'echo Deploying to $ENV'
    }
}
```

---

## ğŸ“Œ 3. `post` Directive â€” Runs After the Pipeline or Stage

> `post` defines **actions** after a stage or whole pipeline finishes.

---

### â­ Pipeline-Level Post Actions

```groovy
post {
    success {
        echo "Build succeeded!"
    }
    failure {
        echo "Build failed!"
    }
    always {
        cleanWs()
    }
}
```

---

### ğŸ§ª Publish Reports on Build Completion

```groovy
post {
    always {
        junit '**/target/surefire-reports/*.xml'
    }
}
```

---

### ğŸ”” Notify on Failure (Email/Slack)

```groovy
post {
    failure {
        slackSend message: "Build FAILED"
    }
}
```

---

## ğŸ“Œ 4. `notifications` (Custom Pattern)

> This is often implemented using shared libraries.

---

### ğŸŒŸ Real Example (Using Shared Library)

`vars/notifySlack.groovy`

```groovy
def call(String msg) {
    slackSend(message: msg, color: '#FF0000')
}
```

Usage:

```groovy
notifications {
    notifySlack("Build completed for ${env.JOB_NAME}")
}
```

This is NOT a Jenkins core directive but is widely used in enterprise pipelines.

---

## ğŸ“Œ 5. `script` Block â€” Run Groovy Code Inside Declarative Pipeline

> Used when you need **full Groovy power** inside a Declarative pipeline.

---

### â­ Example 1: Loop Through Microservices

```groovy
stage('Build Services') {
    steps {
        script {
            def services = ['auth', 'billing', 'orders']
            services.each { svc ->
                sh "docker build -t myapp/${svc}:latest ${svc}/"
            }
        }
    }
}
```

---

### â­ Example 2: Conditional Logic

```groovy
script {
    if (env.BRANCH_NAME == 'main') {
        deployToProd()
    } else {
        echo "Skipping production deployment"
    }
}
```

---

### â­ Example 3: Return Values

```groovy
script {
    def version = sh(script: "cat version.txt", returnStdout: true).trim()
    echo "Version is $version"
}
```

---

## ğŸ“Œ 6. `when` Directive â€” Conditional Stage Execution

> Determines **WHEN** a stage should run.

---

### â­ Example 1: Run Only on Main Branch

```groovy
stage('Deploy to Prod') {
    when { branch 'main' }
    steps { sh './deploy-prod.sh' }
}
```

---

### â­ Example 2: Run When File Changes

```groovy
when { changeset "**/*.java" }
```

---

### â­ Example 3: Run Only When Manual Trigger

```groovy
when { buildingTag() }
```

---

### â­ Example 4: Multiple Conditions

```groovy
when {
    allOf {
        branch 'main'
        environment name: 'READY', value: 'true'
    }
}
```

---

## ğŸ“Œ 7. `input` Directive â€” Human Approval / Manual Gates

> Used for:
>
> - âœ” deployment approvals
> - âœ” manual QA verification
> - âœ” promotion workflows

---

### â­ Example 1: Basic Approval

```groovy
stage('Approval') {
    steps {
        input "Deploy to Production?"
    }
}
```

---

### â­ Example 2: Approve with Parameters

```groovy
input message: "Approve deploy?", parameters: [
    string(name: "TAG", defaultValue: "latest")
]
```

---

### â­ Example 3: Approvers Only

```groovy
input message: "Continue?", submitter: 'team-lead'
```

---

## ğŸ“Œ 8. `parameters` Directive â€” Pass Values to the Pipeline

> Used to customize pipeline behavior.

---

### â­ String Parameter

```groovy
parameters {
    string(name: 'ENV', defaultValue: 'dev')
}
```

---

### â­ Choice Parameter

```groovy
parameters {
    choice(name: 'ACTION', choices: ['build', 'deploy'])
}
```

---

### â­ Boolean Parameter

```groovy
parameters {
    booleanParam(name: 'RUN_TESTS', defaultValue: true)
}
```

---

### â­ Full Example

```groovy
stage("Deploy") {
    when { expression { params.ENV == 'prod' } }
    steps {
        sh "./deploy.sh ${params.ENV}"
    }
}
```

---

## ğŸ“Œ 9. `credentials` Directive â€” Secure Access in Pipelines

> Credentials must NEVER be hard-coded.

---

### â­ Example 1: Username/Password

```groovy
steps {
    withCredentials([usernamePassword(
        credentialsId: 'docker-creds',
        usernameVariable: 'USER',
        passwordVariable: 'PASS'
    )]) {
        sh "docker login -u $USER -p $PASS"
    }
}
```

---

### â­ Example 2: Secret Text

```groovy
withCredentials([string(credentialsId: 'api-secret', variable: 'TOKEN')]) {
    sh "curl -H 'Authorization: Bearer $TOKEN' https://api.com/data"
}
```

---

### â­ Example 3: SSH Key

```groovy
sshagent(['github-key']) {
    sh "git pull"
}
```

---

## ğŸ“Œ 10. `stash` & `unstash` â€” Sharing Files Between Stages/Agents

> Use them when:
>
> - âœ” build and test stages run on **different agents**
> - âœ” you need to pass artifacts between stages

---

### â­ Example: Build on Linux â†’ Test on Windows

```groovy
stage('Build') {
    agent { label 'linux' }
    steps {
        sh 'mvn package'
        stash includes: 'target/*.jar', name: 'app'
    }
}

stage('Test') {
    agent { label 'windows' }
    steps {
        unstash 'app'
        bat 'java -jar target/app.jar'
    }
}
```

---

### ğŸ‘ Best Practice

Name your stashes clearly â†’ reduces debugging pain.

---

## ğŸ“Œ 11. `parallel` Directive â€” Run Stages at the Same Time

> Use when:
>
> - âœ” running multiple test suites
> - âœ” building microservices
> - âœ” speeding up CI by 50â€“80%

---

<div align="center" style="background-color:#fff; border-radius: 10px; border: 2px solid">
   <img src="image/1765392111920.png" alt="GitHub Actions Matrix Build" style="width: 80%">
</div>

<div align="center" style="background-color:#fff; border-radius: 10px; border: 2px solid">
   <img src="image/1765392122236.png" alt="GitHub Actions Matrix Build" style="width: 80%">
</div>

---

### â­ Example 1: Parallel Tests

```groovy
stage('Tests') {
    parallel {
        Unit: { sh 'npm run test:unit' }
        Integration: { sh 'npm run test:integration' }
        UI: { sh 'npm run test:ui' }
    }
}
```

---

### â­ Example 2: Build 3 Microservices in Parallel

```groovy
stage('Build Services') {
    parallel {
        ServiceA: { sh 'docker build -t a . ' }
        ServiceB: { sh 'docker build -t b . ' }
        ServiceC: { sh 'docker build -t c . ' }
    }
}
```

---

### â­ Example 3: Parallel with Fail-Fast

```groovy
parallel failFast: true, branches: [
    Unit: { sh 'npm test' },
    Lint: { sh 'npm run lint' }
]
```

---

## ğŸ¯ Final Summary Table

<div align="center" style="background-color: #192730ff; border-radius: 5px; border: 2px solid">

| Directive       | Purpose                           | Real Use Cases                         |
| --------------- | --------------------------------- | -------------------------------------- |
| `agent`         | Where pipeline/stage runs         | Docker, Kubernetes, node labels        |
| `environment`   | Define environment variables      | Versions, credentials, flags           |
| `post`          | Actions after success/failure     | Cleanup, Slack alerts, test reports    |
| `notifications` | Custom wrappers for notifications | Slack, email from shared libs          |
| `script`        | Full Groovy logic                 | Loops, conditions, dynamic commands    |
| `when`          | Conditional execution             | Run only on main branch, tags, changes |
| `input`         | Manual approval                   | Deployments, QA validation             |
| `parameters`    | User inputs before build          | ENV selection, actions                 |
| `credentials`   | Secure secrets                    | API keys, Docker login, SSH keys       |
| `stash/unstash` | Move files across agents          | Build in Linux â†’ Test in Windows       |
| `parallel`      | Execute tasks concurrently        | Parallel tests, microservices builds   |

</div>

---

## ğŸ‰ You're Now a Jenkins Directive Expert!

If you want, I can also create:

ğŸ”¥ A **mega Jenkinsfile** showing ALL directives together
ğŸ”¥ A **real CI/CD pipeline for Java, Node.js, .NET, or Python**
ğŸ”¥ A **Jenkins best practices cheat sheet for interviews**
ğŸ”¥ A **Jenkins + Kubernetes pipeline with real YAML**

What would you like next?

# ğŸš€ End-to-End Example: Modular, Multi-Repo CI/CD Pipeline Using Reusable Workflows

## ğŸ¯ Goal

Weâ€™ll design a full CI/CD architecture with **three repositories** and **centralized workflows**, allowing every team to reuse common build, test, deploy, and notify logic without code duplication.

---

<div align="center" style="background:#343739ff; border-radius:20px">

```mermaid
graph TD
    A["ğŸ‘©â€ğŸ’» Dev pushes code to Repo A (API)"]
    B["ğŸ—ï¸ Build Workflow (Reusable)"]
    C["ğŸ§ª Test Workflow (Reusable)"]
    D["ğŸš€ Deploy Workflow (Reusable)"]
    E["ğŸ”” Notify Workflow (Reusable)"]
    F["ğŸ’¬ Slack / Teams Notification"]

    A --> B --> C --> D --> E --> F
```

</div>

---

## ğŸ§± Project Architecture Overview

<div align="center" style="background:#343739ff; border-radius:20px">

| Repository         | Purpose                  | Contains                                            |
| ------------------ | ------------------------ | --------------------------------------------------- |
| **`.github`**      | Central shared workflows | `build.yml`, `test.yml`, `deploy.yml`, `notify.yml` |
| **`webapp`**       | Frontend app             | Calls reusable workflows                            |
| **`api-service`**  | Backend API              | Calls reusable workflows                            |
| **`infra-deploy`** | Infrastructure as Code   | Calls deploy workflow with environment matrix       |

</div>

---

## ğŸ—ï¸ Step 1 â€” The Shared Workflow Repository (`acme-org/.github`)

### ğŸ§© build.yml

```yaml
name: ğŸ—ï¸ Build Reusable Workflow

on:
  workflow_call:
    inputs:
      node-version:
        required: true
        type: string
    secrets:
      GITHUB_TOKEN:
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: npm

      - name: Install & Build
        run: |
          npm ci
          npm run build

      - name: ğŸ“¦ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ github.run_id }}
          path: dist/
```

---

### ğŸ§© test.yml

```yaml
name: ğŸ§ª Test Reusable Workflow

on:
  workflow_call:
    secrets:
      GITHUB_TOKEN:
        required: true
    outputs:
      test-result:
        value: ${{ jobs.test.outputs.result }}

jobs:
  test:
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.tests.outputs.result }}
    steps:
      - uses: actions/checkout@v4

      - name: Run Unit Tests
        id: tests
        run: |
          npm test -- --json --outputFile=report.json
          echo "result=passed" >> $GITHUB_OUTPUT
```

---

### ğŸ§© deploy.yml

```yaml
name: ğŸš€ Deploy Reusable Workflow

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
    secrets:
      DEPLOY_KEY:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: build-${{ github.run_id }}

      - name: Deploy to Environment
        run: |
          echo "Deploying to ${{ inputs.environment }}"
          echo "Using key: ${{ secrets.DEPLOY_KEY:0:4 }}***"
```

---

### ğŸ§© notify.yml

```yaml
name: ğŸ”” Notify Reusable Workflow

on:
  workflow_call:
    inputs:
      status:
        required: true
        type: string

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack Message
        run: |
          echo "Deployment ${{ inputs.status }} âœ…"
```

---

## ğŸ§© Step 2 â€” The API Service Repo (`acme-org/api-service`)

ğŸ“„ `.github/workflows/main.yml`

```yaml
name: ğŸ§© API Service CI/CD

on:
  push:
    branches: [main]

jobs:
  build:
    uses: acme-org/.github/.github/workflows/build.yml@v2
    with:
      node-version: 20
    secrets:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test:
    needs: build
    uses: acme-org/.github/.github/workflows/test.yml@v2
    secrets:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy:
    needs: test
    if: ${{ needs.test.outputs.test-result == 'passed' }}
    uses: acme-org/.github/.github/workflows/deploy.yml@v2
    with:
      environment: production
    secrets:
      DEPLOY_KEY: ${{ secrets.PROD_DEPLOY_KEY }}

  notify:
    needs: [deploy]
    uses: acme-org/.github/.github/workflows/notify.yml@v2
    with:
      status: success
```

âœ… **Pipeline Flow:**

```ini
build â†’ test â†’ deploy â†’ notify
```

Each job calls a separate **reusable workflow** â€” clean, modular, and composable.

---

<div align="center" style="background:#343739ff; border-radius:20px">

```mermaid
sequenceDiagram
    participant Dev as ğŸ‘¨â€ğŸ’» Developer
    participant Repo as ğŸ“¦ api-service
    participant GH as âš™ï¸ GitHub Actions
    participant Shared as ğŸ—ï¸ .github Repo

    Dev->>Repo: push main
    Repo->>Shared: uses build.yml
    Shared-->>Repo: Build artifact
    Repo->>Shared: uses test.yml
    Shared-->>Repo: Test result = passed
    Repo->>Shared: uses deploy.yml
    Shared-->>Repo: Deploy success
    Repo->>Shared: uses notify.yml
    Shared-->>Repo: Slack notification âœ…
```

</div>

---

## âš™ï¸ Step 3 â€” Multi-Environment Matrix Example (Infrastructure Repo)

ğŸ“„ `acme-org/infra-deploy/.github/workflows/deploy-matrix.yml`

```yaml
name: ğŸ—ï¸ Infra Deploy Matrix

on:
  workflow_dispatch:

jobs:
  deploy:
    strategy:
      matrix:
        env: [dev, staging, prod]
    uses: acme-org/.github/.github/workflows/deploy.yml@v2
    with:
      environment: ${{ matrix.env }}
    secrets:
      DEPLOY_KEY: ${{ secrets.ORG_DEPLOY_KEY }}
```

âœ… This deploys to all environments **in parallel**, powered by the same shared workflow.

---

## ğŸ§  Step 4 â€” Handling Outputs Between Workflows

You can chain workflows by passing outputs through:

```yaml
build:
  uses: acme-org/.github/.github/workflows/build.yml@v2
  outputs:
    artifact: ${{ steps.build.outputs.artifact }}

deploy:
  needs: build
  uses: acme-org/.github/.github/workflows/deploy.yml@v2
  with:
    artifact-path: ${{ needs.build.outputs.artifact }}
```

---

## ğŸ§° Step 5 â€” Example: Cache, Artifact, and Conditional Deploy

Letâ€™s spice it up ğŸ˜

```yaml
jobs:
  build:
    uses: acme-org/.github/.github/workflows/build.yml@v2
    with:
      node-version: 20
    secrets:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy:
    needs: build
    if: github.ref == 'refs/heads/main'
    uses: acme-org/.github/.github/workflows/deploy.yml@v2
    with:
      environment: prod
    secrets:
      DEPLOY_KEY: ${{ secrets.PROD_DEPLOY_KEY }}
```

ğŸ’¡ Only deploys from `main` branch.
Artifacts and caching handled automatically via the shared logic.

---

## ğŸ§© Step 6 â€” Visualizing the Complete System

<div align="center" style="background:#343739ff; border-radius:20px">

```mermaid
graph TD
    subgraph ORG["ğŸ¢ acme-org"]
        GH["ğŸ§± .github (Shared Workflows)"]
        API["ğŸ“¦ api-service"]
        WEB["ğŸŒ webapp"]
        INFRA["ğŸ—ï¸ infra-deploy"]
    end

    API -->|uses build.yml| GH
    API -->|uses test.yml| GH
    API -->|uses deploy.yml| GH
    API -->|uses notify.yml| GH

    WEB -->|uses build.yml| GH
    WEB -->|uses test.yml| GH

    INFRA -->|uses deploy.yml| GH
```

</div>

Everything flows through the central `.github` repo â€” all pipelines inherit the same **quality, security, and deployment rules**.

---

## ğŸ” Step 7 â€” Governance with CODEOWNERS

In the `.github` repo:

```ini
# Only DevOps Team can modify shared workflows
.github/workflows/* @acme-org/devops-team
```

Ensures no one can modify core pipelines casually â€” strong governance âœ…

---

## ğŸŒ Step 8 â€” Notifications Integration

In `notify.yml`, you can extend to:

- Send Slack / Teams messages
- Create GitHub issue on failure
- Post webhook to monitoring service

Example:

```yaml
- name: Notify Slack
  uses: slackapi/slack-github-action@v2
  with:
    payload: |
      {
        "text": "âœ… Deployment to ${{ inputs.status }} succeeded!"
      }
  env:
    SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
```

---

## ğŸ§­ Step 9 â€” Version Control for Reusable Workflows

Tag each stable version:

```bash
git tag v1
git push origin v1
```

Then use:

```yaml
uses: acme-org/.github/.github/workflows/build.yml@v1
```

When you upgrade something (e.g., Node 21 or new cache logic), just:

```bash
git tag v2
```

ğŸ’¡ The entire org upgrades by switching `@v1` â†’ `@v2`.

---

## âœ… Benefits of This Architecture

<div align="center" style="background:#343739ff; border-radius:20px">

| Benefit          | Description                                        |
| ---------------- | -------------------------------------------------- |
| **Consistency**  | Every repo follows same build/test/deploy pattern  |
| **Simplicity**   | No need to maintain duplicate YAMLs                |
| **Scalability**  | Adding new services is effortless                  |
| **Security**     | Centralized secret and permission management       |
| **Auditability** | All workflow changes go through `.github` repo PRs |
| **Speed**        | Parallel, cached, artifact-based execution         |

</div>

---

## ğŸ’¬ TL;DR by Your Human Mentor

> Youâ€™ve officially built a **multi-repo GitHub Actions platform**.  
> Each repo just _calls a workflow_ â€” the same way a frontend calls an API.
>
> Reusable workflows are your DevOps microservices â€” composable, versioned, secure, and fast.
>
> ğŸ“ Congrats, youâ€™re now thinking like a **GitHub Actions Architect**. ğŸ§ âš™ï¸

---

<div align="center" style="background:#343739ff; border-radius:20px">

```mermaid
graph TD
    Dev["ğŸ‘©â€ğŸ’» Developer Push"]
    Build["ğŸ—ï¸ Build Workflow"]
    Test["ğŸ§ª Test Workflow"]
    Deploy["ğŸš€ Deploy Workflow"]
    Notify["ğŸ”” Notify Workflow"]
    Slack["ğŸ’¬ Slack Notification"]

    Dev --> Build --> Test --> Deploy --> Notify --> Slack
    classDef animate stroke-dasharray: 8,5,stroke-dashoffset: 900,animation: dash 25s linear infinite;
    class Dev,Build,Test,Deploy,Notify,Slack animate
```

</div>

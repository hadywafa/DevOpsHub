# ‚úçüèª **Hands-on: Matrix Workflow for Monorepo**

Let‚Äôs build a **single workflow** that:

- Builds **one image per service** in the monorepo
- Uses a **matrix over services**
- Pushes each image with tags:

  - `sha_full` ‚Üí `sha-<full_sha>`
  - `branch-short_sha` ‚Üí `<branch>-<short_sha>`
  - `branch-latest` ‚Üí `<branch>-latest` (only on branch pushes)
  - **SemVer tag** (when triggered by a **tag push**) ‚Üí `<git_tag>`

---

## 1Ô∏è‚É£ Assumed monorepo structure

```text
my-monorepo/
‚îú‚îÄ services/
‚îÇ  ‚îú‚îÄ api/
‚îÇ  ‚îÇ  ‚îú‚îÄ Dockerfile
‚îÇ  ‚îÇ  ‚îî‚îÄ ...
‚îÇ  ‚îú‚îÄ web/
‚îÇ  ‚îÇ  ‚îú‚îÄ Dockerfile
‚îÇ  ‚îÇ  ‚îî‚îÄ ...
‚îÇ  ‚îî‚îÄ worker/
‚îÇ     ‚îú‚îÄ Dockerfile
‚îÇ     ‚îî‚îÄ ...
‚îî‚îÄ .github/
   ‚îî‚îÄ workflows/
      ‚îî‚îÄ docker-ci.yml
```

Each service has its own `Dockerfile` in `services/<service>/Dockerfile`.

We‚Äôll assume you‚Äôre pushing to **Docker Hub** with secrets:

- `DOCKERHUB_USERNAME`
- `DOCKERHUB_TOKEN` (Personal Access Token / password)

You can easily adapt this to GHCR later.

---

## 2Ô∏è‚É£ Full workflow: build & push with matrix + multi-tags

Create: `.github/workflows/docker-ci.yml`

```yaml
name: Build & Push Docker Images (Monorepo)

on:
  push:
    branches:
      - main
      - develop
      - feature/**
    tags:
      - "v*.*.*" # semver tags, e.g. v1.2.3 (adjust as you like)

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        service: [api, web, worker] # list your services here

    env:
      REGISTRY: docker.io
      # final image name will be: docker.io/<DOCKERHUB_USERNAME>/<repo>-<service>
      REPO_NAME: myapp # change to your base repo name

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Prepare image name & tags
        id: meta
        run: |
          # base image name per service
          IMAGE_NAME="${{ env.REGISTRY }}/${{ secrets.DOCKERHUB_USERNAME }}/${{ env.REPO_NAME }}-${{ matrix.service }}"

          echo "Image name: $IMAGE_NAME"

          # full SHA
          FULL_SHA="${GITHUB_SHA}"
          SHORT_SHA="${GITHUB_SHA::7}"

          # ref type: branch or tag
          REF_TYPE="${GITHUB_REF_TYPE}"       # 'branch' or 'tag'
          REF_NAME="${GITHUB_REF_NAME}"       # branch name or tag name

          echo "REF_TYPE=${REF_TYPE}"
          echo "REF_NAME=${REF_NAME}"

          # sanitize branch name for tag usage (lowercase, replace / with -)
          if [ "${REF_TYPE}" = "branch" ]; then
            BRANCH_RAW="${REF_NAME}"
          else
            # for tag pushes, the "branch" concept doesn't make sense
            BRANCH_RAW=""
          fi

          if [ -n "${BRANCH_RAW}" ]; then
            BRANCH_SAFE=$(echo "${BRANCH_RAW}" | tr '[:upper:]' '[:lower:]' | tr '/_' '-')
          else
            BRANCH_SAFE=""
          fi

          echo "BRANCH_SAFE=${BRANCH_SAFE}"

          # start building tags list
          TAGS=""

          # 1) sha_full
          TAGS+="${IMAGE_NAME}:sha-${FULL_SHA}"

          # 2) branch-short_sha (only if branch)
          if [ -n "${BRANCH_SAFE}" ]; then
            TAGS+=$'\n'"${IMAGE_NAME}:${BRANCH_SAFE}-${SHORT_SHA}"
          fi

          # 3) branch-latest (only if branch)
          if [ -n "${BRANCH_SAFE}" ]; then
            TAGS+=$'\n'"${IMAGE_NAME}:${BRANCH_SAFE}-latest"
          fi

          # 4) Semver tag if this is a tag push (e.g. v1.2.3)
          if [ "${REF_TYPE}" = "tag" ]; then
            VERSION_TAG="${REF_NAME}"   # e.g. v1.2.3
            TAGS+=$'\n'"${IMAGE_NAME}:${VERSION_TAG}"

            # optional: also create a tag without the leading 'v'
            if [[ "${VERSION_TAG}" == v* ]]; then
              PLAIN_VERSION="${VERSION_TAG#v}"   # remove leading v
              TAGS+=$'\n'"${IMAGE_NAME}:${PLAIN_VERSION}"
            fi
          fi

          echo "Generated tags:"
          echo "${TAGS}"

          # expose to other steps
          {
            echo "image=${IMAGE_NAME}"
            echo "tags<<EOF"
            echo "${TAGS}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ./services/${{ matrix.service }}
          file: ./services/${{ matrix.service }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          # optionally: buildx cache
          # cache-from: type=gha
          # cache-to: type=gha,mode=max
```

---

## 3Ô∏è‚É£ What this workflow actually does

For **each service** in `[api, web, worker]`:

### üß± Image naming

Image name per service:

```text
docker.io/<DOCKERHUB_USERNAME>/myapp-<service>
```

Examples (for `DOCKERHUB_USERNAME = ahmed` and `service = api`):

- `docker.io/ahmed/myapp-api`
- `docker.io/ahmed/myapp-web`
- `docker.io/ahmed/myapp-worker`

---

### üè∑ Tags on a branch push (e.g. push to `feature/new-api`)

Assume:

- Branch name: `feature/new-api`
- Full SHA: `1234567890abcdef...`
- Short SHA: `1234567`
- Service: `api`

Sanitized branch:

```text
feature-new-api
```

Tags:

- `sha_full`:
  `docker.io/ahmed/myapp-api:sha-1234567890abcdef...`
- `branch-short_sha`:
  `docker.io/ahmed/myapp-api:feature-new-api-1234567`
- `branch-latest`:
  `docker.io/ahmed/myapp-api:feature-new-api-latest`

Same pattern for `web`, `worker`.

---

### üè∑ Tags on a SemVer tag push (e.g. `v1.2.3`)

Trigger: `git push origin v1.2.3`

For each service (`api`, `web`, `worker`), you get:

- `sha_full`:
  `docker.io/ahmed/myapp-api:sha-1234567890abcdef...`
- `branch-short_sha` and `branch-latest` ‚Üí **skipped**
  (because here `REF_TYPE=tag`, no branch context)
- `semver tags`:

  - `docker.io/ahmed/myapp-api:v1.2.3`
  - `docker.io/ahmed/myapp-api:1.2.3` (if original tag starts with `v`)

You can later pull:

```bash
docker pull docker.io/ahmed/myapp-api:v1.2.3
docker pull docker.io/ahmed/myapp-api:1.2.3
```

---

## 4Ô∏è‚É£ Adapting / Tweaking

- **Change services list**
  In `matrix.service`, add/remove services as needed:

  ```yaml
  matrix:
    service: [api, web, worker, billing, notifications]
  ```

- **Change repo base name**

  ```yaml
  env:
    REPO_NAME: myapp-prod # will become myapp-prod-api, myapp-prod-web, ...
  ```

- **Use GHCR instead of Docker Hub**

  - Set `REGISTRY: ghcr.io`
  - Image name becomes `ghcr.io/<owner>/<repo>-<service>`
  - Use `GITHUB_TOKEN` for login

If you want, next step we can:

- Convert this to **GHCR** version
- Or adapt to your **exact** monorepo naming convention and registry (e.g. `company/app/service`).

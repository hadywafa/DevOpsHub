# ğŸ§± DynamoDB Local Secondary Index (LSI) â€“ SQL-Friendly Deep Dive

As a SQL veteran, you're used to index pages, clustered/non-clustered layouts, and precise I/O control. DynamoDB takes a different approach but offers indexing superpowers if you understand the internal layout.

This guide walks through the full data layout for a table using **LSI** â€” starting from the original item layout, then showing how the partition data looks when using each `ProjectionType`: `KEYS_ONLY`, `INCLUDE`, and `ALL`.

---

## ğŸ—‚ï¸ Original Base Table Layout (No Index Yet)

We'll use a sample `Orders` table:

### ğŸ”¹ Table Schema

- **Partition Key:** `CustomerID`
- **Sort Key:** `OrderID`
- **Attributes:** `OrderDate`, `TotalAmount`

### ğŸ”¢ Sample Items

```txt
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ—‚ Base Table View (sorted by OrderID)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[ORD-001] â†’ {
    CustomerID: User123,
    OrderID: ORD-001,
    OrderDate: 2024-03-09,
    TotalAmount: $250
}

[ORD-002] â†’ {
    CustomerID: User123,
    OrderID: ORD-002,
    OrderDate: 2024-03-08,
    TotalAmount: $120
}

[ORD-003] â†’ {
    CustomerID: User123,
    OrderID: ORD-003,
    OrderDate: 2024-03-07,
    TotalAmount: $300
}
```

ğŸ§  Without any LSI, you can only **query using the base sort key** `OrderID`. Sorting/filtering by `OrderDate` requires a **full table scan**.

---

## ğŸ”„ Adding an LSI: Sorted by `OrderDate`

All LSIs:

- Must be defined at table creation
- Share the same **partition key** (`CustomerID`)
- Use a different **sort key** (here: `OrderDate`)
- Are stored **in the same partition**, but with different internal layouts based on projection

---

## ğŸ” Partition View: `ProjectionType: KEYS_ONLY`

### ğŸ”¹ Whatâ€™s stored?

- `CustomerID` (PK)
- `OrderDate` (alternate sort key)

```text
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ—‚ Base Table View (sorted by OrderID)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
....etc
....etc
....etc
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ—‚ LSI: OrderDateIndex (KEYS_ONLY)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Partition: User123
  â”œâ”€â”€ 2024-03-07 â†’ { CustomerID: User123, OrderDate: 2024-03-07 }
  â”œâ”€â”€ 2024-03-08 â†’ { CustomerID: User123, OrderDate: 2024-03-08 }
  â””â”€â”€ 2024-03-09 â†’ { CustomerID: User123, OrderDate: 2024-03-09 }
```

ğŸ“Œ Youâ€™ll **need to read from base table** to fetch other fields like `OrderID`, `TotalAmount`.

---

## ğŸ” Partition View: `ProjectionType: INCLUDE`

### ğŸ”¹ Whatâ€™s stored?

- `CustomerID`, `OrderDate`
- Only selected fields (e.g., `TotalAmount`)

```json
"Projection": {
  "ProjectionType": "INCLUDE",
  "NonKeyAttributes": ["TotalAmount"]
}
```

```text
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ—‚ Base Table View (sorted by OrderID)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
....etc
....etc
....etc
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ—‚ LSI: OrderDateIndex (INCLUDE: TotalAmount)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Partition: User123
  â”œâ”€â”€ 2024-03-07 â†’ { CustomerID: User123, OrderDate: 2024-03-07, TotalAmount: 300 }
  â”œâ”€â”€ 2024-03-08 â†’ { CustomerID: User123, OrderDate: 2024-03-08, TotalAmount: 120 }
  â””â”€â”€ 2024-03-09 â†’ { CustomerID: User123, OrderDate: 2024-03-09, TotalAmount: 250 }
```

ğŸ“Œ You can get `TotalAmount` **from the index**, but still need a **second read** if you want `OrderID`.

---

## ğŸ” Partition View: `ProjectionType: ALL`

### ğŸ”¹ Whatâ€™s stored?

- **Everything**: Full item copy from base table

```text
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ—‚ Base Table View (sorted by OrderID)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
....etc
....etc
....etc
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ—‚ LSI: OrderDateIndex (ALL)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Partition: User123
  â”œâ”€â”€ 2024-03-07 â†’ {
        CustomerID: User123,
        OrderID: ORD-003,
        OrderDate: 2024-03-07,
        TotalAmount: 300
      }
  â”œâ”€â”€ 2024-03-08 â†’ {
        CustomerID: User123,
        OrderID: ORD-002,
        OrderDate: 2024-03-08,
        TotalAmount: 120
      }
  â””â”€â”€ 2024-03-09 â†’ {
        CustomerID: User123,
        OrderID: ORD-001,
        OrderDate: 2024-03-09,
        TotalAmount: 250
      }
```

ğŸ“Œ Everything you need is **available directly from the LSI**. No extra read required â€” but you're storing more.

---

## ğŸ§  Summary Table: LSI Projection Options

| Projection Type | Whatâ€™s Stored in Index            | Need Base Table Read?     | Ideal For...                       |
| --------------- | --------------------------------- | ------------------------- | ---------------------------------- |
| `KEYS_ONLY`     | Only PK + LSI Sort Key            | âœ… Yes                    | Minimal storage                    |
| `INCLUDE`       | Keys + selected attributes        | âŒ No (if attrs included) | Filtering with limited fields      |
| `ALL`           | Full copy of item from base table | âŒ No                     | Fast reads at cost of more storage |

---

## ğŸ§¬ Internals for SQL Folks (ğŸ‘€ Real Talk)

ğŸ”¸ Think of LSI as **non-clustered indexes** in SQL â€” **copying key columns and optionally data columns**, but not the entire table.

ğŸ”¸ Difference: LSI lives **inside the partition** of the base table â€” itâ€™s not a separate index file like SQL.

ğŸ”¸ Yes, in `ALL` projection, **Dynamo duplicates data inside the same partition** â€” itâ€™s a tradeoff between speed and space.

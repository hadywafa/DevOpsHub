# âš™ï¸ **AWS SSM Run Command**

_â€œRun commands on thousands of machines â€” without ever touching SSH.â€!_

---

## ğŸ” **What Is Run Command?**

> **Run Command** is a core feature of AWS Systems Manager that lets you **remotely and securely execute scripts/commands** on **EC2 instances**, **on-prem servers**, and **hybrid machines** â€” at scale and **without opening ports or using SSH/RDP**.

---

## ğŸ§  **How It Works Internally**

```mermaid
sequenceDiagram
    participant Admin as ğŸ‘¨â€ğŸ’» You (Admin)
    participant SSM as ğŸ§  AWS Systems Manager
    participant Agent as ğŸ“¡ SSM Agent
    participant OS as ğŸ–¥ï¸ Target Instance

    Admin->>SSM: Send Run Command
    SSM->>Agent: Deliver command over HTTPS
    Agent->>OS: Execute Shell/PowerShell locally
    OS-->>Agent: Return output
    Agent-->>SSM: Status + Output
    SSM-->>Admin: Success / Fail / Output logs
```

âœ… **No inbound access** required  
âœ… The agent **pulls the command** via **SSM endpoint (HTTPS)**

---

## ğŸ“„ **What Powers the Run Command?**

Run Command uses **SSM Documents (SSM Docs)**

- Format: **YAML or JSON**
- Type: `Command`
- Example: `AWS-RunShellScript`, `AWS-RunPowerShellScript`
- Can include:
  - Parameters
  - Pre/post logic
  - Logging destinations

---

## âœ¨ **Top Features**

| Feature               | Description                                                |
| --------------------- | ---------------------------------------------------------- |
| ğŸ§  No SSH/RDP         | Communicates securely via **SSM Agent over HTTPS**         |
| ğŸ¯ Targeting          | By **Instance ID**, **Tags**, or **Resource Groups**       |
| ğŸ§¾ Reusable Documents | Parameterized, versioned, and shareable                    |
| â±ï¸ Rate Control       | Control **Concurrency** and **Error Threshold**            |
| ğŸ“¤ Output Handling    | Store in **S3**, notify via **SNS**, log to **CloudWatch** |
| ğŸ” Event-Driven       | Can be used as **EventBridge Target** for automation       |

---

## ğŸ§ª **Example Commands**

### ğŸ“¦ **Run Shell Script (Linux)**

```bash
aws ssm send-command \
  --document-name "AWS-RunShellScript" \
  --targets "Key=tag:Role,Values=WebServer" \
  --parameters 'commands=["df -h"]' \
  --comment "Disk usage check"
```

### ğŸªŸ **Run PowerShell Script (Windows)**

```bash
aws ssm send-command \
  --document-name "AWS-RunPowerShellScript" \
  --targets "Key=InstanceIds,Values=i-1234567890abcdef0" \
  --parameters 'commands=["Get-Service"]'
```

---

## ğŸ“¦ **Output Storage & Logging**

You can direct command output to:

- ğŸ“¦ **Amazon S3**
- ğŸ“Š **CloudWatch Logs**
- ğŸ”” **Amazon SNS Notifications**

Example:

```bash
--output-s3-bucket-name my-patch-results \
--cloud-watch-output-config CloudWatchLogGroupName=MySSMLogs,CloudWatchOutputEnabled=true
```

---

## âš–ï¸ **Concurrency & Error Thresholds**

Set **safe limits** for large-scale execution:

- `MaxConcurrency`: e.g. "10" or "10%" (how many instances at once)
- `MaxErrors`: e.g. "2" or "5%" (abort if this many fail)

```bash
--max-concurrency "10" \
--max-errors "1"
```

---

## ğŸ§  Use Cases

| Use Case          | Command                            |
| ----------------- | ---------------------------------- |
| Install software  | `"yum install -y nginx"`           |
| Patch scanning    | `AWS-RunPatchBaseline`             |
| Restart service   | `"sudo systemctl restart apache2"` |
| Clean logs        | `"rm -rf /var/log/*.gz"`           |
| Compliance checks | `"check firewall rules"`           |

---

## ğŸ§± Security Model

- âœ… IAM-based permissions (you define who can run what commands on which instances)
- âœ… Uses **SSM Agent + HTTPS** (no SSH ports exposed)
- âœ… Fully auditable via **CloudTrail**

---

## ğŸš« Common Pitfalls

| Problem                      | Solution                                   |
| ---------------------------- | ------------------------------------------ |
| âŒ â€œCommand failed silentlyâ€ | Check instance has SSM Agent + IAM role    |
| âŒ â€œTarget not foundâ€        | Check target tag key/value or instance ID  |
| âŒ â€œNot authorizedâ€          | Verify IAM policy allows `ssm:SendCommand` |

---

## ğŸ“ Summary

| Topic                 | Key Info                                        |
| --------------------- | ----------------------------------------------- |
| What is it?           | Remote shell command execution via SSM          |
| Agent Required?       | âœ… Yes                                          |
| No SSH needed?        | âœ… Yes                                          |
| Works on Private VPC? | âœ… Yes                                          |
| Docs Format           | YAML or JSON                                    |
| Common Docs           | `AWS-RunShellScript`, `AWS-RunPowerShellScript` |
| Logs to S3 / CW       | âœ… Optional                                     |
| IAM Controlled        | âœ… Granular permissions supported               |

---

## ğŸ“˜ References

- [ğŸ“„ AWS Run Command Docs](https://docs.aws.amazon.com/systems-manager/latest/userguide/run-command.html)
- [ğŸ“„ SSM Documents Guide](https://docs.aws.amazon.com/systems-manager/latest/userguide/documents.html)
- [ğŸ“˜ AWS CLI â€“ send-command](https://docs.aws.amazon.com/cli/latest/reference/ssm/send-command.html)

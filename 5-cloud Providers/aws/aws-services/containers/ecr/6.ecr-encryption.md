# ğŸ” Amazon ECR Encryption: Complete Guide

> _Encrypting Container Images at Rest & In Transit + Cost Insights!_

---

Amazon Elastic Container Registry (ECR) is a fully managed Docker and OCI-compatible image registry. It stores your container images **securely** â€” and **encryption is always on**.

---

## ğŸ” Overview: Encryption in ECR

| Encryption Type | Location      | Mechanism Used    | Default? | Customizable?        |
| --------------- | ------------- | ----------------- | -------- | -------------------- |
| ğŸ”’ At Rest      | Image Storage | AES-256 / AWS KMS | âœ… Yes   | âœ… Yes (KMS options) |
| ğŸ” In Transit   | Data Transfer | TLS 1.2+          | âœ… Yes   | âŒ No (always TLS)   |

---

## ğŸ›¡ï¸ Encryption at Rest

Amazon ECR encrypts all image layers, manifests, and metadata at rest. You configure encryption **per repository** at creation time:

### 1ï¸âƒ£ AES-256 (Amazon S3-Managed Keys)

> âœ… **Default + Free**  
> ğŸ§  Uses S3 Server-Side Encryption (SSE-S3)

- Industry-standard AES-256 encryption
- No key management required
- No extra cost â€” **totally free**
- Ideal for general-purpose workloads with no strict compliance

---

### 2ï¸âƒ£ AWS KMS (Key Management Service)

> ğŸ” Provides deeper control & visibility  
> ğŸ’° **Involves cost** depending on the key type and API usage

You can choose:

#### a. **AWS-Managed KMS Key (`aws/ecr`)**

- Managed and rotated automatically by AWS
- Offers basic auditability via CloudTrail
- You donâ€™t control access to the key

#### b. **Customer-Managed KMS Key (CMK)**

- You create and manage the key
- Control key usage with IAM/KMS policies
- Set custom rotation rules
- Compliant with strict regulatory frameworks

---

## ğŸ’° Cost Comparison

| Encryption Option        | Storage Encryption | Monthly Key Cost | API Call Cost                 | Ideal For                       |
| ------------------------ | ------------------ | ---------------- | ----------------------------- | ------------------------------- |
| **AES-256 (SSE-S3)**     | âœ… Yes             | \$0              | \$0                           | General workloads               |
| **AWS-Managed KMS Key**  | âœ… Yes             | \$0              | ~\$0.03 per 10,000 ops        | Basic auditing needs            |
| **Customer-Managed KMS** | âœ… Yes             | \$1/key/month    | ~\$0.03 per 10,000 operations | Compliance, fine-grained access |

> ğŸ’¡ **Most users pay under \$2/month for customer-managed keys unless performing thousands of operations.**

---

## âš™ï¸ How to Set Encryption

### ğŸ–¥ï¸ Console

1. Go to **ECR > Repositories > Create Repository**
2. Under **Encryption settings**, choose:
   - ğŸ”˜ `AES-256` (default)
   - ğŸ”˜ `AWS KMS`
     - Select **AWS-managed key** or **Customer-managed key**
3. Create the repository

### ğŸ§‘â€ğŸ’» CLI Example

```bash
aws ecr create-repository \
  --repository-name my-api-repo \
  --encryption-configuration encryptionType=KMS,kmsKey=arn:aws:kms:region:account-id:key/key-id
```

> âš ï¸ You cannot change encryption settings after repository creation!

---

## ğŸ“¡ **Encryption in Transit**

All traffic between your client (e.g., Docker CLI) and ECR is encrypted using **TLS 1.2+**.

| Action        | Protocol Used |
| ------------- | ------------- |
| `docker push` | HTTPS (TLS)   |
| `docker pull` | HTTPS (TLS)   |

> ğŸ” This ensures your container layers and manifests arenâ€™t sniffable during transmission â€” no room for MITM attacks!

---

## ğŸ”‘ Example KMS Policy for ECR

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowECRAccess",
      "Effect": "Allow",
      "Principal": {
        "Service": "ecr.amazonaws.com"
      },
      "Action": ["kms:GenerateDataKey", "kms:Decrypt"],
      "Resource": "*"
    }
  ]
}
```

Customize to limit access by conditions, VPCs, roles, or accounts.

---

## ğŸ“Š Real-World Use Cases

| Use Case                             | Recommended Encryption Type |
| ------------------------------------ | --------------------------- |
| Small project, no compliance needs   | AES-256 (SSE-S3)            |
| Startup with monitoring requirements | AWS-Managed KMS             |
| Healthcare / Finance / Regulated     | Customer-Managed KMS        |

---

## ğŸ§  Best Practices

âœ… Use **AES-256** unless you specifically need KMS  
âœ… For compliance, go with **customer-managed KMS keys**  
âœ… Enable **KMS key rotation**  
âœ… Enable **CloudTrail** to log key usage  
âœ… Use **VPC endpoints** for private access  
âœ… Restrict KMS key usage via **key policy** and **IAM**

---

## âš ï¸ Common Mistakes

| Mistake                            | Fix                                              |
| ---------------------------------- | ------------------------------------------------ |
| Forgot to allow ECR in KMS policy  | Add `ecr.amazonaws.com` to KMS key's Principal   |
| Created repo with wrong encryption | Delete and recreate the repository               |
| Used KMS key in wrong region       | Ensure key is in the **same region** as ECR repo |
| No CloudTrail enabled              | Set it up to audit access to KMS and ECR         |

---

## ğŸ“š Official Docs & References

- ğŸ“„ [Encryption at Rest in Amazon ECR](https://docs.aws.amazon.com/AmazonECR/latest/userguide/encryption-at-rest.html)
- ğŸ“„ [Put Encryption Configuration (CLI)](https://docs.aws.amazon.com/cli/latest/reference/ecr/put-encryption-configuration.html)
- ğŸ“„ [AWS KMS Pricing](https://aws.amazon.com/kms/pricing/)
- ğŸ“„ [AWS KMS Documentation](https://docs.aws.amazon.com/kms/latest/developerguide/overview.html)

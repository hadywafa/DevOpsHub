# ğŸ³ğŸ’¨ **Amazon ECR Pull-Through Cache + Repository Creation Templates: Deep Practical Guide**

> _Build caching + control pipelines with zero manual repo creation!_

---

## ğŸ¯ **What You'll Learn**

| ğŸ” Topic                   | âœ… You'll Master                                          |
| -------------------------- | --------------------------------------------------------- |
| ğŸŒ€ Pull-Through Cache      | Speeding up and caching public images                     |
| ğŸ§© Repo Creation Templates | Applying default settings when ECR auto-creates repos     |
| ğŸ”¥ Real Example            | Use Docker Hubâ€™s `nginx` image under `prod/nginx`         |
| âš™ï¸ Console + CLI           | Step-by-step for both interfaces                          |
| ğŸ’¡ Deep Insights           | Why these features matter, what happens behind the scenes |

---

## ğŸ§  Scenario: Cache Docker Hub NGINX Securely

> You're pulling `nginx:latest` often in CI. Itâ€™s **slow**, **Docker Hub is rate-limiting you**, and you're **manually creating ECR repos**.

Weâ€™ll fix all that with:

- ğŸ” Pull-through cache
- ğŸ›¡ï¸ Secure default repo settings (via template)
- ğŸ’¥ No manual repo creation

---

## ğŸŒ€ Step 1: Enable Pull-Through Cache

### ğŸ“¦ Console Steps

1. Go to **ECR Console â†’ Private Registry â†’ Feature Settings**
2. Under **Pull through cache**, click **Edit**
3. Add rule:
   - **Upstream registry**: Docker Hub
   - **Namespace prefix**: `prod/nginx`
4. Click **Save**

### ğŸ§ª CLI

```bash
aws ecr create-pull-through-cache-rule \
  --ecr-repository-prefix prod/nginx \
  --upstream-registry-url registry-1.docker.io \
  --region us-east-1
```

â³ First pull from this repo will reach Docker Hub.
ğŸš€ Next pulls are cached in your private ECR.

---

## ğŸ§© Step 2: Configure Repository Creation Template

> ğŸ§  **Why?**  
> When the `prod/nginx` repo **doesn't exist**, ECR will auto-create it using your **template**, applying:

- Encryption âœ…
- Scanning âœ…
- Tag immutability âœ…
- IAM restrictions âœ…
- Lifecycle policy âœ…

### ğŸ‘¨â€ğŸ’» Console Steps

1. Go to **ECR Console â†’ Feature Settings â†’ Repository creation templates**
2. Click **Edit**
3. Add a template:
   - **Prefix**: `prod/`
   - **Tag immutability**: Enabled
   - **KMS encryption**: Enabled
   - **Scanning**: Basic
   - **Lifecycle**: Delete untagged images after 30 days
   - **Permissions**: Allow `ECRDeveloperRole` only
4. Save

### ğŸ§ª CLI Setup

#### 1. `lifecycle.json`

```json
{
  "rules": [
    {
      "rulePriority": 1,
      "description": "Delete untagged images older than 30 days",
      "selection": {
        "tagStatus": "untagged",
        "countType": "sinceImagePushed",
        "countUnit": "days",
        "countNumber": 30
      },
      "action": {
        "type": "expire"
      }
    }
  ]
}
```

#### 2. `policy.json`

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowCIOnly",
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::123456789012:role/ECRDeveloperRole"
      },
      "Action": [
        "ecr:GetDownloadUrlForLayer",
        "ecr:BatchGetImage",
        "ecr:BatchCheckLayerAvailability",
        "ecr:PutImage",
        "ecr:InitiateLayerUpload",
        "ecr:UploadLayerPart",
        "ecr:CompleteLayerUpload"
      ],
      "Resource": "*"
    }
  ]
}
```

#### 3. Apply Template

```bash
aws ecr put-repository-creation-template \
  --registry-id 123456789012 \
  --repository-prefix prod/ \
  --encryption-configuration encryptionType=KMS \
  --image-tag-mutability IMMUTABLE \
  --image-scanning-configuration scanOnPush=true \
  --lifecycle-policy-text file://lifecycle.json \
  --repository-policy-text file://policy.json \
  --region us-east-1
```

---

## ğŸ§ª Step 3: Pull Image from ECR (Trigger the Flow)

### ğŸ§‘â€ğŸ’» Authenticate Docker

```bash
aws ecr get-login-password --region us-east-1 \
  | docker login \
    --username AWS \
    --password-stdin 123456789012.dkr.ecr.us-east-1.amazonaws.com
```

### ğŸ³ Pull the Cached Image

```bash
docker pull 123456789012.dkr.ecr.us-east-1.amazonaws.com/prod/nginx:latest
```

---

## ğŸ” What Happens Behind the Scenes

```mermaid
sequenceDiagram
  participant Dev as ğŸ§‘ Developer
  participant DockerHub as ğŸ³ Docker Hub
  participant ECR as ğŸ“¦ Amazon ECR
  participant KMS as ğŸ” AWS KMS

  Dev->>ECR: Pull prod/nginx
  ECR->>ECR: Repo exists?
  alt âŒ Doesn't exist
    ECR->>ECR: Match prefix `prod/`
    ECR->>ECR: Create repo with template: [ Scanning - Encryption - Tag immutability - IAM policy - Lifecycle policy ]
  end
  ECR->>DockerHub: Fetch nginx:latest
  DockerHub-->>ECR: Return image layers
  ECR->>Dev: Serve image from cache
```

---

## â“ Do I Need to Manually Create Repos?

| Condition                                                                       | What Happens                           |
| ------------------------------------------------------------------------------- | -------------------------------------- |
| You pull from a cached prefix, repo **doesnâ€™t exist**, and template exists      | âœ… ECR creates repo automatically      |
| You pull from a cached prefix, repo exists                                      | âœ… ECR caches & serves it              |
| You pull from a cached prefix, repo **doesnâ€™t exist**, but no matching template | âŒ Pull fails â€” repo not found         |
| You push your own image                                                         | ğŸ”§ Manual repo creation still required |

---

## ğŸ§  Summary of Benefits

| Feature                    | What It Solves                                     |
| -------------------------- | -------------------------------------------------- |
| **Pull Through Cache**     | Avoid Docker Hub rate limits + speed up builds     |
| **Repo Creation Template** | Secure auto-created repos with policies & defaults |

---

## ğŸ§¼ Optional Cleanup

```bash
aws ecr delete-pull-through-cache-rule \
  --ecr-repository-prefix prod/nginx \
  --region us-east-1

aws ecr delete-repository \
  --repository-name prod/nginx \
  --force \
  --region us-east-1
```

---

## ğŸ Final Thoughts

With this combo, your private registry becomes:

- ğŸ§  Smart (auto-creates repos with safe defaults)
- ğŸš€ Fast (caches from Docker Hub once)
- ğŸ” Secure (IAM + encryption + lifecycle)
- ğŸ’¥ Fully automated

Would you like this in Markdown or a one-click deployment with CloudFormation next? ğŸ˜

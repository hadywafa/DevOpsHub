# ğŸ§  Amazon ECS Cluster

## ğŸ“Œ ECS Core Model

At the highest level, ECS operates as an **orchestrator** for containers. It does three jobs:

1. **Defines** how your app should run â†’ using a **Task Definition**
2. **Schedules** how & when your containers run â†’ via **Tasks**, **Services**, or **Scheduled Tasks**
3. **Executes** containers using compute â†’ **Fargate**, **EC2**, or **ECS Anywhere**

---

> Think of a **cluster** as your neighborhood or playground ğŸ¡ where all your containers run.

It groups:

- ğŸ§Š **Services** (long-running apps like a website or API)
- ğŸ” **Tasks** (one-time jobs like scripts or cronjobs)
- ğŸ“… **Scheduled Tasks** (jobs that run on a timer, like a daily report)

You can run **Fargate** or **EC2-backed** tasks in this playground.

---

## ğŸ”§ What Happens When You Create a Cluster?

Letâ€™s go step by step. ECS gives you these sections:

---

### 1ï¸âƒ£ **Services**

> âš™ï¸ **What are ECS Services?**

ğŸ‘¦ Think of this as a **forever-running app** that restarts if it breaks.

ğŸ“¦ It uses a **Task Definition** and keeps a fixed number of copies (**tasks**) running all the time.

ğŸ§  Services are great for:

- Web APIs
- Backend servers
- Databases (not common but possible)

ğŸ§™ Pro Tip:

- ECS Services support **load balancing**, **blue/green deployments**, **auto scaling**, and **service discovery**.

---

### 2ï¸âƒ£ **Tasks (Run Task)**

> ğŸš€ A task is just a one-time shot of your container.

ğŸ‘¶ You can think of it like:  
"Hey ECS, go run this thing once and don't worry about it after."

ğŸ“¦ It also uses a **Task Definition**, but unlike a service, it **doesn't restart or scale** â€” it just runs and finishes.

ğŸ§  Great for:

- Data processing jobs
- Scheduled backups
- Ad-hoc scripts

---

### 3ï¸âƒ£ **Scheduled Tasks**

> â° These are just â€œRun Taskâ€ commands that happen on a schedule.

ğŸ‘¦ Like setting an alarm clock:  
"Run this task every day at 6 AM!"

Uses:

- Cron jobs
- Email reports
- Cleanup jobs

âœ… It uses **CloudWatch Events (EventBridge)** behind the scenes to schedule the task.

---

## ğŸ” ECS Execution Flow Overview

```mermaid
flowchart LR
    TaskDef[ğŸ“˜ Task Definition] --> Trigger[â–¶ï¸ Trigger: <br/> - Run Task or <br/> - Create Service or <br/> - Schedule Task]
    Trigger --> Scheduler[ğŸ§  ECS Scheduler]
    Scheduler --> CP[âš™ï¸ Capacity Provider Strategy]
    CP --> Compute[ğŸ—ï¸ Launch onto Fargate / EC2]
    Compute --> Task[ğŸ“¦ Task with container/'s]
    Task --> Logging[ğŸªµ Logs + ğŸ“ˆ Monitoring]
```

---

## ğŸ§± ECS Cluster: The Execution Boundary

> A **cluster** is a **logical boundary** that defines where your ECS workloads will run. It doesnâ€™t run anything by itself â€” it's a container runtime workspace that uses **capacity providers** (Fargate or EC2) to launch actual work.

---

## ğŸ¯ Task Definition (Blueprint for Execution)

Think of this as your deployment unit:

- Contains one or more **containers**
- Specifies:
  - Image to use (`nginx:latest`)
  - CPU/memory
  - Logging config
  - Networking mode
  - Environment variables
  - IAM role bindings

ğŸ“˜ Stored as a **versioned resource** and reused by services or tasks.

---

## ğŸ” Task (One-off Unit of Work)

> A **Task** is the actual instantiation of a Task Definition inside a Cluster.

A task runs:

- Once if triggered directly (e.g., "Run Task" button or AWS CLI)
- Continuously if managed by a **Service**
- On a schedule if created as a **Scheduled Task**

Each task is a **containerized runtime** provisioned using **Fargate or EC2** based on your settings.

---

## ğŸ•°ï¸ Scheduled Tasks (Time-based One-shot Jobs)

These are EventBridge rules that **trigger â€œRun Taskâ€** on a defined schedule (cron or rate expression).

Examples:

- Nightly batch jobs
- Weekly S3 report cleaners
- Daily ETL syncs

Unlike services, **they donâ€™t persist**, scale, or track health â€” just run and exit.

---

## âš™ï¸ Services (Long-Running Containers)

> An ECS **Service** is a controller that keeps a desired count of tasks running, automatically replacing failed ones.

### What a Service Controls

| Feature               | Description                |
| --------------------- | -------------------------- |
| ğŸ” Task Count         | Maintains N running copies |
| ğŸ“¡ Load Balancer      | Integrates with ALB or NLB |
| ğŸ”„ Rolling Deployment | Controlled updates         |
| ğŸ” Health Check Logic | Replace unhealthy tasks    |
| âš–ï¸ Auto Scaling       | Horizontal scale out/in    |

Services are the **stateful orchestrators** for stateless containers.

---

## ğŸ”¥ Capacity Providers (Pro-Level)

> Capacity Providers let ECS decide **where** and **how** to launch tasks.

- Can be:
  - `FARGATE`
  - `FARGATE_SPOT`
  - `MyEC2AutoScalingGroup`

Each ECS **Service** can have a **Capacity Provider Strategy** like:

```json
[
  {
    "capacityProvider": "FARGATE",
    "weight": 1
  },
  {
    "capacityProvider": "FARGATE_SPOT",
    "weight": 2
  }
]
```

ğŸ’¡ **Weight** means preference â€” more weight = more tasks land there.

ğŸ§  ECS chooses the best capacity provider based on this.

---

## ğŸ¤” Which Should You Use?

| Use Case                 | Recommendation           |
| ------------------------ | ------------------------ |
| Web app backend          | ECS Service on Fargate   |
| Data processing pipeline | Run Task on Fargate      |
| Cron job (nightly task)  | Scheduled Task           |
| High performance compute | EC2 with Auto Scaling    |
| Spot instance savings    | Fargate Spot or EC2 SPOT |
| Load balancer & scaling  | ECS Service              |

---

## ğŸ“¦ Container Execution Lifecycle

Hereâ€™s how a task is born and run in a cluster:

```mermaid
sequenceDiagram
    actor Dev
    participant ECSCluster
    participant CapacityProvider
    participant Fargate
    participant EC2
    participant Task

    Dev->>ECSCluster: Create Task Definition
    Dev->>ECSCluster: Run Task OR Create Service
    ECSCluster->>CapacityProvider: Evaluate strategy
    CapacityProvider-->>Fargate: (if strategy includes Fargate)
    CapacityProvider-->>EC2: (if EC2 provider selected)
    Fargate->>Task: Launch container(s)
    Task->>ECSCluster: Register logs, ENI, monitoring
```

---

## ğŸ” Monitoring, Insights & Logs

| Tool                      | Description                                 |
| ------------------------- | ------------------------------------------- |
| ğŸ“Š **CloudWatch Metrics** | Resource usage, task count, failures        |
| ğŸªµ **CloudWatch Logs**     | Container logs (via `awslogs` driver)       |
| ğŸ“ˆ **Container Insights** | Advanced CPU/memory/process metrics         |
| ğŸ§ª **ADOT Sidecar**       | OpenTelemetry sidecar for tracing & metrics |

Monitoring is per cluster and optionally enhanced via Container Insights or sidecars.

---

## ğŸ” Security Boundary

- **Task Role**: Used by the container to access AWS resources (e.g., S3)
- **Execution Role**: Used by ECS to pull the image, create logs, attach ENI
- **Security Group**: Used when in `awsvpc` mode for task-level networking
- **KMS Keys**: Can encrypt task logs, volumes, secrets

---

## ğŸ” Update and Rollback

ECS Services support:

- **Rolling Deployments** (default)
- **Blue/Green deployments** via CodeDeploy (advanced)
- **Force new deployments** (redeploy current task)

You can rollback by selecting a previous task definition revision.

---

## âœ… Summary: ECS Orchestration Model

| Component            | Role in System              |
| -------------------- | --------------------------- |
| ğŸ“˜ Task Definition   | The application blueprint   |
| ğŸ“¦ Task              | Running instance of the app |
| ğŸ§ƒ Service           | Long-running controller     |
| ğŸ•°ï¸ Scheduled Task    | Timed execution logic       |
| ğŸ§± Cluster           | Logical execution workspace |
| âš™ï¸ Capacity Provider | Execution logic (how/where) |
| â˜ï¸ Fargate / EC2     | Compute provider            |

# ğŸŒ Amazon S3 CORS (Cross-Origin Resource Sharing)

Ever run your **SPA on `localhost:4200`** and got blocked when trying to fetch an image or file from **S3**?  
Thatâ€™s **CORS** stepping in â€” the browserâ€™s built-in security guard. Letâ€™s break it all down in a way that makes total sense to a software developer.

---

<div align="center" style="padding: 0 0;">
  <img src="images/s3-cors.png" alt="S3 CORS" style="border-radius: 10px;" >
</div>

---

## ğŸ§  What is CORS, Really?

> **CORS** (Cross-Origin Resource Sharing) is a security feature enforced by browsers that **prevents JavaScript from making requests to a different origin unless explicitly allowed**.

| Request Origin   | Allowed?                                   |
| ---------------- | ------------------------------------------ |
| Same origin      | âœ… Yes                                     |
| Different origin | âš ï¸ Blocked unless allowed via CORS headers |

### ğŸ”¥ Real Example

Your Angular frontend is served from:

```ini
http://localhost:4200
```

Your backend API or S3 bucket is hosted on:

```ini
http://localhost:5001
or
https://mybucket.s3.amazonaws.com
```

Without CORS? âŒ The browser blocks the request.
With CORS? âœ… The browser checks the S3 bucket's CORS config â†’ allows access.

---

## ğŸ§© Why CORS is Needed in S3

Amazon S3 is a **RESTful object store** and doesnâ€™t care about browsers â€” but **browsers do** care about origins.  
Thatâ€™s where **CORS rules** come in to tell the browser:

> â€œYes, requests from origin `X` are allowed to access me.â€

---

## ğŸ—‚ï¸ S3 CORS Use Cases

- ğŸ–¼ï¸ Hosting images on S3 and showing them on your frontend
- ğŸ“„ Downloading PDFs directly from S3
- â˜ï¸ Uploading files to S3 directly from the browser using JavaScript
- ğŸ”„ Accessing S3 via `fetch()` or `axios` in frontend apps

---

## ğŸ§ª How CORS Works in Amazon S3

```mermaid
sequenceDiagram
    participant Browser
    participant WebApp as Angular App (localhost:4200)
    participant S3 as Amazon S3 Bucket

    WebApp->>Browser: JS calls fetch('https://s3.amazonaws.com/my-bucket/image.jpg')
    Browser->>S3: OPTIONS preflight request
    S3-->>Browser: Responds with Access-Control headers
    Browser->>S3: GET image.jpg
    S3-->>WebApp: image.jpg
```

---

## ğŸ“œ Sample CORS Configuration for S3 Bucket

```json
[
  {
    "AllowedHeaders": ["*"],
    "AllowedMethods": ["GET", "POST", "PUT"],
    "AllowedOrigins": ["http://localhost:4200", "https://example.com"],
    "ExposeHeaders": ["ETag"],
    "MaxAgeSeconds": 3000
  }
]
```

### ğŸ” What These Fields Mean

| Field            | Meaning                                                              |
| ---------------- | -------------------------------------------------------------------- |
| `AllowedOrigins` | List of origins that can make requests to this bucket                |
| `AllowedMethods` | What kind of HTTP methods are permitted (`GET`, `POST`, `PUT`, etc.) |
| `AllowedHeaders` | What request headers are allowed from the client                     |
| `ExposeHeaders`  | What headers can be seen by the browser (like `ETag`)                |
| `MaxAgeSeconds`  | How long the **preflight response** should be cached                 |

---

## âš™ï¸ How to Apply CORS in S3

### ğŸ“Œ Via AWS Console

1. Open the **S3 Console**
2. Choose your **bucket**
3. Go to **Permissions** â†’ **CORS Configuration**
4. Paste the CORS JSON
5. âœ… Save

---

## ğŸ§  Understanding the Preflight Request

When your frontend sends certain types of requests (e.g., `PUT`, custom headers), **the browser first sends a `OPTIONS` request** to ask:

> â€œHey, is this allowed?â€

If S3 replies with valid headers â†’ request proceeds.  
Otherwise â†’ âŒ blocked by the browser.

### ğŸ’¡ Preflight Caching

The `MaxAgeSeconds` field tells the browser **how long to cache** the preflight result.

```json
"MaxAgeSeconds": 3000
```

Means: for 3000 seconds (~50 minutes), donâ€™t re-ask S3 â€” just use the cached CORS permission. ğŸš€

---

## ğŸ” Common Gotchas

| Mistake                                               | Fix It By...                                              |
| ----------------------------------------------------- | --------------------------------------------------------- |
| Using `*` in `AllowedOrigins` and sending credentials | âŒ Not allowed â€” remove credentials or be explicit        |
| No CORS config at all                                 | Add proper JSON under Permissions â†’ CORS Configuration    |
| Wrong HTTP method                                     | Ensure `AllowedMethods` includes `PUT`, `POST`, etc.      |
| Preflight always failing                              | Check request headers, enable them under `AllowedHeaders` |

---

## âœ… When Should You Use CORS in S3?

- Hosting a static frontend elsewhere that pulls resources from S3
- Uploading files directly from browser to S3
- Integrating S3 images or fonts into a website

---

## ğŸ§ª Bonus Test Tool

Use the **[S3 Preflight Tester](https://apitester.org/)** or open **DevTools â†’ Network tab â†’ OPTIONS** to debug your CORS flow live.

---

## ğŸ§¼ Final Words

> ğŸ§  CORS is not an S3 feature â€” itâ€™s a **browser protection layer**.  
> S3 just helps you **respond properly** to the browser's questions.  
> Get your JSON config right â€” and your frontend will thank you!

# ğŸš€ Deep Dive: CodeBuild Caching

ğŸ“¦ For .NET & Angular â€“ Explained Line by Line

---

## ğŸ¤” Why Is Caching Important?

Without caching, every build:

- Reinstalls all dependencies (`dotnet restore`, `npm ci`)
- Downloads packages from the internet
- Slows down your CI/CD pipelines (wasted time â±ï¸)

### âœ… With Caching

- If your dependency files **donâ€™t change**, you **reuse previously downloaded packages** from AWS S3.
- Faster builds ğŸ’¨
- Fewer network failures ğŸŒ
- Less cost & bandwidth ğŸ’¸

---

## ğŸ§± How CodeBuild Caching Works Internally

<div align="center">

```mermaid
---
config:
  look: handDrawn
  layout: elk
  elk:
    mergeEdges: false
    nodePlacementStrategy: LINEAR_SEGMENTS
---
flowchart TD
  A[Build Starts] --> B{Is Cache Configured?}
  B -- No --> D[Install All Dependencies from Internet]
  B -- Yes --> C[Check Cache Key in S3]
  C -->|Hit| E[Restore Cache - node_modules, NuGet, etc.]
  C -->|Miss| D
  E --> F[Run Build]
  F --> G[Update Cache and Push to S3]
```

</div>

---

## âš™ï¸ Anatomy of the Cache Block

Letâ€™s break this down:

```yaml
cache:
  paths:
    - "node_modules/**/*"
  key: npm-cache-$(codebuild-hash-files package-lock.json)
  fallback-keys:
    - npm-cache-
    - npm-
```

### ğŸ”¹ `paths`

> What you want to cache

ğŸ“¦ For Angular:

```yaml
paths:
  - "node_modules/**/*"
```

ğŸ“¦ For .NET:

```yaml
paths:
  - "/root/.nuget/packages/**/*"
```

This tells CodeBuild to:

- ğŸ” Look for these folders/files
- ğŸ”„ Save them after the build (if caching is enabled)
- ğŸ“¦ Restore them before the build (if the cache key matches)

---

### ğŸ”¹ `key`

> Uniquely identifies the cache version to use

```yaml
key: npm-cache-$(codebuild-hash-files package-lock.json)
```

ğŸ” Whatâ€™s this doing?

- `codebuild-hash-files package-lock.json` creates a **hash (fingerprint)** of the file.
- If your `package-lock.json` **changes**, the hash changes â†’ new cache used.
- If itâ€™s the **same**, CodeBuild restores the old cache from S3 â†’ ğŸš€ faster install

> Same applies to `.NET` using `*.csproj` or `.sln` as the fingerprint file.

---

### ğŸ”¹ `fallback-keys`

> What if the exact cache **key** is not found?

Then CodeBuild tries the `fallback-keys`, in order.

```yaml
fallback-keys:
  - npm-cache-
  - npm-
```

This is helpful if:

- You added `package-lock.json` recently (so no hash match)
- You still want to try a **general fallback**

---

## ğŸ§ª Real Example: Angular Caching Buildspec (Fully Explained)

```yaml
version: 0.2

cache:
  paths:
    - "node_modules/**/*" # â† What to cache
  key: npm-cache-$(codebuild-hash-files package-lock.json) # â† Fingerprint based on dependency file
  fallback-keys:
    - npm-cache- # â† Try this if hash fails
    - npm- # â† Final fallback
phases:
  install:
    runtime-versions:
      nodejs: 18
    commands:
      - echo "Installing dependencies..."
      - npm ci # â† Fast & clean install using lock file
  build:
    commands:
      - echo "Building app..."
      - npm run build -- --configuration production
```

---

## ğŸ§ª Real Example: .NET NuGet Caching Buildspec (Fully Explained)

```yaml
version: 0.2

cache:
  paths:
    - "/root/.nuget/packages/**/*" # â† Cache NuGet global package cache
  key: nuget-cache-$(codebuild-hash-files **/*.csproj) # â† Change if project files change
  fallback-keys:
    - nuget-cache-
    - nuget-

phases:
  install:
    runtime-versions:
      dotnet: 8.0
    commands:
      - echo "Restoring NuGet packages..."
      - dotnet restore # â† Uses the local cache if found
  build:
    commands:
      - echo "Building .NET app..."
      - dotnet build --configuration Release --no-restore
  post_build:
    commands:
      - echo "Publishing .NET app..."
      - dotnet publish -c Release -o ./publish

artifacts:
  files:
    - "**/*"
  base-directory: publish
```

---

### ğŸ§  Behind the Scenes (Angular)

<div align="center">

```mermaid
sequenceDiagram
    participant Build as CodeBuild
    participant S3 as AWS S3 Cache
    participant NPM as npm registry

    Build->>S3: Get cache with key (hash of package-lock.json)
    alt Cache HIT
        S3->>Build: Restore node_modules
        Build-->>NPM: Minimal fetch (if any)
    else Cache MISS
        Build->>NPM: Full install via npm ci
    end
    Build->>S3: Push updated cache (node_modules)
```

</div>

---

## ğŸ”¥ Pro Tips

<div align="center">

| Tip                                    | Why It Matters                             |
| -------------------------------------- | ------------------------------------------ |
| ğŸ—ï¸ Use lock files for hashes           | Ensures only meaningful changes bust cache |
| ğŸ§¹ Use âœ… `npm ci` not âŒ`npm install` | Clean, fast, reproducible installs         |
| âš¡ Cache global NuGet                  | `.NET restore` becomes blazing fast        |
| ğŸ’¥ Clear cache manually if needed      | Delete in S3 or update key logic           |
| ğŸ§ª Use `codebuild-hash-files`          | Secure, dynamic cache key generation       |

</div>

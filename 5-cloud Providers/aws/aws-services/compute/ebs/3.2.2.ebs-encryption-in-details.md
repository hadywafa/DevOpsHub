# ğŸ›¡ï¸ **EBS Encryption & Decryption: How It Works Behind the Scenes**

Amazon **Elastic Block Store (EBS)** provides durable storage volumes that can be encrypted **at rest and in transit** â€” all **managed by AWS Key Management Service (KMS)**.

Letâ€™s break down the **two main flows**:

- ğŸ” Encryption flow (when **writing data** to the volume)
- ğŸ”“ Decryption flow (when **reading data** from the volume)

---

## ğŸ” **1. EBS Encryption Flow (Write Path)**

Letâ€™s imagine your EC2 instance wants to **store** some secret data like `"Launch codes"` on an EBS volume. AWS needs to make sure this is **secure and encrypted** â€” even before it hits the disk.

### âš™ï¸ Step-by-Step: Encryption Process

```mermaid
sequenceDiagram
    participant EC2 as EC2 Instance ğŸ’»
    participant KMS as AWS KMS ğŸ”‘
    participant HEM as Host Encryption Module ğŸ§ 
    participant EBS as Encrypted EBS Volume ğŸ’½

    EC2->>HEM: Send unencrypted data ("Launch codes") ğŸ“¤
    HEM->>KMS: Request Data Encryption Key (DEK) ğŸ—ï¸
    KMS-->>HEM: Return encrypted DEK (wrapped under CMK) ğŸ›¡ï¸
    HEM->>HEM: Decrypt DEK using CMK in memory ğŸ§ 
    HEM->>HEM: Encrypt data using DEK ğŸ”’
    HEM->>EBS: Store encrypted data ğŸ’½
```

---

### ğŸ§  Let's Break it Down

1ï¸âƒ£ **EC2 Sends Data**  
Your EC2 instance writes some data like a database update or log to disk.

2ï¸âƒ£ **Host Encryption Module Takes Over**  
Before the data reaches the disk, it's intercepted by a **Hypervisor-level host encryption module**.

3ï¸âƒ£ **KMS Generates a Key**  
The module asks **AWS KMS** for a **Data Encryption Key (DEK)**. KMS uses a **Customer Master Key (CMK)** to generate and return an encrypted DEK.

4ï¸âƒ£ **DEK is Decrypted in Memory**  
The encrypted DEK is decrypted temporarily in memory and **never stored** unencrypted on disk.

5ï¸âƒ£ **Data is Encrypted with DEK**  
The module now uses this decrypted DEK to encrypt your data.

6ï¸âƒ£ **Encrypted Data is Written to EBS**  
Only after encryption is complete does the data go to your EBS volume. Data **at rest** is always encrypted.

---

## ğŸ”“ **2. EBS Decryption Flow (Read Path)**

When your EC2 instance **reads** from the encrypted EBS volume, the system reverses the process â€” but the EC2 never knows or touches the encryption keys.

### âš™ï¸ Step-by-Step: Decryption Process

```mermaid
sequenceDiagram
    participant EBS as Encrypted EBS Volume ğŸ’½
    participant HEM as Host Encryption Module ğŸ§ 
    participant KMS as AWS KMS ğŸ”‘
    participant EC2 as EC2 Instance ğŸ’»

    EC2->>EBS: Request encrypted data ğŸ“¥
    EBS->>HEM: Return encrypted data ğŸ”’
    HEM->>KMS: Request encrypted DEK (or retrieve from cache) ğŸ—ï¸
    KMS-->>HEM: Return encrypted DEK ğŸ”
    HEM->>HEM: Decrypt DEK using CMK ğŸ§ 
    HEM->>HEM: Decrypt the data using DEK ğŸ”“
    HEM-->>EC2: Return unencrypted data ğŸ“„
```

---

### ğŸ§  Let's Break it Down

1ï¸âƒ£ **EC2 Requests Data**  
Your app on EC2 asks for data (e.g., reads from a database or a file).

2ï¸âƒ£ **Encrypted Data is Retrieved**  
The EBS volume sends the encrypted block to the host-level encryption module.

3ï¸âƒ£ **KMS Provides the Key**  
If not already cached, the module gets the **encrypted DEK** from KMS.

4ï¸âƒ£ **DEK is Decrypted Temporarily**  
The DEK is decrypted using your CMK, **inside memory only**, never written to disk.

5ï¸âƒ£ **Data is Decrypted with DEK**  
The encrypted data block is decrypted using the decrypted DEK.

6ï¸âƒ£ **EC2 Gets the Plaintext**  
Your EC2 instance receives **clean, decrypted data** with no clue that this magic even happened under the hood.

---

## âœ¨ Real-World Analogy

ğŸ” **Encryption = Sealing a Secret Letter**

- You (EC2) want to store a letter.
- The host encryption module is your **mailroom guy with a shredder and safe**.
- He calls AWS KMS to **get a vault key** (DEK) locked inside a box (encrypted under CMK).
- He opens the box **in memory**, encrypts your letter, locks it in a safe (EBS), and discards the key copy.

ğŸ”“ **Decryption = Opening the Safe**

- When you need the letter back, he retrieves it from the safe, unlocks the vault key again, opens the letter, and hands it to you.
- You never see the key or safe â€” just your letter.

---

## ğŸ§© Summary Table: Encryption vs. Decryption

| ğŸ› ï¸ Action        | ğŸ” Encryption                | ğŸ”“ Decryption                  |
| ---------------- | ---------------------------- | ------------------------------ |
| ğŸ”‘ Key Source    | KMS (generates DEK)          | KMS (fetches DEK)              |
| ğŸ“¦ Key Handling  | DEK decrypted in memory only | DEK decrypted in memory only   |
| ğŸ§  Module        | Host-level Encryption Module | Host-level Encryption Module   |
| ğŸ’½ Data Location | Stored encrypted on EBS      | Returned decrypted to EC2      |
| ğŸ“¡ In Transit    | Encrypted automatically      | Decrypted only before delivery |

---

## âœ… Benefits of This Design

- **Zero Touch**: All this encryption/decryption is transparent to your application.
- **Key Rotation**: You can rotate your CMK in KMS; AWS re-encrypts new data automatically.
- **Compliance**: Meets standards like PCI DSS, HIPAA, GDPR, etc.
- **No Performance Tradeoff**: Encryption is optimized â€” you donâ€™t take a big performance hit.

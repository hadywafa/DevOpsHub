# â˜ï¸ How AWS EventBridge Works Internally (for Devs Who Hate Black Boxes)

## ðŸ” What Is AWS EventBridge?

> **EventBridge is AWSâ€™s event bus system that helps your services talk to each other â€” asynchronously and decoupled.**

Officially:

> "**Amazon EventBridge** is a **serverless event bus service** that enables you to build event-driven applications by connecting various event sources to targets."

âœ… Successor to CloudWatch Events  
âœ… Built-in support for **SaaS integrations**, **AWS services**, and **custom apps**  
âœ… Features **filtering**, **transformation**, **multi-target routing**, and **custom buses**

---

## âš™ï¸ How It Works: S3 Upload â†’ CodePipeline Flow

Letâ€™s say you upload a file to S3 and want it to trigger CodePipeline. Hereâ€™s what happens internally:

### ðŸ§± Step-by-Step Internals

#### 1ï¸âƒ£ S3 Uploads a File (The Catalyst)

- You upload an object using `PutObject`.
- This action is **not natively emitted to EventBridge by S3**.
- Instead, **CloudTrail records the API call**.

```json
{
  "eventSource": "s3.amazonaws.com",
  "eventName": "PutObject",
  "requestParameters": {
    "bucketName": "my-bucket",
    "key": "myfile.txt"
  }
}
```

ðŸ” Think of **CloudTrail** as your AWS "security camera" ðŸŽ¥ â€” recording every API activity.

---

#### 2ï¸âƒ£ CloudTrail Forwards Event to EventBridge

- This **management event** is part of the **default EventStream**.
- EventBridge **listens to CloudTrail** and receives the matching event.
- No custom trail required. No cost. Magic? Nah â€” just integration.

---

#### 3ï¸âƒ£ EventBridge Matches Event to Rule

You define a rule like this:

```json
{
  "source": ["aws.s3"],
  "detail-type": ["AWS API Call via CloudTrail"],
  "detail": {
    "eventName": ["PutObject"],
    "requestParameters": {
      "bucketName": ["my-bucket"]
    }
  }
}
```

> ðŸ§  **EventBridge evaluates patterns** against every incoming event. If the pattern matches â†’ it forwards to the target (CodePipeline, Lambda, etc.).

---

#### 4ï¸âƒ£ CodePipeline Gets Triggered

- EventBridge invokes the **StartPipelineExecution** API.
- You can pass **custom input**, like `ObjectKey`, using **input transformers**.

---

## ðŸ§¬ Mermaid: Internal Event Flow

```mermaid
sequenceDiagram
    actor User
    participant S3
    participant CloudTrail
    participant EventBridge
    participant CodePipeline

    User->>S3: Upload object (PutObject)
    S3-->>CloudTrail: Logs API call
    CloudTrail-->>EventBridge: Emits management event
    EventBridge-->>EventBridge: Match event to rule
    EventBridge->>CodePipeline: StartPipelineExecution (with object key)
    CodePipeline-->>User: Pipeline runs
```

ðŸ§  **Key Insight**: The chain only works because **CloudTrail is silently feeding EventBridge** under the hood.

---

## ðŸ§ª Real-World Setup: End-to-End

### ðŸªœ Step-by-Step Setup

| Step | Action                                       |
| ---- | -------------------------------------------- |
| 1ï¸âƒ£   | Upload to S3 triggers `PutObject` API        |
| 2ï¸âƒ£   | CloudTrail logs the event                    |
| 3ï¸âƒ£   | EventBridge receives the log via EventStream |
| 4ï¸âƒ£   | Rule matches `PutObject` for `my-bucket`     |
| 5ï¸âƒ£   | CodePipeline starts via API call             |

---

## ðŸ›¡ï¸ Security Notes

âœ… Make sure **EventBridge has IAM permissions** to invoke the pipeline  
âœ… Example policy:

```json
{
  "Effect": "Allow",
  "Action": "codepipeline:StartPipelineExecution",
  "Resource": "*"
}
```

âœ… Pipeline role must also support input revision override if needed

---

---

---

## ðŸ§  Q1: **Why is CloudTrail needed when triggering a pipeline from an S3 object upload?**

### âœ… Short Answer

> **S3 doesnâ€™t natively emit events to EventBridge. Instead, CloudTrail captures API calls like `PutObject` and forwards them to EventBridge.**

---

### ðŸ” Full Explanation

- S3 **does not emit native EventBridge events** for `PutObject`.
- But S3 **does emit API-level events** to **CloudTrail**, such as:

  ```json
  {
    "eventSource": "s3.amazonaws.com",
    "eventName": "PutObject"
  }
  ```

- **CloudTrail acts as the bridge** between S3 and EventBridge.

---

### ðŸŽ¯ Why is this necessary?

- **âŒ Without CloudTrail:**

  - S3 **bucket event notifications** support `Lambda`/`SNS`/`SQS` directly, but **`not` EventBridge**
  - No way to "watch" object uploads via EventBridge alone

- **âœ… With CloudTrail:**

  - CloudTrail logs `PutObject` â†’ EventBridge rule can match it and forward to CodePipeline

---

## ðŸ’¸ Q2: **Do I have to pay for CloudTrail? Can I use the free one?**

### ðŸ’¡ Good News

> You **donâ€™t need to create a custom CloudTrail trail** to get this functionality!

- EventBridge **automatically integrates with the CloudTrail EventStream** for free.
- This is the **"management events" default integration**, and it's free for most AWS services, including S3.

ðŸŸ¢ **So:**

- âœ… You **do not need to create a trail**
- âœ… You **do not pay anything extra** unless you enable full data event logging or advanced features
- âœ… CodePipeline triggers **still work** with the **default CloudTrail-to-EventBridge stream**

---

## ðŸ§  Q3: **Is EventBridge just a filter for incoming events?**

### âœ… Short Answer

> EventBridge is **more than a filter** â€” itâ€™s a **serverless event router with pattern matching, transformation, and multiple targets**.

---

### ðŸ§© Internally, it does

| Capability                | Description                                                                |
| ------------------------- | -------------------------------------------------------------------------- |
| ðŸ” **Filtering**          | Match events with rules based on content (`source`, `eventName`, etc.)     |
| ðŸ” **Transformation**     | Modify event structure via **input transformer** before passing to targets |
| ðŸŽ¯ **Routing to targets** | Send matched events to targets like Lambda, Step Functions, CodePipeline   |
| â° **Scheduled events**   | Cron-style scheduled rules                                                 |
| ðŸ§© **Custom buses**       | You can create your own event buses for microservices separation           |
| ðŸ” **Access control**     | IAM & resource-based policies control who can put and consume events       |

So yes â€” it **does filter** events, but also **transforms, routes, and manages** them.

---

## ðŸ§  Q4: **Can EventBridge be triggered by something other than CloudTrail?**

### âœ… Absolutely

EventBridge **can receive events from**:

| Source Type                    | Examples                                              |
| ------------------------------ | ----------------------------------------------------- |
| ðŸ”¹ **AWS Services (native)**   | CodeBuild, ECS, Auto Scaling, CodePipeline, EC2, etc. |
| ðŸ”¸ **CloudTrail-based**        | S3, DynamoDB (via API calls)                          |
| ðŸ”¸ **Custom apps**             | Your app emits events via `PutEvents` API             |
| ðŸ”¸ **SaaS providers**          | Datadog, Auth0, Zendesk, MongoDB Atlas, etc.          |
| ðŸ”¸ **Schedule (cron)**         | Scheduled expressions like `rate(5 minutes)`          |
| ðŸ”¸ **Other EventBridge buses** | Events can be routed from one bus to another          |

---

### ðŸ”§ Example

Letâ€™s say you use **Amazon CodeBuild** â†’ it emits **native events** like:

```json
{
  "source": "aws.codebuild",
  "detail-type": "CodeBuild Build State Change",
  "detail": {
    "build-status": "SUCCEEDED",
    "project-name": "MyBuildProject"
  }
}
```

ðŸŸ¡ **No CloudTrail needed. Native integration.**

But for services like **S3**, which donâ€™t emit native EventBridge events, AWS uses CloudTrail as an **intermediary event publisher**.

---

## ðŸ§  Q5: Does **CloudTrail emit events**?

### âœ… Yes â€” but **not in the way you might think**

CloudTrail **does not emit events** like a real-time push service.
Instead, it acts like a **log sink** for **API calls** and can optionally **stream those logs to EventBridge**.

Letâ€™s break it down in a human-smart way.

### ðŸ’¡ What CloudTrail _actually_ does

| Role                                | Description                                                                                                                                                      |
| ----------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ðŸ“œ **Recorder**                     | Captures all **API activity** across your AWS account (e.g., `PutObject`, `StartInstances`) and writes logs to S3 or CloudWatch                                  |
| ðŸ“¡ **Event Source** for EventBridge | Some of these API actions (called **management events**) are streamed **internally** into EventBridge **in near real-time**, even **without a trail configured** |

---

### ðŸŽ¯ So is CloudTrail an **event emitter**?

Yes, **in the context of EventBridge**, but:

- ðŸ”¸ It doesnâ€™t emit in the traditional sense (e.g., SNS-style push).
- ðŸ”¸ It emits **certain management events** via a **built-in stream** to EventBridge.
- ðŸ”¸ It doesnâ€™t push to SNS, SQS, or Lambda **directly**.
- ðŸ”¸ Itâ€™s not designed as a general-purpose event router.

---

### ðŸ¤” Where can CloudTrail **emit to**?

| Target                        | Explanation                                                                |
| ----------------------------- | -------------------------------------------------------------------------- |
| ðŸ”¹ **Amazon S3**              | âœ… By default (via trails), logs are written to S3 as JSON files.          |
| ðŸ”¸ **Amazon CloudWatch Logs** | âœ… You can forward logs to CloudWatch Log Groups.                          |
| ðŸ”¹ **Amazon EventBridge**     | âœ… Certain **management events** are streamed to EventBridge in real time. |
| âŒ **SNS / SQS / Lambda**     | âŒ Not directly â€” must go through EventBridge or custom logic.             |

---

### ðŸ¤– Internal Flow (S3 Example)

Letâ€™s say you upload a file to an S3 bucket:

```mermaid
sequenceDiagram
    actor User
    participant S3
    participant CloudTrail
    participant EventBridge
    participant CodePipeline

    User->>S3: PUT object to bucket
    S3-->>CloudTrail: Logs the PutObject API call
    CloudTrail-->>EventBridge: Emits event (if it's a supported mgmt event)
    EventBridge-->>CodePipeline: Rule matches & triggers pipeline
```

ðŸ§  **Key Insight**:  
CloudTrail is **not a messaging service** like SNS. Itâ€™s a **logging/auditing service** that **happens to stream selected events into EventBridge**.

---

## ðŸ§  Q5: What if I want CloudTrail to push to other services?

Youâ€™d need to use **EventBridge** as the middleman:

1. CloudTrail event â†’ EventBridge
2. EventBridge rule â†’ Target: Lambda, Step Functions, CodePipeline, etc.

Orâ€¦

You could write your own Lambda that polls the S3 logs written by CloudTrail â€” but this is less efficient and not real-time.

---

## ðŸ“š References

- [ðŸ“˜ Create EventBridge Rule for S3](https://docs.aws.amazon.com/codepipeline/latest/userguide/create-S3-source-events.html)
- [ðŸ“˜ Amazon S3 Source Action Reference](https://docs.aws.amazon.com/codepipeline/latest/userguide/action-reference-S3.html)
- [ðŸ“˜ EventBridge Input Transformer](https://docs.aws.amazon.com/eventbridge/latest/userguide/eb-input-transformer.html)
- [ðŸ“˜ CloudTrail Integration](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-event-reference.html)

# üßæ **Identity-Based Policies in AWS IAM**

> _"What can‚Äôt this identity do?"_

**Identity-based policies** are permission rules that define **what AWS actions are allowed or denied** for a specific IAM **user, group, or role**. These policies are written in JSON and **attach directly to identities**‚Äîthere's no need to specify a `Principal` because the attachment itself determines it.

---

## üîë **Why It‚Äôs Called Identity-Based**

| Feature         | Description                                                                  |
| --------------- | ---------------------------------------------------------------------------- |
| üîó Attached To  | IAM **User**, **Group**, or **Role**                                         |
| üö´ No Principal | The policy is applied **to the identity** it‚Äôs attached to                   |
| üì¶ Policy Types | AWS Managed, Customer Managed, and Inline Policies                           |
| üß† Use Cases    | Control permissions for individuals, teams, or roles inside your AWS account |

---

## üß± **Structure of an IAM Identity-Based Policy**

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow" | "Deny",
      "Action": "service:action",
      "Resource": "arn:aws:...",
      "Condition": {
        "operator": {
          "key": "value"
        }
      }
    }
  ]
}
```

### üìå Policy Fields Explained

| Field       | Description                                                       |
| ----------- | ----------------------------------------------------------------- |
| `Version`   | Always `"2012-10-17"` (the current IAM policy version).           |
| `Effect`    | `"Allow"` or `"Deny"`. Deny always overrides allow.               |
| `Action`    | One or more actions (like `"s3:PutObject"` or `"ec2:*"`).         |
| `Resource`  | ARN(s) or `"*"` for all. Can be narrowed down.                    |
| `Condition` | (Optional) Add logic such as IP, MFA, Tags, or Time-based checks. |

---

## üß™ **How Policy Evaluation Works**

```mermaid
---
config:
  look: handDrawn
  layout: elk
  elk:
    mergeEdges: false
---
graph TD
    A[User Requests Access] --> B[All Access Denied by Default]
    B --> C{Explicit Deny Found?}
    C -- Yes --> D[Access Denied ‚ùå]
    C -- No --> E{Explicit Allow Found?}
    E -- Yes --> F[Access Allowed ‚úÖ]
    E -- No --> D
```

> üß† AWS IAM **starts with deny**, and only **explicit allow** opens access‚Äîunless there's an **explicit deny**, which always wins.

---

## üéØ **Examples of Effect, Action, and Resource**

### ‚úÖ Allow Read Access to S3 Bucket

```json
{
  "Effect": "Allow",
  "Action": "s3:GetObject",
  "Resource": "arn:aws:s3:::my-bucket/*"
}
```

### ‚ùå Deny Deletion from a Confidential Bucket

```json
{
  "Effect": "Deny",
  "Action": "s3:DeleteObject",
  "Resource": "arn:aws:s3:::confidential-bucket/*"
}
```

---

## ‚ú® Advanced: `NotAction` Usage

Sometimes you want to say ‚Äúeverything **except** this action‚Äù:

```json
{
  "Effect": "Allow",
  "NotAction": "s3:DeleteBucket",
  "Resource": "arn:aws:s3:::*"
}
```

üîí This allows **all S3 actions** except deleting a bucket.

---

## üß† Real-World Examples from Source

### ‚úÖ Allow all services except IAM (NotAction)

```json
{
  "Effect": "Allow",
  "NotAction": "iam:*",
  "Resource": "*"
}
```

### ‚ùå Deny access to a specific S3 bucket

```json
{
  "Sid": "NoClassifiedBucket",
  "Effect": "Deny",
  "Action": "s3:*",
  "Resource": ["arn:aws:s3:::dolfinedcal123", "arn:aws:s3:::dolfinedcal123/*"]
}
```

---

## üß© Conditions in Identity Policies

Conditions are used to **enforce context-sensitive access**, such as:

| Condition Type    | Example Use                               |
| ----------------- | ----------------------------------------- |
| `IpAddress`       | Restrict by source IP or range            |
| `BoolIfExists`    | Enforce MFA only if attribute exists      |
| `StringEquals`    | Match resource tags or session attributes |
| `DateGreaterThan` | Time-limited access                       |

---

### üí° Condition Examples

#### ‚úÖ Allow EC2 actions from specific IP ranges

```json
"Condition": {
  "IpAddress": {
    "aws:SourceIp": ["203.0.113.0/24", "2001:DB8:1234:5678::/64"]
  }
}
```

#### ‚ùå Deny Stop/Terminate EC2 if **not** using MFA

```json
"Condition": {
  "BoolIfExists": {
    "aws:MultiFactorAuthPresent": false
  }
}
```

#### ‚úÖ Allow EC2 actions if instance has specific tag

```json
"Condition": {
  "StringEquals": {
    "ec2:ResourceTag/Environment": "Dev"
  }
}
```

---

## üß™ Practical Use Case: Enforce Secure Access

### ‚ùå Deny EC2 Stop/Terminate from untrusted IPs

```json
{
  "Effect": "Deny",
  "Action": ["ec2:StopInstances", "ec2:TerminateInstances"],
  "Resource": "*",
  "Condition": {
    "NotIpAddress": {
      "aws:SourceIp": ["203.0.113.0/24"]
    }
  }
}
```

### ‚úÖ Allow EC2 actions only if using MFA

```json
{
  "Effect": "Allow",
  "Action": "ec2:*",
  "Resource": "*",
  "Condition": {
    "Bool": {
      "aws:MultiFactorAuthPresent": true
    }
  }
}
```

---

## üìò Bonus: JSON Snippet Anatomy

```json
{
  "Sid": "OptionalStatementID",
  "Effect": "Allow",
  "Action": "s3:GetObject",
  "Resource": "arn:aws:s3:::my-bucket/*",
  "Condition": {
    "IpAddress": {
      "aws:SourceIp": "192.168.0.1/24"
    }
  }
}
```

- `Sid` = Statement ID (optional but useful for debugging)
- Multiple `Statements` can live in one policy block

---

## ‚úÖ Summary Table

| Field                | Meaning                                                            |
| -------------------- | ------------------------------------------------------------------ |
| **Attached To**      | IAM User, Group, Role                                              |
| **Principal**        | **Implicit** (policy inherits it from where it‚Äôs attached)         |
| **Evaluation**       | Deny by default ‚Üí Allow ‚Üí Deny (if explicitly stated)              |
| **Wildcard Support** | ‚úÖ Yes (`*` in action, resource)                                   |
| **Condition Logic**  | ‚úÖ Yes ‚Äì IP, tags, MFA, time, VPC, Org                             |
| **Use Case**         | Enforce internal permissions for identities within the AWS account |

---

## ‚úçÔ∏è Example Identity-Based Policy

```json
// This policy statement denies any IP
// address outside of the two listed ranges
// from terminating EC2 instances
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Deny",
      "Action": "ec2:TerminateInstances",
      "Resource": "*",
      "Condition": {
        "NotIpAddress": {
          "aws:SourceIp": ["192.0.2.0/24", "203.0.113.0/24"]
        }
      }
    }
  ]
}
```

```json
// This policy statement allows users with
// source IP address from the ranges
// 203.0.113.0/24 or 2001:DB8:1234:5678::/
// to do all  EC2 actions on all EC2 resources
{
  "Version": "2012-10-17",
  "Statement": {
    "Effect": "Allow",
    "Action": "ec2:*",
    "Resource": "*",
    "Condition": {
      "IpAddress": {
        "aws:SourceIp": ["203.0.113.0/24", "2001:DB8:1234:5678::/64"]
      }
    }
  }
}
```

```json
// This policy statement denies users
// who have not been authenticated
// with MFA from terminating or
// stopping EC2 instances.
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "DenyStopAndTerminateWhenMFAIsNotPresent",
      "Effect": "Deny",
      "Action": ["ec2:StopInstances", "ec2:TerminateInstances"],
      "Resource": "*",
      "Condition": {
        "BoolIfExists": { "aws:MultiFactorAuthPresent": false }
      }
    }
  ]
}
```

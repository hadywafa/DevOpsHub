# 🔐 **IAM Policy Evaluation Logic (Within an AWS Account)**

<div align="center">
  <img src="images/aws-iam-policy-evaluation-login.png" alt="AWS IAM Policy Evaluation" style="border-radius: 10px">
</div>

---

## 📚 **What Is Policy Evaluation in IAM?**

When a user or service makes a request to AWS (like `s3:GetObject`), AWS evaluates **all applicable policies** to determine one thing:

> ✅ **Should I allow this action on this resource in this context?**

That decision is based on **IAM policy evaluation logic**, which always follows a predictable flow.

---

## ⚙️ **Key Concepts Before the Evaluation**

| 🧩 Concept                | 🔍 Meaning                                                       |
| ------------------------- | ---------------------------------------------------------------- |
| **Identity-based policy** | Attached to users, groups, or roles                              |
| **Resource-based policy** | Attached to resources (like S3 buckets, SQS queues, etc.)        |
| **Permission boundary**   | Max limit for what an identity-based policy can grant (optional) |
| **Session policy**        | Temporary policy that further restricts the session              |
| **Explicit allow**        | A policy that directly allows an action (`"Effect": "Allow"`)    |
| **Explicit deny**         | A policy that directly blocks an action (`"Effect": "Deny"`)     |
| **Implicit deny**         | The default when nothing allows an action                        |

---

## 🔄 **IAM Policy Evaluation Process Step-by-Step**

### 🧭 Step 1: AWS Collects All Applicable Policies

AWS gathers:

- All **identity-based policies** (user, group, role)
- All **resource-based policies**
- Optional: session policies and permission boundaries

### ⛔ Step 2: Start with an **Implicit Deny**

By default, **everything is denied** unless **explicitly allowed**.

```text
Default: Deny everything
```

### ✅ Step 3: Look for Any Matching **Allow**

If any policy contains an `"Effect": "Allow"` that matches:

- the requested action
- the target resource
- and the context (conditions, IPs, MFA, etc.)

...then AWS considers allowing it.

### ❌ Step 4: Check for Any **Explicit Deny**

If **any policy** explicitly denies the action:

```json
"Effect": "Deny"
```

➡️ It **overrides all allows**.

Even if 100 policies say "Allow", **a single explicit Deny wins**.

### 📘 Step 5: Final Decision

| ✅ If there’s a matching **Allow** AND **no Deny** → **Request is allowed**  
| ❌ If there’s a matching **Deny** → **Request is denied**  
| ❌ If nothing matches → **Request is implicitly denied**

---

## 📊 IAM Evaluation Logic Table

| Condition                                     | Result           |
| --------------------------------------------- | ---------------- |
| No matching policy                            | ❌ Implicit Deny |
| One policy allows action                      | ✅ Allowed       |
| One allows, another denies                    | ❌ Denied        |
| Only deny policies match                      | ❌ Denied        |
| Session policy or boundary removes permission | ❌ Denied        |

---

## 🧠 Analogy: IAM Policy Logic Is Like a Security Gate

Imagine AWS IAM as a **security guard at a gate**:

1. The gate is **closed by default** 🧱
2. If someone shows an "Allow" pass ✅, the guard **considers letting them in**
3. But if any pass says "DENY this person" ❌—they're **instantly blocked**, no questions asked

---

## 🧪 Real-Life Example: Evaluating S3 Access

- 🎯 **Request**: User tries to run `s3:GetObject` on a file in an S3 bucket

### 🔍 Step-by-Step

- ✅ Identity-based policy allows `s3:GetObject` on `arn:aws:s3:::docs/*`
- ❌ Resource-based policy has `"Effect": "Deny"` on `arn:aws:s3:::docs/secret.pdf`

**Result** → ❌ Denied (because Deny > Allow)

---

## 🚫 Gotchas to Watch Out For

- ❌ **Missing Allow** means Implicit Deny
- ❌ **Explicit Deny** overrides everything
- ❌ Conditions like `"aws:MultiFactorAuthPresent": "true"` can silently block requests if not met
- ✅ Combine multiple "Allow" statements to get full access, but **one Deny still ruins it**

---

## ✅ Summary

| Step | What Happens                                                          |
| ---- | --------------------------------------------------------------------- |
| 1️⃣   | AWS collects all identity-based, resource-based, and session policies |
| 2️⃣   | By default, the request is denied                                     |
| 3️⃣   | AWS looks for a matching `"Effect": "Allow"`                          |
| 4️⃣   | If any `"Effect": "Deny"` is found, it overrides the allow            |
| 5️⃣   | If no allows match, access is implicitly denied                       |

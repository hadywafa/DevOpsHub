# 🧠 **Docker RAM Resource Limits**

> Memory limits prevent one container from eating all your system RAM 🍔 —
> causing other containers (or even your host) to crash or swap.

Docker uses the **Linux Memory Cgroup Controller** to:

- Cap how much RAM a container can use
- Optionally control swap usage
- Decide whether to kill the container or throttle it when it runs out

---

## ⚙️ **How Docker Handles Memory**

Containers share the host’s memory pool.
When you don’t set any limit:

- Containers can use **as much memory as the host allows**.
- If total usage exceeds physical RAM, the **kernel OOM (Out Of Memory) Killer** will randomly kill processes (often your container 😅).

---

## 🧩 **Docker Memory Control Flags**

| Flag                   | Description                                | Type     |
| ---------------------- | ------------------------------------------ | -------- |
| `--memory`             | Hard limit on RAM usage                    | Hard cap |
| `--memory-swap`        | Combined RAM + swap limit                  | Hard cap |
| `--memory-reservation` | Soft limit (preference hint)               | Soft cap |
| `--oom-kill-disable`   | Disable OOM killer                         | Risky 🚨 |
| `--kernel-memory`      | Legacy flag for kernel memory (deprecated) | N/A      |

---

## 1️⃣ `--memory` — Hard Memory Limit

### 💡 Concept:

Defines the **maximum amount of RAM** a container can use.
If it exceeds that amount, the kernel **kills the container’s process**.

---

### 🧪 Example 1 — Limit to 512 MB

```bash
docker run -d --name web --memory=512m nginx
```

🧮 Result:

- Container is capped at 512 MB of physical memory.
- If the process tries to use more → ❌ **Killed by OOM Killer**.

---

### 🧪 Example 2 — 2 GB Limit

```bash
docker run -d --name db --memory=2g postgres
```

- Container cannot use more than **2 GB RAM**.
- If it tries, the kernel terminates it:

  ```ini
  Out of Memory: Kill process 1234 (postgres)
  ```

- Logs: `dmesg | grep -i kill`

---

### ⚙️ Internally (Cgroups)

Docker sets:

```ini
/sys/fs/cgroup/memory/docker/<id>/memory.limit_in_bytes = 536870912
```

(= 512 MB in bytes)

---

## 2️⃣ `--memory-swap` — RAM + Swap Limit

### 💡 Concept:

Specifies **total memory (RAM + swap)** that a container can use.

- `--memory` = physical RAM limit
- `--memory-swap` = total memory (RAM + swap)

So, **swap = memory-swap - memory**

---

### 🧪 Example 1 — Allow 512MB RAM + 512MB Swap

```bash
docker run -d --memory=512m --memory-swap=1g nginx
```

🧮 Result:

- Container can use **512 MB RAM** + **512 MB swap** = **1 GB total**.
- When RAM is full, it can use swap before being killed.

---

### 🧪 Example 2 — Disable Swap

```bash
docker run -d --memory=512m --memory-swap=512m nginx
```

🧮 Result:

- Container can use **512 MB total** (no swap at all).

---

### ⚠️ Notes

| Behavior                      | Description                      |
| ----------------------------- | -------------------------------- |
| `--memory-swap` = `--memory`  | No swap allowed                  |
| `--memory-swap` = `2x memory` | Equal RAM + swap space           |
| Omit `--memory-swap`          | Docker defaults to `2x memory`   |
| Set `--memory-swap=-1`        | Unlimited swap (not recommended) |

---

## 3️⃣ `--memory-reservation` — Soft Limit (Hint)

### 💡 Concept:

This is a **soft memory limit** — a _“preferred”_ usage target.

> When the host is under memory pressure, the kernel starts reclaiming memory from containers exceeding their reservation.

It doesn’t kill the container immediately — it’s a **warning threshold**.

---

### 🧪 Example — Soft Limit + Hard Limit

```bash
docker run -d \
  --memory=1g \
  --memory-reservation=512m \
  nginx
```

🧮 Result:

- Normal condition → can use up to 1 GB
- Under pressure → kernel tries to reclaim memory above 512 MB

Think of it like saying:
🗣️ “You _can_ use 1 GB, but please stay near 512 MB unless really needed.”

---

## 4️⃣ `--oom-kill-disable` — Disabling OOM Killer 😬

### 💡 Concept:

Prevents the kernel from killing the container when it exceeds its memory limit.

⚠️ Dangerous — if memory is exhausted, your container (and even host) can hang.

---

### 🧪 Example

```bash
docker run -d --memory=1g --oom-kill-disable=true nginx
```

🧮 Result:

- Instead of killing the container, it stalls or errors with memory allocation failures.
- Used in special cases (like debug or kernel experiments).

---

## 5️⃣ (Deprecated) `--kernel-memory`

This was used to limit kernel memory per container:

```bash
docker run --kernel-memory=50m nginx
```

But it’s now deprecated in modern Docker versions (since kernel 5.x and cgroup v2).

---

## 📝 **Combined Example** — Full Memory Configuration

```bash
docker run -d \
  --name backend \
  --memory=1g \
  --memory-swap=2g \
  --memory-reservation=512m \
  --oom-kill-disable=false \
  nginx
```

### 🧮 **Breakdown**

| Flag                        | Meaning                                    |
| --------------------------- | ------------------------------------------ |
| `--memory=1g`               | Hard cap: container cannot exceed 1 GB RAM |
| `--memory-swap=2g`          | Can use extra 1 GB swap                    |
| `--memory-reservation=512m` | Soft target for kernel reclaiming          |
| `--oom-kill-disable=false`  | Allow OOM killer if limit exceeded         |

---

### ⚙️ **Internally (Cgroup Settings)**

| File                                                            | Value              |
| --------------------------------------------------------------- | ------------------ |
| `/sys/fs/cgroup/memory/docker/<id>/memory.limit_in_bytes`       | 1073741824 (1 GB)  |
| `/sys/fs/cgroup/memory/docker/<id>/memory.memsw.limit_in_bytes` | 2147483648 (2 GB)  |
| `/sys/fs/cgroup/memory/docker/<id>/memory.soft_limit_in_bytes`  | 536870912 (512 MB) |

---

## 🖼️ **Visualization** — Memory Limit Layers

<div align="center" style="background-color:#1b1515ff; border-radius: 10px; border: 2px solid">

```mermaid
---
config:
  look: handDrawn
  theme: dark
---
flowchart TD
  A[Container Memory Usage]
  B[Soft Limit (reservation)]
  C[Hard Limit (--memory)]
  D[Swap Limit (--memory-swap)]
  A -->|reclaim if pressure| B
  B -->|kill if exceeds| C
  C -->|allow swap up to| D
```

</div>

> 🧠 Linux tries to reclaim memory first (soft limit),
> then kills the container if it breaks the hard cap.

---

## 🧩 **Inspecting Memory Limits**

```bash
docker inspect <container> | grep -i mem
```

Or view live usage:

```bash
docker stats
```

Example output:

```ini
CONTAINER   MEM USAGE / LIMIT    MEM %   NET I/O
backend     780MiB / 1GiB        76%     12MB / 3MB
```

---

## 🧠 **Comparison Table** — All Memory Flags

| Flag                   | Purpose              | Type  | Enforced by        | Example                     |
| ---------------------- | -------------------- | ----- | ------------------ | --------------------------- |
| `--memory`             | Hard RAM limit       | Hard  | Cgroups            | `--memory=512m`             |
| `--memory-swap`        | Total RAM+swap limit | Hard  | Cgroups            | `--memory-swap=1g`          |
| `--memory-reservation` | Soft limit (hint)    | Soft  | Kernel reclaim     | `--memory-reservation=256m` |
| `--oom-kill-disable`   | Disable OOM killer   | Risky | Kernel OOM handler | `--oom-kill-disable=true`   |

---

## 🚀 **Best Practices**

✅ Always set both `--memory` and `--memory-swap`
✅ Use `--memory-reservation` for “nice to have” hints
✅ Never disable OOM killer in production
✅ Use `docker stats` or `cAdvisor` for monitoring
✅ For database containers: allow some swap (helps burst usage)
✅ For microservices: use strict hard caps to prevent runaway usage

---

## 🍕 **Analogy**: Memory as a Restaurant Kitchen

| Concept                | Analogy                                           |
| ---------------------- | ------------------------------------------------- |
| `--memory`             | Maximum number of ingredients allowed in kitchen  |
| `--memory-reservation` | Ideal daily ingredient usage target               |
| `--memory-swap`        | Borrowing ingredients from nearby store (swap)    |
| `--oom-kill-disable`   | Refusing to throw spoiled food → kitchen chaos 😅 |

---

## ✅ **Summary**

| Concept                                 | Description                                   |
| --------------------------------------- | --------------------------------------------- |
| **Memory Cgroup**                       | Controls and limits container memory          |
| **Hard Limit (`--memory`)**             | Absolute maximum memory usage                 |
| **Swap Limit (`--memory-swap`)**        | Adds swap headroom                            |
| **Soft Limit (`--memory-reservation`)** | Preferred operating zone                      |
| **OOM Killer**                          | Kernel process killer when memory exceeds cap |

---

## ✅ **In short**

Docker uses **memory cgroups** to make sure no container eats the whole buffet 🍴.
You can set **hard limits** (`--memory`, `--memory-swap`), **soft preferences** (`--memory-reservation`), and control **OOM behavior** (`--oom-kill-disable`).
Together, these keep your system **stable, fair, and predictable** — especially when running multiple apps or services.

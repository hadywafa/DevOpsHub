# ğŸ§© Lab 3 â€” Connecting Namespace Network (10.10.0.0/24) to External Host (192.168.1.3)

## ğŸ¯ Objective

We want two-way communication:

| Direction    | Description                                                              | Example            |
| ------------ | ------------------------------------------------------------------------ | ------------------ |
| **Outbound** | From namespace (e.g., blue: `10.10.0.2`) â†’ external host (`192.168.1.3`) | `ping 192.168.1.3` |
| **Inbound**  | From external host (`192.168.1.3`) â†’ namespace (`10.10.0.2`)             | `ping 10.10.0.2`   |

---

## ğŸ§± Network Topology

```text
        +----------------------------------------------------------+
        |                      Host1 (Docker Host)                 |
        |----------------------------------------------------------|
        | eth0: 192.168.1.2/24  (LAN interface)                    |
        | br0: 10.10.0.254/24 (Bridge)                             |
        | NAT: 10.10.0.0/24 -> 192.168.1.2                         |
        +-----------+----------------------------------------------+
                    |
      -----------------------------(LAN)------------------------------
                    |
        +-------------------------------------------+
        |         Host2 (Client / External)         |
        | eth0: 192.168.1.3/24                      |
        +-------------------------------------------+

Namespaces under Host1:
  red:   10.10.0.1
  blue:  10.10.0.2
  green: 10.10.0.3
  yellow:10.10.0.4
```

---

## ğŸ§  Conceptual Flow

| Case                        | What Happens                                           | Requires                        |
| --------------------------- | ------------------------------------------------------ | ------------------------------- |
| **Outbound (Blue â†’ Host2)** | Blue sends packet via bridge â†’ Host1 â†’ eth0 â†’ Host2    | Host1 does NAT (masquerade)     |
| **Inbound (Host2 â†’ Blue)**  | Host2 sends to 192.168.1.2 â†’ Host1 routes to 10.10.0.2 | Requires port forwarding (DNAT) |

---

## âš™ï¸ Step 1 â€” Confirm Host1â€™s Interface IPs

```bash
ip addr show eth0
ip addr show br0
```

Expected:

```ini
eth0: 192.168.1.2/24
br0:  10.10.0.254/24
```

---

## âš™ï¸ Step 2 â€” Enable IP Forwarding on Host1

This allows packets to _pass through_ Host1 (just like a router).

```bash
sysctl -w net.ipv4.ip_forward=1
```

Make it permanent:

```bash
echo "net.ipv4.ip_forward = 1" >> /etc/sysctl.conf
```

---

## âš™ï¸ Step 3 â€” Configure Default Route in Each Namespace

Tell namespaces that their gateway is the bridge (`10.10.0.254`).

```bash
ip -n red route add default via 10.10.0.254
ip -n blue route add default via 10.10.0.254
ip -n green route add default via 10.10.0.254
ip -n yellow route add default via 10.10.0.254
```

âœ… Test:

```bash
ip netns exec blue ip route
```

Should show:

```ini
default via 10.10.0.254 dev veth-blue
10.10.0.0/24 dev veth-blue proto kernel scope link src 10.10.0.2
```

---

## ğŸ§  Step 4 â€” Outbound Communication (Blue â†’ Host2)

Weâ€™ll use **NAT (masquerading)** on Host1 so packets from 10.10.0.x can go out via eth0.

### 4.1 Add iptables NAT Rule on Host1

```bash
iptables -t nat -A POSTROUTING -s 10.10.0.0/24 -o eth0 -j MASQUERADE
```

âœ… This hides the internal IP (10.10.0.2) and replaces it with Host1â€™s public IP (192.168.1.2).

So when Blue pings Host2:

1. Blue (10.10.0.2) â†’ sends packet to 10.10.0.254 (gateway)
2. Host1 NATs it â†’ source becomes 192.168.1.2
3. Host2 replies to 192.168.1.2
4. Host1 un-NATs and forwards reply to Blue

### 4.2 Test Outbound

From inside blue namespace:

```bash
ip netns exec blue ping -c 2 192.168.1.3
```

âœ… Expected: Successful reply!

---

## ğŸ§© Step 5 â€” Inbound Communication (Host2 â†’ Blue Namespace)

Outbound worked because of NAT â€” but **inbound requires DNAT** (port forwarding).

Letâ€™s forward packets from Host1â€™s IP:Port â†’ Blueâ€™s internal IP.

Example: allow SSH (port 2222 external â†’ 22 internal)

```bash
iptables -t nat -A PREROUTING -p tcp -d 192.168.1.2 --dport 2222 \
  -j DNAT --to-destination 10.10.0.2:22
iptables -A FORWARD -p tcp -d 10.10.0.2 --dport 22 -j ACCEPT
```

Now from **Host2 (192.168.1.3)**:

```bash
ssh -p 2222 user@192.168.1.2
```

âœ… Youâ€™ll connect to SSH server running inside Blue namespace (10.10.0.2:22).

---

## âš™ï¸ Step 6 â€” Test Inbound Ping (Optional with Static Route)

For ICMP (ping), DNAT is trickier.
You can either:

- Add a static route in Host2, or
- Keep using NAT for TCP/UDP access

To allow raw ping **without NAT**, youâ€™d need Host2 to know 10.10.0.0/24 exists behind Host1.

On Host2:

```bash
ip route add 10.10.0.0/24 via 192.168.1.2
```

âœ… Now, direct pings work both ways:

```bash
ping -c 2 10.10.0.2  # From Host2
```

---

## ğŸ§  Deep Dive: Packet Flow

### ğŸ”¹ Outbound (Blue â†’ Host2)

```text
[10.10.0.2] â”€â”€â–º [br0 10.10.0.254] â”€â”€â–º NAT (to 192.168.1.2) â”€â”€â–º [Host2 192.168.1.3]
```

Return path:

```ini
[Host2 192.168.1.3] â”€â”€â–º [192.168.1.2] â”€â”€â–º Un-NAT â†’ [10.10.0.2]
```

### ğŸ”¹ Inbound (Host2 â†’ Blue)

If DNAT rule added:

```text
192.168.1.3:2222 â†’ 192.168.1.2:2222 (PREROUTING)
     â†“
DNAT â†’ 10.10.0.2:22 â†’ Blue namespace
```

---

## ğŸ§© Diagram â€” Full Setup

```mermaid
---
config:
  look: handDrawn
---
graph TD
  subgraph Host2 [Host2 - 192.168.1.3]
    H2eth[eth0]
  end

  subgraph Host1 [Host1 - Router + Namespaces]
    subgraph br0 [Bridge br0: 10.10.0.254/24]
      BRveth1[veth-blue-br]
      BRveth2[veth-red-br]
      BRveth3[veth-green-br]
      BRveth4[veth-yellow-br]
    end
    ETH[eth0: 192.168.1.2]
    subgraph Blue [ns: blue 10.10.0.2]
      VBlue[veth-blue]
    end
    BRveth1<-->VBlue
    ETH-->|NAT|BRveth1
  end

  H2eth--192.168.1.0/24 LAN-->ETH
```

---

## ğŸ§© Step 7 â€” Verify Everything

| Test               | Command                               | Expected    |
| ------------------ | ------------------------------------- | ----------- |
| Outbound from Blue | `ip netns exec blue ping 192.168.1.3` | âœ… replies  |
| Inbound via NAT    | `ssh -p 2222 user@192.168.1.2`        | âœ… connects |
| Inbound via route  | `ping 10.10.0.2` (after static route) | âœ… replies  |

---

## ğŸ’¡ Summary Table

| Action                        | Mechanism                      | Tool                                        |
| ----------------------------- | ------------------------------ | ------------------------------------------- |
| Namespaces â†’ Host â†’ LAN       | Source NAT (MASQUERADE)        | `iptables -t nat -A POSTROUTING`            |
| Host â†’ Namespace              | Destination NAT (Port forward) | `iptables -t nat -A PREROUTING`             |
| Host2 â†’ Namespace (direct IP) | Static route                   | `ip route add 10.10.0.0/24 via 192.168.1.2` |
| Routing between br0 â†” eth0    | IP forwarding                  | `sysctl -w net.ipv4.ip_forward=1`           |

---

## ğŸ”¥ Key Takeaways

- **Namespaces are isolated**, but you can â€œconnectâ€ them using Linux networking primitives.
- **Bridge acts as Layer 2 switch**.
- **IP forwarding** turns the host into a router.
- **NAT (MASQUERADE)** enables outbound traffic.
- **DNAT + Forwarding** enables inbound traffic.
- **Static routes** allow direct reachability without NAT.

---

Would you like me to continue with **Lab 4 â€” Connecting Internet (External WAN) to namespaces via NAT (real outbound Internet access)** next?

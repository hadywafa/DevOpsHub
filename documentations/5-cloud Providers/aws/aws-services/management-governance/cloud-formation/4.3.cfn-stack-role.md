# **üõ°Ô∏è AWS CloudFormation Stack Role**

## **üìå Introduction**

By default, when a user creates or updates a CloudFormation stack, **the stack operates with the IAM permissions of the user who initiated the request**. This means that if a user lacks the necessary IAM permissions, CloudFormation **fails to deploy resources**.

To solve this, **AWS CloudFormation Stack Roles** allow CloudFormation to assume an IAM role with **predefined permissions**, ensuring:

‚úÖ **Users can deploy stacks without requiring extensive IAM permissions.**  
‚úÖ **CloudFormation has only the permissions it needs to manage stack resources.**  
‚úÖ **Enhanced security and compliance by limiting direct user privileges.**

---

![cfn-stack-role](images/cfn-stack-role.png)

---

## **üîñ Why Do We Need a Stack Role?**

| **Scenario**                        | **Why a Stack Role is Needed?**                                     |
| ----------------------------------- | ------------------------------------------------------------------- |
| **User has limited permissions**    | Allows stack deployment using an IAM role with broader permissions. |
| **Multiple teams deploying stacks** | Ensures consistency in permissions across environments.             |
| **Compliance and governance**       | Restricts unauthorized changes to sensitive resources.              |
| **Separation of duties**            | Developers can deploy stacks without having direct IAM permissions. |

---

## **üîñ How Stack Role Works in AWS CloudFormation**

1Ô∏è‚É£ **User initiates a CloudFormation stack operation** (create, update, delete).  
2Ô∏è‚É£ **CloudFormation assumes the IAM Role specified as the Stack Role.**  
3Ô∏è‚É£ **CloudFormation uses the role‚Äôs permissions** to provision or modify AWS resources.

```mermaid
sequenceDiagram
autonumber
participant Admin as Administrator
participant Developer as Developer
participant CloudFormation as AWS CloudFormation
participant IAMRole as Stack Role (IAM)
Admin->>IAMRole: 1Ô∏è‚É£ Create Stack Role with Required Permissions
Developer->>CloudFormation: 2Ô∏è‚É£ Create/Update/Delete Stack
CloudFormation->>IAMRole: 3Ô∏è‚É£ Assume Role for Execution
IAMRole->>CloudFormation: ‚úÖ Temporary Permissions Granted
CloudFormation->>AWSResources: 4Ô∏è‚É£ Deploy Resources Using Role
```

‚úÖ **Ensures CloudFormation operates with controlled permissions, reducing security risks.**

---

## **üîñ Setting Up a Stack Role for Developers**

### **üõ†Ô∏è Step 1: Administrator Creates the Stack Role**

#### **Create an IAM Role for CloudFormation Execution**

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "cloudformation.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
```

‚úî **Allows CloudFormation to assume this role.**

#### **Attach Permissions for CloudFormation Execution**

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": ["ec2:CreateInstance", "s3:CreateBucket", "iam:PassRole"],
      "Resource": "*"
    }
  ]
}
```

‚úî **Grants permissions to CloudFormation to create AWS resources.**

---

### **üõ†Ô∏è Step 2: Developer Uses the Stack Role for Deployment**

#### **Developer‚Äôs IAM Policy** (Minimal Permissions)

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": ["cloudformation:CreateStack", "cloudformation:UpdateStack", "cloudformation:DeleteStack"],
      "Resource": "*"
    }
  ]
}
```

‚úî **Developer can manage CloudFormation stacks but not directly access AWS resources.**

---

## **üîñ How a Developer Uses a Stack Role in AWS CLI**

### **üõ†Ô∏è Create a Stack with a Specific Role**

```sh
aws cloudformation create-stack --stack-name MySecureStack \
  --template-body file://template.yaml \
  --role-arn arn:aws:iam::123456789012:role/MyCloudFormationRole
```

‚úî **Ensures CloudFormation assumes the correct IAM Role for stack execution.**

---

### **üõ†Ô∏è Updating a Stack with a Specific Role**

```sh
aws cloudformation update-stack --stack-name MySecureStack \
  --template-body file://template.yaml \
  --role-arn arn:aws:iam::123456789012:role/MyCloudFormationRole
```

‚úî **Ensures updates are performed with controlled permissions.**

---

## **üîñ Using a Stack Role in Nested Stacks**

When deploying **nested stacks**, the **parent stack role must have permissions to pass roles** to child stacks. Use the `RoleARN` property in the nested stack definition:

### **üõ†Ô∏è Example: Assigning a Role to a Nested Stack**

```yaml
Resources:
  ParentStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      StackName: "ParentStack"
      TemplateURL: "https://s3.amazonaws.com/mybucket/parent-template.yaml"
      RoleARN: "arn:aws:iam::123456789012:role/MyCloudFormationRole"

  NestedStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      StackName: "NestedStack"
      TemplateURL: "https://s3.amazonaws.com/mybucket/nested-template.yaml"
      RoleARN: "arn:aws:iam::123456789012:role/MyCloudFormationRole"
```

‚úî **Ensures both parent and nested stacks use the same IAM Role for execution.**

---

## **üîñ Best Practices for Using Stack Roles**

‚úÖ **Use IAM Least Privilege Model**

- Grant CloudFormation only the permissions it needs.  
  ‚úÖ **Restrict Role Usage to CloudFormation Service**
- Prevent unintended use of the role by other AWS services.  
  ‚úÖ **Monitor Role Assumption with AWS CloudTrail**
- Track who and when CloudFormation assumes the role.  
  ‚úÖ **Use Service Control Policies (SCPs) in AWS Organizations**
- Prevent users from overriding stack roles manually.

---

## **‚úÖ Conclusion**

AWS CloudFormation **Stack Roles** provide a secure, controlled way to deploy AWS resources by **delegating permissions to an IAM role** rather than relying on user credentials.

‚úî **Ensures security by limiting direct user access.**  
‚úî **Facilitates compliance and governance.**  
‚úî **Prevents privilege escalation and misconfigurations.**

üí° **Using Stack Roles effectively enhances security and control over AWS deployments!** üöÄ

# **ğŸ”¢ AWS CloudFormation StackSets**

AWS CloudFormation **StackSets** enable you to deploy and manage **CloudFormation stacks across multiple AWS accounts and regions** from a **centralized** control point.

âœ” **Simplifies infrastructure management** â€“ Deploy CloudFormation stacks at scale.  
âœ” **Ensures consistency** â€“ Enforce standardized infrastructure across accounts/regions.  
âœ” **Automates deployments** â€“ Apply infrastructure changes automatically across environments.

---

![cfn-stack-set](images/cfn-stack-set.png)

---

## **ğŸ› ï¸ How AWS CloudFormation StackSets Work?**

### **Key Components:**

**1ï¸âƒ£ StackSet** â€“ A **template and configuration** that defines the stack to be deployed across accounts/regions.  
**2ï¸âƒ£ Stack Instances** â€“ Individual stacks deployed in each target account and region.  
**3ï¸âƒ£ Administrator Account** â€“ The AWS account that manages StackSet operations.  
**4ï¸âƒ£ Target Accounts** â€“ AWS accounts where the stack will be deployed.  
**5ï¸âƒ£ Execution Role** â€“ An IAM role in each target account that grants permissions for deployment.

âœ… **AWS Organizations Integration:** Use StackSets with **Service-Managed Permissions** to automate deployments across your organization.

---

## **ğŸ”— StackSet Deployment Models**

### **1ï¸âƒ£ Self-Managed Permissions**

- **Administrator Account** deploys stacks to **target accounts**.
- **Execution IAM Role** is required in each target account.
- Best for organizations with **custom IAM permission models**.

### **2ï¸âƒ£ Service-Managed Permissions (AWS Organizations Integration)**

- StackSets automatically deploy to **all accounts in an AWS Organization**.
- AWS CloudFormation manages IAM roles **automatically**.
- Best for large-scale **enterprise deployments**.

âœ… **Recommendation:** Use **Service-Managed Permissions** for streamlined, secure deployments across an AWS Organization.

---

## **ğŸŒ Why Use AWS CloudFormation StackSets?**

ğŸ”¹ **Multi-Account Deployments** â€“ Deploy CloudFormation stacks across multiple AWS accounts within an AWS Organization.  
ğŸ”¹ **Multi-Region Deployments** â€“ Ensure infrastructure is consistent across AWS regions.  
ğŸ”¹ **Centralized Management** â€“ Control deployments from a single AWS account.  
ğŸ”¹ **Automated Rollouts** â€“ Enable automatic stack creation, updates, and deletions across accounts.  
ğŸ”¹ **IAM Permission Control** â€“ Manage IAM roles for StackSet execution securely.

---

## **ğŸ—ï¸ Creating an AWS CloudFormation StackSet**

### **1ï¸âƒ£ Define the StackSet Template**

The **CloudFormation template** should define the infrastructure resources (e.g., IAM roles, VPCs, S3 buckets).

**Example CloudFormation Template (S3 Bucket Creation):**

```yaml
AWSTemplateFormatVersion: "2010-09-09"
Description: "StackSet Example - S3 Bucket Deployment"

Resources:
  MyS3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "my-stackset-bucket-${AWS::Region}-${AWS::AccountId}"
```

âœ” **Defines an S3 bucket that will be deployed across accounts/regions.**

---

### **2ï¸âƒ£ Create the StackSet in AWS CloudFormation**

#### **Using AWS CLI**

```sh
aws cloudformation create-stack-set \
  --stack-set-name MyStackSet \
  --template-body file://stackset-template.yaml \
  --permission-model SERVICE_MANAGED
```

âœ” **Creates a StackSet with service-managed permissions.**

---

### **3ï¸âƒ£ Add Stack Instances (Deploy to Accounts/Regions)**

Deploy the StackSet across multiple AWS accounts and regions.

#### **Using AWS CLI**

```sh
aws cloudformation create-stack-instances \
  --stack-set-name MyStackSet \
  --accounts 111122223333 444455556666 \
  --regions us-east-1 us-west-2
```

âœ” **Deploys the StackSet to multiple accounts (`111122223333`, `444455556666`) in multiple regions (`us-east-1`, `us-west-2`).**

---

### **4ï¸âƒ£ Updating a StackSet**

If you need to update the stack, modify the StackSet template and apply the update.

#### **Using AWS CLI**

```sh
aws cloudformation update-stack-set \
  --stack-set-name MyStackSet \
  --template-body file://updated-template.yaml
```

âœ” **Updates the CloudFormation resources across all stack instances.**

---

## **âŒ Deleting StackSets**

To remove stacks from target accounts, delete stack instances first, then delete the StackSet.

### **1ï¸âƒ£ Delete Stack Instances**

```sh
aws cloudformation delete-stack-instances \
  --stack-set-name MyStackSet \
  --accounts 111122223333 444455556666 \
  --regions us-east-1 us-west-2 \
  --no-retain-stacks
```

âœ” Removes the stack instances without retaining resources.

### **2ï¸âƒ£ Delete the StackSet**

```sh
aws cloudformation delete-stack-set --stack-set-name MyStackSet
```

âœ” Deletes the StackSet after all instances are removed.

---

## **ğŸ”¤ Key Terms in AWS CloudFormation StackSets**

| **Term**                | **Definition**                                                                 |
| ----------------------- | ------------------------------------------------------------------------------ |
| **Concurrent Accounts** | The number of AWS accounts where stack operations are executed simultaneously. |
| **Failure Tolerance**   | Maximum number of accounts or regions that can fail during deployment.         |
| **Retain Stacks**       | Retains the stack resources when deleting stack instances to avoid data loss.  |

## **âš ï¸ StackSet Limitations & Considerations**

| **Limitation**                             | **Description**                                                     |
| ------------------------------------------ | ------------------------------------------------------------------- |
| **Requires IAM Roles**                     | Execution roles must exist in target accounts (Self-Managed).       |
| **Region-Specific**                        | Stacks must be created in **AWS-supported regions**.                |
| **StackSet Updates Are Sequential**        | Updates happen **one region at a time**, not simultaneously.        |
| **Stack Deletion Order Matters**           | You must delete **stack instances first** before deleting StackSet. |
| **Service-Managed Model Requires AWS Org** | Only works if your accounts are part of an **AWS Organization**.    |

---

## **âœ… Best Practices for Using StackSets**

âœ” **Use AWS Organizations & Service-Managed Permissions** for automated multi-account deployments.  
âœ” **Design templates with dynamic naming** (e.g., `!Sub "${AWS::Region}-${AWS::AccountId}"`).  
âœ” **Enable StackSet drift detection** to monitor infrastructure consistency.  
âœ” **Test updates in a single region/account first** before rolling out globally.  
âœ” **Use parameters in templates** to customize deployments per account/region.  
âœ” **Avoid frequent updates** to minimize deployment time across accounts.

---

## ğŸ“ **Conclusion**

AWS CloudFormation **StackSets** enable **scalable, automated, and consistent** infrastructure deployments across **multiple AWS accounts and regions**.

âœ” **Streamlines infrastructure management at scale**.  
âœ” **Ensures standardization and compliance** across AWS environments.  
âœ” **Reduces operational overhead** for multi-account deployments.

ğŸ’¡ **Mastering StackSets simplifies enterprise-wide AWS CloudFormation deployments!** ğŸš€

# Limiting Origin Access

## Limiting Origin Access Through CloudFront Only (EC2 & ALB)

- AWS publishes the IP ranges for CloudFront edge servers.
- For ALB and EC2 origins, we can limit the incoming requests through CloudFront only.
- Using the CloudFront edge servers IP information, we can configure the NACLs and Security Groups of the EC2 or the ALB origins.

---

- CloudFront managed prefix-list contains the IP address ranges of CloudFront edge servers.
- We can use the CloudFront managed prefix-list in the security group configuration for EC2 or ALB origins.
- CloudFront maintains the prefix-list, so customers do not have to keep updating the list of IP Addresses for CloudFront.
- Prefix-list name for CloudFront is, `com.amazonaws.global.cloudfront.origin-facing`

## Limiting Access Through CloudFront Only (S3 Bucket Origins)

`Origin Access Control (OAC)` is a CloudFront Services Principal

- It can be used as a principal in S3 bucket policies to provide access through authenticated requests to S3.
- We can use it to restrict access to S3 buckets and limit this access through CloudFront only.
- The S3 bucket must be a regular one, not a website endpoint bucket

---

AWS recommends removing the public access to any S3 buckets used as origin servers with CloudFront.

```json
// Bucket Policy - CloudFront Origin Access Control (OAC)
{
  "Version": "2012-10-17",
  "Statement": {
    "Sid": "AllowCloudFrontServicePrincipalReadOnly",
    "Effect": "Allow",
    "Principal": {
      "Service": "cloudfront.amazonaws.com"
    },
    "Action": "s3:GetObject",
    "Resource": "arn:aws:s3:::<S3 bucket name>/*",
    "Condition": {
      "StringEquals": {
        "AWS:SourceArn": "arn:aws:cloudfront::<AWS account ID>:distribution/<CloudFront distribution ID>"
      }
    }
  }
}
```

### Signing (Authorization) Behavior

- **Sign origin requests:** CloudFront always signs all requests sent to the S3 bucket origin.
- Do not sign requests
  - CloudFront will not sign any requests sent to the S3 bucket origin.
  - In this case for cloudfront to access the bucket, it must be publicly accessible.
- Do not override Authorization header
  - Pass on the client authorization header or sign the request when no authorization header is present

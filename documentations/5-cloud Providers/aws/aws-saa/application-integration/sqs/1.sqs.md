# SQS

A message queue is a form of asynchronous service-to-service communication used in serverless and microservices architectures.

![sqs](images/sqs.png)

**Message queues can:**

- Enhance application performance.
- Increase reliability.
- Allow for granular scalability.
- Simplify application coding.

---

- SQS is a `fast`, `reliable`, `durable`, `secure` and `fully managed` web-based hosted message queue service.
- `Durability`: SQS stores all message queues and messages `across multiple AZs in one AWS region`.
- Clients no longer need to build and run highly available message clusters in AWS.
- SQS is a `poll-based` service. Consumers need to read messages from the queues.

---

- An `unlimited number` of messages can be written to a queue.
  - `message size can be up to 256KB`.
  - `We can write up to 10 message (in a batch) but the size is still limited to 256KB`.
- EC2 instances or Lambda functions can be used to write and/or process messages to/from the queue.
- Use EC2 instances with auto scaling to scale consumers based on the number of messages in the queue.
  - CloudWatch can be used to monitor the message queue length metric for SQS queue

## Message Lifecycle

-- explain the message lifecycle from producer to consumer, include all cases such as message success or failed ..etc

## Queue Types

### 1. Standard SQS Queue

- Unlimited Throughput.
- At least once delivery of messages.
- Duplicate messages are possible.
- Best effort ordering

### 2. FIFO SQS Queue

- 300 TPS/API, 3000 TPS/API with batching.
- Exactly once processing.
- No duplicates.
- Strict First-In First-Out ordering.

## Polling types

### 1. Short Polling (Default)

- The request is responded to immediately even if the queue is empty.
- Higher cost due to the increased number of requests.

### 2. Long Polling

- SQS `waits up to 20 seconds` (configurable) for a message to appear in the queue before returning a response.
- Less requests means lower costs

## Retention Period, Visibility Timeout & Delay Queue

### 1. Retention Period

SQS messages can remain in the queue for `up to 14 days`. The `default is 4 days`

### 2. Visibility Timeout

Is the duration of time a message is locked for read by other consumers after it has been read by a consumer to process it (`default is 30 seconds`, the `maximum is 12 hrs`)

### 3. Delay Queue

Allows for delaying the delivery of new messages to the queue. `Default is 0 seconds`, `max is 15 minutes`

## Auto Scaling The Consumers

**This can be based on several CloudWatch Metrics:**

1. **ApproximateAgeOfOldestMessage:** The approximate age of the oldest non-deleted message in the queue.
2. **NumberOfMessagesSent:** The number of messages added to a queue.
3. **ApproximateNumberOfMessagesVisible:** The number of messages available for retrieval from the queue.

## Pricing

- Pricing is based on the number of requests per month.
- Every Amazon SQS API `action/call` is counted as a request.
- Each `64 KB chunk` of payload is charged as `one request`.
- Data transfer out (per GB)
- Standard and FIFO rates are different, FIFO costs more.

# **IAM Role - Advanced Overview üîë**

An **IAM Role** is a powerful AWS feature that enables flexible, temporary, and secure access to AWS resources. Unlike IAM users, IAM roles do not have long-term credentials like passwords or access keys. Instead, they use **STS temporary credentials**, which are dynamically created and expire after a set time period.

## **What is an IAM Role? ü§î**

An **IAM Role** is an entity that defines a set of permissions to access specific AWS resources. It can be assumed (used) by anyone authorized to do so, such as IAM users, AWS services, or even external users.

### **Key Characteristics:**

- **No Long-Term Credentials**: IAM roles do not store passwords or access keys. They rely on temporary **STS credentials**.
- **Assumable by Anyone**: Unlike IAM users, an IAM role can be assumed by:

  - **IAM users** within the same or different AWS accounts.
  - **AWS services** like EC2, Lambda, and S3.
  - **Federated users** (non-IAM users) authenticated through an external identity provider.

**Why use IAM roles?**  
With IAM roles, you do not need to manage long-term security credentials for every entity that needs access to your AWS resources, which improves security and reduces the overhead of credential management.

## **Anatomy of an IAM Role ‚öôÔ∏è**

An IAM Role is composed of two key components:

1. **Permissions Policy üìù**:

   - Specifies what actions are allowed with the role, such as accessing certain AWS services (S3, EC2, etc.).

2. **Trust Policy üîë**:
   - Specifies who can assume the role (which entities are authorized). The trust policy is what defines the **"Principal"** that is allowed to assume the role.

## **Cross-Account Access üè¶**

IAM roles are commonly used for **cross-account access**, allowing resources from one AWS account (Account A) to be accessed by resources in another AWS account (Account B). This is useful when multiple AWS accounts need to interact with each other.

### **How Cross-Account Access Works üîó**

1. **Trusting Account (Account A)**:

   - The IAM role in **Account A** defines which entities are allowed to assume the role.
     ![IAM Role Trusting Account](images/iam-role-trusting-account.png)

2. **Trusted Account (Account B)**:
   - The IAM user or resource in **Account B** must have the necessary permission to **assume the role** in Account A.
     ![IAM Role Trusted Account](images/iam-role-trusted-account.png)

### **Example of Cross-Account Access üìÅ**

![iam-role-ex-cross-account-access](images/iam-role-ex-cross-account-access.png)

Let's say **Account A** wants to grant **Account B** access to its S3 bucket (`s3bucket123`).

**Account A - Trust Policy (IAM Role)**  
This policy defines that **Account B** is allowed to assume the role in **Account A**.

```json
{
  "Version": "2012-10-17",
  "Statement": {
    "Effect": "Allow",
    "Principal": { "AWS": "arn:aws:iam::AccountB-ID:root" },
    "Action": "sts:AssumeRole"
  }
}
```

**Account A - Permissions Policy (IAM Role)**  
This policy defines the permissions granted when **Account B** assumes the role. Here, **Account B** is allowed to list the contents of the `s3bucket123`.

```json
{
  "Version": "2012-10-17",
  "Statement": {
    "Effect": "Allow",
    "Action": "s3:ListBucket",
    "Resource": "arn:aws:s3:::s3bucket123"
  }
}
```

**Account B - User Policy**  
This policy allows **Account B's** IAM user to assume the role in **Account A**.

```json
{
  "Version": "2012-10-17",
  "Statement": {
    "Effect": "Allow",
    "Action": "sts:AssumeRole",
    "Resource": "arn:aws:iam::AccountA-ID:role/ls3bucket"
  }
}
```

## **Using External ID in Cross-Account Access üîê**

Imagine that you have two AWS accounts:

- **Account A**: A company that owns resources (e.g., S3 buckets, EC2 instances) and wants to allow access to those resources by a trusted third party.
- **Account B**: A third-party service provider that needs access to **Account A's** resources (e.g., accessing the S3 bucket to store logs).

Without any safeguards in place (like an **External ID**), Account A could inadvertently give **Account B** too much access, or allow a malicious third party to misuse the permissions. This is known as the **Confused Deputy Problem**.

### **Scenario: Without External ID (The Confused Deputy Problem)**

1. **Account A** creates a role and trusts **Account B** to assume that role.
2. **Account A** allows **Account B** to access its resources, like an S3 bucket, through a trust policy (e.g., **sts:AssumeRole**).
3. **Account B** has access to assume the role in **Account A**. However, **Account B** might not be the only party that can assume the role.
4. A malicious user from **Account C** can use **Account B‚Äôs** identity or service to assume **Account A's** role without **Account A** knowing. This happens because the role does not validate if **Account C** is the one attempting to assume the role, allowing **Account C** to take advantage of **Account B‚Äôs** permissions.

### **The Problem:**

- **Account A** intended to grant access to **Account B**, but **Account C** (a malicious third party) could also use **Account B's** role to gain unauthorized access to **Account A's** resources.
- **Account A** has no way of verifying that **Account C** is not pretending to be **Account B**.

This is the **Confused Deputy Problem**‚Äîwhere the deputy (Account B) gets "confused" by an external party (Account C) and grants access unintentionally.

### **How External ID Solves the Problem:**

The **External ID** is an added security feature to prevent this kind of confusion. It‚Äôs like a secret password that ensures that only the right party (**Account B**) can access **Account A‚Äôs** resources, and **Account C** cannot misuse the permissions.

### **Solution with External ID:**

1. **Account A** creates a role and specifies a trust policy that requires **Account B** to provide a specific **External ID** when assuming the role.
2. **Account B** knows the **External ID** and uses it when making a request to assume the role.
3. **Account C**, even though it might know the role ARN of **Account A**, **cannot assume the role** because it doesn‚Äôt know the **External ID**.
4. **Account A** is now confident that only **Account B** (with the correct **External ID**) can assume the role and access its resources.

### **Example:**

#### **Account A - Trust Policy with External ID**

```json
{
  "Version": "2012-10-17",
  "Statement": {
    "Effect": "Allow",
    "Principal": { "AWS": "arn:aws:iam::AccountB-ID:root" },
    "Action": "sts:AssumeRole",
    "Condition": {
      "StringEquals": {
        "sts:ExternalId": "secret123"
      }
    }
  }
}
```

#### **Account B - User Policy to Assume the Role**

```json
{
  "Version": "2012-10-17",
  "Statement": {
    "Effect": "Allow",
    "Action": "sts:AssumeRole",
    "Resource": "arn:aws:iam::AccountA-ID:role/MyRole",
    "Condition": {
      "StringEquals": {
        "sts:ExternalId": "secret123"
      }
    }
  }
}
```

In this case:

- **Account B** can assume the role **only if** it includes the correct **External ID** ("secret123").
- **Account C**, even if it knows the role ARN, cannot assume the role because it does not have the correct **External ID**.

### **The Benefit of Using External ID:**

- **Prevents unauthorized access** by ensuring that only the **intended entity** (Account B) can assume the role.
- It **secures cross-account access** by verifying that the entity requesting access is indeed the trusted one (Account B), not a potential attacker (Account C).
- Protects against **malicious third parties** who might try to exploit roles across accounts.

## **Conclusion üéØ**

**IAM Roles** are a powerful feature in AWS, enabling secure and flexible management of access to AWS resources. Whether you're managing cross-account access, federating external users, or using temporary credentials, IAM roles provide a seamless way to ensure that only the right entities can assume roles and access critical resources. By using trust and permissions policies, along with features like **External IDs** and **STS**, AWS provides granular control over who can assume roles and perform actions on your resources.

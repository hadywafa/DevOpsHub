# üîß **Prometheus Relabeling** ‚Äî ‚ÄúWhere Labels Are Born, Filtered, and Transformed‚Äù

## üìñ **What Is Relabeling?**

> **Relabeling** is Prometheus‚Äôs mechanism to **transform, filter, or drop targets and labels** ‚Äî before scraping happens.

Think of it as a **pipeline** that processes every discovered target (and metric labels later) using flexible rules.

Relabeling =  
üß© **Discovery ‚Üí Transformation ‚Üí Filtering ‚Üí Scraping**

---

## ‚ÅâÔ∏è **Where Relabeling Is Used**

There are **two main contexts** where relabeling occurs:

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Type                                             | When It Happens | Purpose                                        |
| ------------------------------------------------ | --------------- | ---------------------------------------------- |
| **Target Relabeling** (`relabel_configs`)        | Before scraping | Filter or modify discovered targets            |
| **Metric Relabeling** (`metric_relabel_configs`) | After scraping  | Filter or modify labels _on collected samples_ |

</div>

---

<div align="center" style="background-color: #11171F; border-radius: 10px; border: 2px solid">
    <img src="image/1762567657575.png" alt="Instant Vector" style="width: 80%">
</div>

---

## üß© **Relabeling Flow (Visual)**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

```mermaid
flowchart LR
    A[Service Discovery] --> B[Discovered Targets + __meta_ labels]
    B --> C[relabel_configs]
    C -->|Filtered & Transformed| D[Final Scrape Targets]
    D --> E[Scraping Metrics]
    E --> F[metric_relabel_configs]
    F --> G[Final Stored Metrics in TSDB]
```

</div>

---

## üß† **How It Works**

Each relabel rule is applied **in order**, and every rule can:

- **Read** labels (`source_labels`)
- **Apply** a regex match
- **Perform an action** (keep, drop, replace, etc.)
- **Write** the result into a new or existing label (`target_label`)

---

## üß© **The Relabel Rule Structure**

```yaml
relabel_configs:
  - source_labels: [__meta_ec2_tag_Name]
    target_label: instance
    regex: (.*)
    replacement: ${1}
    action: replace
```

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Field           | Purpose                                                            |
| --------------- | ------------------------------------------------------------------ |
| `source_labels` | List of labels to read input from                                  |
| `regex`         | Regular expression applied to joined source labels                 |
| `replacement`   | Template string to write into `target_label`                       |
| `target_label`  | Label that will be modified or created                             |
| `action`        | Operation type (e.g., `replace`, `keep`, `drop`, `labelmap`, etc.) |

</div>

---

## ‚öôÔ∏è **Available Actions**

Let‚Äôs break down all **actions** with examples üëá

---

### 1Ô∏è‚É£ `replace` ‚Äî The Most Common One

> Replace or create a new label based on another.

```yaml
- source_labels: [__meta_ec2_tag_Name]
  target_label: instance
  regex: (.*)
  replacement: ${1}
  action: replace
```

üß† **Example:**  
If AWS tag Name = `webserver-1`  
‚Üí Prometheus sets `instance="webserver-1"`

‚úÖ Used for creating human-friendly labels from metadata.

---

### 2Ô∏è‚É£ `keep` ‚Äî Keep Only Matching Targets

> Keeps targets that **match** the regex.

```yaml
- source_labels: [__meta_ec2_tag_Environment]
  regex: prod
  action: keep
```

üß† **Example:**
Only scrape EC2 instances tagged `Environment=prod`.

Everything else is dropped.

---

### 3Ô∏è‚É£ `drop` ‚Äî Exclude Matching Targets

> Drops targets that **match** the regex.

```yaml
- source_labels: [__meta_kubernetes_namespace]
  regex: dev
  action: drop
```

üß† **Example:**
Don‚Äôt scrape any pods in the `dev` namespace.

‚úÖ Very useful for ignoring test environments.

---

### 4Ô∏è‚É£ `hashmod` ‚Äî Assign Targets to Buckets

> Compute a hash and take a modulo ‚Äî often used for **sharding Prometheus** setups.

```yaml
- source_labels: [__address__]
  target_label: __tmp_hash
  modulus: 4
  action: hashmod
```

üß† **Example:**  
Splits targets into 4 shards (`0`, `1`, `2`, `3`) based on their address.

Used in **federation** or **HA Prometheus** setups.

---

### 5Ô∏è‚É£ `labelmap` ‚Äî Copy Labels by Pattern

> Dynamically copy labels that match a regex.

```yaml
- regex: __meta_kubernetes_pod_label_(.+)
  action: labelmap
```

üß† **Example:**  
Copies all pod labels like `app`, `env`, etc. into normal labels:

```INI
__meta_kubernetes_pod_label_app="api"
‚Üì
app="api"
```

‚úÖ Saves you from writing dozens of replace rules.

---

### 6Ô∏è‚É£ `labeldrop` ‚Äî Drop Labels Matching Regex

> Removes labels from the target or sample.

```yaml
- regex: __meta_kubernetes_pod_label_.+
  action: labeldrop
```

üß† **Example:**  
Drops all metadata labels to reduce cardinality.

---

### 7Ô∏è‚É£ `labelkeep` ‚Äî Keep Only Specific Labels

> The opposite of labeldrop.

```yaml
- regex: (app|instance|job)
  action: labelkeep
```

üß† **Example:**  
Keeps only `app`, `instance`, and `job` ‚Äî drops everything else.

---

### 8Ô∏è‚É£ `uppercase` / `lowercase`

> Convert label values to uppercase or lowercase.

```yaml
- source_labels: [env]
  target_label: env
  action: lowercase
```

üß† **Example:**  
Turns `Prod` ‚Üí `prod` for label consistency.

---

### 9Ô∏è‚É£ `replace_all` (in newer Prometheus)

> Like replace, but applies multiple times per label.

Used when you want to replace _all_ regex matches, not just the first.

---

## üß© **Special Labels You Must Know**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Label              | Purpose                                            |
| ------------------ | -------------------------------------------------- |
| `__address__`      | The target‚Äôs host:port ‚Äî Prometheus scrapes this   |
| `__scheme__`       | HTTP or HTTPS                                      |
| `__metrics_path__` | Path to metrics endpoint (default `/metrics`)      |
| `__param_<name>`   | Sets query parameter for the scrape request        |
| `__meta_*`         | Metadata labels from Service Discovery (temporary) |
| `__tmp_*`          | Temporary labels (used during relabeling)          |

</div>

---

üí° After relabeling is done:

- `__meta_*` and `__tmp_*` are deleted automatically
- Only normal labels (like `job`, `instance`, `env`) remain

---

## üìù **Real-World Examples**

### üß≠ Example 1 ‚Äî Clean Up EC2 Targets

```yaml
scrape_configs:
  - job_name: "ec2-nodes"
    ec2_sd_configs:
      - region: us-east-1
    relabel_configs:
      - source_labels: [__meta_ec2_tag_Environment]
        regex: prod
        action: keep
      - source_labels: [__meta_ec2_private_ip]
        target_label: instance
        action: replace
      - source_labels: [__meta_ec2_tag_Name]
        target_label: name
        action: replace
```

‚úÖ Keeps only `prod` instances  
‚úÖ Renames `__meta_ec2_private_ip` ‚Üí `instance`  
‚úÖ Adds `name` label from EC2 tag

---

### üß≠ Example 2 ‚Äî Kubernetes Pods

```yaml
- job_name: "k8s-pods"
  kubernetes_sd_configs:
    - role: pod
  relabel_configs:
    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
      regex: true
      action: keep
    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
      target_label: __metrics_path__
      action: replace
    - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
      target_label: __address__
      separator: ;
      regex: (.+);(\d+)
      replacement: ${1}:${2}
      action: replace
```

‚úÖ Keeps only Pods annotated with `prometheus.io/scrape: "true"`  
‚úÖ Configures custom scrape path and port per Pod

---

### üß≠ Example 3 ‚Äî Add Static Environment Label

```yaml
- target_label: environment
  replacement: production
  action: replace
```

‚úÖ Adds a constant label to all targets.

---

## üß™ **Debugging Relabeling**

Prometheus UI helps you visualize how relabeling affects targets.

Go to:

```ini
http://<prometheus>:9090/targets
```

üß© Hover over a target ‚Üí click ‚Äúshow more‚Äù ‚Üí  
You‚Äôll see **before** and **after** relabeling sections:

- **Discovered Labels** (all `__meta_...`)
- **Labels after relabeling**

This helps debug why something got dropped or renamed.

---

## üî¥ **Common Mistakes**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Mistake                            | Why It‚Äôs Bad                                           |
| ---------------------------------- | ------------------------------------------------------ |
| Forgetting `action:`               | Defaults to `replace`, may cause unexpected overwrites |
| Dropping too many labels           | Can lose useful metadata                               |
| Using regex `.*` blindly           | Matches everything ‚Äî unsafe                            |
| Confusing target vs metric relabel | Leads to silent data loss                              |
| Forgetting case sensitivity        | Regex in Prometheus is case-sensitive                  |

</div>

---

## üß© **Metric Relabeling ‚Äî Post-Scrape Filtering**

> Applied **after** the target is scraped ‚Äî affects the metric samples themselves.

```yaml
metric_relabel_configs:
  - source_labels: [__name__]
    regex: "node_disk_.+"
    action: drop
```

‚úÖ Drops all disk metrics to reduce storage.

üí° Use metric relabeling **carefully** ‚Äî it permanently drops or rewrites data before storage.

---

## üèÅ **Practical Use Cases Summary**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Goal                                | Action                    |
| ----------------------------------- | ------------------------- |
| Keep only production systems        | `keep`                    |
| Drop development or test targets    | `drop`                    |
| Add environment label               | `replace`                 |
| Copy Kubernetes pod labels          | `labelmap`                |
| Remove metadata noise               | `labeldrop`               |
| Normalize label cases               | `lowercase` / `uppercase` |
| Shard scraping among Prom instances | `hashmod`                 |

</div>

---

## üñºÔ∏è **Mental Model ‚Äî The Label Factory**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

```mermaid
flowchart LR
    A["__meta_* Labels (Raw Input)"] --> B[relabel_configs (Target Filtering)]
    B --> C["Final Scrape Targets (__address__, job, env)"]
    C --> D["Scrape Metrics"]
    D --> E[metric_relabel_configs (Metric Filtering)]
    E --> F["Final Clean Metrics in TSDB"]
```

</div>

---

## üí¨ **Human Analogy**

> Think of **Service Discovery** as the _guest list_ of a big event üéüÔ∏è
> and **Relabeling** as the _bouncer_ and _name tag printer_:
>
> - Bouncer (`keep`/`drop`) decides who gets in.
> - Name tag printer (`replace`/`labelmap`) gives everyone nice readable labels.
> - Cleanup crew (`labeldrop`) removes unnecessary badges.
> - All before the party (scraping) starts üéâ

---

## üßæ **TL;DR**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Action                    | Description                  | Example                                   |
| ------------------------- | ---------------------------- | ----------------------------------------- |
| `replace`                 | Change or add label          | Rename `__meta_ec2_tag_Name` ‚Üí `instance` |
| `keep`                    | Keep only matching targets   | Keep only `env=prod`                      |
| `drop`                    | Drop matching targets        | Drop `namespace=dev`                      |
| `labelmap`                | Copy labels matching pattern | Copy `__meta_kubernetes_pod_label_*`      |
| `labeldrop`               | Drop labels matching pattern | Drop `__meta_*`                           |
| `labelkeep`               | Keep only specific labels    | Keep `app`, `env`, `job`                  |
| `hashmod`                 | Shard targets                | Distribute across Prom instances          |
| `uppercase` / `lowercase` | Normalize text               | Convert `Prod` ‚Üí `prod`                   |

</div>

---

‚úÖ **In short:**  
**Service Discovery** finds everything.  
**Relabeling** decides what stays, how it‚Äôs named, and how it looks.

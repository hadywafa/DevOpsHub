Perfect ğŸ‘ Letâ€™s start strong.

---

# â˜¸ï¸ Monitoring Kubernetes with Prometheus

> The evolution from container-level metrics to full cluster observability ğŸš€

---

## ğŸ¯ Goal

Youâ€™ve already monitored:

* ğŸ§± Linux hosts (via Node Exporter)
* ğŸ³ Containers (via Docker metrics & cAdvisor)

Now itâ€™s time to scale up to **Kubernetes**, where Prometheus doesnâ€™t just scrape hosts or containers â€” it scrapes **the entire ecosystem**:

* Pods
* Nodes
* Namespaces
* Kubelet and API Server metrics
* Cluster components like etcd, scheduler, and controller-manager

---

## ğŸŒ 1ï¸âƒ£ Why Monitoring in Kubernetes Is Different

In Docker, you monitor static targets (like host IPs).
In Kubernetes, everything is **dynamic** â€” pods, nodes, and services are constantly created or destroyed.

So manual target lists (like `static_configs`) become impossible.
Prometheus solves this with **Kubernetes Service Discovery** ğŸ§ .

---

### ğŸ§© What Prometheus Sees in Kubernetes

| Layer                   | Examples                              | Purpose                       |
| ----------------------- | ------------------------------------- | ----------------------------- |
| **Cluster Components**  | `kube-apiserver`, `etcd`, `scheduler` | Health of control plane       |
| **Node Level**          | `kubelet`, `node_exporter`            | Resource usage & system stats |
| **Pod/Container Level** | cAdvisor (built-in)                   | CPU, memory, I/O per pod      |
| **Workload Level**      | Deployments, DaemonSets               | Performance per application   |

---

## ğŸ” 2ï¸âƒ£ Kubernetes Metrics Sources

| Source                    | Description                                            | Exposed At                     |
| ------------------------- | ------------------------------------------------------ | ------------------------------ |
| ğŸ§  **Kubelet**            | Exposes node & container metrics (via cAdvisor)        | `https://<node>:10250/metrics` |
| âš™ï¸ **Kube State Metrics** | Translates Kubernetes objects into metrics             | `:8080/metrics`                |
| ğŸ“¦ **cAdvisor**           | Container-level performance stats (bundled in Kubelet) | `:10250/metrics/cadvisor`      |
| ğŸ§© **API Server**         | Metrics about API calls, latency, etc.                 | `:6443/metrics`                |
| ğŸ’¾ **etcd**               | Cluster database health                                | `:2379/metrics`                |

âœ… Prometheus can scrape *all of these* automatically once integrated with Kubernetes Service Discovery.

---

## ğŸ§  3ï¸âƒ£ How Prometheus Integrates Inside Kubernetes

Letâ€™s visualize ğŸ‘‡

```mermaid
flowchart LR
subgraph Kubernetes Cluster
  A[Kubelet<br>+ cAdvisor]:::node
  B[Kube State Metrics]:::svc
  C[Kube API Server]:::ctrl
  D[etcd]:::db
  E[Node Exporter]:::node
end
P[Prometheus Pod]:::prom
G[Grafana Pod]:::graf

P -->|Scrape metrics| A
P --> B
P --> C
P --> D
P --> E
G -->|Query| P

classDef prom fill:#f2c94c,stroke:#222,color:#000;
classDef graf fill:#56ccf2,stroke:#222,color:#000;
classDef node fill:#27ae60,stroke:#222,color:#fff;
classDef svc fill:#9b51e0,stroke:#222,color:#fff;
classDef ctrl fill:#2d9cdb,stroke:#222,color:#fff;
classDef db fill:#eb5757,stroke:#222,color:#fff;
```

> Prometheus runs **inside the cluster**, scraping metrics from every component using **Kubernetes API-based discovery** instead of fixed IPs.

---

## âš™ï¸ 4ï¸âƒ£ Prometheus Configuration (Kubernetes Service Discovery)

Prometheus dynamically discovers targets using the Kubernetes API:

```yaml
scrape_configs:
  - job_name: 'kubernetes-nodes'
    kubernetes_sd_configs:
      - role: node
    scheme: https
    tls_config:
      ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      insecure_skip_verify: true
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

  - job_name: 'kubernetes-pods'
    kubernetes_sd_configs:
      - role: pod
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
```

### ğŸ§© Explanation

* **`role: node`** â†’ discovers node-level targets (Kubelet, node exporter)
* **`role: pod`** â†’ discovers pod-level endpoints dynamically
* **`relabel_configs`** â†’ filters only those pods annotated with `prometheus.io/scrape=true`

---

## ğŸ§± 5ï¸âƒ£ Installing Prometheus in Kubernetes

### Option 1: Using Helm (recommended)

```bash
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm install prometheus prometheus-community/prometheus
```

Helm automatically deploys:

* Prometheus Server
* Alertmanager
* Node Exporter DaemonSet
* Kube State Metrics
* ConfigMaps for scrape targets

### Option 2: Manual YAML Deployment

If you prefer YAMLs:

```bash
kubectl apply -f prometheus-deployment.yaml
kubectl apply -f prometheus-service.yaml
```

---

## ğŸ“Š 6ï¸âƒ£ Visualizing with Grafana

Grafana connects to Prometheus via the in-cluster URL:

```
http://prometheus-server.prometheus.svc.cluster.local
```

And you can import prebuilt Kubernetes dashboards:

* **315** â€“ Kubernetes cluster monitoring
* **6417** â€“ Kubelet performance
* **12104** â€“ Node & Pod resource usage

---

## ğŸ’¡ 7ï¸âƒ£ Best Practices for Cluster Observability

| Practice                                                 | Benefit                          |
| -------------------------------------------------------- | -------------------------------- |
| ğŸ”’ Use RBAC for Prometheus ServiceAccount                | Restrict API permissions         |
| ğŸ§± Use ServiceMonitors (via Prometheus Operator)         | Auto-discover annotated Services |
| ğŸ“Š Aggregate data with Thanos / Cortex                   | Scale for large clusters         |
| âš¡ Scrape interval tuning                                 | Reduce API load                  |
| ğŸ§© Label consistently (e.g., `namespace`, `pod`, `node`) | Easier queries & dashboards      |

---

## ğŸ§  Summary

| Metric Source          | Component          | Prometheus Role       |
| ---------------------- | ------------------ | --------------------- |
| **Node / cAdvisor**    | Kubelet            | Resource usage        |
| **Pod-level**          | cAdvisor           | Per-container metrics |
| **Kubernetes Objects** | Kube State Metrics | Cluster state         |
| **Control Plane**      | API Server, etcd   | Cluster health        |
| **Custom Apps**        | Exporters / SDKs   | Application metrics   |

---

âœ… **Result:**
Prometheus provides **full-stack observability** â€”
from **node â†’ container â†’ pod â†’ deployment â†’ cluster** ğŸ’¥

---

Would you like me to move next into **â€œInstalling Prometheus Operator and ServiceMonitors (the modern Kubernetes monitoring method)â€**?
Itâ€™s the next big concept after basic Prometheus integration.

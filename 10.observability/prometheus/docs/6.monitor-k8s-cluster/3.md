Perfect ğŸ‘Œ â€” this next topic is **Monitoring Kubernetes Control Plane Components with Prometheus Operator** ğŸ§©

Hereâ€™s what weâ€™ll cover step by step in your favorite enhanced style:

1ï¸âƒ£ What the **control plane** is and why it matters
2ï¸âƒ£ Which components expose metrics and where
3ï¸âƒ£ How Prometheus Operator auto-discovers them
4ï¸âƒ£ Example **ServiceMonitors** for each (API server, etcd, scheduler, controller-manager)
5ï¸âƒ£ Visual overview + best practices

---

# â˜¸ï¸ Monitoring Kubernetes Control Plane with Prometheus Operator

> Gain observability over the â€œbrainâ€ of your Kubernetes cluster ğŸ§ 

---

## ğŸ¯ 1ï¸âƒ£ What Is the Control Plane?

The **control plane** is the core decision-making layer of Kubernetes â€” it manages scheduling, scaling, and cluster health.
If your control plane breaks, the whole cluster becomes brain-dead ğŸ’€.

It includes:

| Component                 | Role                                                |
| ------------------------- | --------------------------------------------------- |
| ğŸ§  **API Server**         | The front door â€” handles all kubectl & API requests |
| ğŸ—„ï¸ **etcd**              | Stores cluster state                                |
| âš™ï¸ **Scheduler**          | Decides which node runs which pod                   |
| ğŸ§© **Controller Manager** | Ensures desired state (e.g., restarts pods)         |

---

## ğŸ“¡ 2ï¸âƒ£ Where Metrics Come From

| Component              | Metrics Endpoint                | Description                                |
| ---------------------- | ------------------------------- | ------------------------------------------ |
| **API Server**         | `https://<master>:6443/metrics` | Request latency, API call rate, errors     |
| **etcd**               | `https://<master>:2379/metrics` | Storage size, leader elections, DB latency |
| **Scheduler**          | `http://<master>:10251/metrics` | Scheduling duration, pending pods          |
| **Controller Manager** | `http://<master>:10252/metrics` | Sync loops, reconciliation timings         |

âœ… Each component exposes a Prometheus-compatible `/metrics` endpoint out of the box.

---

## ğŸ§© 3ï¸âƒ£ How Prometheus Operator Discovers Them

Prometheus Operator uses **ServiceMonitors** that match built-in Kubernetes component labels.
You donâ€™t need to manually specify targets â€” the operator detects components dynamically using label selectors.

---

## ğŸ§± 4ï¸âƒ£ Example ServiceMonitors

### ğŸ§  API Server

```yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: apiserver
  namespace: monitoring
  labels:
    release: kube-prometheus-stack
spec:
  selector:
    matchLabels:
      component: apiserver
      provider: kubernetes
  namespaceSelector:
    matchNames:
      - default
  endpoints:
    - port: https
      scheme: https
      interval: 30s
      tlsConfig:
        insecureSkipVerify: true
```

âœ… Collects API call latency, request counts, and error ratios.

---

### ğŸ—„ï¸ etcd

```yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: etcd
  namespace: monitoring
  labels:
    release: kube-prometheus-stack
spec:
  selector:
    matchLabels:
      k8s-app: etcd
  namespaceSelector:
    matchNames:
      - kube-system
  endpoints:
    - port: etcd
      scheme: https
      interval: 30s
      tlsConfig:
        insecureSkipVerify: true
```

âœ… Tracks etcd leader changes, DB writes, compactions, and storage pressure.

---

### âš™ï¸ Scheduler

```yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: kube-scheduler
  namespace: monitoring
  labels:
    release: kube-prometheus-stack
spec:
  selector:
    matchLabels:
      component: kube-scheduler
  namespaceSelector:
    matchNames:
      - kube-system
  endpoints:
    - port: http-metrics
      interval: 30s
```

âœ… Exposes metrics like scheduling latency and pending pod counts.

---

### ğŸ§© Controller Manager

```yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: kube-controller-manager
  namespace: monitoring
  labels:
    release: kube-prometheus-stack
spec:
  selector:
    matchLabels:
      component: kube-controller-manager
  namespaceSelector:
    matchNames:
      - kube-system
  endpoints:
    - port: http-metrics
      interval: 30s
```

âœ… Monitors replication controller loops, sync times, and reconciliation metrics.

---

## ğŸ§  5ï¸âƒ£ Visual Overview

```mermaid
flowchart TD
subgraph K8s Control Plane
A[API Server<br>:6443/metrics]:::api
B[etcd<br>:2379/metrics]:::etcd
C[Scheduler<br>:10251/metrics]:::sched
D[Controller Manager<br>:10252/metrics]:::ctrl
end

P[Prometheus Operator<br>(via ServiceMonitors)]:::prom
P --> A
P --> B
P --> C
P --> D

classDef prom fill:#f2c94c,stroke:#222,color:#000;
classDef api fill:#2d9cdb,stroke:#222,color:#fff;
classDef etcd fill:#eb5757,stroke:#222,color:#fff;
classDef sched fill:#9b51e0,stroke:#222,color:#fff;
classDef ctrl fill:#27ae60,stroke:#222,color:#fff;
```

> Prometheus Operator scrapes control plane components dynamically using labeled Services.
> You never touch Prometheus config directly â€” itâ€™s all CRD-based and auto-managed.

---

## âš¡ 6ï¸âƒ£ Common Dashboards (Grafana)

* **Control Plane Health Overview (Dashboard ID: 15759)**
  â†’ API latency, etcd write speed, scheduler health
* **etcd Performance Dashboard (ID: 3070)**
  â†’ DB size, leader elections, latency histograms
* **Kubernetes / Control Plane Overview (ID: 15760)**
  â†’ Combined control plane visibility

---

## ğŸ’¡ 7ï¸âƒ£ Best Practices

| Practice                                     | Benefit                                |
| -------------------------------------------- | -------------------------------------- |
| ğŸ§± Deploy Operator in `monitoring` namespace | Keeps observability stack isolated     |
| ğŸ”’ Enable TLS on control plane metrics       | Prevents plain HTTP metrics leaks      |
| âš™ï¸ Use Label Selectors wisely                | Avoid duplicate scrapes                |
| ğŸ§© Leverage `namespaceSelector`              | Multi-namespace observability          |
| ğŸš€ Use Grafana alerts for API server latency | Detect control plane bottlenecks early |

---

## âœ… Summary

| Component              | Monitored via  | Metrics Examples                                                       |
| ---------------------- | -------------- | ---------------------------------------------------------------------- |
| **API Server**         | ServiceMonitor | `apiserver_request_duration_seconds`                                   |
| **etcd**               | ServiceMonitor | `etcd_server_has_leader`, `etcd_debugging_mvcc_db_total_size_in_bytes` |
| **Scheduler**          | ServiceMonitor | `scheduler_e2e_scheduling_duration_seconds`                            |
| **Controller Manager** | ServiceMonitor | `workqueue_depth`, `reconcile_duration_seconds`                        |

---

## ğŸ§  TL;DR

> Prometheus Operator automatically scrapes your **control plane components** using ServiceMonitors.
> You gain deep visibility into cluster health, request latency, and internal state â€” all declaratively managed through CRDs ğŸ’ª.

---

Would you like me to continue next with **â€œMonitoring Node and Pod Metrics (via Node Exporter, Kubelet, and cAdvisor)â€** â€” the worker-side view of Kubernetes observability?

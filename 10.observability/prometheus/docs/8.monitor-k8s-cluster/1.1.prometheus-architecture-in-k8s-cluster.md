# â˜¸ï¸ **Prometheus Stack Components in Kubernetes**

> _â€œMeet the Full Monitoring Family Living Inside Your Clusterâ€_

---

## ğŸ§  **What Is the Prometheus Stack?**

> The **Prometheus Stack** (deployed via Helm chart `prometheus-community/kube-prometheus-stack`) is an all-in-one Kubernetes monitoring suite that includes **Prometheus**, **Alertmanager**, **Grafana**, and several **exporters**.

It doesnâ€™t just install Prometheus â€” it installs an entire **ecosystem** for collecting, storing, alerting, and visualizing cluster metrics.

---

## ğŸ§© **Core Architecture Overview**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

```mermaid
flowchart TB
    direction TB
    A[Prometheus Operator] --> B1[Prometheus]
    A --> B2[Alertmanager]
    B3[Grafana]
    B4[CDRs: ServiceMonitor / PodMonitor / PrometheusRule] --> A
    B1 -->|Scrapes| E1[Node Exporter]
    B1 -->|Scrapes| E2[Kube State Metrics]
    B1 -->|Scrapes| E3[Kubelet / cAdvisor]
    B1 -->|Scrapes| E4[Application Metrics]
    B2 -->|Sends Alerts| N[Slack / Email / PagerDuty]
    B3 -->|Visualizes| B1
```

</div>

---

<div align="center" style="background-color: #11171F; border-radius: 10px; border: 2px solid">
    <img src="image/1762616078215.png" alt="Instant Vector" style="width: 80%">
</div>

---

## ğŸ§‘ğŸ»â€ğŸ’» **Deploy Prometheus in K8s**

```bash
# add helm repo for prometheus community
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
# update helm repo for prometheus community
helm repo update
# install prometheus
helm install prometheus prometheus-community/kube-prometheus-stack --version 45.7.1 --namespace monitoring --create-namespace
```

```bash
# to search all helm chart available for prometheus-community:
helm search repo prometheus-community
# to search specific chart version:
helm search repo prometheus-community/kube-prometheus-stack --versions
# to install specific version:
helm install prometheus prometheus-community/kube-prometheus-stack --version 14.0.1
# to upgrade:
helm upgrade --install prometheus prometheus-community/kube-prometheus-stack
# to uninstall:
helm uninstall prometheus
```

---

## 1ï¸âƒ£ **Control Plane Components**

These are **brains** of the stack â€” they orchestrate how everything works together.

---

### ğŸ”¹ Prometheus Operator

- ğŸ“¦ **Type:** Deployment
- ğŸ§© **Purpose:** Automates setup, updates, and monitoring of Prometheus and Alertmanager.

ğŸ’¡ Instead of writing manual Prometheus configs, you declare monitoring objects as **Custom Resources (CRDs)** â€” and the operator does the rest.

**CRDs Managed:**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| CRD              | Description                                                      |
| ---------------- | ---------------------------------------------------------------- |
| `Prometheus`     | Defines Prometheus instances, replicas, storage, scrape settings |
| `Alertmanager`   | Defines Alertmanager cluster specs                               |
| `ServiceMonitor` | Auto-discovers Services for scraping                             |
| `PodMonitor`     | Scrapes Pods directly (without a Service)                        |
| `PrometheusRule` | Defines alerting & recording rules                               |
| `Probe`          | Performs HTTP/TCP/ICMP blackbox probing                          |
| `ThanosRuler`    | Adds Thanos rule evaluation (optional)                           |

</div>

---

âœ… **Why Important:**

- Handles upgrades gracefully.
- Ensures consistency of Prometheus configs.
- Enables declarative monitoring (GitOps-friendly).

---

## 2ï¸âƒ£ **Data Plane Components**

These are the **engines** that collect, store, and visualize your data.

---

### ğŸ”¹ **Prometheus**

- ğŸ“¦ **Type:** StatefulSet
- ğŸ§© **Purpose:** Collects & stores time-series metrics, evaluates rules, triggers alerts.

**Key Tasks:**

- Scrapes targets discovered via ServiceMonitor & PodMonitor.
- Stores metrics in its built-in **TSDB**.
- Evaluates **PromQL queries** and alert rules.

**Config Options:**

- Retention (`15d`, `30d`, or `retentionSize`)
- Persistent Volume for long-term data
- Remote Write for external storage (Thanos, Cortex, Mimir)
- HA setup (multiple replicas)

**Exposes:**

- `:9090` â†’ Prometheus UI & API (`/api/v1/query`, `/targets`, `/rules`)

---

### ğŸ”¹ **Alertmanager**

- ğŸ“¦ **Type:** StatefulSet
- ğŸ§© **Purpose:** Receives alerts from Prometheus and routes them to destinations like **Slack**, **Email**, or **PagerDuty**.

**Workflow:**

1. Prometheus triggers an alert based on rule evaluation.
2. Alertmanager groups, deduplicates, and sends notifications.
3. Supports silence periods and routing trees.

**Exposes:**

- `:9093` â†’ Alertmanager Web UI

**Example Receivers:**

- Email
- Slack Webhook
- Microsoft Teams
- PagerDuty

ğŸ’¡ **Tip:** All configuration lives in the Helm chart under `alertmanager.config`.

---

### ğŸ”¹ **Grafana**

- ğŸ“¦ **Type:** Deployment
- ğŸ§© **Purpose:** The **visual layer** of your monitoring stack.

**Out-of-the-box dashboards include:**

- ğŸŒ Cluster Overview
- ğŸ’¾ Node Resource Usage
- âš™ï¸ API Server & Scheduler Health
- ğŸ§± Pod & Container Metrics

**Auto-provisioned Datasource:** Prometheus
**Exposes:**

- `:80` â†’ Grafana Web UI

**Credentials:**
Default: `admin / prom-operator` (or your custom password in `values.yaml`)

---

## 3ï¸âƒ£ **Metrics Collectors (Exporters)**

These are **agents** that expose metrics for Prometheus to scrape.

---

<div align="center" style="background-color: #11171F; border-radius: 10px; border: 2px solid">
    <img src="image/1762623999111.png" alt="Instant Vector" style="width: 80%">
</div>

---

### ğŸ”¹ **Node Exporter**

- ğŸ“¦ **Type:** DaemonSet
- ğŸ§  **Purpose:** Exposes Linux host-level metrics (CPU, memory, disk, I/O, filesystem).

Every node runs one Node Exporter pod.

**Common Metrics:**

| Metric                             | Description      |
| ---------------------------------- | ---------------- |
| `node_cpu_seconds_total`           | CPU time by mode |
| `node_memory_MemAvailable_bytes`   | Available memory |
| `node_filesystem_avail_bytes`      | Free disk space  |
| `node_network_receive_bytes_total` | Network traffic  |

---

### ğŸ”¹ **Kube-State-Metrics**

- ğŸ“¦ **Type:** Deployment
- ğŸ§  **Purpose:** Generates metrics _about_ Kubernetes objects â€” not the nodes themselves.

Example metrics:

| Metric                                      | Description               |
| ------------------------------------------- | ------------------------- |
| `kube_pod_status_phase`                     | Pod running/pending state |
| `kube_deployment_status_replicas_available` | Available replicas        |
| `kube_hpa_status_current_replicas`          | Autoscaler metrics        |

ğŸ’¡ **Used for:** Kubernetes object health, cluster state, scaling status, and deployment analysis.

---

### ğŸ”¹ **Kubelet / cAdvisor**

- ğŸ“¦ **Type:** Built into every Node
- ğŸ§  **Purpose:** Provides container and pod resource usage metrics (CPU, memory, network).

**Key Metrics:**

- `container_cpu_usage_seconds_total`
- `container_memory_usage_bytes`

Prometheus scrapes these via built-in ServiceMonitors (`kubelet`, `cadvisor`).

---

### ğŸ”¹ **Blackbox Exporter (Optional)**

- ğŸ“¦ **Type:** Deployment
- ğŸ§  **Purpose:** Performs HTTP, TCP, ICMP probes to check endpoint health.

Used with `Probe` CRDs:

```yaml
apiVersion: monitoring.coreos.com/v1
kind: Probe
spec:
  module: http_2xx
  targets:
    staticConfig:
      static:
        - https://example.com
```

---

## 4ï¸âƒ£ **Discovery & Rules Components**

### ğŸ”¹ **ServiceMonitor**

- ğŸ§  **Purpose:** Tells Prometheus **which Services** to scrape.
  You attach it to your appâ€™s Kubernetes Service.

```yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
spec:
  selector:
    matchLabels:
      app: my-app
  endpoints:
    - port: metrics
      interval: 30s
```

ğŸ’¡ If your app exposes `/metrics` on a Service, ServiceMonitor makes Prometheus scrape it automatically.

---

### ğŸ”¹ **PodMonitor**

- ğŸ§  **Purpose:** Tells Prometheus to scrape **pods directly** (no Service).
  Useful for Jobs or headless pods.

---

### ğŸ”¹ **PrometheusRule**

- ğŸ§  **Purpose:** Defines **alerting and recording rules** used by Prometheus.

```yaml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
spec:
  groups:
    - name: node.rules
      rules:
        - record: instance:node_cpu_utilization:rate5m
          expr: 1 - avg(irate(node_cpu_seconds_total{mode="idle"}[5m]))
        - alert: HighCPUUsage
          expr: instance:node_cpu_utilization:rate5m > 0.9
          for: 5m
          labels:
            severity: warning
          annotations:
            description: "High CPU usage detected on {{ $labels.instance }}"
```

---

## ğŸ“Š Visualization & Dashboards

Deployed automatically from ConfigMaps and pre-wired to Prometheus.

**Categories:**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Dashboard                                    | Focus                     |
| -------------------------------------------- | ------------------------- |
| **Kubernetes / Compute Resources / Cluster** | Overall CPU, memory, pods |
| **Kubernetes / API Server**                  | API performance           |
| **Node Exporter / Nodes**                    | Node-level system stats   |
| **Kubernetes / Pods / Containers**           | App resource usage        |

</div>

---

## âš™ï¸ Supporting Components

| Component                        | Purpose                                                   |
| -------------------------------- | --------------------------------------------------------- |
| **RBAC Roles & ServiceAccounts** | Secure access to API & scraping endpoints                 |
| **ConfigMaps**                   | Store dashboards, Prometheus config, and rule definitions |
| **Secrets**                      | Grafana admin credentials, alertmanager config            |
| **Persistent Volumes (PVCs)**    | Ensure Prometheus & Alertmanager keep historical data     |

---

## ğŸ§­ How Components Interact

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

```mermaid
sequenceDiagram
    participant App
    participant Exporter
    participant Prometheus
    participant Alertmanager
    participant Grafana

    App->>Exporter: Expose metrics (/metrics)
    Prometheus->>Exporter: Pull metrics
    Prometheus->>Alertmanager: Send alerts
    Grafana->>Prometheus: Query data for dashboards
    User->>Grafana: View dashboards & alerts
```

</div>

---

## âš¡ Why Itâ€™s Powerful

âœ… **Auto-discovery** of cluster metrics  
âœ… **Built-in dashboards** and rules  
âœ… **Declarative monitoring** with CRDs  
âœ… **Easy scaling & upgrades** via Helm  
âœ… **Alerting pipeline included** (Prometheus â†’ Alertmanager â†’ Notifications)  
âœ… **Integration ready** with Thanos, Loki, or Mimir

---

## ğŸ“ **Example Real-World Setup**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Component           | Resource Type | Example Purpose      |
| ------------------- | ------------- | -------------------- |
| Prometheus          | StatefulSet   | Collect all metrics  |
| Alertmanager        | StatefulSet   | Route alerts         |
| Grafana             | Deployment    | Visualize data       |
| Node Exporter       | DaemonSet     | Node health          |
| Kube-State-Metrics  | Deployment    | K8s object state     |
| Prometheus Operator | Deployment    | CRD controller       |
| ServiceMonitor      | CRD           | Scrape apps          |
| PrometheusRule      | CRD           | Alerts & recording   |
| ConfigMap           | Object        | Dashboards & configs |

</div>

---

## ğŸ§  **Summary**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Category           | Components                                  | Description                               |
| ------------------ | ------------------------------------------- | ----------------------------------------- |
| **Control Plane**  | Prometheus Operator, CRDs                   | Manage Prometheus resources declaratively |
| **Data Plane**     | Prometheus, Alertmanager, Grafana           | Collect, alert, visualize                 |
| **Exporters**      | Node Exporter, Kube-State-Metrics, cAdvisor | Provide raw metrics                       |
| **Discovery**      | ServiceMonitor, PodMonitor                  | Tell Prometheus what to scrape            |
| **Rules & Alerts** | PrometheusRule, Alertmanager                | Predefined alerting logic                 |
| **Visualization**  | Grafana                                     | Dashboards, queries, trends               |
| **Support**        | RBAC, PVCs, ConfigMaps                      | Security & persistence                    |

</div>

---

## ğŸ **TL;DR**

> ğŸ’¬ The Prometheus Stack in Kubernetes is like a **mini observability platform**:
>
> - **Prometheus** collects data ğŸ§®
> - **Alertmanager** screams when something breaks ğŸ“£
> - **Grafana** shows pretty graphs ğŸ“Š
> - **Exporters** feed them data ğŸ´
> - **Operator** automates it all ğŸ¤–

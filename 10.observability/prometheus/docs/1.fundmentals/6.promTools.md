# âš™ï¸ **Promtools**

## ğŸ¯ **What Is Promtool?**

**`promtool`** is a **command-line utility** that ships with Prometheus.
Itâ€™s mainly used for **validation**, **testing**, and **debugging** Prometheus configurations and rules â€” before you ever reload or restart Prometheus itself.

> Think of `promtool` as Prometheusâ€™ â€œlint + test + debugâ€ combo.

---

## ğŸ“‚ **Where It Lives**

When you install Prometheus, `promtool` is included in the same binary package.

If you installed via tarball:

```bash
./promtool --version
# promtool, version 2.54.0 (branch: HEAD, revision: 0c90f72...)
```

If installed via package manager or Docker:

```bash
promtool --help
```

---

## ğŸ’« **What You Can Do With Promtool**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Category                    | Command                   | Purpose                                            |
| --------------------------- | ------------------------- | -------------------------------------------------- |
| âŒ **Validation**           | `check config`            | Validate your `prometheus.yml` syntax              |
| âœ… **Rules testing**        | `check rules`             | Validate alerting/recording rules                  |
| ğŸ§ª **Unit testing rules**   | `test rules`              | Run tests on alerting/recording rule logic         |
| ğŸ“Š **Benchmarking**         | `bench rules`             | Measure rule evaluation performance                |
| ğŸ§  **Expression debugging** | `query instant / range`   | Run queries directly against a Prometheus instance |
| ğŸ§¾ **Exported data checks** | `tsdb` subcommands        | Inspect TSDB blocks, corruption, head, cardinality |
| ğŸ§® **Remote Write check**   | `check web-config`        | Validate the web auth/TLS config (e.g., `web.yml`) |
| ğŸ§° **Misc Tools**           | `create-block`, `analyze` | Diagnose or simulate storage blocks                |

</div>

---

## 1ï¸âƒ£ **Validate Your Config File**

Before you reload Prometheus after editing `prometheus.yml`, run:

```bash
promtool check config /etc/prometheus/prometheus.yml
```

**Output:**

```ini
Checking /etc/prometheus/prometheus.yml
  SUCCESS: 0 rule files found
```

If you have a typo (e.g., missing colon), itâ€™ll tell you exactly where:

```ini
Error parsing scrape_configs: yaml: line 27: did not find expected key
```

âœ… **Purpose:** avoid broken Prometheus restarts.

---

## 2ï¸âƒ£ **Validate Rule Files**

To check all alerting and recording rules:

```bash
promtool check rules /etc/prometheus/rules/*.yml
```

If valid:

```ini
Checking /etc/prometheus/rules/alerts.yml
  SUCCESS: 3 rules found
```

If not:

```ini
Error parsing rules file /etc/prometheus/rules/alerts.yml: group "Node": rule 3, "HighCPU": invalid expression
```

---

## 3ï¸âƒ£ **Test Rule Logic (Unit Testing)**

You can unit test your alert or recording rules with synthetic data.

### ğŸ§± Example

`rules.yml`

```yaml
groups:
  - name: cpu_alerts
    rules:
      - record: instance_cpu_usage
        expr: 100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)
```

`rules_test.yml`

```yaml
rule_files:
  - rules.yml
tests:
  - interval: 1m
    input_series:
      - series: 'node_cpu_seconds_total{mode="idle",instance="node1"}'
        values: "0+1x10"
    promql_expr_test:
      - expr: instance_cpu_usage
        eval_time: 10m
        exp_samples:
          - labels: '{instance="node1"}'
            value: 90
```

Run it:

```bash
promtool test rules rules_test.yml
# Unit Testing:  PASS
```

âœ… **Purpose:** verify alert math before deploying.

---

## 4ï¸âƒ£ **Benchmark Rule Performance**

For performance tuning:

```bash
promtool bench rules /etc/prometheus/rules/alerts.yml
```

Output includes evaluation time per rule and performance hints.

---

## 5ï¸âƒ£ **Query Prometheus Directly (Instant / Range)**

To test expressions:

```bash
promtool query instant http://localhost:9090 'up'
promtool query range http://localhost:9090 'rate(http_requests_total[5m])' --start=2025-11-01T00:00:00Z --end=2025-11-01T01:00:00Z --step=30s
```

âœ… **Use case:** debugging expressions before you put them into dashboards or alerts.

---

## 6ï¸âƒ£ **TSDB Inspection Tools**

For storage debugging and corruption checks.

### Example:

Inspect block info:

```bash
promtool tsdb analyze /var/lib/prometheus
```

Check for corruption:

```bash
promtool tsdb check /var/lib/prometheus
```

Print label cardinality (memory usage insight):

```bash
promtool tsdb stats /var/lib/prometheus
```

> This is critical for detecting **high-cardinality metrics** that slow down Prometheus.

---

## 7ï¸âƒ£ **Validate Web Config (for Auth & TLS)**

Before starting Prometheus with `--web.config.file=web.yml`:

```bash
promtool check web-config /etc/prometheus/web.yml
```

It checks:

- YAML syntax
- bcrypt password hash format
- TLS certificate/key paths

---

## ğŸ“ **Example Workflow in Real Life**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Step | Command                                | Why                                          |
| ---- | -------------------------------------- | -------------------------------------------- |
| 1ï¸âƒ£   | `promtool check config prometheus.yml` | Validate scrape targets config               |
| 2ï¸âƒ£   | `promtool check rules rules.yml`       | Catch syntax errors in alerts                |
| 3ï¸âƒ£   | `promtool test rules rules_test.yml`   | Verify alert math correctness                |
| 4ï¸âƒ£   | `promtool bench rules rules.yml`       | Measure evaluation performance               |
| 5ï¸âƒ£   | `promtool tsdb analyze`                | Detect storage corruption or label explosion |

</div>

---

## ğŸ‰ **Bonus Tip: Using Promtool Inside Docker**

If your Prometheus runs in Docker:

```bash
docker run --rm -v $(pwd):/etc/prometheus prom/prometheus promtool check config /etc/prometheus/prometheus.yml
```

---

## ğŸ—ï¸ **TL;DR**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Use Case         | Command                     | Purpose                     |
| ---------------- | --------------------------- | --------------------------- |
| Validate config  | `promtool check config`     | Catch YAML or logic errors  |
| Validate rules   | `promtool check rules`      | Catch invalid PromQL        |
| Test rules       | `promtool test rules`       | Simulate alerts locally     |
| Check web config | `promtool check web-config` | Verify Basic Auth/TLS setup |
| Debug TSDB       | `promtool tsdb analyze`     | Find label bloat/corruption |
| Query Prometheus | `promtool query ...`        | Try expressions directly    |

</div>

# âš™ï¸ **PromQL Functions** â€” The Ultimate Guide

## ğŸ“š Table of Contents â€” Prometheus Architecture & Data Flow

1. [ğŸ§® Math Functions](#1)
2. [â° Date / Time Functions](#2)
3. [ğŸ”„ Changing Type Functions](#3)
4. [ğŸ”¢ Sorting Functions](#4)
5. [ğŸš« Absence Functions](#5)
6. [âœ… Present Functions](#6)
7. [ğŸ”¤ String (Label) Functions](#7)
8. [ğŸ§¾ Final Summary Table](#8)
9. [ğŸ’¡ Real-World Examples](#9)

---

<a id="1"></a>

## ğŸ§® **Math Functions**

_(Used to transform or normalize metric values)!_

 <div align="center" style="background-color: #11171F; border-radius: 10px; border: 2px solid">
    <img src="image/1762525467428.png" alt="Instant Vector" style="width: 80%">
</div>

PromQL allows you to perform **arithmetic** directly on metric values.
These math functions modify numeric values (scalars or vectors) without changing labels.

---

### ğŸ”¹ `abs(v)` â€” Absolute Value

Removes the negative sign from values.

ğŸ“˜ **Definition:**

> Returns the absolute value of each element in the vector.

ğŸ§© **Example:**

```promql
abs(node_filesystem_free_bytes - node_filesystem_size_bytes)
```

â¡ï¸ If disk space calculation produces `-5000000` (because of scrape delay),
`abs()` ensures it becomes positive `5000000`.

âœ… **Use Case:** Prevent invalid negatives when doing subtraction on Counters or Gauges.

---

### ğŸ”¹ `ceil(v)` â€” Round Up

Rounds each value **up** to the nearest integer.

ğŸ“˜ **Example:**

```promql
ceil(node_load1)
```

If `node_load1 = 1.2`, â†’ `2`.

âœ… **Use Case:** Display rounded values in dashboards.

---

### ğŸ”¹ `floor(v)` â€” Round Down

Rounds each value **down** to the nearest integer.

ğŸ“˜ **Example:**

```promql
floor(cpu_utilization_percent)
```

If `cpu_utilization_percent = 99.8`, â†’ `99`.

âœ… **Use Case:** Clean up floating numbers before alert comparison.

---

### ğŸ”¹ `round(v, to)` â€” Round to a Specific Multiple

ğŸ“˜ **Syntax:**

```promql
round(v, to)
```

If `to` is omitted, rounds to nearest integer.

ğŸ“˜ **Example:**

```promql
round(node_memory_MemFree_bytes / 1e9, 0.1)
```

â†’ Rounds to nearest 0.1 GB.

âœ… **Use Case:** Human-readable dashboards (e.g., round to 0.5 GB increments).

---

### ğŸ”¹ `clamp_max(v, max)` / `clamp_min(v, min)`

Limits metric values to within a threshold.

ğŸ“˜ **Examples:**

```promql
clamp_max(cpu_usage_percent, 100)
clamp_min(cpu_usage_percent, 0)
```

So if a buggy metric reports 120%, itâ€™s clamped to 100.

âœ… **Use Case:** Prevent false alerts or visual overshoots in graphs.

---

### ğŸ”¹ `sqrt(v)` â€” Square Root

ğŸ“˜ **Example:**

```promql
sqrt(metric)
```

Useful in variance or normalization formulas.

---

### ğŸ”¹ `ln(v)`, `log2(v)`, `log10(v)` â€” Logarithmic Scaling

Used to express exponential growth patterns (like latency or exponential backoffs).

ğŸ“˜ **Example:**

```promql
log10(request_latency_seconds)
```

âœ… **Use Case:** Log-scale visualizations for latency distributions.

---

### ğŸ”¹ `exp(v)` â€” Exponential

Inverse of logarithm â€” computes eË£.

ğŸ“˜ **Example:**

```promql
exp(cpu_usage_ratio)
```

Used in anomaly detection formulas (advanced use).

---

ğŸ§  **Key Tip:**
You can chain math functions:

```promql
round(clamp_min(cpu_temp_celsius, 0), 0.5)
```

â¡ï¸ Clamp below 0Â°C â†’ Round to nearest 0.5Â°C.

---

### ğŸ§© Summary Table

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Function                    | Description    | Example               |
| --------------------------- | -------------- | --------------------- |
| `abs()`                     | Absolute value | `abs(a - b)`          |
| `ceil()`                    | Round up       | `ceil(node_load1)`    |
| `floor()`                   | Round down     | `floor(temp)`         |
| `round(v, to)`              | Round to step  | `round(x, 0.1)`       |
| `clamp_min()`               | Lower bound    | `clamp_min(cpu, 0)`   |
| `clamp_max()`               | Upper bound    | `clamp_max(cpu, 100)` |
| `sqrt()`                    | Square root    | `sqrt(latency)`       |
| `ln()`, `log2()`, `log10()` | Logs           | `log10(size)`         |
| `exp()`                     | Exponent       | `exp(rate)`           |

</div>

---

<a id="2"></a>

## â° **Date / Time Functions**

<div align="center" style="background-color: #11171F; border-radius: 10px; border: 2px solid">
    <img src="image/1762526986396.png" alt="Instant Vector" style="width: 80%">
</div>

<div align="center" style="background-color: #11171F; border-radius: 10px; border: 2px solid">
    <img src="image/1762525546594.png" alt="Instant Vector" style="width: 80%">
</div>

These functions are critical for **time-based comparisons, freshness checks, and temporal alerts**.

---

### ğŸ”¹ `time()`

Returns the **current evaluation time** as a UNIX timestamp (seconds since epoch).

ğŸ“˜ **Example:**

```promql
time()
```

â¡ï¸ Might return `1730998100`.

âœ… **Use Case:**
Used to compare time elapsed since last metric update.

---

### ğŸ”¹ `timestamp(v)`

Returns the **timestamp** of each sample in vector `v`.

ğŸ“˜ **Example:**

```promql
timestamp(up)
```

If `up{instance="app1"} = 1` was scraped at 1730998000,
you get `1730998000` as the value.

âœ… **Use Case:**
Detect stale metrics:

```promql
(time() - timestamp(up)) > 300
```

â¡ï¸ If > 300 seconds since last scrape â†’ target is stale.

---

### ğŸ§© Visual Understanding

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

```mermaid
sequenceDiagram
    participant User
    participant Prometheus
    User->>Prometheus: query "time()"
    Prometheus-->>User: current UNIX timestamp
    User->>Prometheus: query "timestamp(up)"
    Prometheus-->>User: last scrape timestamp of each target
```

</div>

---

### ğŸ”¹ Other Date Functions (less common)

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Function         | Description         |
| ---------------- | ------------------- |
| `year(v)`        | Year part (2025)    |
| `month(v)`       | Month number (1â€“12) |
| `day_of_week(v)` | 0â€“6 (Sunday=0)      |
| `hour(v)`        | Hour of day (0â€“23)  |

</div>

---

Example:

```promql
hour(time()) >= 9 and hour(time()) <= 17
```

â¡ï¸ Useful for â€œworking hoursâ€ alerts.

---

âœ… **Real-World Example:**  
Alert if a service hasnâ€™t reported in 5 minutes:

```promql
(time() - timestamp(up{job="backend"})) > 300
```

---

<a id="3"></a>

## ğŸ”„ **Changing Type Functions**

These convert between **scalar** (single number) and **vector** (series of metrics).

---

### ğŸ”¹ `scalar(v)`

Converts a **single-element instant vector** into a **scalar number**.

ğŸ“˜ **Example:**

```promql
scalar(up{instance="node1"})
```

If `up{instance="node1"} = 1`, result â†’ `1`.

âœ… **Use Case:** Extract numeric constants from metrics.

---

### ğŸ”¹ `vector(scalar)`

Converts a **scalar constant** into a **single-sample vector**.

ğŸ“˜ **Example:**

```promql
vector(100)
```

Result â†’ A vector with one element: `{}` = 100

âœ… **Use Case:**  
When you need to compare metric values to a constant threshold:

```promql
node_memory_MemFree_bytes / vector(1073741824)
```

â¡ï¸ Convert bytes â†’ gigabytes.

---

ğŸ§© Diagram: Type Conversion

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

```mermaid
flowchart LR
    A["Scalar (1 value)"] -->|"vector()"| B["Instant Vector (series)"]
    B -->|"scalar()"| A
```

</div>

---

<a id="4"></a>

## ğŸ”¢ **Sorting Functions**

<div align="center" style="background-color: #11171F; border-radius: 10px; border: 2px solid">
    <img src="image/1762525654251.png" alt="Instant Vector" style="width: 80%">
</div>

These organize your results for **ranking dashboards** or **finding top consumers**.

---

### ğŸ”¹ `sort(v)`

Sorts series **ascending** by value.

ğŸ“˜ **Example:**

```promql
sort(node_load1)
```

â¡ï¸ From lowest â†’ highest load.

---

### ğŸ”¹ `sort_desc(v)`

Sorts series **descending** by value.

ğŸ“˜ **Example:**

```promql
sort_desc(rate(http_requests_total[5m]))
```

â¡ï¸ From highest â†’ lowest request rate.

âœ… **Use Case:**
Show _Top 10_ busiest services in Grafana.

---

### ğŸ§© Combine With `topk()` and `bottomk()`

```promql
topk(5, sort_desc(rate(http_requests_total[5m])))
```

â¡ï¸ Top 5 busiest services.

---

ğŸ§  **Tip:** Sorting doesnâ€™t aggregate â€” it just orders values visually.

---

<a id="5"></a>

## ğŸš« **Absence Functions**

Used to **detect missing metrics or targets**, one of the most useful alerting tricks in Prometheus.

---

### ğŸ”¹ `absent(v)`

Returns a vector with value `1` _if the expression returns no data_.

ğŸ“˜ **Example:**

```promql
absent(up{job="api"})
```

If no API target is reporting â†’ returns `1`.

âœ… **Use Case:**
Alert if a target stops exposing its metrics:

```promql
absent(up{job="web"}) == 1
```

---

### ğŸ”¹ `absent_over_time(v[range])`

Returns 1 if a metric was **absent during the entire range**.

ğŸ“˜ **Example:**

```promql
absent_over_time(up{job="db"}[10m])
```

If the DB didnâ€™t send any data for 10 minutes â†’ returns 1.

âœ… **Use Case:**
Alert when a service hasnâ€™t sent any data for a while.

---

ğŸ§© Visual Explanation

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

```mermaid
flowchart TD
    A["Metric exists?"] -->|Yes| B["Return nothing"]
    A -->|No| C["Return {__name__='absent', value=1}"]
```

</div>

---

<a id="6"></a>

## âœ… **Present Functions**

Used in some advanced PromQL-compatible systems (like **Thanos** and **VictoriaMetrics**)
to detect **presence** instead of absence.

> Not part of classic Prometheus, but commonly seen in large observability setups.

---

### ğŸ”¹ `present(v)`

Returns `1` if the expression has _any_ result.

ğŸ“˜ **Example:**

```promql
present(up{job="api"})
```

â¡ï¸ Returns `1` if `up{job="api"}` exists.

---

### ğŸ”¹ `present_over_time(v[range])`

Returns `1` if the metric existed _at any point_ during that range.

ğŸ“˜ **Example:**

```promql
present_over_time(http_requests_total[1h])
```

â¡ï¸ `1` if any sample appeared in last hour.

âœ… **Use Case:**  
Confirm data was reported at least once during a period.

---

ğŸ§  Think of it as:

> `present()` = â€œIs anyone here right now?â€  
> `present_over_time()` = â€œHas anyone been here recently?â€

---

<a id="7"></a>

## ğŸ”¤ **String (Label) Functions**

PromQL doesnâ€™t directly modify numeric values using strings,  
but **label manipulation functions** let you rewrite, merge, and extract parts of label values.

---

### ğŸ”¹ `label_replace(v, dst_label, replacement, src_label, regex)`

Creates or modifies a label using regex capture groups.

ğŸ“˜ **Example:**

```promql
label_replace(up, "region", "$1", "instance", "(.*):.*")
```

If `instance="us-east-1:9100"`
â†’ Adds `region="us-east-1"`

âœ… **Use Case:** Extract structured info from existing labels (e.g., region, cluster).

---

### ğŸ”¹ `label_join(v, dst_label, separator, src1, src2, â€¦)`

Joins multiple labels into a new one using a separator.

ğŸ“˜ **Example:**

```promql
label_join(up, "full_id", "-", "job", "instance")
```

If `job="api"` and `instance="node1"`,
â†’ `full_id="api-node1"`

âœ… **Use Case:** Build unique labels for correlation or aggregation.

---

### ğŸ§© Visual Example

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

```mermaid
flowchart TD
    A["up{job='api', instance='node1'}"] --> B["label_join(up, 'id', '-', 'job', 'instance')"]
    B --> C["Result: up{id='api-node1'}"]
```

</div>

---

### âš™ï¸ Combining String Functions

Sometimes used together for complex transformations:

```promql
label_join(
  label_replace(up, "region", "$1", "instance", "(.*)-node.*"),
  "target_id", "_", "region", "job"
)
```

â¡ï¸ Extract region â†’ combine region + job â†’ `target_id="us-west_api"`

---

<a id="8"></a>

## ğŸ§¾ **Final Summary Table**

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Category            | Functions                                                                        | What They Do                  |
| ------------------- | -------------------------------------------------------------------------------- | ----------------------------- |
| **Math**            | `abs`, `ceil`, `floor`, `round`, `clamp_min`, `clamp_max`, `sqrt`, `ln`, `log10` | Numeric operations            |
| **Date/Time**       | `time`, `timestamp`, `year`, `month`, `hour`                                     | Handle timestamps             |
| **Type Conversion** | `scalar`, `vector`                                                               | Convert between scalar/vector |
| **Sorting**         | `sort`, `sort_desc`                                                              | Order vectors                 |
| **Absence**         | `absent`, `absent_over_time`                                                     | Detect missing metrics        |
| **Present**         | `present`, `present_over_time`                                                   | Detect existing metrics       |
| **String**          | `label_replace`, `label_join`                                                    | Manipulate labels             |

</div>

---

<a id="9"></a>

## ğŸ’¡ **Real-World Examples**

### ğŸ”¸ CPU Utilization (%)

```promql
100 - (avg by(instance)(rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)
```

### ğŸ”¸ Top 5 APIs by request rate

```promql
topk(5, sort_desc(rate(http_requests_total{job="api"}[5m])))
```

### ğŸ”¸ Alert if Prometheus hasnâ€™t scraped any metrics in 10 mins

```promql
absent_over_time(up[10m])
```

### ğŸ”¸ Extract region from instance name

```promql
label_replace(up, "region", "$1", "instance", "(.*)-node.*")
```

# ğŸ”— PromQL Vector Matching â€” Default Behavior, Modifiers, and Match Types

In PromQL, when you use **binary operators** (like `+`, `/`, `>`, `and`, etc.) between two sets of time series, Prometheus must decide **how to match** the series from the left and right sides.

This process is called **vector matching**.

---

<div align="center" style="background-color: #11171F; border-radius: 10px; border: 2px solid">
    <img src="image/1762358830065.png" alt="Instant Vector" style="width: 80%">
</div>

---

## ğŸ§  1. Default Matching Behavior

By default, Prometheus matches time series **only if their label sets are identical** (excluding the metric name).

### ğŸ”¹ Example

```promql
http_requests_total{method="GET", instance="A"} / http_requests_total{method="GET", instance="A"}
```

âœ… This matches â€” same labels.

But:

```promql
http_requests_total{method="GET", instance="A"} / http_requests_total{method="GET", instance="B"}
```

âŒ No match â€” different `instance`.

---

<div align="center" style="background-color: #11171F; border-radius: 10px; border: 2px solid">
    <img src="image/1762358815618.png" alt="Instant Vector" style="width: 80%">
</div>

<div align="center" style="background-color: #11171F; border-radius: 10px; border: 2px solid">
    <img src="image/1762358845449.png" alt="Instant Vector" style="width: 80%">
</div>

<div align="center" style="background-color: #11171F; border-radius: 10px; border: 2px solid">
    <img src="image/1762358864057.png" alt="Instant Vector" style="width: 80%">
</div>

<div align="center" style="background-color: #11171F; border-radius: 10px; border: 2px solid">
    <img src="image/1762359444194.png" alt="Instant Vector" style="width: 80%">
</div>

---

## ğŸ§© 2. Modifying Matching with `on()` and `ignoring()`

### ğŸ”¸ `on(label1, label2, ...)`

Specifies **which labels to use** for matching. All other labels are ignored.

```promql
metricA / on(instance) metricB
```

â†’ Match only on `instance`, ignore all other labels.

---

<div align="center" style="background-color: #11171F; border-radius: 10px; border: 2px solid">
    <img src="image/1762359482731.png" alt="Instant Vector" style="width: 80%">
</div>

---

### ğŸ”¸ `ignoring(label1, label2, ...)`

Specifies **which labels to ignore** during matching. All others must match.

```promql
metricA / ignoring(mode) metricB
```

â†’ Ignore `mode`, match on everything else.

---

<div align="center" style="background-color: #11171F; border-radius: 10px; border: 2px solid">
    <img src="image/1762359516746.png" alt="Instant Vector" style="width: 80%">
</div>

---

## ğŸ”€ 3. One-to-One Matching

### âœ… Definition

Each time series on the left matches **exactly one** time series on the right.

---

<div align="center" style="background-color: #11171F; border-radius: 10px; border: 2px solid">
    <img src="image/1762504039543.png" alt="Instant Vector" style="width: 80%">
</div>

---

### ğŸ”¹ Example

```promql
app_errors_total{instance="A", method="GET"} / app_requests_total{instance="A", method="GET"}
```

Both sides have:

- `instance="A"`
- `method="GET"`

â†’ Safe to divide directly.

## ğŸ” Many-to-One vs One-to-Many

When using binary operators (like `+`, `/`, `>`, etc.) between two metrics, Prometheus must **match time series** from both sides. If one side has **extra labels**, it creates ambiguity â€” and you must resolve it using `on(...)` and `group_left` or `group_right`.

---

### ğŸ§  Default Matching Recap

Prometheus matches time series **only when label sets are identical** (excluding metric name). If labels differ, you must guide Prometheus using:

- `on(...)` â†’ specify which labels to match
- `group_left(...)` or `group_right(...)` â†’ resolve many-to-one ambiguity

---

<div align="center" style="background-color: #11171F; border-radius: 10px; border: 2px solid">
    <img src="image/1762359793468.png" alt="Instant Vector" style="width: 80%">
</div>

<div align="center" style="background-color: #11171F; border-radius: 10px; border: 2px solid">
    <img src="image/1762359813915.png" alt="Instant Vector" style="width: 80%">
</div>

<div align="center" style="background-color: #11171F; border-radius: 10px; border: 2px solid">
    <img src="image/1762359845275.png" alt="Instant Vector" style="width: 80%">
</div>

---

## ğŸ…°ï¸ 1. Many-to-One Matching

### âœ… Definition

**Left side** has **many series** per label combination  
**Right side** has **one series** per label combination

### ğŸ”¹ Example

#### Left: `http_errors`

```ini
{error="400", path="/cats"} â†’ 2
{error="404", path="/cats"} â†’ 5
{error="500", path="/cats"} â†’ 4
```

#### Right: `http_requests`

```ini
{path="/cats"} â†’ 2
```

### âŒ Invalid Query

````promql
http_errors + on(path) http_requests
```ini
Fails with:

```ini
Error executing query: many-to-one matching must be explicit (group_left/group_right)
````

### âœ… Correct Query

```promql
http_errors + on(path) group_left(error) http_requests
```

### ğŸ§  Behavior

- Match on `path`
- Keep `error` label from left
- Result:

  ```ini
  {error="400", path="/cats"} â†’ 2 + 2 = 4
  {error="404", path="/cats"} â†’ 5 + 2 = 7
  {error="500", path="/cats"} â†’ 4 + 2 = 6
  ```

---

## ğŸ…±ï¸ 2. One-to-Many Matching

### âœ… Definition

**Left side** has **one series** per label combination  
**Right side** has **many series** per label combination

### ğŸ”¹ Example

#### Left: `http_requests`

```ini
{path="/cats"} â†’ 2
```

#### Right: `http_errors`

```ini
{error="400", path="/cats"} â†’ 2
{error="404", path="/cats"} â†’ 5
```

### âŒ Invalid Query

```promql
http_requests + on(path) http_errors
```

### âœ… Correct Query

```promql
http_requests + on(path) group_right(error) http_errors
```

### ğŸ§  Behavior

- Match on `path`
- Keep `error` label from right
- Result:

  ```ini
  {error="400", path="/cats"} â†’ 2 + 2 = 4
  {error="404", path="/cats"} â†’ 2 + 5 = 7
  ```

---

## ğŸ§  Summary Table

<div align="center" style="background-color: #141a19ff;color: #a8a5a5ff; border-radius: 10px; border: 2px solid">

| Match Type  | Description            | Modifier Needed        | Example                                                |
| ----------- | ---------------------- | ---------------------- | ------------------------------------------------------ |
| One-to-One  | Labels match exactly   | âŒ No                  | `A{instance="X"} / B{instance="X"}`                    |
| Many-to-One | Left has extra labels  | âœ… Yes (`group_left`)  | `A{error, path} + on(path) group_left(error) B{path}`  |
| One-to-Many | Right has extra labels | âœ… Yes (`group_right`) | `A{path} + on(path) group_right(error) B{error, path}` |

</div>

# ğŸ§² [Grafana Alloy](https://grafana.com/docs/alloy/latest/)

> **Grafana Alloy** is a **vendor-neutral, programmable observability agent** that runs as a **single binary** and is responsible for **collecting, processing, and exporting telemetry data** (logs, metrics, traces, profiles). Alloy **does not store data**. It acts as a **pipeline engine**, wiring sources â†’ processors â†’ destinations using a **declarative component graph**.

---

![Image](https://grafana.com/media/docs/alloy/alloy_diagram_v2.svg)

---

## ğŸ§  One-Sentence Mental Model (Very Important)

> **Alloy is to observability what kube-proxy is to networking**:
> It doesnâ€™t own the data â€” it **routes, transforms, and forwards it correctly**.

---

## ğŸ”´ **Problem: Why Alloy Exists**

### 1ï¸âƒ£ Before Alloy (The Old World)

| Signal   | Tool                    |
| -------- | ----------------------- |
| Logs     | Promtail                |
| Metrics  | Prometheus Agent        |
| Traces   | OpenTelemetry Collector |
| Profiles | Pyroscope Agent         |

âŒ **Problems**:

- Too many agents
- Duplicate logic (discovery, relabeling, auth)
- Hard to operate at scale
- Inconsistent configuration models

---

### 2ï¸âƒ£ Grafanaâ€™s Answer: Alloy

Grafana unified **everything** into **one programmable agent**:

| Capability     | Alloy |
| -------------- | ----- |
| Logs           | âœ…    |
| Metrics        | âœ…    |
| Traces         | âœ…    |
| Profiles       | âœ…    |
| Routing        | âœ…    |
| Fan-out        | âœ…    |
| Vendor neutral | âœ…    |

---

## ğŸŸ¢ **What Alloy Is (and Is NOT)**

### âœ… Alloy IS:

- A **data plane**
- A **pipeline engine**
- A **runtime for observability components**
- A **Promtail replacement**
- An **OTel-compatible agent**

### âŒ Alloy is NOT:

- A database
- A UI
- Loki / Prometheus / Tempo
- A control plane

---

## âš™ï¸ **Alloy Core Architecture**

<div align="center" style="background-color:#1f2a2aff;border-radius:10px;border:2px solid">

```mermaid
graph LR
    A[ğŸ“¥ Source Component]
    B[âš™ï¸ Processing Component]
    C[ğŸ“¤ Destination Component]

    A --> B --> C

    classDef src fill:#2b8a3e,color:#fff;
    classDef proc fill:#b08900,color:#fff;
    classDef dst fill:#364fc7,color:#fff;

    class A src
    class B proc
    class C dst
```

</div>

---

### ğŸ”‘ Alloy Design Rule

> **Everything in Alloy is a Component**
> Components are wired together using **explicit references**

---

## ğŸ§© **Alloy Component Types**

### 1ï¸âƒ£ **Sources** â€“ _Where data comes from_

Examples:

- Kubernetes pods
- Files
- Journald
- OTLP
- Prometheus scrape targets

```alloy
loki.source.kubernetes "pods" { }
```

---

### 2ï¸âƒ£ **Processors** â€“ _How data is transformed_

Examples:

- Label extraction
- JSON parsing
- Filtering
- Enrichment
- Redaction

```alloy
loki.process "enrich" { }
```

---

### 3ï¸âƒ£ **Destinations** â€“ _Where data goes_

Examples:

- Loki
- Prometheus Remote Write
- Tempo
- Grafana Cloud

```alloy
loki.write "default" { }
```

---

## ğŸ§  **Alloy Is a Directed Graph (Not a Script)**

This is critical.

- There is **no execution order**
- Only **data flow**
- Components exist independently
- Connections define behavior

> If itâ€™s not wired, it doesnâ€™t run.

---

## ğŸŒ **Full Log Pipeline Example (Mental Model)**

<div align="center" style="background-color:#232b2dff;border-radius:10px;border:2px solid">

```mermaid
sequenceDiagram
    title Alloy Log Pipeline Flow ğŸ“œ

    participant Pod as ğŸ“¦ Pod
    participant FS as ğŸ—‚ï¸ /var/log/pods
    participant Src as ğŸ“¥ loki.source.kubernetes
    participant Proc as âš™ï¸ loki.process
    participant Write as ğŸ“¤ loki.write
    participant Loki as ğŸ§± Loki

    Pod->>FS: Write container logs
    FS->>Src: Tail log files
    Src->>Proc: Attach k8s metadata
    Proc->>Proc: Parse / filter / label
    Proc->>Write: Forward logs
    Write->>Loki: Push logs via HTTP
```

</div>

---

## ğŸ” **Why Alloy Configuration Feels â€œHardâ€ at First**

Because Alloy:

- Is **explicit**
- Avoids magic
- Forces correctness
- Exposes all moving parts

This is **good**, but brutal without guardrails.

---

## ğŸ”´ **Common Failure Points (You Experienced These)**

| Mistake             | Result               |
| ------------------- | -------------------- |
| Wrong log path      | No logs              |
| Missing relabel     | Logs without labels  |
| Wrong CRI parsing   | Garbled logs         |
| Missing permissions | Silent failure       |
| Wrong wiring        | Component never runs |

ğŸ‘‰ This is exactly why **k8s-monitoring exists** (next topic).

---

## ğŸ§  **Key Alloy Concepts You Must Memorize**

### ğŸ”‘ 1. Components donâ€™t auto-connect

You must explicitly wire them:

```alloy
forward_to = [loki.write.default.receiver]
```

---

### ğŸ”‘ 2. Kubernetes metadata is NOT automatic

It comes from:

- discovery
- relabeling
- processing

---

### ğŸ”‘ 3. Alloy is stateless

If Alloy dies:

- Logs still exist
- They resume tailing

---

### ğŸ”‘ 4. Alloy replaces Promtail completely

Promtail is deprecated.

---

## ğŸ§­ **Where Alloy Runs**

| Environment | Pattern          |
| ----------- | ---------------- |
| Kubernetes  | DaemonSet        |
| VM          | systemd service  |
| Bare metal  | binary           |
| Containers  | sidecar / daemon |

---

## ğŸ§  **When You Should Use Raw Alloy**

Use **raw Alloy config** if:

- You need conditional routing
- You want multiple pipelines
- You need per-tenant logic
- You ingest non-K8s sources
- You are building a platform

---

## ğŸŸ¢ **When You Should NOT Use Raw Alloy**

Do **not** start with raw Alloy if:

- You only need pod logs
- You are learning
- You want reliability fast
- You operate multiple clusters

This is where **`k8s-monitoring` wins**.

---

## ğŸ§  Memorization Block

### ğŸ”‘ Alloy = **S-P-D**

| Letter | Meaning     | Remember           |
| ------ | ----------- | ------------------ |
| **S**  | Source      | Where data enters  |
| **P**  | Process     | Transform / enrich |
| **D**  | Destination | Where data leaves  |

> If logs donâ€™t appear â†’ one of S, P, or D is broken.

---

## ğŸ§  Final Takeaway

- Alloy is **not scary**
- It is **honest**
- It exposes observability mechanics
- Helm charts exist to **protect you from foot-guns**
- Mastery comes from **reading generated configs**

# ‚ò∏Ô∏è **How Falco Rules Work in Kubernetes**

Falco runs as a **DaemonSet** on every node.
Each Falco pod loads a set of rule files during startup:

- Default rule sets
- Custom rules you create
- Rules loaded from ConfigMaps (Helm)
- Rules embedded into the container image (rare)

Falco evaluates rules **locally on each node** and sends alerts through its output channels or Sidekick.

Let's break down exactly how rules work, how to add them, how to override defaults, and how to debug them.

---

<div align="center" style="background-color:#fff; border-radius: 10px; border: 2px solid">
<img src="https://miro.medium.com/1%2A6GvoqcwEo-vNf0A2j5_FNw.gif" alt="istio installation" style="width: 100%">
</div>

---

<div align="center" style="background-color:#fff; border-radius: 10px; border: 2px solid">
<img src="https://falco.org/blog/gitops-your-falco-rules/images/gitops-your-falco-rules-01.png" alt="istio installation" style="width: 100%">
</div>

---

## 1Ô∏è‚É£ **Where Falco Rules Live in Kubernetes**

When installed via Helm, Falco loads rules from:

### ‚úî Default rules (bundled inside Falco container):

```ini
/etc/falco/falco_rules.yaml
/etc/falco/falco_rules.local.yaml
/etc/falco/k8s_audit_rules.yaml
```

### ‚úî Your custom rules (from ConfigMaps):

These appear inside the Falco pod under:

```ini
/etc/falco/rules.d/<yourfile>.yaml
```

### ‚úî Helm also includes overrides at:

```ini
/etc/falco/falco_rules.local.yaml
```

**The order matters** ‚Äî last loaded rules override earlier ones.

---

## 2Ô∏è‚É£ **How Falco Loads Rules (Order of Precedence)**

Falco processes rule files in this order:

- Falco internal default rules
- Default local overrides
- Built-in Kubernetes audit rules
- **Your custom rules (highest precedence)**

‚û°Ô∏è If there is a conflict, **the last loaded rule wins**.

Example:  
If you want to disable a default rule, you override it in your custom rule file.

---

## 3Ô∏è‚É£ **How to Add Custom Rules in Kubernetes**

You have 3 real-world ways to add custom rules:

---

### **‚úî Method 1: Helm Values (Recommended for production)**

In `values.yaml`:

```yaml
customRules:
  custom_rules.yaml: |
    - rule: Detect Suspicious Curl Use
      desc: curl inside container
      condition: evt.type=execve and proc.name=curl
      output: "curl executed in %container.id"
      priority: WARNING
      tags: [network]
```

Then install/update Helm release:

```bash
helm upgrade --install falco falcosecurity/falco -f values.yaml
```

Helm will create a ConfigMap under:

```ini
/etc/falco/rules.d/custom_rules.yaml
```

---

### **‚úî Method 2: Manual ConfigMap (Good for quick testing)**

Create a ConfigMap:

```bash
kubectl -n falco create configmap falco-custom-rules \
  --from-file=custom_rules.yaml
```

Patch the Falco DaemonSet to mount it:

```yaml
volumeMounts:
  - name: falco-custom-rules
    mountPath: /etc/falco/rules.d/custom_rules.yaml
    subPath: custom_rules.yaml
```

Apply patch:

```bash
kubectl apply -f <patchfile>.yaml
```

---

### **‚úî Method 3: Edit falco_rules.local.yaml (Debugging only)**

Inside the Falco pod:

```ini
kubectl exec -n falco falco-xxxxx -- bash
vi /etc/falco/falco_rules.local.yaml
```

‚ùó This is **not persistent** after restart unless mounted through a ConfigMap.

---

## 4Ô∏è‚É£ **Validating Your Custom Rules (Critical Step!)**

Falco supports a **rules validation mode**:

### Run validation inside a Falco pod:

```bash
falco --validate /etc/falco/rules.d/custom_rules.yaml
```

Or validate ALL rules:

```bash
falco --validate /etc/falco
```

If your rule has syntax errors, Falco will show:

- ‚ùå missing field
- ‚ùå unknown operator
- ‚ùå bad YAML
- ‚ùå undefined macro/list

---

## 5Ô∏è‚É£ **How to Debug Rules in Kubernetes (Most Important Skill)**

Debugging Falco rules requires a repeatable strategy:

---

### **Step 1 ‚Äî Watch Falco logs live**

```bash
kubectl logs -n falco -l app=falco -f
```

Or:

```bash
kubectl logs -n falco ds/falco -f
```

Look for messages like:

```ini
Evaluating rule: Detect Interactive Shell
```

---

### **Step 2 ‚Äî Increase Falco Debugging Mode**

In `values.yaml`:

```yaml
falco:
  verbosity: debug
```

Apply Helm upgrade:

```bash
helm upgrade falco falcosecurity/falco -f values.yaml
```

Falco will now print:

- Rule evaluation failures
- Missing fields in events
- Macro resolution
- Event field values

---

### **Step 3 ‚Äî Test rules manually using `falco --dry-run`**

You can run Falco in dry-run mode to test matching:

```bash
falco --rules custom_rules.yaml --dry-run
```

Useful for:

- Testing complex macros
- Checking for rule conflicts
- Validating K8s audit rules

---

### **Step 4 ‚Äî Test your rule by generating an event**

Example rule:

```yaml
proc.name = bash
```

Trigger event:

```bash
kubectl exec -it nginx -- bash
```

Then check logs:

```bash
kubectl logs -n falco ds/falco | grep bash
```

If your rule didn‚Äôt fire:

- Add `proc.cmdline` to output
- Check if event is `execve`
- Check if your container uses `sh` not `bash`
- Debug with verbosity enabled

---

### **Step 5 ‚Äî Check if the rule was loaded**

Run inside Falco container:

```bash
falco --list
```

This prints ALL active rules.

If your rule is missing:

- ConfigMap not loaded
- Mount path incorrect
- YAML indentation incorrect
- Rule name duplicated

---

## 6Ô∏è‚É£ **Overriding or Disabling Default Rules**

To disable a default rule:

Create a rule file:

```yaml
- rule: Unexpected Connection in Container
  enabled: false
```

This overrides the built-in rule and disables it.

To modify an existing rule:

Redefine it:

```yaml
- rule: Unexpected Connection in Container
  condition: evt.type=connect and fd.sip!=8.8.8.8
```

Falco will take your modified version because it loads last.

---

## üî¥ **Rule Loading Errors You Will Encounter (And How to Fix Them)**

| Error                   | Meaning                             | Fix                         |
| ----------------------- | ----------------------------------- | --------------------------- |
| unknown field proc.comm | invalid field                       | Check Falco field reference |
| macro not defined       | referencing macro before definition | Move macro above rule       |
| invalid list name       | list misspelled                     | Check YAML list name        |
| wrong indentation       | YAML problem                        | Fix formatting              |
| could not parse rule    | bad syntax                          | Use `falco --validate`      |

---

## ‚úÖ **Best Practices for Managing Falco Rules in Kubernetes**

- ‚úî Keep custom rules in `rules.d/` folder
- ‚úî Use Helm `customRules` for production
- ‚úî Never edit the container filesystem directly
- ‚úî Use GitOps (ArgoCD / Flux) for rule lifecycle
- ‚úî Use Sidekick to route alerts to SIEM/logging
- ‚úî Create environment-specific rule overrides

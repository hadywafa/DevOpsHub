# üéõ Customizing Istio Installation ‚Äì Big Picture

When you install Istio with `istioctl install`, you‚Äôre really using **one API**:

> **`IstioOperator` API**
> This drives:
>
> - what components get installed,
> - their **Kubernetes settings** (resources, replicas, node selectors, etc.),
> - their **Istio/Helm settings** (trace sampling, logging, global options, gateways‚Ä¶).

You can customize **in three main ways**:

1. `istioctl install --set ...` ‚Üí quick & dirty overrides
2. `istioctl install -f my-operator.yaml` ‚Üí proper declarative config
3. Advanced:

   - custom charts & profiles
   - patching the generated manifest with `overlays`

This works for **sidecar** or **ambient** ‚Äî the difference is mostly **which profile** you pick (`default`, `ambient`, `demo`, etc.). ([Istio][1])

---

## 1Ô∏è‚É£ Prerequisites (what docs expect you did)

Before playing with customization, docs assume: ([Istio][1])

- You **downloaded the Istio release** (so you have `istioctl`, manifests, samples).
- You did any needed **platform-specific setup** (EKS/GKE/OpenShift/etc.).
- Your **pods/services satisfy Istio‚Äôs requirements** (ports, labels, etc.).

---

## 2Ô∏è‚É£ The `IstioOperator` API (your main customization entry)

### 2.1 Using `--set` on the CLI

You can override parameters directly from the command line.

Example ‚Äì enable **debug logging** globally: ([Istio][1])

```bash
istioctl install --set values.global.logging.level=debug
```

Example ‚Äì change a Helm-style option (trace sampling): ([Istio][1])

```bash
istioctl install --set values.pilot.traceSampling=0.1
```

> Rule of thumb:
>
> - `values.*` ‚Üí **Helm values-style** settings
> - `components.*` and `meshConfig` ‚Üí **IstioOperator API** settings

---

### 2.2 Using an `IstioOperator` YAML

Instead of a long `--set` line, you can put everything into a YAML and pass it with `-f`: ([Istio][1])

```bash
istioctl install -f my-operator.yaml
```

Example (very simple):

```yaml
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
spec:
  profile: default # or demo, minimal, ambient, etc.
  values:
    global:
      logging:
        level: debug
```

This is the **recommended way** for anything serious (GitOps, PR reviews, history, etc.).

---

## 3Ô∏è‚É£ Step 1 ‚Äì Identify the Istio component you want to customize

The docs say: **customization is per component**.
The main components in the `IstioOperator` API are: ([Istio][1])

- `base`
- `pilot` (this is `istiod`)
- `ingressGateways`
- `egressGateways`
- `cni`
- `istiodRemote`

You access them as:

```yaml
spec:
  components:
    pilot: ...
    ingressGateways: ...
    cni: ...
```

Example ‚Äì disable `pilot` (for illustration only üòÖ): ([Istio][1])

```yaml
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
spec:
  components:
    pilot:
      enabled: false
```

Same thing via CLI:

```bash
istioctl install --set components.pilot.enabled=false
```

---

## 4Ô∏è‚É£ Step 2 ‚Äì Customize Kubernetes settings for a component

Every component has a **KubernetesResourceSpec** under `.k8s`, where you can tweak: ([Istio][1])

1. Resources (CPU/memory)
2. Readiness probes
3. Replica count
4. HPA settings
5. PodDisruptionBudget
6. Pod annotations
7. Service annotations
8. ImagePullPolicy
9. Priority class
10. Node selector
11. Affinity / anti-affinity
12. Service options
13. Tolerations
14. Strategy
15. Environment variables
16. Pod security context
17. Volumes / mounts

All using normal K8s API types.

### Example: tune `pilot` resources and HPA

From docs: ([Istio][1])

```yaml
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
spec:
  components:
    pilot:
      k8s:
        resources:
          requests:
            cpu: 1000m # override default 500m
            memory: 4096Mi # override default 2048Mi
        hpaSpec:
          maxReplicas: 10 # default 5
          minReplicas: 2 # default 1
```

Apply it:

```bash
istioctl install -f pilot-k8s.yaml
```

This regenerates the manifest with your changes and applies it.

---

## 5Ô∏è‚É£ Step 3 ‚Äì Customize Istio settings via the Helm API (`values`)

The `IstioOperator` spec has a **pass-through** field called `values` that maps directly to **Helm values** (the old style). ([Istio][1])

Example from docs: configure global + pilot settings: ([Istio][1])

```yaml
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
spec:
  values:
    pilot:
      traceSampling: 0.1 # override from 1.0
    global:
      monitoringPort: 15014
```

You can mix this with `components.*` and `meshConfig` in the same file.

Docs note: some settings exist both in `values.*` and the `IstioOperator` API for a while (migration period), but **they recommend using the `IstioOperator` API wherever possible**, because it‚Äôs validated and follows Istio‚Äôs community process. ([Istio][1])

---

## 6Ô∏è‚É£ Step 4 ‚Äì Configure gateways (special case)

Gateways are special because you can have **multiple ingress/egress gateways**.
In `IstioOperator`, they are list-based components. ([Istio][1])

Key points from docs:

- `default` profile installs **one ingress gateway**: `istio-ingressgateway`.
- From Istio 1.7+, you **must specify the gateway name** in overlays ‚Äì no implicit default. ([Istio][1])

### 6.1 Customize built-in + add a new user gateway

Example from docs: ([Istio][1])

```yaml
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
spec:
  components:
    ingressGateways:
      - name: istio-ingressgateway # built-in one
        enabled: true
      - namespace: user-ingressgateway-ns
        name: ilb-gateway
        enabled: true
        k8s:
          resources:
            requests:
              cpu: 200m
          serviceAnnotations:
            cloud.google.com/load-balancer-type: "internal"
          service:
            ports:
              - port: 8060
                targetPort: 8060
                name: tcp-citadel-grpc-tls
              - port: 5353
                name: tcp-dns
```

Important note: **Helm-style gateway values** (like `values.gateways.istio-ingressgateway`) are **shared by all gateways**, so if you need **per-gateway** Helm customization, the docs suggest using a **separate `IstioOperator` CR** just for the user gateways. ([Istio][1])

Example (second CR only for custom gateway):

```yaml
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
spec:
  profile: empty
  components:
    ingressGateways:
      - name: ilb-gateway
        namespace: user-ingressgateway-ns
        enabled: true
        # copy relevant settings from istio-ingressgateway
  values:
    gateways:
      istio-ingressgateway:
        debug: error
```

You then generate/apply this separately with `istioctl`.

---

## 7Ô∏è‚É£ Advanced: use your own charts & profiles

The `istioctl` `install`, `manifest generate`, and `profile` commands can use **different sources for charts & profiles**: ([Istio][1])

- **Built-in compiled charts** (default)
- Charts from local filesystem, via `--manifests` (e.g., `istioctl install --manifests mycharts/`)

### 7.1 Customize charts in `manifests/`

You can:

- copy the `manifests/` folder from the release,
- tweak the charts & profiles under it,
- and point `istioctl` at your copy:

```bash
istioctl install --manifests mycharts/
```

For big orgs, this is how you **maintain your own opinionated Istio flavor**.

### 7.2 Custom profiles

Profiles live in `manifests/profiles/`. You can: ([Istio][1])

- Add `custom1.yaml` there,
- Reference it by name via `spec.profile` or `--set profile=custom1`.

Example from docs:

```bash
istioctl manifest generate \
  --manifests mycharts/ \
  --set profile=custom1 \
  -f path-to-user-overlay.yaml
```

That means:

- `default.yaml`
- `custom1.yaml`
- `user-overlay.yaml`
  ‚Üí merged into one set of values.

Docs also say: **you usually don‚Äôt need new profiles** ‚Äì using **multiple overlays** often gives the same result:

```bash
istioctl manifest generate \
  --manifests mycharts/ \
  -f manifests/profiles/custom1.yaml \
  -f path-to-user-overlay.yaml
```

You only need a custom profile if you want to refer to it by name from `IstioOperatorSpec.profile`. ([Istio][1])

---

## 8Ô∏è‚É£ Advanced: patch the generated manifest with `overlays`

This is the ‚Äú**surgical edit**‚Äù tool üõ†

The flow:

1. `IstioOperator` ‚Üí used by `istioctl` to generate a manifest
2. Before applying, you can **patch that manifest** with `k8s.overlays` in `IstioOperator`. ([Istio][1])

Example from docs (`patch.yaml`): ([Istio][1])

```yaml
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
spec:
  profile: empty
  hub: docker.io/istio
  tag: 1.1.6
  components:
    pilot:
      enabled: true
      namespace: istio-control
      k8s:
        overlays:
          - kind: Deployment
            name: istiod
            patches:
              # select list item by value
              - path: spec.template.spec.containers.[name:discovery].args.[30m]
                value: "60m"
              # select list item by key:value
              - path: spec.template.spec.containers.[name:discovery].ports.[containerPort:8080].containerPort
                value: 1234
              # override with object
              - path: spec.template.spec.containers.[name:discovery].env.[name:POD_NAMESPACE].valueFrom
                value: |
                  fieldRef:
                    apiVersion: v2
                    fieldPath: metadata.myPath
              # delete env item
              - path: spec.template.spec.containers.[name:discovery].env.[name:REVISION]
              # delete map item
              - path: spec.template.spec.containers.[name:discovery].securityContext
          - kind: Service
            name: istiod
            patches:
              - path: spec.ports.[name:https-dns].port
                value: 11111
```

You then run:

```bash
istioctl manifest generate -f patch.yaml
```

This prints the resulting patched manifests (which you can apply or pipe to `kubectl apply`). ([Istio][1])

### 8.1 List item selection syntax

Both `--set` and `k8s.overlays` support: ([Istio][1])

- `[index]`
- `[value]`
- `[key:value]`

Example:
`containers.[name:discovery].ports.[containerPort:8080].containerPort`

This allows precise edits without knowing the exact index in the YAML list.

---

## 9Ô∏è‚É£ Mental cheat-sheet: ‚ÄúI want to ‚Ä¶ so I use ‚Ä¶‚Äù

| Goal                                                       | Use this                                                             |
| ---------------------------------------------------------- | -------------------------------------------------------------------- |
| Quick one-off override (e.g. tracing 0.1)                  | `istioctl install --set values.pilot.traceSampling=0.1` ([Istio][1]) |
| Tune CPU/memory/replicas/HPA for a component               | `spec.components.<component>.k8s` in `IstioOperator`                 |
| Change global/Istio settings (logging, trace, ports‚Ä¶)      | `spec.values.*` (Helm style)                                         |
| Add or customize gateways                                  | `spec.components.ingressGateways[]` / `egressGateways[]`             |
| Maintain your own chart/profile set                        | `--manifests mycharts/` + custom profiles                            |
| Surgical low-level patch to generated Kubernetes resources | `spec.components.<..>.k8s.overlays`                                  |

---

If you like, next we can do a **full example file** like:

- ‚ÄúProd-ready sidecar install with tuned `istiod` resources + 2 ingress gateways (public + internal)‚Äù

or

- ‚ÄúAmbient install with customized ztunnel resources and a separate ILB gateway CR‚Äù.

You choose the scenario and I‚Äôll build the full YAML in your style. üöÄ

[1]: https://istio.io/latest/docs/setup/additional-setup/customize-installation/ "Istio / Customizing the installation configuration"

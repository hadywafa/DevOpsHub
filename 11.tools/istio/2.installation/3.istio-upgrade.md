# ğŸš€ Istio Upgrade â€” The Complete, Clean, 2025 Guide

_(Sidecar mode + Ambient mode + `istioctl` + Helm + Best Practices)_

Upgrading Istio **should not be scary** â€” but it _is_ strict.
Istio has one of the strongest upgrade safety models in Kubernetes.

Letâ€™s go step by step.

---

## ğŸ§  1. Istio Upgrade Philosophy (Very Important)

Istio's upgrade model is:

> **â€œControl plane first â†’ data plane later â†’ app rollout at your pace.â€**

Meaning:

### âœ”ï¸ Step 1: Upgrade control plane (`istiod`)

### âœ”ï¸ Step 2: Leave sidecars / ztunnels running older version (backward compatible)

### âœ”ï¸ Step 3: Gradually update workloads (rolling restarts)

### âœ”ï¸ Step 4: Validate â†’ finish â†’ cleanup

This gives you:

- zero downtime
- version-skew upgrades
- reversible step boundaries
- safe rollback

---

## ğŸ§® 2. Supported Upgrade Patterns

Istio officially supports:

### **âœ”ï¸ In-place upgrade**

Upgrade the existing control plane revision and proxies.

### **âœ”ï¸ Revision-based upgrade (Recommended)**

Install a **new revision** (`istio-1-20`, `istio-1-21`, etc.)
â†’ migrate namespaces gradually
â†’ remove old revision.

This is the **best practice**.

### **âœ”ï¸ Canary control plane**

Similar to revisions but using canary deployments of `istiod`.

### **âœ”ï¸ Upgrade using Helm**

Chart upgrade + proxy injection restart.

### **âœ”ï¸ Upgrade using Ambient mode semantics**

zTunnel and waypoints upgrade gracefully like sidecars.

---

## ğŸ“¦ 3. Tools Used for Upgrade

Upgrades usually involve:

### ğŸŸ¦ `istioctl upgrade`

The simplest form â€” it analyzes your cluster and upgrades the control plane in place.

### ğŸŸ§ `istioctl install --revision xyz`

Install a new revision â†’ migrate workloads â†’ delete old one.

### ğŸŸ© Helm `upgrade`

`helm upgrade istiod istio/istiod --version x.y.z`

### ğŸŸ¨ Ambient-specific upgrades

Upgrade:

- `ztunnel`
- `istio-cni`
- waypoints
  independently and safely.

---

## ğŸ› ï¸ 4. **In-place Upgrade (Simplest Way)**

This upgrades the control plane **within the same revision**.

### Step 1 â€” Dry-run analysis

```bash
istioctl upgrade --dry-run
```

This shows:

- compatibility
- deprecated resources
- warnings
- required changes

### Step 2 â€” Perform upgrade

```bash
istioctl upgrade
```

### Step 3 â€” Restart workloads (to refresh sidecars)

Sidecar mode:

```bash
kubectl rollout restart deployment -n <ns>
```

Ambient mode:
zTunnel refreshes automatically â†’ only restart pods if you want to update runtime behavior.

---

## ğŸ§¬ 5. Revision-Based Upgrade (The Recommended Way)

This is the **safe, modern, production-grade upgrade**.

Imagine your current Istio version is **1.20**
You want to upgrade to **1.21**.

### Step 1 â€” Install the new revision

```bash
istioctl install --revision 1-21 -y
```

This creates:

```ini
istiod-1-21
```

alongside the existing:

```ini
istiod-1-20
```

No breakage. No downtime.

---

### Step 2 â€” Label a namespace to use the _new_ revision

```bash
kubectl label namespace default istio.io/rev=1-21 --overwrite
```

### Step 3 â€” Restart only the workloads in that namespace

```bash
kubectl rollout restart deployment -n default
```

Pods will now get **1.21 sidecars**.

---

### Step 4 â€” Gradually migrate all namespaces

One by one, at your pace.

### Step 5 â€” Verify everything

```bash
istioctl proxy-status
```

Check that all proxies are talking to `istiod-1-21`.

---

### Step 6 â€” Delete the old revision

```bash
kubectl delete ns istio-system-1-20
# or
istioctl uninstall --revision 1-20
```

Done: zero downtime.

---

## ğŸ› ï¸ 6. Sidecar Upgrade Details (Sidecar Mode)

Sidecars upgrade only when workloads restart.

This means:

- **control plane upgrade â‰  sidecar upgrade**
- you decide when to restart apps
- can mix 1.20 and 1.21 proxies safely

Supported version skew:

- **N to N+1 minor version** between proxy & control plane

---

## ğŸŒ‰ 7. Ambient Mode Upgrade Details

Ambient mode upgrades consist of:

### âœ”ï¸ Upgrade **istiod** (control plane)

`istioctl upgrade`

### âœ”ï¸ Upgrade **ztunnel**

DaemonSet rolling update:

```ini
kubectl get ds -n istio-system ztunnel
```

â†’ new pods rollout automatically with no app restarts.

### âœ”ï¸ Upgrade **Waypoints**

Waypoint proxies are Kubernetes deployments â†’ rolling upgrade:

```ini
kubectl rollout restart deployment -n <ns> <waypoint-name>
```

### âœ”ï¸ **No restarts for apps** needed in ambient mode

Apps are completely sidecarless.

Huge advantage.

---

## ğŸ“¦ 8. Helm Upgrade (Sidecar or Ambient)

### Step 1 â€” Update Istio base CRDs

```bash
helm upgrade istio-base istio/base \
  -n istio-system \
  --version 1.21.x
```

### Step 2 â€” Upgrade control plane

```bash
helm upgrade istiod istio/istiod \
  -n istio-system \
  --version 1.21.x
```

### Step 3 â€” Upgrade gateways (if any)

```bash
helm upgrade istio-ingress istio/gateway \
  -n istio-ingress \
  --version 1.21.x
```

### Step 4 â€” Upgrade ambient components

```bash
helm upgrade istio-cni istio/cni -n istio-system --version 1.21.x
helm upgrade ztunnel istio/ztunnel -n istio-system --version 1.21.x
```

Then follow the revision-based approach for workloads.

---

## ğŸ”„ 9. Verification Steps (Very Important)

### Check control plane health

```bash
kubectl get pods -n istio-system
```

### Check all proxies connect to the new istiod

```bash
istioctl proxy-status
```

### Check mesh-wide configuration

```bash
istioctl analyze
```

### Check gateways

```bash
kubectl get deployment -A | grep gateway
```

---

## ğŸ§¯ 10. Rollback Strategy (Safe & Simple)

Istio upgrades are reversible:

### âœ”ï¸ If using in-place upgrade

Run:

```bash
istioctl upgrade --set revision=<old-version>
```

or reinstall the old version.

---

### âœ”ï¸ If using revision-based upgrade (best practice)

Rollback = simply switch namespace label back:

```bash
kubectl label namespace default istio.io/rev=1-20 --overwrite
kubectl rollout restart deploy -n default
```

Done.

---

## ğŸ“ 11. Common Pitfalls

âŒ Upgrading multiple major releases at once
â†’ Always do N â†’ N+1.

âŒ Forgetting to upgrade CRDs
â†’ Must upgrade with Istio Base chart or `istioctl` automatically does it.

âŒ Not restarting workloads after sidecar version change
â†’ old â†’ new proxies won't show up until restart.

âŒ Mixing `istio-injection=enabled` and revision mode
â†’ Donâ€™t use both; use only `istio.io/rev=`.

---

## ğŸ§ 12. TL;DR â€” Istio Upgrade in One Sentence

> **Upgrade control plane â†’ migrate workloads gradually using revision labels â†’ restart apps (sidecar mode only) â†’ delete old revision. Ambient mode upgrades are simpler because there are no sidecars.**

---

If you want, I can generate:

### âœ”ï¸ A full upgrade checklist (copy/paste for production)

### âœ”ï¸ A detailed upgrade comparison (Sidecar vs Ambient)

### âœ”ï¸ A practical walkthrough (1.20 â†’ 1.21 with real commands)

### âœ”ï¸ A GitOps upgrade pipeline example (Flux/ArgoCD)

Just tell me.
